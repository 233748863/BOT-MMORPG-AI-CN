# 实现计划: 血量/蓝量检测 (Health Mana Detection)

## 概述

实现血量/蓝量检测功能，通过图像识别检测游戏界面中的血条和蓝条百分比。

## 任务列表

- [ ] 1. 实现状态条分析器
  - [ ] 1.1 创建 `核心/状态检测.py` 文件，实现 `状态条分析器` 类
    - HSV 颜色空间分析
    - 填充边界检测
    - _需求: 2.1, 2.3_
  - [ ] 1.2 实现颜色配置支持
    - 可配置的颜色范围
    - 渐变颜色处理
    - _需求: 2.2, 2.4_
  - [ ]* 1.3 编写属性测试：检测值范围
    - **属性 1: 检测值范围**
    - *对于任意* 检测结果，百分比应在 [0.0, 1.0] 范围内
    - **验证: 需求 2.5, 3.3**

- [ ] 2. 实现血量检测器
  - [ ] 2.1 实现 `血量检测器` 类
    - 区域配置
    - 检测方法
    - 置信度计算
    - _需求: 1.1, 2.1, 6.4_
  - [ ] 2.2 实现 `蓝量检测器` 类
    - 单独区域配置
    - 未配置时返回 1.0
    - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 3. 实现平滑处理
  - [ ] 3.1 实现 `平滑器` 类
    - 移动平均计算
    - 突变检测和快速响应
    - _需求: 4.1, 4.2, 4.3_
  - [ ]* 3.2 编写属性测试：平滑稳定性
    - **属性 2: 平滑稳定性**
    - *对于任意* 连续相似输入，平滑后输出变化应小于突变阈值
    - **验证: 需求 4.1, 4.2**
  - [ ]* 3.3 编写属性测试：突变响应性
    - **属性 3: 突变响应性**
    - *对于任意* 血量显著变化（>10%），检测器应在下一帧立即反映
    - **验证: 需求 4.3**

- [ ] 4. 实现校准工具
  - [ ] 4.1 实现 `校准工具` 类
    - 区域选择界面
    - 预览功能
    - _需求: 1.2, 1.3_
  - [ ] 4.2 实现配置保存和加载
    - 保存到配置文件
    - 支持多游戏配置
    - _需求: 1.4, 1.5_

- [ ] 5. 实现错误处理
  - [ ] 5.1 实现检测失败处理
    - 返回上次有效值
    - 超时返回满血
    - _需求: 6.1, 6.2_
  - [ ] 5.2 实现日志和诊断
    - 记录检测失败
    - 血量变化日志
    - _需求: 5.4, 6.3_

- [ ] 6. 集成到决策引擎
  - [ ] 6.1 修改 `核心/决策引擎.py`，集成血量检测
    - 每个决策周期调用检测
    - 紧急规则触发
    - _需求: 5.1, 5.2, 5.3_
  - [ ] 6.2 添加检测配置到配置文件
    - 血条/蓝条区域配置
    - 颜色配置
    - _需求: 1.4_

- [ ] 7. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 验证检测准确性
  - 如有问题请询问用户

## 备注

- 带 `*` 标记的任务为可选测试任务
- 使用 OpenCV 进行颜色分析
- 默认平滑窗口 5 帧
