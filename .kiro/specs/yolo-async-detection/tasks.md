# 实现计划: YOLO 异步检测 (YOLO Async Detection)

## 概述

实现 YOLO 异步检测功能，将目标检测从主循环中分离到独立线程，提高整体帧率。

## 任务列表

- [x] 1. 实现线程安全组件
  - [x] 1.1 创建 `核心/异步检测.py` 文件，实现 `检测队列` 类
    - 线程安全的队列操作（使用 threading.Lock）
    - 溢出计数跟踪（_溢出计数 属性）
    - _需求: 1.2, 4.2_
  - [x] 1.2 实现 `结果缓存` 类
    - 线程安全的结果存储（使用 threading.Lock）
    - 时间戳记录（_时间戳 属性）
    - _需求: 2.1, 2.2, 2.3, 2.4, 4.1_
  - [x] 1.3 编写属性测试：线程安全性
    - **属性 1: 线程安全性**
    - *对于任意* 并发访问结果缓存的操作，不应产生数据竞争
    - 测试文件: `测试/test_异步检测线程安全性属性.py`
    - **验证: 需求 4.1, 4.2**

- [x] 2. 实现异步检测器
  - [x] 2.1 实现 `异步检测器` 类核心功能
    - 检测线程管理（_检测循环 方法）
    - 帧提交（提交帧 方法）和结果获取（获取结果 方法）
    - _需求: 1.1, 1.3, 1.4_
  - [x] 2.2 实现优雅关闭机制
    - 线程停止信号（_停止事件）
    - 资源清理（停止 方法，支持超时参数）
    - _需求: 1.5_
  - [x] 2.3 编写属性测试：优雅关闭
    - **属性 2: 优雅关闭**
    - *对于任意* 停止请求，检测线程应在 1 秒内完成关闭
    - 测试文件: `测试/test_异步检测优雅关闭属性.py`
    - **验证: 需求 1.5**

- [x] 3. 实现检测频率控制
  - [x] 3.1 实现检测间隔配置
    - 支持帧数间隔（检测间隔 参数）
    - _需求: 3.1_
  - [x] 3.2 实现帧跳过逻辑
    - 队列满时跳过帧（放入 方法返回 False）
    - _需求: 3.2, 3.4_

- [x] 4. 实现性能监控
  - [x] 4.1 实现 `性能监控器` 类
    - 延迟记录和统计（记录延迟、获取统计 方法）
    - 队列状态跟踪（性能统计 数据类）
    - _需求: 5.1, 5.2, 5.3_
  - [x] 4.2 实现警告机制
    - 检测落后警告（连续错误检测）
    - 日志记录（logging 模块）
    - _需求: 3.3, 5.4_
  - [x] 4.3 编写属性测试：结果时效性
    - **属性 3: 结果时效性**
    - *对于任意* 获取的检测结果，时间戳应反映实际检测完成时间
    - 测试文件: `测试/test_结果时效性属性.py`
    - **验证: 需求 2.3**

- [x] 5. 实现异常处理
  - [x] 5.1 实现检测线程异常处理
    - 捕获并记录异常（try-except 在 _检测循环 中）
    - 继续运行不崩溃（continue 语句）
    - _需求: 4.3, 4.4_
  - [x] 5.2 实现回退机制
    - 线程启动失败时回退到同步检测（_回退到同步 标志，_同步检测 方法）
    - _需求: 4.4_

- [x] 6. 集成到目标检测器
  - [x] 6.1 修改 `核心/目标检测器.py`，集成异步检测器
    - 添加异步模式配置（启用异步 参数）
    - 异步检测方法（异步检测、获取异步结果、停止异步检测）
    - _需求: 1.1, 1.4_
  - [x] 6.2 添加异步检测配置
    - 队列大小、检测间隔等（默认异步检测配置）
    - _需求: 3.1_

- [x] 7. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 验证帧率提升效果
  - 如有问题请询问用户

## 实现状态

所有任务已完成！

### 已实现的核心文件
- `核心/异步检测.py` - 异步检测模块（检测队列、结果缓存、性能监控器、异步检测器）
- `核心/目标检测器.py` - 已集成异步检测功能

### 已实现的测试文件
- `测试/test_异步检测线程安全性属性.py` - 属性 1 测试
- `测试/test_异步检测优雅关闭属性.py` - 属性 2 测试
- `测试/test_结果时效性属性.py` - 属性 3 测试

## 备注

- 使用 threading 模块实现多线程
- 默认队列大小 3，检测间隔 3 帧
- 支持上下文管理器自动启停
- 支持同步回退模式
