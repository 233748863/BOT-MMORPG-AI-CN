# 需求文档

## 简介

本文档定义了 MMORPG 游戏 AI 助手项目中发现的业务逻辑问题的修复需求。这些问题涉及参数命名不一致、功能未正确集成、配置同步问题等，需要系统性地修复以确保项目的稳定性和正确性。

## 术语表

- **屏幕截取模块**: 核心/屏幕截取.py，负责捕获游戏画面
- **数据收集模块**: 训练/收集数据.py，负责录制玩家操作数据
- **机器人模块**: 运行/运行机器人.py 和 运行/增强机器人.py，负责运行 AI 自动玩游戏
- **决策引擎**: 核心/决策引擎.py，负责根据游戏状态做出动作决策
- **训练模块**: 训练/训练模型.py，负责训练 AI 模型
- **配置模块**: 配置/设置.py，负责管理全局配置
- **智能录制器**: 负责评估和过滤训练数据片段
- **GDI截取**: Windows GDI 屏幕截取方式

## 需求

### 需求 1: 修复屏幕截取函数参数名称不一致

**用户故事:** 作为开发者，我希望屏幕截取函数的参数名称保持一致，以便调用函数时不会出现参数名称错误。

#### 验收标准

1. 当数据收集模块调用截取屏幕函数时，屏幕截取模块应接受参数名"区域"而非"region"
2. 当机器人模块调用截取屏幕函数时，屏幕截取模块应接受参数名"区域"而非"region"
3. 屏幕截取模块应保持向后兼容，同时接受"区域"和"region"两种参数名
4. 无论使用哪种参数名，屏幕截取模块应产生相同的结果

### 需求 2: 修复智能录制数据过滤逻辑

**用户故事:** 作为数据科学家，我希望智能录制的过滤逻辑能够真正过滤低价值数据，以便用更高质量的数据训练模型。

#### 验收标准

1. 当智能录制器评估片段为"should_filter=True"时，数据收集模块应将该片段从训练数据列表中排除
2. 当智能录制器评估片段为"low"价值等级且使用auto_filter选项时，数据收集模块应将该片段从训练数据列表中排除
3. 当过滤选项为"high_only"时，数据收集模块应只包含"high"价值等级的片段
4. 当过滤选项为"all"时，数据收集模块应包含所有片段，不论价值等级
5. 数据收集模块应显示准确的统计信息，展示已过滤和已保存的片段数量

### 需求 3: 修复 GDI 截取宽高计算偏移

**用户故事:** 作为开发者，我希望 GDI 屏幕截取能正确计算尺寸，以便截取的区域与预期区域完全匹配。

#### 验收标准

1. 当从区域 (左, 上, 右, 下) 计算截取尺寸时，屏幕截取模块应计算宽度为 (右 - 左)，不加 1
2. 当从区域 (左, 上, 右, 下) 计算截取尺寸时，屏幕截取模块应计算高度为 (下 - 上)，不加 1
3. 当截取区域为 (0, 0, 100, 100) 时，屏幕截取模块应返回正好 100x100 像素的图像

### 需求 4: 修复动作索引冲突

**用户故事:** 作为游戏玩家，我希望每个动作都有唯一的按键映射，以便 AI 不会混淆不同的动作。

#### 验收标准

1. 配置模块应为每个动作索引分配唯一的按键映射
2. 当动作索引 18 定义为"技能F"时，配置模块不应同时将"F"键映射到动作索引 21
3. 配置模块应为"交互"动作（索引 21）使用不与"技能F"冲突的其他按键
4. 如果在配置加载时检测到按键冲突，配置模块应记录警告信息

### 需求 5: 修复配置更新后模型输入尺寸不同步

**用户故事:** 作为开发者，我希望模型输入尺寸在窗口区域变化时自动更新，以便模型接收正确尺寸的输入。

#### 验收标准

1. 当调用更新窗口区域函数并传入新区域时，配置模块应重新计算模型输入宽度和模型输入高度
2. 配置模块应使用公式：模型输入宽度 = 游戏宽度 // 模型缩放比例
3. 配置模块应使用公式：模型输入高度 = 游戏高度 // 模型缩放比例
4. 当窗口区域更新时，配置模块应通知依赖模块尺寸变化

### 需求 6: 修复训练模块类别权重未应用问题

**用户故事:** 作为数据科学家，我希望类别权重在训练时真正被应用，以便模型学习所有动作类别的平衡表示。

#### 验收标准

1. 当启用类别权重平衡时，训练模块应将计算的权重应用到损失函数
2. 训练模块应使用加权损失函数而非默认的 categorical_crossentropy
3. 当训练完成时，训练模块应记录使用了哪个损失函数
4. 如果类别权重无法应用，训练模块应记录警告并回退到默认损失函数

### 需求 7: 修复训练 Loss 值获取问题

**用户故事:** 作为数据科学家，我希望在训练过程中看到准确的 loss 值，以便监控训练进度并保存带有正确 loss 信息的检查点。

#### 验收标准

1. 当训练进行中时，训练模块应从训练过程中获取实际的 loss 值
2. 训练模块不应使用硬编码的 0.0 作为 loss 值
3. 当保存检查点时，训练模块应在检查点元数据中包含实际的 loss 值
4. 训练模块应在训练进度输出中显示 loss 值

### 需求 8: 实现血量检测集成到增强机器人

**用户故事:** 作为游戏玩家，我希望增强机器人使用实际的血量检测，以便它能做出更好的生存决策。

#### 验收标准

1. 当增强机器人创建决策上下文时，机器人模块应使用状态检测器的实际血量百分比，而非硬编码的 1.0
2. 机器人模块应与现有的状态检测器组件集成
3. 如果血量检测失败，机器人模块应回退到 1.0 并记录警告
4. 当血量百分比低于紧急阈值时，决策引擎应正确触发紧急规则
