# 实现计划: 业务逻辑修复

## 概述

本计划按优先级修复 MMORPG 游戏 AI 助手项目中的 8 个业务逻辑问题。任务按模块分组，确保每个修复都有对应的测试验证。

## 任务

- [x] 1. 修复屏幕截取模块问题
  - [x] 1.1 添加参数别名支持
    - 修改 `核心/屏幕截取.py` 中的 `截取屏幕` 函数
    - 添加 `region` 参数作为 `区域` 的别名
    - 优先使用 `区域` 参数，如果未提供则使用 `region`
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [x] 1.2 修复 GDI 截取宽高计算
    - 修改 `核心/屏幕截取.py` 中的 `_标准GDI截取` 函数
    - 将 `宽度 = 右 - 左 + 1` 改为 `宽度 = 右 - 左`
    - 将 `高度 = 下 - 上 + 1` 改为 `高度 = 下 - 上`
    - _需求: 3.1, 3.2, 3.3_

  - [x] 1.3 编写屏幕截取属性测试
    - **属性 1: 参数名称等价性**
    - **属性 5: 截取尺寸正确性**
    - **验证: 需求 1.3, 1.4, 3.1, 3.2**

- [x] 2. 修复配置模块问题
  - [x] 2.1 修复动作索引冲突
    - 修改 `配置/设置.py` 中的 `动作定义` 字典
    - 将动作索引 21 的"交互"按键从 "F" 改为 "G"
    - 添加按键冲突检测函数 `检测按键冲突()`
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [x] 2.2 修复配置同步问题
    - 修改 `配置/设置.py` 中的 `更新窗口区域` 函数
    - 在更新游戏宽度/高度后，同步更新 `模型输入宽度` 和 `模型输入高度`
    - _需求: 5.1, 5.2, 5.3_

  - [x] 2.3 编写配置模块属性测试
    - **属性 6: 按键映射唯一性**
    - **属性 7: 模型输入尺寸同步**
    - **验证: 需求 4.1, 5.1, 5.2, 5.3**

- [x] 3. 检查点 - 确保核心模块测试通过
  - 运行屏幕截取和配置模块的测试
  - 如有问题请询问用户

- [x] 4. 修复数据收集模块问题
  - [x] 4.1 修复智能录制数据过滤逻辑
    - 修改 `训练/收集数据.py` 中的主程序循环
    - 在片段评估后，根据 `should_save_segment()` 结果决定是否添加到训练数据
    - 添加临时缓冲区存储当前片段的帧数据
    - 只有当片段应该保存时，才将缓冲区数据添加到训练数据列表
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [x] 4.2 修复过滤统计显示
    - 更新进度显示逻辑，显示准确的过滤和保存计数
    - 在最终报告中显示过滤统计
    - _需求: 2.5_

  - [x] 4.3 编写数据过滤属性测试
    - **属性 2: 过滤逻辑一致性**
    - **属性 3: 过滤模式正确性**
    - **属性 4: 统计准确性**
    - **验证: 需求 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 5. 修复训练模块问题
  - [x] 5.1 修复类别权重应用
    - 修改 `训练/训练模型.py`
    - 确保加权损失函数被传递给模型的 `fit` 方法
    - 添加日志记录使用的损失函数类型
    - _需求: 6.1, 6.2, 6.3, 6.4_

  - [x] 5.2 修复 Loss 值获取
    - 修改 `训练/训练模型.py`
    - 使用 TFLearn 回调机制获取实际 loss 值
    - 更新检查点保存逻辑，包含实际 loss 值
    - _需求: 7.1, 7.2, 7.3, 7.4_

  - [x] 5.3 编写训练模块单元测试
    - 测试类别权重应用
    - 测试 loss 值获取
    - **验证: 需求 6.1, 6.2, 7.2, 7.3**

- [x] 6. 检查点 - 确保训练模块测试通过
  - 运行训练模块的测试
  - 如有问题请询问用户

- [x] 7. 修复增强机器人模块问题
  - [x] 7.1 集成血量检测
    - 修改 `运行/增强机器人.py`
    - 导入并初始化状态检测器
    - 在创建决策上下文时，从状态检测器获取实际血量百分比
    - 添加错误处理，检测失败时回退到 1.0
    - _需求: 8.1, 8.2, 8.3_

  - [x] 7.2 验证紧急规则触发
    - 确保决策引擎在低血量时正确触发紧急规则
    - 添加日志记录紧急规则触发情况
    - _需求: 8.4_

  - [x] 7.3 编写血量检测属性测试
    - **属性 8: 血量检测集成**
    - **属性 9: 紧急规则触发**
    - **验证: 需求 8.1, 8.3, 8.4**

- [x] 8. 最终检查点 - 确保所有测试通过
  - 运行所有测试
  - 如有问题请询问用户

## 注意事项

- 所有任务都是必须执行的，包括测试任务
- 每个任务都引用了具体的需求以便追溯
- 检查点任务用于确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
