# 实现计划: 模型热切换 (Model Hot Swap)

## 概述

实现模型热切换功能，支持在运行时切换不同的 AI 模型，无需重启程序。

## 任务列表

- [x] 1. 实现模型管理器核心
  - [x] 1.1 创建 `核心/模型管理.py` 文件，实现 `模型管理器` 类
    - 模型槽位管理
    - 模型加载和卸载
    - _需求: 1.1, 1.3, 1.5_
  - [x] 1.2 实现 `模型槽位` 数据类
    - 存储模型实例和元数据
    - 内存使用跟踪
    - _需求: 1.4_
  - [x] 1.3 实现配置文件加载
    - 从 JSON/YAML 加载模型配置
    - 配置验证
    - _需求: 1.2, 5.1, 5.2, 5.4_

- [x] 2. 实现运行时切换
  - [x] 2.1 实现线程安全的模型切换
    - 使用锁保护切换过程
    - 确保切换原子性
    - _需求: 2.1, 2.3_
  - [x] 2.2 实现切换性能优化
    - 预加载模型到内存
    - 100ms 内完成切换
    - _需求: 2.2_
  - [x] 2.3 编写属性测试：切换原子性
    - **属性 1: 切换原子性**
    - *对于任意* 模型切换操作，切换过程中不应返回无效预测结果
    - **验证: 需求 2.1, 2.3**

- [x] 3. 实现自动切换规则
  - [x] 3.1 实现 `自动切换规则` 数据类和 `自动切换器` 类
    - 规则定义和匹配
    - 优先级处理
    - _需求: 3.1, 3.2_
  - [x] 3.2 实现冷却时间机制
    - 防止频繁切换
    - 可配置冷却时间
    - _需求: 3.3, 3.4_
  - [x] 3.3 编写属性测试：冷却时间有效性
    - **属性 2: 冷却时间有效性**
    - *对于任意* 自动切换，两次切换间隔应不小于配置的冷却时间
    - **验证: 需求 3.3**

- [x] 4. 实现快捷键集成
  - [x] 4.1 实现 `快捷键处理器` 类
    - 快捷键注册和处理
    - 循环切换功能
    - _需求: 4.1, 4.3_
  - [x] 4.2 实现切换反馈
    - 显示当前活动模型名称
    - 状态输出集成
    - _需求: 4.2, 4.4_

- [x] 5. 实现配置热重载
  - [x] 5.1 实现配置重新加载功能
    - 不重启更新配置
    - 验证新配置
    - _需求: 5.3_
  - [x] 5.2 实现切换事件日志
    - 记录所有切换事件
    - 包含触发方式和原因
    - _需求: 2.4_

- [x] 6. 集成到决策引擎
  - [x] 6.1 修改 `核心/决策引擎.py`，集成模型管理器
    - 替换单一模型为模型管理器
    - 添加自动切换检查
    - _需求: 2.1, 3.2_
  - [x] 6.2 添加快捷键监听
    - 集成到主循环
    - _需求: 4.1_

- [x] 7. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 验证切换速度和稳定性
  - 如有问题请询问用户

## 备注

- 所有任务已完成
- 默认冷却时间 5 秒
- 快捷键默认 F1-F4
- 已实现的核心组件:
  - `模型管理器` - 多模型加载、切换、内存管理
  - `自动切换器` - 基于游戏状态的自动切换规则
  - `快捷键处理器` - 快捷键注册和循环切换
  - `切换反馈管理器` - 切换反馈和状态输出
  - `切换事件日志管理器` - 切换事件记录和导出
- 已实现的测试:
  - `test_切换原子性属性.py` - 属性测试：切换原子性
  - `test_冷却时间有效性属性.py` - 属性测试：冷却时间有效性
  - `test_切换事件日志.py` - 单元测试：切换事件日志功能
