# 实现计划: 断点续训 (Checkpoint Resume Training)

## 概述

实现训练检查点保存和恢复功能，支持训练中断后从上次中断处继续训练。

## 任务列表

- [x] 1. 创建检查点管理器核心类
  - [x] 1.1 创建 `工具/检查点管理.py` 文件，实现 `检查点管理器` 类
    - 实现 `__init__` 方法，接受保存目录和最大检查点数参数
    - 实现目录创建和初始化逻辑
    - _需求: 1.3_
  - [x] 1.2 实现 `训练状态` 和 `检查点元数据` 数据类
    - 定义所有必需字段（模型权重、优化器状态、epoch、batch、loss等）
    - _需求: 1.2, 3.1_
  - [x] 1.3 编写属性测试：检查点完整性往返

    - **属性 1: 检查点保存完整性**
    - *对于任意* 训练状态，保存后加载应得到等价的状态
    - **验证: 需求 1.2, 2.3, 3.1**

- [x] 2. 实现检查点保存功能
  - [x] 2.1 实现 `保存检查点` 方法
    - 保存模型权重、优化器状态、训练进度
    - 生成带时间戳的文件名
    - 更新 latest 符号链接
    - _需求: 1.1, 1.2, 1.5_
  - [x] 2.2 实现 `删除旧检查点` 方法
    - 按时间排序检查点
    - 删除超出数量限制的旧检查点
    - _需求: 1.4_
  - [x] 2.3 编写属性测试：检查点数量限制

    - **属性 2: 检查点数量限制**
    - *对于任意* 保存操作序列，检查点数量应不超过配置的最大值
    - **验证: 需求 1.4**

- [x] 3. 实现检查点加载功能
  - [x] 3.1 实现 `列出检查点` 方法
    - 扫描目录获取所有检查点文件
    - 解析并返回元数据列表
    - _需求: 2.1, 3.2_
  - [x] 3.2 实现 `加载检查点` 方法
    - 支持加载指定路径或最新检查点
    - 支持按 epoch 或时间戳加载
    - 验证检查点完整性
    - _需求: 2.2, 2.3, 3.3_
  - [x] 3.3 编写属性测试：默认加载最新检查点

    - **属性 3: 默认加载最新**
    - *对于任意* 多个检查点，默认加载应返回最新的检查点
    - **验证: 需求 2.2**

- [x] 4. 实现错误处理和恢复连续性
  - [x] 4.1 实现检查点损坏检测和处理
    - 验证检查点文件完整性
    - 损坏时返回错误并建议使用更早检查点
    - _需求: 2.4_
  - [x] 4.2 实现训练恢复连续性
    - 确保恢复后从正确的 batch 继续
    - _需求: 2.5_
  - [x] 4.3 编写属性测试：恢复训练连续性

    - **属性 4: 恢复训练连续性**
    - *对于任意* 检查点恢复，恢复后的 batch 应紧接中断时的 batch
    - **验证: 需求 2.5**

- [x] 5. 集成到训练流程
  - [x] 5.1 修改 `训练/训练模型.py`，集成检查点管理器
    - 在训练循环中添加检查点保存调用
    - 添加启动时检查点检测逻辑
    - _需求: 1.1, 4.1_
  - [x] 5.2 实现自动恢复提示
    - 检测现有检查点
    - 提示用户选择恢复或重新开始
    - _需求: 4.1, 4.2, 4.3_

- [x] 6. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 如有问题请询问用户

## 备注

- 带 `*` 标记的任务为可选测试任务，可跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 属性测试验证核心正确性属性
