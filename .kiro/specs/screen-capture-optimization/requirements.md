# 需求文档

## 简介

屏幕截取优化功能，将当前基于 GDI 的截图方式升级为 DXGI Desktop Duplication API，提升截图速度和效率，降低 CPU 占用。

## 术语表

- **屏幕截取器**: 负责捕获游戏画面的模块
- **DXGI 截取器**: 基于 DXGI Desktop Duplication 的截取器
- **GDI 截取器**: 基于 GDI 的传统截取器（当前实现）
- **帧缓冲区**: 存储截取图像数据的缓冲区

## 需求列表

### 需求 1: DXGI 截取实现

**用户故事:** 作为开发者，我希望使用 DXGI Desktop Duplication 进行屏幕截取，以便实现更高的截取速度。

#### 验收标准

1. DXGI 截取器应使用 Windows Desktop Duplication API 进行屏幕截取
2. 当游戏运行时，DXGI 截取器应以 60+ FPS 的速度截取帧
3. DXGI 截取器应返回与当前 GDI 实现相同格式的图像（numpy 数组，RGB）
4. DXGI 截取器应支持截取屏幕的特定区域

### 需求 2: 自动后端选择

**用户故事:** 作为开发者，我希望系统自动选择最佳截取方法，以便在所有系统上都能工作。

#### 验收标准

1. 屏幕截取器应检测当前系统是否支持 DXGI
2. 如果 DXGI 可用，屏幕截取器应默认使用 DXGI 截取器
3. 如果 DXGI 不可用，屏幕截取器应回退到 GDI 截取器
4. 屏幕截取器应记录正在使用的截取后端

### 需求 3: 性能优化

**用户故事:** 作为开发者，我希望截取过程中优化内存使用，以便系统高效运行。

#### 验收标准

1. DXGI 截取器应重用帧缓冲区以最小化内存分配
2. DXGI 截取器应在可能时支持零拷贝访问帧数据
3. DXGI 截取器应在不使用时正确释放 GPU 资源
4. 屏幕截取器应提供性能指标（截取时间、内存使用）

### 需求 4: 错误恢复

**用户故事:** 作为开发者，我希望截取系统能从错误中恢复，以便 AI 继续运行。

#### 验收标准

1. 如果 DXGI 截取失败，屏幕截取器应尝试重新初始化截取会话
2. 如果重新初始化失败，屏幕截取器应回退到 GDI 截取
3. 屏幕截取器应记录截取错误及诊断信息
4. 屏幕截取器应优雅地处理显示模式变化（分辨率、刷新率）

### 需求 5: 向后兼容

**用户故事:** 作为用户，我希望新的截取系统能与现有代码兼容，以便无需修改脚本。

#### 验收标准

1. 屏幕截取器应提供与当前 截取屏幕 函数相同的 API
2. 屏幕截取器应支持相同的区域参数格式（左, 上, 右, 下）
3. 屏幕截取器应返回相同格式的图像（numpy 数组，RGB）
4. 屏幕截取器应是当前实现的直接替代品
