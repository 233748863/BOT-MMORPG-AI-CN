# 实现计划: 屏幕截取优化 (Screen Capture Optimization)

## 概述

实现屏幕截取优化功能，使用 DXGI Desktop Duplication API 替代传统 GDI 截图。

## 任务列表

- [ ] 1. 实现后端检测器
  - [ ] 1.1 创建 `核心/屏幕截取优化.py` 文件，实现 `后端检测器` 类
    - 检测 DXGI 可用性
    - 获取系统图形信息
    - _需求: 2.1_
  - [ ] 1.2 实现最佳后端选择逻辑
    - 根据系统能力选择后端
    - _需求: 2.2, 2.3_

- [ ] 2. 实现 DXGI 截取器
  - [ ] 2.1 实现 `DXGI截取器` 类核心功能
    - Desktop Duplication API 初始化
    - 帧获取和复制
    - _需求: 1.1, 1.2_
  - [ ] 2.2 实现区域截取和格式转换
    - 支持指定区域截取
    - 转换为 RGB numpy 数组
    - _需求: 1.3, 1.4_
  - [ ] 2.3 实现资源管理
    - 帧缓冲区重用
    - GPU 资源释放
    - _需求: 3.1, 3.2, 3.3_

- [ ] 3. 实现统一截取器接口
  - [ ] 3.1 实现 `屏幕截取器` 类
    - 统一的截取接口
    - 自动后端选择
    - _需求: 5.1, 5.2, 5.3_
  - [ ] 3.2 实现性能统计
    - 截取时间统计
    - 失败和恢复计数
    - _需求: 3.4_
  - [ ]* 3.3 编写属性测试：输出格式一致性
    - **属性 1: 输出格式一致性**
    - *对于任意* 截取请求，DXGI 和 GDI 后端应返回相同格式的图像
    - **验证: 需求 1.3, 5.3**

- [ ] 4. 实现错误恢复
  - [ ] 4.1 实现 DXGI 重新初始化
    - 截取失败时重新初始化
    - 显示模式变化处理
    - _需求: 4.1, 4.4_
  - [ ] 4.2 实现 GDI 回退机制
    - DXGI 不可用时回退
    - 记录错误和诊断信息
    - _需求: 4.2, 4.3_
  - [ ]* 4.3 编写属性测试：错误恢复能力
    - **属性 2: 错误恢复能力**
    - *对于任意* DXGI 截取失败，系统应能自动恢复或回退到 GDI
    - **验证: 需求 4.1, 4.2**

- [ ] 5. 实现 GDI 截取器（保留）
  - [ ] 5.1 重构现有 GDI 截取代码为 `GDI截取器` 类
    - 保持现有功能
    - 统一接口
    - _需求: 2.3, 5.4_

- [ ] 6. 集成到现有代码
  - [ ] 6.1 修改 `核心/屏幕截取.py`，使用新的截取器
    - 替换现有截取函数
    - 保持 API 兼容
    - _需求: 5.1, 5.4_
  - [ ] 6.2 添加截取配置
    - 后端选择配置
    - 性能监控开关
    - _需求: 2.4_

- [ ] 7. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 验证截取速度提升
  - 如有问题请询问用户

## 备注

- 带 `*` 标记的任务为可选测试任务
- 需要安装 d3dshot 或 dxcam 库
- DXGI 仅在 Windows 8+ 可用
