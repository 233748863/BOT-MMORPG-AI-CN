"""
цибхЮЛшонч╗ГшДЪцЬм
чФиф║Ошонч╗Гц╕╕цИПAIцибхЮЛ

ф╜┐чФицЦ╣ц│Х:
1. чбоф┐Эх╖▓цФ╢щЫЖш╢│хдЯчЪДшонч╗ГцХ░цНо
2. ш┐РшбМцндшДЪцЬм
3. щАЙцЛйшонч╗Гцибх╝П
4. чнЙх╛Ешонч╗ГхоМцИР
"""

import numpy as np
import cv2
import os
import sys
from random import shuffle

# ц╖╗хКащб╣чЫоца╣чЫох╜ХхИ░ш╖пх╛Д
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from ца╕х┐Г.цибхЮЛхоЪф╣Й import inception_v3
from щЕНч╜о.шо╛ч╜о import (
    цибхЮЛш╛УхЕехо╜х║ж, цибхЮЛш╛УхЕещлШх║ж, хнжф╣ачОЗ,
    шонч╗Гш╜оцХ░, цибхЮЛф┐ЭхнШш╖пх╛Д, цХ░цНоф┐ЭхнШш╖пх╛Д, цА╗хКиф╜ЬцХ░
)
from х╖ехЕ╖.цгАцЯечВ╣чобчРЖ import цгАцЯечВ╣чобчРЖхЩи, цПРчд║цБвхдНшонч╗Г, цШ╛чд║цгАцЯечВ╣хИЧшби

# цгАцЯечВ╣щЕНч╜о
цгАцЯечВ╣чЫох╜Х = os.path.join(os.path.dirname(цибхЮЛф┐ЭхнШш╖пх╛Д), "checkpoints")
цгАцЯечВ╣ф┐ЭхнШщЧ┤щЪФ = 5  # цпПхдДчРЖNф╕кцЦЗф╗╢ф┐ЭхнШф╕АцмбцгАцЯечВ╣
цЬАхдзцгАцЯечВ╣цХ░щЗП = 5  # ф┐ЭчХЩчЪДцЬАхдзцгАцЯечВ╣цХ░щЗП


def шО╖хПЦцХ░цНоцЦЗф╗╢хИЧшби(цХ░цНочЫох╜Х):
    """
    шО╖хПЦцЙАцЬЙшонч╗ГцХ░цНоцЦЗф╗╢
    
    хПВцХ░:
        цХ░цНочЫох╜Х: цХ░цНоцЦЗф╗╢чЫох╜Х
    
    ш┐ФхЫЮ:
        list: цХ░цНоцЦЗф╗╢ш╖пх╛ДхИЧшби
    """
    цЦЗф╗╢хИЧшби = []
    
    if not os.path.exists(цХ░цНочЫох╜Х):
        print(f"тЭМ цХ░цНочЫох╜Хф╕НхнШхЬи: {цХ░цНочЫох╜Х}")
        return цЦЗф╗╢хИЧшби
    
    for цЦЗф╗╢хРН in os.listdir(цХ░цНочЫох╜Х):
        if цЦЗф╗╢хРН.endswith('.npy') and 'шонч╗ГцХ░цНо' in цЦЗф╗╢хРН:
            цЦЗф╗╢хИЧшби.append(os.path.join(цХ░цНочЫох╜Х, цЦЗф╗╢хРН))
    
    цЦЗф╗╢хИЧшби.sort()
    return цЦЗф╗╢хИЧшби


def хКаш╜╜шонч╗ГцХ░цНо(цЦЗф╗╢ш╖пх╛Д):
    """
    хКаш╜╜хНХф╕кшонч╗ГцХ░цНоцЦЗф╗╢
    
    хПВцХ░:
        цЦЗф╗╢ш╖пх╛Д: цХ░цНоцЦЗф╗╢ш╖пх╛Д
    
    ш┐ФхЫЮ:
        tuple: (шонч╗ГцХ░цНо, ц╡ЛшпХцХ░цНо)
    """
    try:
        цХ░цНо = np.load(цЦЗф╗╢ш╖пх╛Д, allow_pickle=True)
        
        # хИЖхЙ▓шонч╗ГщЫЖхТМц╡ЛшпХщЫЖ (цЬАхРО50ф╕кца╖цЬмф╜Ьф╕║ц╡ЛшпХ)
        шонч╗ГцХ░цНо = цХ░цНо[:-50]
        ц╡ЛшпХцХ░цНо = цХ░цНо[-50:]
        
        return шонч╗ГцХ░цНо, ц╡ЛшпХцХ░цНо
    
    except Exception as e:
        print(f"тЭМ хКаш╜╜цХ░цНохд▒ш┤е {цЦЗф╗╢ш╖пх╛Д}: {e}")
        return None, None


def хЗЖхдЗцЙ╣цмбцХ░цНо(цХ░цНо, хо╜х║ж, щлШх║ж):
    """
    хЗЖхдЗцибхЮЛшонч╗ГчЪДцЙ╣цмбцХ░цНо
    
    хПВцХ░:
        цХ░цНо: хОЯхзЛцХ░цНо
        хо╜х║ж: хЫ╛хГПхо╜х║ж
        щлШх║ж: хЫ╛хГПщлШх║ж
    
    ш┐ФхЫЮ:
        tuple: (X, Y) шонч╗ГцХ░цНо
    """
    # цПРхПЦхЫ╛хГП
    XхЫ╛хГП = np.array([ца╖цЬм[0] for ца╖цЬм in цХ░цНо])
    X = XхЫ╛хГП.reshape(-1, хо╜х║ж, щлШх║ж, 3)
    
    # цПРхПЦцаЗчн╛
    Y = [ца╖цЬм[1] for ца╖цЬм in цХ░цНо]
    
    return X, Y


def цШ╛чд║шонч╗ГшПЬхНХ():
    """цШ╛чд║шонч╗ГщЕНч╜ошПЬхНХ"""
    print("\n" + "=" * 50)
    print("ЁЯдЦ MMORPGц╕╕цИПAI - цибхЮЛшонч╗Гх╖ехЕ╖")
    print("=" * 50)
    print("\nх╜УхЙНщЕНч╜о:")
    print(f"  - ш╛УхЕех░║хп╕: {цибхЮЛш╛УхЕехо╜х║ж} x {цибхЮЛш╛УхЕещлШх║ж}")
    print(f"  - хнжф╣ачОЗ: {хнжф╣ачОЗ}")
    print(f"  - шонч╗Гш╜оцХ░: {шонч╗Гш╜оцХ░}")
    print(f"  - хКиф╜Ьч▒╗хИл: {цА╗хКиф╜ЬцХ░}")
    print(f"  - цибхЮЛф┐ЭхнШ: {цибхЮЛф┐ЭхнШш╖пх╛Д}")
    print()


def ф╕╗чиЛх║П():
    """ф╕╗шонч╗ГчиЛх║П"""
    
    цШ╛чд║шонч╗ГшПЬхНХ()
    
    # шО╖хПЦцХ░цНоцЦЗф╗╢
    цХ░цНоцЦЗф╗╢хИЧшби = шО╖хПЦцХ░цНоцЦЗф╗╢хИЧшби(цХ░цНоф┐ЭхнШш╖пх╛Д)
    
    if not цХ░цНоцЦЗф╗╢хИЧшби:
        print("тЭМ цЬкцЙ╛хИ░шонч╗ГцХ░цНоцЦЗф╗╢!")
        print(f"   шп╖хЕИш┐РшбМ 'цФ╢щЫЖцХ░цНо.py' цФ╢щЫЖшонч╗ГцХ░цНо")
        print(f"   цХ░цНох║Фф┐ЭхнШхЬи: {цХ░цНоф┐ЭхнШш╖пх╛Д}")
        return
    
    print(f"ЁЯУБ цЙ╛хИ░ {len(цХ░цНоцЦЗф╗╢хИЧшби)} ф╕кцХ░цНоцЦЗф╗╢")
    
    # хИЭхзЛхМЦцгАцЯечВ╣чобчРЖхЩи
    цгАцЯечВ╣чобчРЖ = цгАцЯечВ╣чобчРЖхЩи(цгАцЯечВ╣чЫох╜Х, цЬАхдзцгАцЯечВ╣цХ░щЗП)
    
    # хИЭхзЛхМЦшонч╗ГчК╢цАБ
    ш╡╖хзЛш╜оцмб = 0
    ш╡╖хзЛцЦЗф╗╢ч┤вх╝Х = 0
    х╜УхЙНloss = 0.0
    
    # цгАцЯецШпхРжцЬЙцгАцЯечВ╣хПпф╗ецБвхдН
    if цПРчд║цБвхдНшонч╗Г(цгАцЯечВ╣чобчРЖ):
        цгАцЯечВ╣цХ░цНо = цгАцЯечВ╣чобчРЖ.хКаш╜╜цгАцЯечВ╣()
        if цгАцЯечВ╣цХ░цНо:
            шонч╗Гш┐Ых║ж = цгАцЯечВ╣цХ░цНо.get('шонч╗Гш┐Ых║ж', {})
            ш╡╖хзЛш╜оцмб = шонч╗Гш┐Ых║ж.get('х╜УхЙНepoch', 0)
            ш╡╖хзЛцЦЗф╗╢ч┤вх╝Х = шонч╗Гш┐Ых║ж.get('х╜УхЙНbatch', 0)
            х╜УхЙНloss = цгАцЯечВ╣цХ░цНо.get('цМЗцаЗ', {}).get('loss', 0.0)
            print(f"тЬЕ х░Жф╗О Epoch {ш╡╖хзЛш╜оцмб + 1}, цЦЗф╗╢ {ш╡╖хзЛцЦЗф╗╢ч┤вх╝Х + 1} ч╗зч╗ншонч╗Г")
    
    # шпвщЧоцШпхРжч╗зч╗н
    чбошод = input("\nцШпхРжх╝АхзЛшонч╗Г? (y/n): ").strip().lower()
    if чбошод != 'y':
        print("х╖▓хПЦц╢Ишонч╗Г")
        return
    
    # чбоф┐ЭцибхЮЛчЫох╜ХхнШхЬи
    цибхЮЛчЫох╜Х = os.path.dirname(цибхЮЛф┐ЭхнШш╖пх╛Д)
    if цибхЮЛчЫох╜Х:
        os.makedirs(цибхЮЛчЫох╜Х, exist_ok=True)
    
    # хИЫх╗║цибхЮЛ
    print("\nЁЯПЧя╕П  хИЫх╗║цибхЮЛ...")
    цибхЮЛ = inception_v3(
        цибхЮЛш╛УхЕехо╜х║ж, 
        цибхЮЛш╛УхЕещлШх║ж, 
        3, 
        хнжф╣ачОЗ, 
        ш╛УхЗ║ч▒╗хИл=цА╗хКиф╜ЬцХ░, 
        цибхЮЛхРНчз░=цибхЮЛф┐ЭхнШш╖пх╛Д
    )
    
    # цгАцЯецШпхРжцЬЙх╖▓ф┐ЭхнШчЪДцибхЮЛ
    if os.path.exists(цибхЮЛф┐ЭхнШш╖пх╛Д + '.index'):
        хКаш╜╜щАЙцЛй = input("\nхПСчО░х╖▓ф┐ЭхнШчЪДцибхЮЛя╝МцШпхРжхКаш╜╜? (y/n): ").strip().lower()
        if хКаш╜╜щАЙцЛй == 'y':
            try:
                цибхЮЛ.load(цибхЮЛф┐ЭхнШш╖пх╛Д)
                print("тЬЕ х╖▓хКаш╜╜ф╣ЛхЙНчЪДцибхЮЛ")
            except Exception as e:
                print(f"тЪая╕П  хКаш╜╜цибхЮЛхд▒ш┤е: {e}")
                print("   х░Жф╗Охд┤х╝АхзЛшонч╗Г")
    
    print("\nЁЯЪА х╝АхзЛшонч╗Г...")
    print("-" * 50)
    
    # шонч╗Гх╛кчОп
    for ш╜оцмб in range(ш╡╖хзЛш╜оцмб, шонч╗Гш╜оцХ░):
        print(f"\nЁЯУК шонч╗Гш╜оцмб {ш╜оцмб + 1}/{шонч╗Гш╜оцХ░}")
        
        # щЪПцЬ║цЙУф╣▒цХ░цНоцЦЗф╗╢щб║х║Пя╝Иф╜┐чФихЫ║хоЪчзНхнРф┐ЭшпБхПпщЗНхдНцАзя╝Й
        цХ░цНощб║х║П = list(range(len(цХ░цНоцЦЗф╗╢хИЧшби)))
        shuffle(цХ░цНощб║х║П)
        
        # чбохоЪш╡╖хзЛцЦЗф╗╢ч┤вх╝Х
        цЦЗф╗╢ш╡╖хзЛ = ш╡╖хзЛцЦЗф╗╢ч┤вх╝Х if ш╜оцмб == ш╡╖хзЛш╜оцмб else 0
        
        for шобцХ░ in range(цЦЗф╗╢ш╡╖хзЛ, len(цХ░цНощб║х║П)):
            ч┤вх╝Х = цХ░цНощб║х║П[шобцХ░]
            цЦЗф╗╢ш╖пх╛Д = цХ░цНоцЦЗф╗╢хИЧшби[ч┤вх╝Х]
            
            try:
                print(f"   хдДчРЖцЦЗф╗╢ {шобцХ░ + 1}/{len(цХ░цНоцЦЗф╗╢хИЧшби)}: {os.path.basename(цЦЗф╗╢ш╖пх╛Д)}")
                
                # хКаш╜╜цХ░цНо
                шонч╗ГцХ░цНо, ц╡ЛшпХцХ░цНо = хКаш╜╜шонч╗ГцХ░цНо(цЦЗф╗╢ш╖пх╛Д)
                
                if шонч╗ГцХ░цНо is None:
                    continue
                
                # хЗЖхдЗцЙ╣цмбцХ░цНо
                Xшонч╗Г, Yшонч╗Г = хЗЖхдЗцЙ╣цмбцХ░цНо(шонч╗ГцХ░цНо, цибхЮЛш╛УхЕехо╜х║ж, цибхЮЛш╛УхЕещлШх║ж)
                Xц╡ЛшпХ, Yц╡ЛшпХ = хЗЖхдЗцЙ╣цмбцХ░цНо(ц╡ЛшпХцХ░цНо, цибхЮЛш╛УхЕехо╜х║ж, цибхЮЛш╛УхЕещлШх║ж)
                
                # шонч╗ГцибхЮЛ
                цибхЮЛ.fit(
                    {'input': Xшонч╗Г},
                    {'targets': Yшонч╗Г},
                    n_epoch=1,
                    validation_set=({'input': Xц╡ЛшпХ}, {'targets': Yц╡ЛшпХ}),
                    snapshot_step=2500,
                    show_metric=True,
                    run_id=цибхЮЛф┐ЭхнШш╖пх╛Д
                )
                
                # цЫ┤цЦ░х╜УхЙНlossя╝ИчоАхМЦхдДчРЖя╝МхоЮщЩЕх║Фф╗Ошонч╗ГхЫЮш░ГшО╖хПЦя╝Й
                х╜УхЙНloss = 0.0  # TODO: ф╗Ошонч╗Гш┐ЗчиЛшО╖хПЦхоЮщЩЕloss
                
                # хоЪцЬЯф┐ЭхнШцгАцЯечВ╣
                if (шобцХ░ + 1) % цгАцЯечВ╣ф┐ЭхнШщЧ┤щЪФ == 0:
                    print(f"\nЁЯТ╛ ф┐ЭхнШцгАцЯечВ╣...")
                    цгАцЯечВ╣чобчРЖ.ф┐ЭхнШцгАцЯечВ╣(
                        цибхЮЛ=цибхЮЛ,
                        ф╝ШхМЦхЩичК╢цАБ={},  # TFLearn ф╕НчЫ┤цОецЪ┤щЬ▓ф╝ШхМЦхЩичК╢цАБ
                        х╜УхЙНepoch=ш╜оцмб,
                        х╜УхЙНbatch=шобцХ░ + 1,
                        lossхА╝=х╜УхЙНloss
                    )
                    цибхЮЛ.save(цибхЮЛф┐ЭхнШш╖пх╛Д)
                
            except KeyboardInterrupt:
                print("\n\nтЪая╕П  шонч╗Гшвлф╕нцЦн!")
                print("ЁЯТ╛ цнгхЬиф┐ЭхнШцгАцЯечВ╣...")
                цгАцЯечВ╣чобчРЖ.ф┐ЭхнШцгАцЯечВ╣(
                    цибхЮЛ=цибхЮЛ,
                    ф╝ШхМЦхЩичК╢цАБ={},
                    х╜УхЙНepoch=ш╜оцмб,
                    х╜УхЙНbatch=шобцХ░,
                    lossхА╝=х╜УхЙНloss
                )
                цибхЮЛ.save(цибхЮЛф┐ЭхнШш╖пх╛Д)
                print("тЬЕ цгАцЯечВ╣х╖▓ф┐ЭхнШя╝Мф╕ЛцмбхПпф╗еч╗зч╗ншонч╗Г")
                return
                
            except Exception as e:
                print(f"   тЭМ хдДчРЖцЦЗф╗╢цЧ╢хЗ║щФЩ: {e}")
                continue
        
        # цпПш╜оч╗УцЭЯф┐ЭхнШцгАцЯечВ╣
        print(f"\nЁЯТ╛ ф┐ЭхнШш╜оцмб {ш╜оцмб + 1} чЪДцгАцЯечВ╣...")
        цгАцЯечВ╣чобчРЖ.ф┐ЭхнШцгАцЯечВ╣(
            цибхЮЛ=цибхЮЛ,
            ф╝ШхМЦхЩичК╢цАБ={},
            х╜УхЙНepoch=ш╜оцмб + 1,
            х╜УхЙНbatch=0,
            lossхА╝=х╜УхЙНloss
        )
        цибхЮЛ.save(цибхЮЛф┐ЭхнШш╖пх╛Д)
    
    print("\n" + "=" * 50)
    print("тЬЕ шонч╗ГхоМцИР!")
    print(f"ЁЯУБ цибхЮЛх╖▓ф┐ЭхнШхИ░: {цибхЮЛф┐ЭхнШш╖пх╛Д}")
    print("=" * 50)
    
    # цШ╛чд║цгАцЯечВ╣ф┐бцБп
    print("\nЁЯУЛ цгАцЯечВ╣шо░х╜Х:")
    цШ╛чд║цгАцЯечВ╣хИЧшби(цгАцЯечВ╣чобчРЖ)
    
    print("\nф╕Лф╕Ацне:")
    print("  ш┐РшбМ 'ш┐РшбМ/ш┐РшбМцЬ║хЩиф║║.py' ц╡ЛшпХшонч╗Гхе╜чЪДцибхЮЛ")


if __name__ == "__main__":
    ф╕╗чиЛх║П()
