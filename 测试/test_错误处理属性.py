"""
错误处理属性测试

测试血量/蓝量检测的错误处理功能：
- 检测失败时返回上次有效值（需求 6.1）
- 超时返回满血/满蓝（需求 6.2）
- 日志和诊断功能（需求 6.3）

**验证: 需求 6.1, 6.2, 6.3**
"""

import pytest
import numpy as np
import time
from hypothesis import given, strategies as st, settings

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from 核心.状态检测 import 血量检测器, 蓝量检测器, 状态检测器


class Test检测失败处理:
    """测试检测失败时返回上次有效值（需求 6.1）"""
    
    def test_血量检测失败返回上次有效值(self):
        """血量检测失败时应返回上次有效值"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20)})
        
        # 创建有效图像并检测
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [0, 0, 255]  # 红色填充 50%
        
        第一次结果 = 检测器.检测(有效图像)
        
        # 使用无效图像检测
        无效图像 = np.array([], dtype=np.uint8)
        第二次结果 = 检测器.检测(无效图像)
        
        # 应该返回上次有效值
        assert 第二次结果 == 第一次结果
    
    def test_蓝量检测失败返回上次有效值(self):
        """蓝量检测失败时应返回上次有效值"""
        检测器 = 蓝量检测器({"区域": (0, 0, 100, 20)})
        
        # 创建有效图像并检测
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [255, 0, 0]  # 蓝色填充 50%
        
        第一次结果 = 检测器.检测(有效图像)
        
        # 使用无效图像检测
        无效图像 = np.array([], dtype=np.uint8)
        第二次结果 = 检测器.检测(无效图像)
        
        # 应该返回上次有效值
        assert 第二次结果 == 第一次结果
    
    def test_None图像返回上次有效值(self):
        """None 图像应返回上次有效值"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20)})
        
        # 创建有效图像并检测
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [0, 0, 255]
        
        第一次结果 = 检测器.检测(有效图像)
        第二次结果 = 检测器.检测(None)
        
        assert 第二次结果 == 第一次结果


class Test超时返回满血:
    """测试连续失败超时返回满血/满蓝（需求 6.2）"""
    
    def test_血量检测超时返回满血(self):
        """血量检测连续失败超过超时时间应返回满血"""
        # 设置很短的超时时间便于测试
        检测器 = 血量检测器({"区域": (0, 0, 100, 20), "失败超时": 0.1})
        
        # 创建有效图像并检测一次
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:30] = [0, 0, 255]  # 红色填充 30%
        检测器.检测(有效图像)
        
        # 连续使用无效图像检测
        无效图像 = np.array([], dtype=np.uint8)
        
        # 第一次失败，返回上次有效值
        结果1 = 检测器.检测(无效图像)
        
        # 等待超过超时时间
        time.sleep(0.15)
        
        # 超时后应返回满血
        结果2 = 检测器.检测(无效图像)
        assert 结果2 == 1.0
    
    def test_蓝量检测超时返回满蓝(self):
        """蓝量检测连续失败超过超时时间应返回满蓝"""
        检测器 = 蓝量检测器({"区域": (0, 0, 100, 20), "失败超时": 0.1})
        
        # 创建有效图像并检测一次
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:30] = [255, 0, 0]  # 蓝色填充 30%
        检测器.检测(有效图像)
        
        # 连续使用无效图像检测
        无效图像 = np.array([], dtype=np.uint8)
        检测器.检测(无效图像)
        
        # 等待超过超时时间
        time.sleep(0.15)
        
        # 超时后应返回满蓝
        结果 = 检测器.检测(无效图像)
        assert 结果 == 1.0
    
    def test_成功检测重置超时计时器(self):
        """成功检测应重置超时计时器"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20), "失败超时": 0.2})
        
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [0, 0, 255]
        
        无效图像 = np.array([], dtype=np.uint8)
        
        # 失败一次
        检测器.检测(无效图像)
        time.sleep(0.1)
        
        # 成功检测，重置计时器
        检测器.检测(有效图像)
        
        # 再次失败
        检测器.检测(无效图像)
        time.sleep(0.1)
        
        # 还没超时，应返回上次有效值而不是满血
        结果 = 检测器.检测(无效图像)
        # 由于成功检测重置了计时器，此时还没超时
        assert 结果 != 1.0 or 检测器._首次失败时间 is not None


class Test诊断功能:
    """测试日志和诊断功能（需求 6.3）"""
    
    def test_血量检测器获取检测统计(self):
        """血量检测器应能获取检测统计"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20)})
        
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [0, 0, 255]
        
        # 执行几次检测
        检测器.检测(有效图像)
        检测器.检测(有效图像)
        检测器.检测(np.array([], dtype=np.uint8))  # 失败
        
        统计 = 检测器.获取检测统计()
        
        assert "总检测次数" in 统计
        assert "成功次数" in 统计
        assert "失败次数" in 统计
        assert "成功率" in 统计
        assert 统计["总检测次数"] == 3
        assert 统计["成功次数"] == 2
        assert 统计["失败次数"] == 1
    
    def test_血量检测器获取诊断信息(self):
        """血量检测器应能获取诊断信息"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20)})
        
        诊断 = 检测器.获取诊断信息()
        
        assert "区域配置" in 诊断
        assert "当前值" in 诊断
        assert "上次有效值" in 诊断
        assert "置信度" in 诊断
        assert "连续失败次数" in 诊断
        assert "失败超时设置" in 诊断
        assert "检测统计" in 诊断
    
    def test_蓝量检测器获取检测统计(self):
        """蓝量检测器应能获取检测统计"""
        检测器 = 蓝量检测器({"区域": (0, 0, 100, 20)})
        
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [255, 0, 0]
        
        检测器.检测(有效图像)
        检测器.检测(有效图像)
        
        统计 = 检测器.获取检测统计()
        
        assert 统计["总检测次数"] == 2
        assert 统计["成功次数"] == 2
    
    def test_状态检测器获取诊断信息(self):
        """状态检测器应能获取完整诊断信息"""
        检测器 = 状态检测器({
            "血条": {"区域": (0, 0, 100, 20)},
            "蓝条": {"区域": (0, 25, 100, 15)}
        })
        
        诊断 = 检测器.获取诊断信息()
        
        assert "总检测次数" in 诊断
        assert "血量检测器" in 诊断
        assert "蓝量检测器" in 诊断
    
    def test_状态检测器获取检测统计(self):
        """状态检测器应能获取检测统计汇总"""
        检测器 = 状态检测器({
            "血条": {"区域": (0, 0, 100, 20)},
            "蓝条": {"区域": (0, 25, 100, 15)}
        })
        
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        检测器.检测(有效图像)
        
        统计 = 检测器.获取检测统计()
        
        assert "总检测次数" in 统计
        assert "血量检测" in 统计
        assert "蓝量检测" in 统计
        assert "总成功率" in 统计


class Test设置失败超时:
    """测试设置失败超时功能"""
    
    def test_血量检测器设置失败超时(self):
        """血量检测器应能设置失败超时"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20)})
        
        检测器.设置失败超时(10.0)
        
        assert 检测器._失败超时 == 10.0
    
    def test_蓝量检测器设置失败超时(self):
        """蓝量检测器应能设置失败超时"""
        检测器 = 蓝量检测器({"区域": (0, 0, 100, 20)})
        
        检测器.设置失败超时(10.0)
        
        assert 检测器._失败超时 == 10.0
    
    def test_状态检测器设置失败超时(self):
        """状态检测器应能同时设置血量和蓝量检测器的失败超时"""
        检测器 = 状态检测器({
            "血条": {"区域": (0, 0, 100, 20)},
            "蓝条": {"区域": (0, 25, 100, 15)}
        })
        
        检测器.设置失败超时(10.0)
        
        assert 检测器._血量检测器._失败超时 == 10.0
        assert 检测器._蓝量检测器._失败超时 == 10.0


class Test重置功能:
    """测试重置功能"""
    
    def test_血量检测器重置清空统计(self):
        """血量检测器重置应清空统计"""
        检测器 = 血量检测器({"区域": (0, 0, 100, 20)})
        
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        有效图像[0:20, 0:50] = [0, 0, 255]
        
        检测器.检测(有效图像)
        检测器.检测(有效图像)
        
        检测器.重置()
        
        统计 = 检测器.获取检测统计()
        assert 统计["总检测次数"] == 0
        assert 统计["成功次数"] == 0
        assert 统计["失败次数"] == 0
    
    def test_状态检测器重置(self):
        """状态检测器重置应重置所有子检测器"""
        检测器 = 状态检测器({
            "血条": {"区域": (0, 0, 100, 20)},
            "蓝条": {"区域": (0, 25, 100, 15)}
        })
        
        有效图像 = np.zeros((100, 200, 3), dtype=np.uint8)
        检测器.检测(有效图像)
        
        检测器.重置()
        
        assert 检测器._总检测次数 == 0
        assert 检测器._血量检测器.获取检测统计()["总检测次数"] == 0
        assert 检测器._蓝量检测器.获取检测统计()["总检测次数"] == 0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
