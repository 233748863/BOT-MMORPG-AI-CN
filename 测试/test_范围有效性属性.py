# -*- coding: utf-8 -*-
"""
范围有效性属性测试模块

使用Hypothesis进行属性测试，验证数值类型配置值在定义的范围内。

**属性 3: 范围有效性**
*对于任意* 数值类型配置，其值应在定义的范围内

**验证: 需求 4.4**
"""

import sys
import os

# 添加项目根目录到路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import pytest
from hypothesis import given, strategies as st, settings, assume
from typing import Any, Dict, List, Tuple, Optional

from 核心.配置验证 import 配置验证器, 默认配置模式, 验证错误


# ==================== 策略定义 ====================

# 有效范围内的整数策略
def 范围内整数策略(最小值: int, 最大值: int):
    """生成指定范围内的整数"""
    return st.integers(min_value=最小值, max_value=最大值)


# 有效范围内的浮点数策略
def 范围内浮点数策略(最小值: float, 最大值: float):
    """生成指定范围内的浮点数"""
    return st.floats(
        min_value=最小值, 
        max_value=最大值, 
        allow_nan=False, 
        allow_infinity=False
    )


# 超出范围的整数策略（小于最小值）
def 小于最小值整数策略(最小值: int):
    """生成小于最小值的整数"""
    return st.integers(max_value=最小值 - 1)


# 超出范围的整数策略（大于最大值）
def 大于最大值整数策略(最大值: int):
    """生成大于最大值的整数"""
    return st.integers(min_value=最大值 + 1)


# 超出范围的浮点数策略（小于最小值）
def 小于最小值浮点数策略(最小值: float):
    """生成小于最小值的浮点数"""
    # 使用一个合理的下界
    下界 = 最小值 - 1000.0
    return st.floats(
        min_value=下界,
        max_value=最小值 - 0.0001,
        allow_nan=False,
        allow_infinity=False
    )


# 超出范围的浮点数策略（大于最大值）
def 大于最大值浮点数策略(最大值: float):
    """生成大于最大值的浮点数"""
    # 使用一个合理的上界
    上界 = 最大值 + 1000.0
    return st.floats(
        min_value=最大值 + 0.0001,
        max_value=上界,
        allow_nan=False,
        allow_infinity=False
    )


class Test范围有效性属性:
    """
    范围有效性属性测试类
    
    **Feature: config-gui, 属性 3: 范围有效性**
    **验证: 需求 4.4**
    """
    
    @given(值=范围内整数策略(0, 10000))
    @settings(max_examples=100, deadline=None)
    def test_范围内整数应通过验证_仅最小值(self, 值: int):
        """
        属性测试: 对于任意大于等于最小值的整数，范围验证应通过
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 只有最小值约束
        结果 = 验证器.验证范围(值, 最小值=0, 最大值=None)
        
        assert 结果 is True, f"值 {值} 应通过范围验证 (最小值=0)"
    
    @given(值=范围内整数策略(100, 7680))
    @settings(max_examples=100, deadline=None)
    def test_范围内整数应通过验证_最小值和最大值(self, 值: int):
        """
        属性测试: 对于任意在范围内的整数，范围验证应通过
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 同时有最小值和最大值约束
        结果 = 验证器.验证范围(值, 最小值=100, 最大值=7680)
        
        assert 结果 is True, f"值 {值} 应通过范围验证 (100 <= x <= 7680)"
    
    @given(值=范围内浮点数策略(0.0, 1.0))
    @settings(max_examples=100, deadline=None)
    def test_范围内浮点数应通过验证(self, 值: float):
        """
        属性测试: 对于任意在范围内的浮点数，范围验证应通过
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 置信度阈值范围 0.0 - 1.0
        结果 = 验证器.验证范围(值, 最小值=0.0, 最大值=1.0)
        
        assert 结果 is True, f"值 {值} 应通过范围验证 (0.0 <= x <= 1.0)"
    
    @given(值=范围内浮点数策略(0.0001, 0.1))
    @settings(max_examples=100, deadline=None)
    def test_学习率范围内浮点数应通过验证(self, 值: float):
        """
        属性测试: 对于任意在学习率范围内的浮点数，范围验证应通过
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 学习率范围 0.0001 - 0.1
        结果 = 验证器.验证范围(值, 最小值=0.0001, 最大值=0.1)
        
        assert 结果 is True, f"值 {值} 应通过范围验证 (0.0001 <= x <= 0.1)"
    
    @given(值=小于最小值整数策略(0))
    @settings(max_examples=100, deadline=None)
    def test_小于最小值的整数应失败(self, 值: int):
        """
        属性测试: 对于任意小于最小值的整数，范围验证应失败
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        结果 = 验证器.验证范围(值, 最小值=0, 最大值=None)
        
        assert 结果 is False, f"值 {值} 不应通过范围验证 (最小值=0)"
    
    @given(值=大于最大值整数策略(7680))
    @settings(max_examples=100, deadline=None)
    def test_大于最大值的整数应失败(self, 值: int):
        """
        属性测试: 对于任意大于最大值的整数，范围验证应失败
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        结果 = 验证器.验证范围(值, 最小值=100, 最大值=7680)
        
        assert 结果 is False, f"值 {值} 不应通过范围验证 (最大值=7680)"
    
    @given(值=小于最小值浮点数策略(0.0))
    @settings(max_examples=100, deadline=None)
    def test_小于最小值的浮点数应失败(self, 值: float):
        """
        属性测试: 对于任意小于最小值的浮点数，范围验证应失败
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        结果 = 验证器.验证范围(值, 最小值=0.0, 最大值=1.0)
        
        assert 结果 is False, f"值 {值} 不应通过范围验证 (最小值=0.0)"
    
    @given(值=大于最大值浮点数策略(1.0))
    @settings(max_examples=100, deadline=None)
    def test_大于最大值的浮点数应失败(self, 值: float):
        """
        属性测试: 对于任意大于最大值的浮点数，范围验证应失败
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        结果 = 验证器.验证范围(值, 最小值=0.0, 最大值=1.0)
        
        assert 结果 is False, f"值 {值} 不应通过范围验证 (最大值=1.0)"
    
    def test_None值应通过范围验证(self):
        """
        测试: None值应通过范围验证（None在必需验证中处理）
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        结果 = 验证器.验证范围(None, 最小值=0, 最大值=100)
        
        assert 结果 is True, "None 值应通过范围验证"
    
    def test_无范围约束应通过验证(self):
        """
        测试: 无范围约束时任意值应通过验证
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 无最小值和最大值约束
        结果 = 验证器.验证范围(12345, 最小值=None, 最大值=None)
        
        assert 结果 is True, "无范围约束时任意值应通过验证"
        
        结果 = 验证器.验证范围(-12345, 最小值=None, 最大值=None)
        
        assert 结果 is True, "无范围约束时任意值应通过验证"


class Test范围有效性_验证值方法:
    """
    使用验证值方法测试范围有效性
    
    **Feature: config-gui, 属性 3: 范围有效性**
    **验证: 需求 4.4**
    """
    
    @given(值=范围内整数策略(0, 10000))
    @settings(max_examples=100, deadline=None)
    def test_验证值_范围内整数应通过(self, 值: int):
        """
        属性测试: 使用验证值方法验证范围内整数
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        参数定义 = {"类型": "int", "最小值": 0}
        
        有效, 错误 = 验证器.验证值("测试参数", 值, 参数定义)
        
        assert 有效 is True, f"范围内整数 {值} 应通过验证值方法"
        assert 错误 is None, f"有效值不应产生错误"
    
    @given(值=范围内浮点数策略(0.0, 1.0))
    @settings(max_examples=100, deadline=None)
    def test_验证值_范围内浮点数应通过(self, 值: float):
        """
        属性测试: 使用验证值方法验证范围内浮点数
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        参数定义 = {"类型": "float", "最小值": 0.0, "最大值": 1.0}
        
        有效, 错误 = 验证器.验证值("测试参数", 值, 参数定义)
        
        assert 有效 is True, f"范围内浮点数 {值} 应通过验证值方法"
        assert 错误 is None, f"有效值不应产生错误"
    
    @given(值=小于最小值整数策略(100))
    @settings(max_examples=100, deadline=None)
    def test_验证值_小于最小值应返回范围错误(self, 值: int):
        """
        属性测试: 使用验证值方法验证小于最小值的整数应返回范围错误
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        参数定义 = {"类型": "int", "最小值": 100, "最大值": 7680}
        
        有效, 错误 = 验证器.验证值("测试参数", 值, 参数定义)
        
        assert 有效 is False, f"小于最小值的整数 {值} 不应通过验证"
        assert 错误 is not None, f"无效值应产生错误"
        assert isinstance(错误, 验证错误), f"错误应为验证错误类型"
        assert 错误.错误类型 == "range", f"错误类型应为 'range'，实际为 '{错误.错误类型}'"
    
    @given(值=大于最大值整数策略(256))
    @settings(max_examples=100, deadline=None)
    def test_验证值_大于最大值应返回范围错误(self, 值: int):
        """
        属性测试: 使用验证值方法验证大于最大值的整数应返回范围错误
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        参数定义 = {"类型": "int", "最小值": 1, "最大值": 256}
        
        有效, 错误 = 验证器.验证值("测试参数", 值, 参数定义)
        
        assert 有效 is False, f"大于最大值的整数 {值} 不应通过验证"
        assert 错误 is not None, f"无效值应产生错误"
        assert isinstance(错误, 验证错误), f"错误应为验证错误类型"
        assert 错误.错误类型 == "range", f"错误类型应为 'range'，实际为 '{错误.错误类型}'"


class Test范围有效性_完整配置验证:
    """
    测试完整配置的范围有效性验证
    
    **Feature: config-gui, 属性 3: 范围有效性**
    **验证: 需求 4.4**
    """
    
    @given(
        窗口X=范围内整数策略(0, 10000),
        窗口Y=范围内整数策略(0, 10000),
        窗口宽度=范围内整数策略(100, 7680),
        窗口高度=范围内整数策略(100, 4320),
    )
    @settings(max_examples=100, deadline=None)
    def test_有效窗口设置配置应通过范围验证(self, 窗口X, 窗口Y, 窗口宽度, 窗口高度):
        """
        属性测试: 对于任意有效范围内的窗口设置配置，范围验证应通过
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        配置 = {
            "窗口设置": {
                "窗口X": 窗口X,
                "窗口Y": 窗口Y,
                "窗口宽度": 窗口宽度,
                "窗口高度": 窗口高度,
            }
        }
        
        有效, 错误列表 = 验证器.验证配置(配置)
        
        # 过滤出范围错误
        范围错误 = [e for e in 错误列表 if e.错误类型 == "range"]
        
        assert len(范围错误) == 0, f"有效范围内的窗口设置配置不应产生范围错误，但得到: {范围错误}"
    
    @given(
        置信度阈值=范围内浮点数策略(0.0, 1.0),
        批次大小=范围内整数策略(1, 256),
        学习率=范围内浮点数策略(0.0001, 0.1),
        训练轮次=范围内整数策略(1, 10000),
    )
    @settings(max_examples=100, deadline=None)
    def test_有效模型和训练设置应通过范围验证(self, 置信度阈值, 批次大小, 学习率, 训练轮次):
        """
        属性测试: 对于任意有效范围内的模型和训练设置，范围验证应通过
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        配置 = {
            "模型设置": {
                "模型路径": "模型/test.pth",
                "YOLO模型": "模型/yolo.pt",
                "置信度阈值": 置信度阈值,
            },
            "训练设置": {
                "批次大小": 批次大小,
                "学习率": 学习率,
                "训练轮次": 训练轮次,
            }
        }
        
        有效, 错误列表 = 验证器.验证配置(配置)
        
        # 过滤出范围错误
        范围错误 = [e for e in 错误列表 if e.错误类型 == "range"]
        
        assert len(范围错误) == 0, f"有效范围内的模型和训练设置不应产生范围错误，但得到: {范围错误}"
    
    def test_超出范围的配置应产生范围错误(self):
        """
        测试: 超出范围的配置值应产生范围错误
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 使用超出范围的配置
        配置 = {
            "窗口设置": {
                "窗口X": -10,  # 应该 >= 0
                "窗口Y": -5,   # 应该 >= 0
                "窗口宽度": 50,  # 应该 >= 100
                "窗口高度": 10000,  # 应该 <= 4320
            },
            "模型设置": {
                "模型路径": "模型/test.pth",
                "置信度阈值": 1.5,  # 应该 <= 1.0
            },
            "训练设置": {
                "批次大小": 0,  # 应该 >= 1
                "学习率": 0.5,  # 应该 <= 0.1
                "训练轮次": 0,  # 应该 >= 1
            }
        }
        
        有效, 错误列表 = 验证器.验证配置(配置)
        
        # 应该有范围错误
        范围错误 = [e for e in 错误列表 if e.错误类型 == "range"]
        
        assert len(范围错误) > 0, f"超出范围的配置应产生范围错误"
    
    def test_边界值应通过范围验证(self):
        """
        测试: 边界值应通过范围验证
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 使用边界值的配置
        配置 = {
            "窗口设置": {
                "窗口X": 0,  # 最小值
                "窗口Y": 0,  # 最小值
                "窗口宽度": 100,  # 最小值
                "窗口高度": 4320,  # 最大值
            },
            "模型设置": {
                "模型路径": "模型/test.pth",
                "置信度阈值": 0.0,  # 最小值
            },
            "训练设置": {
                "批次大小": 256,  # 最大值
                "学习率": 0.0001,  # 最小值
                "训练轮次": 1,  # 最小值
            }
        }
        
        有效, 错误列表 = 验证器.验证配置(配置)
        
        # 过滤出范围错误
        范围错误 = [e for e in 错误列表 if e.错误类型 == "range"]
        
        assert len(范围错误) == 0, f"边界值配置不应产生范围错误，但得到: {范围错误}"


class Test范围有效性_错误信息:
    """
    测试范围验证的错误信息生成
    
    **Feature: config-gui, 属性 3: 范围有效性**
    **验证: 需求 4.4, 4.5**
    """
    
    def test_小于最小值错误信息包含正确内容(self):
        """
        测试: 小于最小值的错误信息应包含正确内容
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4, 4.5**
        """
        验证器 = 配置验证器(默认配置模式)
        参数定义 = {"类型": "int", "最小值": 100, "最大值": 7680}
        
        有效, 错误 = 验证器.验证值("窗口宽度", 50, 参数定义)
        
        assert 有效 is False
        assert 错误 is not None
        assert "窗口宽度" in 错误.错误信息
        assert "50" in 错误.错误信息
        assert 错误.当前值 == 50
        assert ">= 100" in 错误.期望值
    
    def test_大于最大值错误信息包含正确内容(self):
        """
        测试: 大于最大值的错误信息应包含正确内容
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4, 4.5**
        """
        验证器 = 配置验证器(默认配置模式)
        参数定义 = {"类型": "float", "最小值": 0.0, "最大值": 1.0}
        
        有效, 错误 = 验证器.验证值("置信度阈值", 1.5, 参数定义)
        
        assert 有效 is False
        assert 错误 is not None
        assert "置信度阈值" in 错误.错误信息
        assert "1.5" in 错误.错误信息
        assert 错误.当前值 == 1.5
        assert "<= 1.0" in 错误.期望值


class Test范围有效性_模式定义参数:
    """
    测试基于模式定义的范围验证
    
    **Feature: config-gui, 属性 3: 范围有效性**
    **验证: 需求 4.4**
    """
    
    @given(参数索引=st.integers(min_value=0, max_value=100))
    @settings(max_examples=100, deadline=None)
    def test_模式定义中的数值参数范围验证(self, 参数索引: int):
        """
        属性测试: 对于模式定义中的任意数值参数，范围验证应正确工作
        
        **Feature: config-gui, 属性 3: 范围有效性**
        **验证: 需求 4.4**
        """
        验证器 = 配置验证器(默认配置模式)
        
        # 收集所有数值类型参数
        数值参数 = []
        for 分区名, 分区定义 in 默认配置模式.items():
            for 参数名, 参数定义 in 分区定义.items():
                if 参数定义.get("类型") in ("int", "float"):
                    数值参数.append((分区名, 参数名, 参数定义))
        
        if len(数值参数) == 0:
            return  # 没有数值参数，跳过测试
        
        # 使用模运算选择参数
        分区名, 参数名, 参数定义 = 数值参数[参数索引 % len(数值参数)]
        
        最小值 = 参数定义.get("最小值")
        最大值 = 参数定义.get("最大值")
        默认值 = 参数定义.get("默认值")
        
        # 验证默认值在范围内
        if 默认值 is not None:
            结果 = 验证器.验证范围(默认值, 最小值, 最大值)
            assert 结果 is True, \
                f"参数 '{分区名}.{参数名}' 的默认值 {默认值} 应在范围 [{最小值}, {最大值}] 内"


if __name__ == "__main__":
    pytest.main([__file__, "-v", "--hypothesis-show-statistics"])
