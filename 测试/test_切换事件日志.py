# -*- coding: utf-8 -*-
"""
单元测试：切换事件日志功能

测试切换事件日志管理器的核心功能：
- 记录所有切换事件
- 包含触发方式和原因
- 日志持久化到文件
- 日志查询和导出

**验证: 需求 2.4**
"""

import os
import time
import json
import tempfile
import shutil
import pytest
from typing import List, Dict, Any


# ==================== 测试用虚拟模型 ====================

class 虚拟模型:
    """虚拟模型，用于测试"""
    
    def __init__(self, 标识: str = "test"):
        self.模型标识 = 标识
    
    def run(self, output_names, input_dict):
        """模拟 ONNX Runtime 接口"""
        import numpy as np
        return [np.array([[0.1, 0.2, 0.3, 0.4]])]
    
    def get_inputs(self):
        """模拟 ONNX Runtime 接口"""
        class 输入信息:
            name = "input"
            shape = [1, 224, 224, 3]
        return [输入信息()]
    
    def get_outputs(self):
        """模拟 ONNX Runtime 接口"""
        class 输出信息:
            name = "output"
        return [输出信息()]


# ==================== 测试辅助函数 ====================

def 创建测试管理器():
    """创建用于测试的模型管理器"""
    from 核心.模型管理 import 模型管理器, 模型槽位
    
    管理器 = 模型管理器()
    
    # 添加虚拟模型
    管理器._槽位['模型A'] = 模型槽位(
        名称='模型A',
        路径='虚拟路径A',
        模型实例=虚拟模型("A"),
        已加载=True,
        内存占用=1024*1024
    )
    管理器._槽位['模型B'] = 模型槽位(
        名称='模型B',
        路径='虚拟路径B',
        模型实例=虚拟模型("B"),
        已加载=True,
        内存占用=1024*1024
    )
    管理器._活动模型 = '模型A'
    
    return 管理器


# ==================== 测试类 ====================

class Test切换事件日志:
    """
    测试切换事件日志功能
    
    **验证: 需求 2.4**
    """
    
    def setup_method(self):
        """每个测试方法前的设置"""
        # 创建临时日志目录
        self.临时目录 = tempfile.mkdtemp()
    
    def teardown_method(self):
        """每个测试方法后的清理"""
        # 删除临时目录
        if os.path.exists(self.临时目录):
            shutil.rmtree(self.临时目录)
    
    def test_切换事件数据类(self):
        """
        测试切换事件数据类的基本功能
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件
        
        # 创建切换事件
        事件 = 切换事件(
            时间戳=time.time(),
            原模型="模型A",
            新模型="模型B",
            触发方式="manual",
            触发原因="手动切换测试",
            切换耗时=50.0,
            切换成功=True
        )
        
        # 验证转为字典
        字典 = 事件.转为字典()
        assert 字典["原模型"] == "模型A"
        assert 字典["新模型"] == "模型B"
        assert 字典["触发方式"] == "manual"
        assert 字典["触发原因"] == "手动切换测试"
        assert 字典["切换耗时"] == 50.0
        assert 字典["切换成功"] == True
        assert "时间" in 字典  # 应该有格式化的时间字符串
        
        # 验证转为日志字符串
        日志字符串 = 事件.转为日志字符串()
        assert "模型A" in 日志字符串
        assert "模型B" in 日志字符串
        assert "manual" in 日志字符串
        assert "成功" in 日志字符串
        
        # 验证从字典创建
        新事件 = 切换事件.从字典创建(字典)
        assert 新事件.原模型 == 事件.原模型
        assert 新事件.新模型 == 事件.新模型
        assert 新事件.触发方式 == 事件.触发方式
    
    def test_日志管理器初始化(self):
        """
        测试日志管理器初始化
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=True
        )
        
        # 验证初始化状态
        状态 = 日志管理器.获取状态()
        assert 状态["内存日志数量"] == 0
        assert 状态["启用文件日志"] == True
        assert 状态["日志目录"] == self.临时目录
        
        # 清理
        管理器.关闭()
    
    def test_记录切换事件(self):
        """
        测试记录切换事件功能
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=True
        )
        
        # 手动记录事件
        事件 = 切换事件(
            时间戳=time.time(),
            原模型="模型A",
            新模型="模型B",
            触发方式="manual",
            触发原因="测试记录",
            切换耗时=25.0,
            切换成功=True
        )
        日志管理器.记录事件(事件)
        
        # 验证内存日志
        日志列表 = 日志管理器.获取日志(数量=10)
        assert len(日志列表) == 1
        assert 日志列表[0]["原模型"] == "模型A"
        assert 日志列表[0]["新模型"] == "模型B"
        
        # 清理
        管理器.关闭()
    
    def test_通过模型切换自动记录日志(self):
        """
        测试通过模型管理器切换时自动记录日志
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=True
        )
        
        # 执行模型切换
        管理器.切换模型("模型B", 触发方式="manual", 触发原因="测试自动记录")
        
        # 等待回调执行
        time.sleep(0.1)
        
        # 验证日志已记录
        日志列表 = 日志管理器.获取日志(数量=10)
        assert len(日志列表) >= 1
        
        # 验证最新日志
        最新日志 = 日志列表[0]
        assert 最新日志["新模型"] == "模型B"
        
        # 清理
        管理器.关闭()
    
    def test_日志过滤功能(self):
        """
        测试日志过滤功能
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False
        )
        
        # 记录不同触发方式的事件
        当前时间 = time.time()
        
        日志管理器.记录事件(切换事件(
            时间戳=当前时间 - 100,
            原模型="模型A", 新模型="模型B",
            触发方式="manual", 触发原因="手动切换"
        ))
        日志管理器.记录事件(切换事件(
            时间戳=当前时间 - 50,
            原模型="模型B", 新模型="模型A",
            触发方式="auto", 触发原因="自动切换"
        ))
        日志管理器.记录事件(切换事件(
            时间戳=当前时间,
            原模型="模型A", 新模型="模型B",
            触发方式="hotkey", 触发原因="快捷键切换"
        ))
        
        # 按触发方式过滤
        手动日志 = 日志管理器.获取日志(触发方式="manual")
        assert len(手动日志) == 1
        assert 手动日志[0]["触发方式"] == "manual"
        
        自动日志 = 日志管理器.获取日志(触发方式="auto")
        assert len(自动日志) == 1
        assert 自动日志[0]["触发方式"] == "auto"
        
        快捷键日志 = 日志管理器.获取日志(触发方式="hotkey")
        assert len(快捷键日志) == 1
        assert 快捷键日志[0]["触发方式"] == "hotkey"
        
        # 按时间范围过滤
        最近日志 = 日志管理器.获取日志(开始时间=当前时间 - 60)
        assert len(最近日志) == 2  # 最近 60 秒内的日志
        
        # 清理
        管理器.关闭()
    
    def test_日志统计信息(self):
        """
        测试日志统计信息功能
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False
        )
        
        # 记录多个事件
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="manual", 触发原因="手动1",
            切换耗时=10.0, 切换成功=True
        ))
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型B", 新模型="模型A",
            触发方式="auto", 触发原因="自动1",
            切换耗时=20.0, 切换成功=True
        ))
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="hotkey", 触发原因="快捷键1",
            切换耗时=30.0, 切换成功=False
        ))
        
        # 获取统计信息
        统计 = 日志管理器.获取统计信息()
        
        assert 统计["总切换次数"] == 3
        assert 统计["手动切换次数"] == 1
        assert 统计["自动切换次数"] == 1
        assert 统计["快捷键切换次数"] == 1
        assert 统计["成功次数"] == 2
        assert 统计["失败次数"] == 1
        assert 统计["平均切换耗时"] == 20.0  # (10 + 20 + 30) / 3
        
        # 清理
        管理器.关闭()
    
    def test_日志文件持久化(self):
        """
        测试日志文件持久化功能
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=True
        )
        
        # 记录事件
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="manual", 触发原因="持久化测试",
            切换耗时=15.0, 切换成功=True
        ))
        
        # 验证日志文件已创建
        日志文件列表 = 日志管理器.获取日志文件列表()
        assert len(日志文件列表) >= 1
        
        # 验证日志文件内容
        日志文件路径 = 日志文件列表[0]
        assert os.path.exists(日志文件路径)
        
        with open(日志文件路径, 'r', encoding='utf-8') as f:
            内容 = f.read()
            assert "模型A" in 内容
            assert "模型B" in 内容
            assert "manual" in 内容
            assert "持久化测试" in 内容
        
        # 清理
        管理器.关闭()
    
    def test_导出日志为JSON(self):
        """
        测试导出日志为 JSON 格式
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False
        )
        
        # 记录事件
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="manual", 触发原因="JSON导出测试"
        ))
        
        # 导出为 JSON
        导出路径 = os.path.join(self.临时目录, "export.json")
        结果 = 日志管理器.导出日志(导出路径, 格式="json")
        
        assert 结果 == True
        assert os.path.exists(导出路径)
        
        # 验证 JSON 内容
        with open(导出路径, 'r', encoding='utf-8') as f:
            数据 = json.load(f)
            assert "日志列表" in 数据
            assert len(数据["日志列表"]) == 1
            assert 数据["日志列表"][0]["原模型"] == "模型A"
        
        # 清理
        管理器.关闭()
    
    def test_导出日志为CSV(self):
        """
        测试导出日志为 CSV 格式
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False
        )
        
        # 记录事件
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="auto", 触发原因="CSV导出测试"
        ))
        
        # 导出为 CSV
        导出路径 = os.path.join(self.临时目录, "export.csv")
        结果 = 日志管理器.导出日志(导出路径, 格式="csv")
        
        assert 结果 == True
        assert os.path.exists(导出路径)
        
        # 验证 CSV 内容
        with open(导出路径, 'r', encoding='utf-8-sig') as f:
            内容 = f.read()
            assert "原模型" in 内容
            assert "新模型" in 内容
            assert "模型A" in 内容
            assert "模型B" in 内容
        
        # 清理
        管理器.关闭()
    
    def test_导出日志为TXT(self):
        """
        测试导出日志为 TXT 格式
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False
        )
        
        # 记录事件
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="hotkey", 触发原因="TXT导出测试"
        ))
        
        # 导出为 TXT
        导出路径 = os.path.join(self.临时目录, "export.txt")
        结果 = 日志管理器.导出日志(导出路径, 格式="txt")
        
        assert 结果 == True
        assert os.path.exists(导出路径)
        
        # 验证 TXT 内容
        with open(导出路径, 'r', encoding='utf-8') as f:
            内容 = f.read()
            assert "模型切换日志导出" in 内容
            assert "模型A" in 内容
            assert "模型B" in 内容
        
        # 清理
        管理器.关闭()
    
    def test_清空日志(self):
        """
        测试清空日志功能
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False
        )
        
        # 记录事件
        日志管理器.记录事件(切换事件(
            时间戳=time.time(),
            原模型="模型A", 新模型="模型B",
            触发方式="manual", 触发原因="清空测试"
        ))
        
        # 验证有日志
        assert len(日志管理器.获取日志()) == 1
        
        # 清空日志
        日志管理器.清空日志()
        
        # 验证日志已清空
        assert len(日志管理器.获取日志()) == 0
        
        # 清理
        管理器.关闭()
    
    def test_内存日志数量限制(self):
        """
        测试内存日志数量限制
        
        **验证: 需求 2.4**
        """
        from 核心.模型管理 import 切换事件日志管理器, 切换事件
        
        管理器 = 创建测试管理器()
        日志管理器 = 切换事件日志管理器(
            管理器,
            日志目录=self.临时目录,
            启用文件日志=False,
            最大内存日志数=5  # 限制为 5 条
        )
        
        # 记录 10 条事件
        for i in range(10):
            日志管理器.记录事件(切换事件(
                时间戳=time.time() + i,
                原模型="模型A", 新模型="模型B",
                触发方式="manual", 触发原因=f"测试{i}"
            ))
        
        # 验证只保留最新的 5 条
        日志列表 = 日志管理器.获取日志(数量=100)
        assert len(日志列表) == 5
        
        # 验证是最新的 5 条（触发原因应该是 5-9）
        原因列表 = [日志["触发原因"] for 日志 in 日志列表]
        assert "测试9" in 原因列表
        assert "测试5" in 原因列表
        assert "测试0" not in 原因列表
        
        # 清理
        管理器.关闭()


# ==================== 运行测试 ====================

if __name__ == "__main__":
    pytest.main([__file__, "-v", "--tb=short"])
