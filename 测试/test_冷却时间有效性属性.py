# -*- coding: utf-8 -*-
"""
属性测试：冷却时间有效性
Property 2: 对于任意自动切换，两次切换间隔应不小于配置的冷却时间

**Feature: model-hot-swap, Property 2: 冷却时间有效性**
**验证: 需求 3.3**
"""

import time
import threading
import numpy as np
import pytest
from hypothesis import given, settings, strategies as st, assume
from typing import List, Optional, Any
from dataclasses import dataclass, field


# ==================== 测试用虚拟模型 ====================

class 虚拟模型A:
    """虚拟模型 A"""
    模型标识 = "A"
    
    def run(self, output_names, input_dict):
        return [np.array([[0.1, 0.2, 0.3, 0.4]])]
    
    def get_inputs(self):
        class 输入信息:
            name = "input"
            shape = [1, 224, 224, 3]
        return [输入信息()]
    
    def get_outputs(self):
        class 输出信息:
            name = "output"
        return [输出信息()]


class 虚拟模型B:
    """虚拟模型 B"""
    模型标识 = "B"
    
    def run(self, output_names, input_dict):
        return [np.array([[0.5, 0.6, 0.7, 0.8]])]
    
    def get_inputs(self):
        class 输入信息:
            name = "input"
            shape = [1, 224, 224, 3]
        return [输入信息()]
    
    def get_outputs(self):
        class 输出信息:
            name = "output"
        return [输出信息()]


class 虚拟模型C:
    """虚拟模型 C"""
    模型标识 = "C"
    
    def run(self, output_names, input_dict):
        return [np.array([[0.9, 0.8, 0.7, 0.6]])]
    
    def get_inputs(self):
        class 输入信息:
            name = "input"
            shape = [1, 224, 224, 3]
        return [输入信息()]
    
    def get_outputs(self):
        class 输出信息:
            name = "output"
        return [输出信息()]


# ==================== 测试辅助函数 ====================

def 创建测试管理器和切换器():
    """创建用于测试的模型管理器和自动切换器"""
    from 核心.模型管理 import 模型管理器, 模型槽位, 自动切换器, 自动切换规则
    
    管理器 = 模型管理器()
    
    # 添加虚拟模型
    管理器._槽位['战斗模型'] = 模型槽位(
        名称='战斗模型',
        路径='虚拟路径A',
        描述='战斗专用模型',
        适用状态=['战斗'],
        模型实例=虚拟模型A(),
        已加载=True,
        内存占用=1024*1024
    )
    管理器._槽位['任务模型'] = 模型槽位(
        名称='任务模型',
        路径='虚拟路径B',
        描述='任务专用模型',
        适用状态=['移动', '对话'],
        模型实例=虚拟模型B(),
        已加载=True,
        内存占用=1024*1024
    )
    管理器._槽位['采集模型'] = 模型槽位(
        名称='采集模型',
        路径='虚拟路径C',
        描述='采集专用模型',
        适用状态=['采集'],
        模型实例=虚拟模型C(),
        已加载=True,
        内存占用=1024*1024
    )
    管理器._活动模型 = '任务模型'
    
    # 创建自动切换器
    切换器 = 自动切换器(管理器)
    
    return 管理器, 切换器


# ==================== 属性测试类 ====================

class Test冷却时间有效性属性:
    """
    Property 2: 冷却时间有效性
    
    *对于任意* 自动切换，两次切换间隔应不小于配置的冷却时间。
    
    **Feature: model-hot-swap, Property 2: 冷却时间有效性**
    **验证: 需求 3.3**
    """
    
    @given(
        冷却时间=st.floats(min_value=0.1, max_value=2.0),
        状态序列=st.lists(
            st.sampled_from(['战斗', '移动', '对话', '采集']),
            min_size=5,
            max_size=20
        )
    )
    @settings(max_examples=100, deadline=None)
    def test_全局冷却时间约束(self, 冷却时间: float, 状态序列: List[str]):
        """
        *对于任意* 冷却时间和状态序列，两次自动切换之间的间隔
        应不小于配置的全局冷却时间。
        
        **Feature: model-hot-swap, Property 2: 冷却时间有效性**
        **验证: 需求 3.3**
        """
        from 核心.模型管理 import 自动切换规则
        
        管理器, 切换器 = 创建测试管理器和切换器()
        
        # 设置全局冷却时间
        切换器.设置全局冷却时间(冷却时间)
        
        # 添加规则
        切换器.添加规则(自动切换规则(
            名称="战斗规则",
            触发状态=["战斗"],
            目标模型="战斗模型",
            优先级=10,
            冷却时间=冷却时间
        ))
        切换器.添加规则(自动切换规则(
            名称="任务规则",
            触发状态=["移动", "对话"],
            目标模型="任务模型",
            优先级=5,
            冷却时间=冷却时间
        ))
        切换器.添加规则(自动切换规则(
            名称="采集规则",
            触发状态=["采集"],
            目标模型="采集模型",
            优先级=5,
            冷却时间=冷却时间
        ))
        
        # 记录切换时间
        切换时间列表 = []
        
        # 执行状态序列
        for 状态 in 状态序列:
            结果 = 切换器.执行自动切换(状态)
            if 结果:
                切换时间列表.append(time.time())
            # 小延迟，模拟实际运行
            time.sleep(0.01)
        
        # 验证：相邻两次切换的间隔应不小于冷却时间
        for i in range(1, len(切换时间列表)):
            间隔 = 切换时间列表[i] - 切换时间列表[i-1]
            # 允许小误差（10ms）
            assert 间隔 >= 冷却时间 - 0.01, \
                f"切换间隔 {间隔:.3f}s 小于冷却时间 {冷却时间:.3f}s"
        
        # 清理
        管理器.关闭()
    
    @given(
        冷却时间=st.floats(min_value=0.2, max_value=1.0),
        尝试次数=st.integers(min_value=5, max_value=20)
    )
    @settings(max_examples=100, deadline=None)
    def test_冷却期间切换被阻止(self, 冷却时间: float, 尝试次数: int):
        """
        *对于任意* 冷却时间，在冷却期间内的切换请求应被阻止。
        
        **Feature: model-hot-swap, Property 2: 冷却时间有效性**
        **验证: 需求 3.3**
        """
        from 核心.模型管理 import 自动切换规则
        
        管理器, 切换器 = 创建测试管理器和切换器()
        
        # 设置冷却时间
        切换器.设置全局冷却时间(冷却时间)
        
        # 添加规则
        切换器.添加规则(自动切换规则(
            名称="战斗规则",
            触发状态=["战斗"],
            目标模型="战斗模型",
            优先级=10,
            冷却时间=冷却时间
        ))
        
        # 确保初始模型不是战斗模型
        管理器._活动模型 = '任务模型'
        
        # 第一次切换应该成功
        第一次结果 = 切换器.执行自动切换("战斗")
        assert 第一次结果, "第一次切换应该成功"
        
        # 在冷却期间内快速尝试多次切换
        冷却期间切换成功数 = 0
        for _ in range(尝试次数):
            # 切换回任务模型（手动切换，不受冷却限制）
            管理器.切换模型("任务模型", 触发方式="manual")
            
            # 尝试自动切换回战斗模型
            结果 = 切换器.执行自动切换("战斗")
            if 结果:
                冷却期间切换成功数 += 1
            
            # 非常短的延迟，确保在冷却期间内
            time.sleep(冷却时间 / (尝试次数 * 2))
        
        # 验证：在冷却期间内，自动切换应该被阻止（最多只有第一次成功）
        # 由于我们在冷却期间内快速尝试，大部分应该被阻止
        assert 冷却期间切换成功数 <= 2, \
            f"冷却期间内有 {冷却期间切换成功数} 次切换成功，应该被阻止"
        
        # 清理
        管理器.关闭()
    
    @given(
        冷却时间=st.floats(min_value=0.1, max_value=0.5)
    )
    @settings(max_examples=100, deadline=None)
    def test_冷却结束后可以切换(self, 冷却时间: float):
        """
        *对于任意* 冷却时间，冷却结束后应该可以正常切换。
        
        **Feature: model-hot-swap, Property 2: 冷却时间有效性**
        **验证: 需求 3.3**
        """
        from 核心.模型管理 import 自动切换规则
        
        管理器, 切换器 = 创建测试管理器和切换器()
        
        # 设置冷却时间
        切换器.设置全局冷却时间(冷却时间)
        
        # 添加规则
        切换器.添加规则(自动切换规则(
            名称="战斗规则",
            触发状态=["战斗"],
            目标模型="战斗模型",
            优先级=10,
            冷却时间=冷却时间
        ))
        
        # 确保初始模型不是战斗模型
        管理器._活动模型 = '任务模型'
        
        # 第一次切换
        第一次结果 = 切换器.执行自动切换("战斗")
        assert 第一次结果, "第一次切换应该成功"
        
        # 等待冷却结束
        time.sleep(冷却时间 + 0.05)
        
        # 切换回任务模型
        管理器.切换模型("任务模型", 触发方式="manual")
        
        # 冷却结束后应该可以切换
        第二次结果 = 切换器.执行自动切换("战斗")
        assert 第二次结果, "冷却结束后应该可以切换"
        
        # 清理
        管理器.关闭()
    
    @given(
        规则冷却时间=st.floats(min_value=0.1, max_value=0.5),
        全局冷却时间=st.floats(min_value=0.1, max_value=0.5)
    )
    @settings(max_examples=100, deadline=None)
    def test_规则独立冷却时间(self, 规则冷却时间: float, 全局冷却时间: float):
        """
        *对于任意* 规则冷却时间和全局冷却时间，每个规则应有独立的冷却时间。
        
        **Feature: model-hot-swap, Property 2: 冷却时间有效性**
        **验证: 需求 3.3**
        """
        from 核心.模型管理 import 自动切换规则
        
        管理器, 切换器 = 创建测试管理器和切换器()
        
        # 设置全局冷却时间
        切换器.设置全局冷却时间(全局冷却时间)
        
        # 添加两个规则，使用不同的冷却时间
        切换器.添加规则(自动切换规则(
            名称="战斗规则",
            触发状态=["战斗"],
            目标模型="战斗模型",
            优先级=10,
            冷却时间=规则冷却时间
        ))
        切换器.添加规则(自动切换规则(
            名称="采集规则",
            触发状态=["采集"],
            目标模型="采集模型",
            优先级=5,
            冷却时间=规则冷却时间 * 2  # 不同的冷却时间
        ))
        
        # 验证规则冷却时间是独立的
        规则1 = 切换器.获取规则("战斗规则")
        规则2 = 切换器.获取规则("采集规则")
        
        assert 规则1 is not None, "战斗规则应该存在"
        assert 规则2 is not None, "采集规则应该存在"
        assert 规则1.冷却时间 == 规则冷却时间, "战斗规则冷却时间应正确"
        assert 规则2.冷却时间 == 规则冷却时间 * 2, "采集规则冷却时间应正确"
        
        # 清理
        管理器.关闭()
    
    def test_禁用自动切换时不触发(self):
        """
        测试：禁用自动切换时，不应触发任何切换。
        
        **Feature: model-hot-swap, Property 2: 冷却时间有效性**
        **验证: 需求 3.4**
        """
        from 核心.模型管理 import 自动切换规则
        
        管理器, 切换器 = 创建测试管理器和切换器()
        
        # 添加规则
        切换器.添加规则(自动切换规则(
            名称="战斗规则",
            触发状态=["战斗"],
            目标模型="战斗模型",
            优先级=10,
            冷却时间=0.1
        ))
        
        # 禁用自动切换
        切换器.禁用自动切换()
        
        # 确保初始模型不是战斗模型
        管理器._活动模型 = '任务模型'
        
        # 尝试切换
        结果 = 切换器.执行自动切换("战斗")
        
        # 验证：禁用时不应切换
        assert not 结果, "禁用自动切换时不应触发切换"
        assert 管理器.获取活动模型() == '任务模型', "模型不应改变"
        
        # 启用后应该可以切换
        切换器.启用自动切换()
        结果 = 切换器.执行自动切换("战斗")
        assert 结果, "启用后应该可以切换"
        
        # 清理
        管理器.关闭()
    
    def test_冷却剩余时间计算正确(self):
        """
        测试：冷却剩余时间计算应正确。
        
        **Feature: model-hot-swap, Property 2: 冷却时间有效性**
        **验证: 需求 3.3**
        """
        from 核心.模型管理 import 自动切换规则
        
        管理器, 切换器 = 创建测试管理器和切换器()
        
        冷却时间 = 1.0
        切换器.设置全局冷却时间(冷却时间)
        
        # 添加规则
        切换器.添加规则(自动切换规则(
            名称="战斗规则",
            触发状态=["战斗"],
            目标模型="战斗模型",
            优先级=10,
            冷却时间=冷却时间
        ))
        
        # 确保初始模型不是战斗模型
        管理器._活动模型 = '任务模型'
        
        # 执行切换
        切换器.执行自动切换("战斗")
        
        # 检查冷却剩余时间
        剩余时间 = 切换器.获取冷却剩余时间()
        assert 剩余时间 > 0, "切换后应有冷却剩余时间"
        assert 剩余时间 <= 冷却时间, f"剩余时间 {剩余时间} 不应超过冷却时间 {冷却时间}"
        
        # 等待一段时间后检查
        time.sleep(0.3)
        新剩余时间 = 切换器.获取冷却剩余时间()
        assert 新剩余时间 < 剩余时间, "剩余时间应该减少"
        
        # 等待冷却结束
        time.sleep(冷却时间)
        最终剩余时间 = 切换器.获取冷却剩余时间()
        assert 最终剩余时间 == 0, "冷却结束后剩余时间应为 0"
        
        # 清理
        管理器.关闭()


# ==================== 运行测试 ====================

if __name__ == "__main__":
    pytest.main([__file__, "-v", "--tb=short"])
