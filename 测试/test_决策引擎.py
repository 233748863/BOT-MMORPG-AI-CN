"""
决策引擎模块测试
验证决策引擎的基本功能
"""

import sys
import os
import time

# 添加项目根目录到路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import pytest

from 核心.数据类型 import (
    游戏状态, 决策策略, 检测结果, 决策上下文, 决策结果, 决策规则, 实体类型, 方向
)
from 核心.决策引擎 import 决策引擎
from 核心.决策规则 import 获取所有规则, 获取战斗规则, 获取紧急规则


class Test决策引擎初始化:
    """测试决策引擎初始化"""
    
    def test_默认初始化(self):
        """测试默认初始化"""
        引擎 = 决策引擎()
        assert 引擎 is not None
        assert 引擎.策略 == 决策策略.混合加权
    
    def test_指定策略初始化(self):
        """测试指定策略初始化"""
        引擎 = 决策引擎(策略=决策策略.规则优先)
        assert 引擎.策略 == 决策策略.规则优先
        
        引擎2 = 决策引擎(策略=决策策略.模型优先)
        assert 引擎2.策略 == 决策策略.模型优先


class Test规则管理:
    """测试规则管理功能"""
    
    def test_添加规则(self):
        """测试添加规则"""
        引擎 = 决策引擎()
        
        规则 = 决策规则(
            名称="测试规则",
            优先级=50,
            条件=lambda ctx: True,
            动作=0,
            冷却时间=0.0
        )
        
        引擎.添加规则(规则)
        assert len(引擎.规则列表) == 1
        assert 引擎.规则列表[0].名称 == "测试规则"
    
    def test_规则优先级排序(self):
        """测试规则按优先级排序"""
        引擎 = 决策引擎()
        
        规则1 = 决策规则(名称="低优先级", 优先级=10, 条件=lambda ctx: True, 动作=0)
        规则2 = 决策规则(名称="高优先级", 优先级=100, 条件=lambda ctx: True, 动作=1)
        规则3 = 决策规则(名称="中优先级", 优先级=50, 条件=lambda ctx: True, 动作=2)
        
        引擎.添加规则(规则1)
        引擎.添加规则(规则2)
        引擎.添加规则(规则3)
        
        # 验证按优先级降序排列
        assert 引擎.规则列表[0].名称 == "高优先级"
        assert 引擎.规则列表[1].名称 == "中优先级"
        assert 引擎.规则列表[2].名称 == "低优先级"
    
    def test_移除规则(self):
        """测试移除规则"""
        引擎 = 决策引擎()
        
        规则 = 决策规则(名称="测试规则", 优先级=50, 条件=lambda ctx: True, 动作=0)
        引擎.添加规则(规则)
        
        assert len(引擎.规则列表) == 1
        
        结果 = 引擎.移除规则("测试规则")
        assert 结果 == True
        assert len(引擎.规则列表) == 0
    
    def test_清空规则(self):
        """测试清空规则"""
        引擎 = 决策引擎()
        
        for i in range(5):
            规则 = 决策规则(名称=f"规则{i}", 优先级=i*10, 条件=lambda ctx: True, 动作=i)
            引擎.添加规则(规则)
        
        assert len(引擎.规则列表) == 5
        
        引擎.清空规则()
        assert len(引擎.规则列表) == 0


class Test状态动作权重:
    """测试状态-动作权重映射"""
    
    def test_战斗状态权重(self):
        """测试战斗状态下的动作权重"""
        引擎 = 决策引擎()
        权重 = 引擎.获取状态动作权重(游戏状态.战斗)
        
        assert isinstance(权重, list)
        assert len(权重) == 32  # 32维动作
    
    def test_对话状态权重(self):
        """测试对话状态下的动作权重"""
        引擎 = 决策引擎()
        权重 = 引擎.获取状态动作权重(游戏状态.对话)
        
        assert isinstance(权重, list)
        assert len(权重) == 32
    
    def test_不同状态权重不同(self):
        """测试不同状态的权重不同"""
        引擎 = 决策引擎()
        
        战斗权重 = 引擎.获取状态动作权重(游戏状态.战斗)
        对话权重 = 引擎.获取状态动作权重(游戏状态.对话)
        
        # 战斗和对话状态的权重应该不同
        assert 战斗权重 != 对话权重


class Test动作冷却:
    """测试动作冷却机制"""
    
    def test_无冷却动作(self):
        """测试无冷却的动作"""
        引擎 = 决策引擎()
        
        # 动作0没有配置冷却时间，应该始终可执行
        assert 引擎.检查冷却(0) == True
    
    def test_冷却中的动作(self):
        """测试冷却中的动作"""
        引擎 = 决策引擎()
        
        # 记录动作9的执行（技能1，有1秒冷却）
        引擎.记录动作执行(9)
        
        # 立即检查应该在冷却中
        # 注意：这取决于配置中动作9是否有冷却时间
        # 如果有冷却时间，应该返回False
        结果 = 引擎.检查冷却(9)
        # 由于冷却时间可能很短，这里只验证函数能正常执行
        assert isinstance(结果, bool)
    
    def test_重置冷却(self):
        """测试重置冷却"""
        引擎 = 决策引擎()
        
        引擎.记录动作执行(9)
        引擎.记录动作执行(10)
        
        引擎.重置冷却()
        
        # 重置后所有动作都应该可执行
        assert 引擎.检查冷却(9) == True
        assert 引擎.检查冷却(10) == True


class Test决策日志:
    """测试决策日志功能"""
    
    def test_决策记录日志(self):
        """测试决策过程记录日志"""
        引擎 = 决策引擎()
        
        上下文 = 决策上下文(
            游戏状态=游戏状态.空闲,
            检测结果=[],
            模型预测=[0.1] * 32,
            血量百分比=1.0,
            附近敌人数量=0
        )
        
        # 执行决策
        结果 = 引擎.决策(上下文)
        
        # 检查日志
        日志 = 引擎.获取决策日志(10)
        assert len(日志) >= 1
        assert 日志[-1].最终决策 is not None
    
    def test_日志包含完整信息(self):
        """测试日志包含完整信息"""
        引擎 = 决策引擎()
        
        上下文 = 决策上下文(
            游戏状态=游戏状态.战斗,
            检测结果=[],
            模型预测=[0.1] * 32,
            血量百分比=0.8,
            附近敌人数量=1
        )
        
        引擎.决策(上下文)
        
        日志 = 引擎.获取决策日志(1)
        assert len(日志) == 1
        
        日志条目 = 日志[0]
        assert 日志条目.时间戳 > 0
        assert 日志条目.上下文 is not None
        assert 日志条目.候选动作 is not None
        assert 日志条目.最终决策 is not None
    
    def test_清空日志(self):
        """测试清空日志"""
        引擎 = 决策引擎()
        
        上下文 = 决策上下文(游戏状态=游戏状态.空闲)
        
        for _ in range(5):
            引擎.决策(上下文)
        
        assert len(引擎.获取决策日志(10)) >= 5
        
        引擎.清空日志()
        assert len(引擎.获取决策日志(10)) == 0


class Test决策执行:
    """测试决策执行"""
    
    def test_基本决策(self):
        """测试基本决策功能"""
        引擎 = 决策引擎()
        
        上下文 = 决策上下文(
            游戏状态=游戏状态.空闲,
            检测结果=[],
            模型预测=[0.1] * 32,
            血量百分比=1.0,
            附近敌人数量=0
        )
        
        结果 = 引擎.决策(上下文)
        
        assert isinstance(结果, 决策结果)
        assert 结果.动作索引 >= 0
        assert 结果.动作名称 is not None
        assert 结果.来源 in ("rule", "model", "mixed")
        assert 0.0 <= 结果.置信度 <= 1.0
    
    def test_规则优先决策(self):
        """测试规则优先策略"""
        引擎 = 决策引擎(策略=决策策略.规则优先)
        
        # 添加一个始终匹配的规则
        规则 = 决策规则(
            名称="始终匹配",
            优先级=100,
            条件=lambda ctx: True,
            动作=5,
            冷却时间=0.0
        )
        引擎.添加规则(规则)
        
        上下文 = 决策上下文(游戏状态=游戏状态.空闲)
        
        结果 = 引擎.决策(上下文)
        
        # 规则应该被匹配
        assert 结果.动作索引 == 5
        assert 结果.来源 == "rule"
    
    def test_紧急规则触发(self):
        """测试紧急规则触发"""
        引擎 = 决策引擎()
        
        # 创建低血量上下文
        上下文 = 决策上下文(
            游戏状态=游戏状态.战斗,
            检测结果=[],
            模型预测=[0.1] * 32,
            血量百分比=0.2,  # 低于30%阈值
            附近敌人数量=1
        )
        
        结果 = 引擎.决策(上下文)
        
        # 应该触发紧急规则
        assert 结果.来源 == "rule"
        assert "紧急" in 结果.原因


class Test预定义规则:
    """测试预定义规则集"""
    
    def test_获取所有规则(self):
        """测试获取所有规则"""
        规则列表 = 获取所有规则()
        
        assert isinstance(规则列表, list)
        assert len(规则列表) > 0
        
        for 规则 in 规则列表:
            assert isinstance(规则, 决策规则)
            assert 规则.名称 is not None
            assert 规则.优先级 >= 0
    
    def test_获取战斗规则(self):
        """测试获取战斗规则"""
        规则列表 = 获取战斗规则()
        
        assert isinstance(规则列表, list)
        assert len(规则列表) > 0
        
        for 规则 in 规则列表:
            assert "战斗" in 规则.名称
    
    def test_获取紧急规则(self):
        """测试获取紧急规则"""
        规则列表 = 获取紧急规则()
        
        assert isinstance(规则列表, list)
        assert len(规则列表) > 0
        
        for 规则 in 规则列表:
            assert "紧急" in 规则.名称


class Test统计信息:
    """测试统计信息功能"""
    
    def test_获取统计信息(self):
        """测试获取统计信息"""
        引擎 = 决策引擎()
        
        统计 = 引擎.获取统计信息()
        
        assert isinstance(统计, dict)
        assert "总决策数" in 统计
        assert "规则决策数" in 统计
        assert "模型决策数" in 统计
        assert "规则数量" in 统计
    
    def test_统计信息更新(self):
        """测试统计信息随决策更新"""
        引擎 = 决策引擎()
        
        上下文 = 决策上下文(游戏状态=游戏状态.空闲)
        
        初始统计 = 引擎.获取统计信息()
        assert 初始统计["总决策数"] == 0
        
        # 执行几次决策
        for _ in range(3):
            引擎.决策(上下文)
        
        更新统计 = 引擎.获取统计信息()
        assert 更新统计["总决策数"] == 3


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
