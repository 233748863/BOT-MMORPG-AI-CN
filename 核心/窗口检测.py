"""
è‡ªåŠ¨çª—å£æ£€æµ‹æ¨¡å—
è‡ªåŠ¨æ£€æµ‹å’Œè·Ÿè¸ªæ¸¸æˆçª—å£

åŠŸèƒ½:
- æŒ‰è¿›ç¨‹å/æ ‡é¢˜æŸ¥æ‰¾çª—å£
- çª—å£ä½ç½®è·Ÿè¸ª
- ç‚¹å‡»é€‰æ‹©æ¨¡å¼
- é…ç½®ä¿å­˜å’ŒåŠ è½½
"""

import os
import json
import time
import ctypes
import ctypes.wintypes
import threading
from typing import Dict, List, Optional, Tuple, Callable, Any
from dataclasses import dataclass, asdict
from datetime import datetime
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
æ—¥å¿— = logging.getLogger(__name__)

# Windows API å¸¸é‡
GWL_STYLE = -16
WS_VISIBLE = 0x10000000
WS_MINIMIZE = 0x20000000
DWMWA_EXTENDED_FRAME_BOUNDS = 9


@dataclass
class çª—å£ä¿¡æ¯:
    """çª—å£ä¿¡æ¯æ•°æ®ç±»"""
    å¥æŸ„: int
    æ ‡é¢˜: str
    è¿›ç¨‹å: str
    è¿›ç¨‹ID: int
    ä½ç½®: Tuple[int, int]  # (x, y)
    å¤§å°: Tuple[int, int]  # (width, height)
    æ˜¯å¦å¯è§: bool = True
    æ˜¯å¦æœ€å°åŒ–: bool = False
    
    def è·å–åŒºåŸŸ(self) -> Tuple[int, int, int, int]:
        """è·å–æˆªå–åŒºåŸŸ (x, y, width, height)"""
        return (self.ä½ç½®[0], self.ä½ç½®[1], self.å¤§å°[0], self.å¤§å°[1])
    
    def to_dict(self) -> dict:
        return asdict(self)


class çª—å£æŸ¥æ‰¾å™¨:
    """æŸ¥æ‰¾å’Œå®šä½æ¸¸æˆçª—å£"""
    
    def __init__(self):
        self._user32 = ctypes.windll.user32
        self._kernel32 = ctypes.windll.kernel32
        self._psapi = ctypes.windll.psapi
    
    def æŒ‰è¿›ç¨‹åæŸ¥æ‰¾(self, è¿›ç¨‹å: str) -> List[çª—å£ä¿¡æ¯]:
        """
        é€šè¿‡è¿›ç¨‹åæŸ¥æ‰¾çª—å£
        
        å‚æ•°:
            è¿›ç¨‹å: è¿›ç¨‹åç§°ï¼ˆå¦‚ "game.exe"ï¼‰
            
        è¿”å›:
            åŒ¹é…çš„çª—å£ä¿¡æ¯åˆ—è¡¨
        """
        æ‰€æœ‰çª—å£ = self.è·å–æ‰€æœ‰çª—å£()
        è¿›ç¨‹åå°å†™ = è¿›ç¨‹å.lower()
        
        åŒ¹é…çª—å£ = [w for w in æ‰€æœ‰çª—å£ if è¿›ç¨‹åå°å†™ in w.è¿›ç¨‹å.lower()]
        return åŒ¹é…çª—å£
    
    def æŒ‰æ ‡é¢˜æŸ¥æ‰¾(self, æ ‡é¢˜: str, æ¨¡ç³ŠåŒ¹é…: bool = True) -> List[çª—å£ä¿¡æ¯]:
        """
        é€šè¿‡çª—å£æ ‡é¢˜æŸ¥æ‰¾çª—å£
        
        å‚æ•°:
            æ ‡é¢˜: çª—å£æ ‡é¢˜ï¼ˆæ”¯æŒéƒ¨åˆ†åŒ¹é…ï¼‰
            æ¨¡ç³ŠåŒ¹é…: æ˜¯å¦å¯ç”¨æ¨¡ç³ŠåŒ¹é…
            
        è¿”å›:
            åŒ¹é…çš„çª—å£ä¿¡æ¯åˆ—è¡¨
        """
        æ‰€æœ‰çª—å£ = self.è·å–æ‰€æœ‰çª—å£()
        æ ‡é¢˜å°å†™ = æ ‡é¢˜.lower()
        
        if æ¨¡ç³ŠåŒ¹é…:
            åŒ¹é…çª—å£ = [w for w in æ‰€æœ‰çª—å£ if æ ‡é¢˜å°å†™ in w.æ ‡é¢˜.lower()]
        else:
            åŒ¹é…çª—å£ = [w for w in æ‰€æœ‰çª—å£ if w.æ ‡é¢˜.lower() == æ ‡é¢˜å°å†™]
        
        return åŒ¹é…çª—å£
    
    def è·å–æ‰€æœ‰çª—å£(self, ä»…å¯è§: bool = True) -> List[çª—å£ä¿¡æ¯]:
        """
        è·å–æ‰€æœ‰çª—å£åˆ—è¡¨
        
        å‚æ•°:
            ä»…å¯è§: æ˜¯å¦åªè¿”å›å¯è§çª—å£
            
        è¿”å›:
            çª—å£ä¿¡æ¯åˆ—è¡¨
        """
        çª—å£åˆ—è¡¨ = []
        
        def æšä¸¾å›è°ƒ(å¥æŸ„, _):
            try:
                ä¿¡æ¯ = self.è·å–çª—å£ä¿¡æ¯(å¥æŸ„)
                if ä¿¡æ¯:
                    if not ä»…å¯è§ or ä¿¡æ¯.æ˜¯å¦å¯è§:
                        çª—å£åˆ—è¡¨.append(ä¿¡æ¯)
            except:
                pass
            return True
        
        æšä¸¾å‡½æ•°ç±»å‹ = ctypes.WINFUNCTYPE(ctypes.c_bool, ctypes.c_int, ctypes.c_int)
        self._user32.EnumWindows(æšä¸¾å‡½æ•°ç±»å‹(æšä¸¾å›è°ƒ), 0)
        
        return çª—å£åˆ—è¡¨
    
    def è·å–çª—å£ä¿¡æ¯(self, å¥æŸ„: int) -> Optional[çª—å£ä¿¡æ¯]:
        """
        è·å–æŒ‡å®šçª—å£çš„è¯¦ç»†ä¿¡æ¯
        
        å‚æ•°:
            å¥æŸ„: çª—å£å¥æŸ„
            
        è¿”å›:
            çª—å£ä¿¡æ¯ï¼Œæ— æ•ˆå¥æŸ„è¿”å› None
        """
        if not self._user32.IsWindow(å¥æŸ„):
            return None
        
        # è·å–æ ‡é¢˜
        é•¿åº¦ = self._user32.GetWindowTextLengthW(å¥æŸ„) + 1
        ç¼“å†²åŒº = ctypes.create_unicode_buffer(é•¿åº¦)
        self._user32.GetWindowTextW(å¥æŸ„, ç¼“å†²åŒº, é•¿åº¦)
        æ ‡é¢˜ = ç¼“å†²åŒº.value
        
        # è·³è¿‡æ— æ ‡é¢˜çª—å£
        if not æ ‡é¢˜:
            return None
        
        # è·å–è¿›ç¨‹ä¿¡æ¯
        è¿›ç¨‹ID = ctypes.c_ulong()
        self._user32.GetWindowThreadProcessId(å¥æŸ„, ctypes.byref(è¿›ç¨‹ID))
        è¿›ç¨‹å = self._è·å–è¿›ç¨‹å(è¿›ç¨‹ID.value)
        
        # è·å–çª—å£ä½ç½®å’Œå¤§å°
        çŸ©å½¢ = ctypes.wintypes.RECT()
        self._user32.GetWindowRect(å¥æŸ„, ctypes.byref(çŸ©å½¢))
        
        ä½ç½® = (çŸ©å½¢.left, çŸ©å½¢.top)
        å¤§å° = (çŸ©å½¢.right - çŸ©å½¢.left, çŸ©å½¢.bottom - çŸ©å½¢.top)
        
        # æ£€æŸ¥å¯è§æ€§
        æ ·å¼ = self._user32.GetWindowLongW(å¥æŸ„, GWL_STYLE)
        æ˜¯å¦å¯è§ = bool(æ ·å¼ & WS_VISIBLE)
        æ˜¯å¦æœ€å°åŒ– = bool(æ ·å¼ & WS_MINIMIZE)
        
        return çª—å£ä¿¡æ¯(
            å¥æŸ„=å¥æŸ„, æ ‡é¢˜=æ ‡é¢˜, è¿›ç¨‹å=è¿›ç¨‹å,
            è¿›ç¨‹ID=è¿›ç¨‹ID.value, ä½ç½®=ä½ç½®, å¤§å°=å¤§å°,
            æ˜¯å¦å¯è§=æ˜¯å¦å¯è§, æ˜¯å¦æœ€å°åŒ–=æ˜¯å¦æœ€å°åŒ–
        )

    def è·å–çª—å£ç¼©ç•¥å›¾(self, å¥æŸ„: int, å¤§å°: Tuple[int, int] = (200, 150)) -> Optional[Any]:
        """
        è·å–çª—å£ç¼©ç•¥å›¾
        
        å‚æ•°:
            å¥æŸ„: çª—å£å¥æŸ„
            å¤§å°: ç¼©ç•¥å›¾å¤§å° (å®½åº¦, é«˜åº¦)
            
        è¿”å›:
            ç¼©ç•¥å›¾å›¾åƒ (numpy æ•°ç»„)ï¼Œå¤±è´¥è¿”å› None
        """
        try:
            import numpy as np
            from PIL import Image
            import win32gui
            import win32ui
            import win32con
            
            if not self._user32.IsWindow(å¥æŸ„):
                return None
            
            # è·å–çª—å£å°ºå¯¸
            çŸ©å½¢ = ctypes.wintypes.RECT()
            self._user32.GetWindowRect(å¥æŸ„, ctypes.byref(çŸ©å½¢))
            å®½åº¦ = çŸ©å½¢.right - çŸ©å½¢.left
            é«˜åº¦ = çŸ©å½¢.bottom - çŸ©å½¢.top
            
            if å®½åº¦ <= 0 or é«˜åº¦ <= 0:
                return None
            
            # åˆ›å»ºè®¾å¤‡ä¸Šä¸‹æ–‡
            çª—å£DC = win32gui.GetWindowDC(å¥æŸ„)
            å†…å­˜DC = win32ui.CreateDCFromHandle(çª—å£DC)
            å…¼å®¹DC = å†…å­˜DC.CreateCompatibleDC()
            
            # åˆ›å»ºä½å›¾
            ä½å›¾ = win32ui.CreateBitmap()
            ä½å›¾.CreateCompatibleBitmap(å†…å­˜DC, å®½åº¦, é«˜åº¦)
            å…¼å®¹DC.SelectObject(ä½å›¾)
            
            # å¤åˆ¶çª—å£å†…å®¹
            å…¼å®¹DC.BitBlt((0, 0), (å®½åº¦, é«˜åº¦), å†…å­˜DC, (0, 0), win32con.SRCCOPY)
            
            # è½¬æ¢ä¸º numpy æ•°ç»„
            ä½å›¾ä¿¡æ¯ = ä½å›¾.GetInfo()
            ä½å›¾æ•°æ® = ä½å›¾.GetBitmapBits(True)
            
            å›¾åƒ = np.frombuffer(ä½å›¾æ•°æ®, dtype=np.uint8)
            å›¾åƒ = å›¾åƒ.reshape((ä½å›¾ä¿¡æ¯['bmHeight'], ä½å›¾ä¿¡æ¯['bmWidth'], 4))
            å›¾åƒ = å›¾åƒ[:, :, :3]  # ç§»é™¤ alpha é€šé“
            å›¾åƒ = å›¾åƒ[:, :, ::-1]  # BGR -> RGB
            
            # æ¸…ç†èµ„æº
            win32gui.DeleteObject(ä½å›¾.GetHandle())
            å…¼å®¹DC.DeleteDC()
            å†…å­˜DC.DeleteDC()
            win32gui.ReleaseDC(å¥æŸ„, çª—å£DC)
            
            # ç¼©æ”¾åˆ°æŒ‡å®šå¤§å°
            PILå›¾åƒ = Image.fromarray(å›¾åƒ)
            PILå›¾åƒ = PILå›¾åƒ.resize(å¤§å°, Image.Resampling.LANCZOS)
            
            return np.array(PILå›¾åƒ)
            
        except ImportError:
            æ—¥å¿—.warning("è·å–ç¼©ç•¥å›¾éœ€è¦å®‰è£… pywin32 å’Œ Pillow åº“")
            return None
        except Exception as e:
            æ—¥å¿—.error(f"è·å–çª—å£ç¼©ç•¥å›¾å¤±è´¥: {e}")
            return None

    def _è·å–è¿›ç¨‹å(self, è¿›ç¨‹ID: int) -> str:
        """è·å–è¿›ç¨‹åç§°"""
        try:
            PROCESS_QUERY_INFORMATION = 0x0400
            PROCESS_VM_READ = 0x0010
            
            è¿›ç¨‹å¥æŸ„ = self._kernel32.OpenProcess(
                PROCESS_QUERY_INFORMATION | PROCESS_VM_READ, False, è¿›ç¨‹ID
            )
            
            if è¿›ç¨‹å¥æŸ„:
                ç¼“å†²åŒº = ctypes.create_unicode_buffer(260)
                self._psapi.GetModuleBaseNameW(è¿›ç¨‹å¥æŸ„, None, ç¼“å†²åŒº, 260)
                self._kernel32.CloseHandle(è¿›ç¨‹å¥æŸ„)
                return ç¼“å†²åŒº.value or "æœªçŸ¥"
        except:
            pass
        return "æœªçŸ¥"
    
    def è·å–å‰å°çª—å£(self) -> Optional[çª—å£ä¿¡æ¯]:
        """è·å–å½“å‰å‰å°çª—å£"""
        å¥æŸ„ = self._user32.GetForegroundWindow()
        return self.è·å–çª—å£ä¿¡æ¯(å¥æŸ„)
    
    def è·å–é¼ æ ‡ä½ç½®çª—å£(self) -> Optional[çª—å£ä¿¡æ¯]:
        """è·å–é¼ æ ‡ä½ç½®ä¸‹çš„çª—å£"""
        ç‚¹ = ctypes.wintypes.POINT()
        self._user32.GetCursorPos(ctypes.byref(ç‚¹))
        å¥æŸ„ = self._user32.WindowFromPoint(ç‚¹)
        
        # è·å–é¡¶å±‚çª—å£
        é¡¶å±‚å¥æŸ„ = self._user32.GetAncestor(å¥æŸ„, 2)  # GA_ROOT = 2
        return self.è·å–çª—å£ä¿¡æ¯(é¡¶å±‚å¥æŸ„ or å¥æŸ„)


@dataclass
class çª—å£å˜åŒ–äº‹ä»¶:
    """çª—å£å˜åŒ–äº‹ä»¶æ•°æ®ç±»"""
    ç±»å‹: str  # "ç§»åŠ¨" / "è°ƒæ•´å¤§å°" / "å…³é—­"
    çª—å£ä¿¡æ¯: Optional[çª—å£ä¿¡æ¯]
    æ—§ä½ç½®: Optional[Tuple[int, int]] = None
    æ–°ä½ç½®: Optional[Tuple[int, int]] = None
    æ—§å¤§å°: Optional[Tuple[int, int]] = None
    æ–°å¤§å°: Optional[Tuple[int, int]] = None
    æ—¶é—´æˆ³: str = ""
    
    def __post_init__(self):
        if not self.æ—¶é—´æˆ³:
            self.æ—¶é—´æˆ³ = datetime.now().isoformat()


class çª—å£è·Ÿè¸ªå™¨:
    """
    è·Ÿè¸ªçª—å£ä½ç½®å˜åŒ–
    
    åŠŸèƒ½:
    - åå°çº¿ç¨‹æŒç»­è·Ÿè¸ªçª—å£çŠ¶æ€
    - æ£€æµ‹çª—å£ä½ç½®å˜åŒ–
    - æ£€æµ‹çª—å£å¤§å°å˜åŒ–
    - æ£€æµ‹çª—å£å…³é—­
    - é€šè¿‡å›è°ƒé€šçŸ¥å˜åŒ–äº‹ä»¶
    """
    
    def __init__(self, å¥æŸ„: int, 
                 ä½ç½®å˜åŒ–å›è°ƒ: Callable[[çª—å£å˜åŒ–äº‹ä»¶], None] = None,
                 å¤§å°å˜åŒ–å›è°ƒ: Callable[[çª—å£å˜åŒ–äº‹ä»¶], None] = None,
                 çª—å£å…³é—­å›è°ƒ: Callable[[çª—å£å˜åŒ–äº‹ä»¶], None] = None,
                 é€šç”¨å›è°ƒ: Callable[[çª—å£ä¿¡æ¯], None] = None):
        """
        åˆå§‹åŒ–è·Ÿè¸ªå™¨
        
        å‚æ•°:
            å¥æŸ„: è¦è·Ÿè¸ªçš„çª—å£å¥æŸ„
            ä½ç½®å˜åŒ–å›è°ƒ: çª—å£ä½ç½®å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°
            å¤§å°å˜åŒ–å›è°ƒ: çª—å£å¤§å°å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°
            çª—å£å…³é—­å›è°ƒ: çª—å£å…³é—­æ—¶çš„å›è°ƒå‡½æ•°
            é€šç”¨å›è°ƒ: ä»»ä½•å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
        """
        self._å¥æŸ„ = å¥æŸ„
        self._ä½ç½®å˜åŒ–å›è°ƒ = ä½ç½®å˜åŒ–å›è°ƒ
        self._å¤§å°å˜åŒ–å›è°ƒ = å¤§å°å˜åŒ–å›è°ƒ
        self._çª—å£å…³é—­å›è°ƒ = çª—å£å…³é—­å›è°ƒ
        self._é€šç”¨å›è°ƒ = é€šç”¨å›è°ƒ
        self._æŸ¥æ‰¾å™¨ = çª—å£æŸ¥æ‰¾å™¨()
        self._è¿è¡Œä¸­ = False
        self._çº¿ç¨‹: Optional[threading.Thread] = None
        self._ä¸Šæ¬¡ä½ç½®: Optional[Tuple[int, int]] = None
        self._ä¸Šæ¬¡å¤§å°: Optional[Tuple[int, int]] = None
        self._ä¸Šæ¬¡åŒºåŸŸ: Optional[Tuple[int, int, int, int]] = None
        self._æ£€æŸ¥é—´éš” = 0.5  # ç§’
        self._é” = threading.Lock()
        self._å˜åŒ–å†å²: List[çª—å£å˜åŒ–äº‹ä»¶] = []
        self._æœ€å¤§å†å²è®°å½• = 100
        
        # åˆå§‹åŒ–ä½ç½®ä¿¡æ¯
        self._åˆå§‹åŒ–ä½ç½®()
    
    def _åˆå§‹åŒ–ä½ç½®(self):
        """åˆå§‹åŒ–çª—å£ä½ç½®ä¿¡æ¯"""
        ä¿¡æ¯ = self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(self._å¥æŸ„)
        if ä¿¡æ¯:
            self._ä¸Šæ¬¡ä½ç½® = ä¿¡æ¯.ä½ç½®
            self._ä¸Šæ¬¡å¤§å° = ä¿¡æ¯.å¤§å°
            self._ä¸Šæ¬¡åŒºåŸŸ = ä¿¡æ¯.è·å–åŒºåŸŸ()
    
    @property
    def å¥æŸ„(self) -> int:
        """è·å–è·Ÿè¸ªçš„çª—å£å¥æŸ„"""
        return self._å¥æŸ„
    
    @property
    def æ˜¯å¦è¿è¡Œä¸­(self) -> bool:
        """æ£€æŸ¥è·Ÿè¸ªå™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ"""
        return self._è¿è¡Œä¸­
    
    @property
    def æ£€æŸ¥é—´éš”(self) -> float:
        """è·å–æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰"""
        return self._æ£€æŸ¥é—´éš”
    
    @æ£€æŸ¥é—´éš”.setter
    def æ£€æŸ¥é—´éš”(self, å€¼: float):
        """è®¾ç½®æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰"""
        if å€¼ > 0:
            self._æ£€æŸ¥é—´éš” = å€¼
    
    def å¯åŠ¨(self):
        """å¯åŠ¨ä½ç½®è·Ÿè¸ªï¼ˆåå°çº¿ç¨‹ï¼‰"""
        if self._è¿è¡Œä¸­:
            æ—¥å¿—.warning("è·Ÿè¸ªå™¨å·²åœ¨è¿è¡Œä¸­")
            return
        
        if not self.çª—å£æ˜¯å¦å­˜åœ¨():
            æ—¥å¿—.error("çª—å£ä¸å­˜åœ¨ï¼Œæ— æ³•å¯åŠ¨è·Ÿè¸ª")
            return
        
        self._è¿è¡Œä¸­ = True
        self._åˆå§‹åŒ–ä½ç½®()
        self._çº¿ç¨‹ = threading.Thread(target=self._è·Ÿè¸ªå¾ªç¯, daemon=True, name="çª—å£è·Ÿè¸ªçº¿ç¨‹")
        self._çº¿ç¨‹.start()
        æ—¥å¿—.info(f"çª—å£è·Ÿè¸ªå·²å¯åŠ¨: å¥æŸ„={self._å¥æŸ„}")
    
    def åœæ­¢(self):
        """åœæ­¢ä½ç½®è·Ÿè¸ª"""
        if not self._è¿è¡Œä¸­:
            return
        
        self._è¿è¡Œä¸­ = False
        if self._çº¿ç¨‹ and self._çº¿ç¨‹.is_alive():
            self._çº¿ç¨‹.join(timeout=2.0)
        self._çº¿ç¨‹ = None
        æ—¥å¿—.info("çª—å£è·Ÿè¸ªå·²åœæ­¢")
    
    def _è·Ÿè¸ªå¾ªç¯(self):
        """è·Ÿè¸ªå¾ªç¯ - åå°çº¿ç¨‹æ‰§è¡Œ"""
        while self._è¿è¡Œä¸­:
            try:
                self._æ£€æŸ¥çª—å£çŠ¶æ€()
                time.sleep(self._æ£€æŸ¥é—´éš”)
            except Exception as e:
                æ—¥å¿—.error(f"è·Ÿè¸ªé”™è¯¯: {e}")
                time.sleep(1.0)
    
    def _æ£€æŸ¥çª—å£çŠ¶æ€(self):
        """æ£€æŸ¥çª—å£çŠ¶æ€å˜åŒ–"""
        # æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨
        if not self.çª—å£æ˜¯å¦å­˜åœ¨():
            self._å¤„ç†çª—å£å…³é—­()
            return
        
        ä¿¡æ¯ = self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(self._å¥æŸ„)
        if ä¿¡æ¯ is None:
            self._å¤„ç†çª—å£å…³é—­()
            return
        
        å½“å‰ä½ç½® = ä¿¡æ¯.ä½ç½®
        å½“å‰å¤§å° = ä¿¡æ¯.å¤§å°
        
        ä½ç½®å·²å˜åŒ– = False
        å¤§å°å·²å˜åŒ– = False
        
        with self._é”:
            # æ£€æµ‹ä½ç½®å˜åŒ–
            if self._ä¸Šæ¬¡ä½ç½® and å½“å‰ä½ç½® != self._ä¸Šæ¬¡ä½ç½®:
                ä½ç½®å·²å˜åŒ– = True
                äº‹ä»¶ = çª—å£å˜åŒ–äº‹ä»¶(
                    ç±»å‹="ç§»åŠ¨",
                    çª—å£ä¿¡æ¯=ä¿¡æ¯,
                    æ—§ä½ç½®=self._ä¸Šæ¬¡ä½ç½®,
                    æ–°ä½ç½®=å½“å‰ä½ç½®
                )
                self._è®°å½•äº‹ä»¶(äº‹ä»¶)
                self._è§¦å‘ä½ç½®å˜åŒ–å›è°ƒ(äº‹ä»¶)
            
            # æ£€æµ‹å¤§å°å˜åŒ–
            if self._ä¸Šæ¬¡å¤§å° and å½“å‰å¤§å° != self._ä¸Šæ¬¡å¤§å°:
                å¤§å°å·²å˜åŒ– = True
                äº‹ä»¶ = çª—å£å˜åŒ–äº‹ä»¶(
                    ç±»å‹="è°ƒæ•´å¤§å°",
                    çª—å£ä¿¡æ¯=ä¿¡æ¯,
                    æ—§å¤§å°=self._ä¸Šæ¬¡å¤§å°,
                    æ–°å¤§å°=å½“å‰å¤§å°
                )
                self._è®°å½•äº‹ä»¶(äº‹ä»¶)
                self._è§¦å‘å¤§å°å˜åŒ–å›è°ƒ(äº‹ä»¶)
            
            # æ›´æ–°è®°å½•
            self._ä¸Šæ¬¡ä½ç½® = å½“å‰ä½ç½®
            self._ä¸Šæ¬¡å¤§å° = å½“å‰å¤§å°
            self._ä¸Šæ¬¡åŒºåŸŸ = ä¿¡æ¯.è·å–åŒºåŸŸ()
        
        # è§¦å‘é€šç”¨å›è°ƒ
        if (ä½ç½®å·²å˜åŒ– or å¤§å°å·²å˜åŒ–) and self._é€šç”¨å›è°ƒ:
            try:
                self._é€šç”¨å›è°ƒ(ä¿¡æ¯)
            except Exception as e:
                æ—¥å¿—.error(f"é€šç”¨å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
    
    def _å¤„ç†çª—å£å…³é—­(self):
        """å¤„ç†çª—å£å…³é—­äº‹ä»¶"""
        æ—¥å¿—.warning("è·Ÿè¸ªçš„çª—å£å·²å…³é—­")
        
        äº‹ä»¶ = çª—å£å˜åŒ–äº‹ä»¶(
            ç±»å‹="å…³é—­",
            çª—å£ä¿¡æ¯=None,
            æ—§ä½ç½®=self._ä¸Šæ¬¡ä½ç½®,
            æ—§å¤§å°=self._ä¸Šæ¬¡å¤§å°
        )
        self._è®°å½•äº‹ä»¶(äº‹ä»¶)
        
        if self._çª—å£å…³é—­å›è°ƒ:
            try:
                self._çª—å£å…³é—­å›è°ƒ(äº‹ä»¶)
            except Exception as e:
                æ—¥å¿—.error(f"çª—å£å…³é—­å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
        
        self._è¿è¡Œä¸­ = False
    
    def _è§¦å‘ä½ç½®å˜åŒ–å›è°ƒ(self, äº‹ä»¶: çª—å£å˜åŒ–äº‹ä»¶):
        """è§¦å‘ä½ç½®å˜åŒ–å›è°ƒ"""
        æ—¥å¿—.info(f"çª—å£ä½ç½®å˜åŒ–: {äº‹ä»¶.æ—§ä½ç½®} -> {äº‹ä»¶.æ–°ä½ç½®}")
        if self._ä½ç½®å˜åŒ–å›è°ƒ:
            try:
                self._ä½ç½®å˜åŒ–å›è°ƒ(äº‹ä»¶)
            except Exception as e:
                æ—¥å¿—.error(f"ä½ç½®å˜åŒ–å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
    
    def _è§¦å‘å¤§å°å˜åŒ–å›è°ƒ(self, äº‹ä»¶: çª—å£å˜åŒ–äº‹ä»¶):
        """è§¦å‘å¤§å°å˜åŒ–å›è°ƒ"""
        æ—¥å¿—.info(f"çª—å£å¤§å°å˜åŒ–: {äº‹ä»¶.æ—§å¤§å°} -> {äº‹ä»¶.æ–°å¤§å°}")
        if self._å¤§å°å˜åŒ–å›è°ƒ:
            try:
                self._å¤§å°å˜åŒ–å›è°ƒ(äº‹ä»¶)
            except Exception as e:
                æ—¥å¿—.error(f"å¤§å°å˜åŒ–å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
    
    def _è®°å½•äº‹ä»¶(self, äº‹ä»¶: çª—å£å˜åŒ–äº‹ä»¶):
        """è®°å½•å˜åŒ–äº‹ä»¶åˆ°å†å²"""
        self._å˜åŒ–å†å².append(äº‹ä»¶)
        # é™åˆ¶å†å²è®°å½•æ•°é‡
        if len(self._å˜åŒ–å†å²) > self._æœ€å¤§å†å²è®°å½•:
            self._å˜åŒ–å†å² = self._å˜åŒ–å†å²[-self._æœ€å¤§å†å²è®°å½•:]
    
    def è·å–å½“å‰ä½ç½®(self) -> Optional[Tuple[int, int, int, int]]:
        """
        è·å–çª—å£å½“å‰ä½ç½®
        
        è¿”å›:
            (x, y, width, height) æˆ– None
        """
        ä¿¡æ¯ = self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(self._å¥æŸ„)
        if ä¿¡æ¯:
            return ä¿¡æ¯.è·å–åŒºåŸŸ()
        return None
    
    def è·å–å½“å‰çª—å£ä¿¡æ¯(self) -> Optional[çª—å£ä¿¡æ¯]:
        """è·å–å½“å‰çª—å£çš„å®Œæ•´ä¿¡æ¯"""
        return self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(self._å¥æŸ„)
    
    def çª—å£æ˜¯å¦å­˜åœ¨(self) -> bool:
        """æ£€æŸ¥çª—å£æ˜¯å¦ä»ç„¶å­˜åœ¨"""
        return ctypes.windll.user32.IsWindow(self._å¥æŸ„) != 0
    
    def çª—å£æ˜¯å¦ç§»åŠ¨(self) -> bool:
        """
        æ£€æŸ¥çª—å£æ˜¯å¦å·²ç§»åŠ¨ï¼ˆç›¸å¯¹äºä¸Šæ¬¡è®°å½•çš„ä½ç½®ï¼‰
        
        è¿”å›:
            True å¦‚æœä½ç½®å·²å˜åŒ–
        """
        å½“å‰ä½ç½® = self.è·å–å½“å‰ä½ç½®()
        if å½“å‰ä½ç½® and self._ä¸Šæ¬¡ä½ç½®:
            return å½“å‰ä½ç½®[:2] != self._ä¸Šæ¬¡ä½ç½®
        return False
    
    def çª—å£æ˜¯å¦è°ƒæ•´å¤§å°(self) -> bool:
        """
        æ£€æŸ¥çª—å£æ˜¯å¦å·²è°ƒæ•´å¤§å°ï¼ˆç›¸å¯¹äºä¸Šæ¬¡è®°å½•çš„å¤§å°ï¼‰
        
        è¿”å›:
            True å¦‚æœå¤§å°å·²å˜åŒ–
        """
        å½“å‰ä½ç½® = self.è·å–å½“å‰ä½ç½®()
        if å½“å‰ä½ç½® and self._ä¸Šæ¬¡å¤§å°:
            å½“å‰å¤§å° = (å½“å‰ä½ç½®[2], å½“å‰ä½ç½®[3])
            return å½“å‰å¤§å° != self._ä¸Šæ¬¡å¤§å°
        return False
    
    def è·å–å˜åŒ–å†å²(self, æ•°é‡: int = 10) -> List[çª—å£å˜åŒ–äº‹ä»¶]:
        """
        è·å–æœ€è¿‘çš„å˜åŒ–å†å²
        
        å‚æ•°:
            æ•°é‡: è¿”å›çš„å†å²è®°å½•æ•°é‡
            
        è¿”å›:
            å˜åŒ–äº‹ä»¶åˆ—è¡¨
        """
        with self._é”:
            return self._å˜åŒ–å†å²[-æ•°é‡:]
    
    def æ¸…é™¤å†å²(self):
        """æ¸…é™¤å˜åŒ–å†å²"""
        with self._é”:
            self._å˜åŒ–å†å².clear()
    
    def è·å–ä¸Šæ¬¡ä½ç½®(self) -> Optional[Tuple[int, int]]:
        """è·å–ä¸Šæ¬¡è®°å½•çš„ä½ç½®"""
        return self._ä¸Šæ¬¡ä½ç½®
    
    def è·å–ä¸Šæ¬¡å¤§å°(self) -> Optional[Tuple[int, int]]:
        """è·å–ä¸Šæ¬¡è®°å½•çš„å¤§å°"""
        return self._ä¸Šæ¬¡å¤§å°
    
    def è·å–ä¸Šæ¬¡åŒºåŸŸ(self) -> Optional[Tuple[int, int, int, int]]:
        """è·å–ä¸Šæ¬¡è®°å½•çš„å®Œæ•´åŒºåŸŸ (x, y, width, height)"""
        return self._ä¸Šæ¬¡åŒºåŸŸ


class çª—å£é€‰æ‹©å™¨:
    """çª—å£é€‰æ‹©ç•Œé¢ï¼ˆå‘½ä»¤è¡Œç‰ˆæœ¬ï¼‰"""
    
    def __init__(self, æŸ¥æ‰¾å™¨: çª—å£æŸ¥æ‰¾å™¨ = None):
        self._æŸ¥æ‰¾å™¨ = æŸ¥æ‰¾å™¨ or çª—å£æŸ¥æ‰¾å™¨()
    
    def æ˜¾ç¤ºåˆ—è¡¨(self, è¿‡æ»¤å…³é”®è¯: str = None) -> Optional[int]:
        """
        æ˜¾ç¤ºçª—å£åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©ï¼ˆå‘½ä»¤è¡Œç‰ˆæœ¬ï¼‰
        
        å‚æ•°:
            è¿‡æ»¤å…³é”®è¯: è¿‡æ»¤çª—å£çš„å…³é”®è¯
            
        è¿”å›:
            é€‰ä¸­çš„çª—å£å¥æŸ„ï¼Œå–æ¶ˆè¿”å› None
        """
        çª—å£åˆ—è¡¨ = self._æŸ¥æ‰¾å™¨.è·å–æ‰€æœ‰çª—å£()
        
        # è¿‡æ»¤
        if è¿‡æ»¤å…³é”®è¯:
            å…³é”®è¯å°å†™ = è¿‡æ»¤å…³é”®è¯.lower()
            çª—å£åˆ—è¡¨ = [w for w in çª—å£åˆ—è¡¨ 
                       if å…³é”®è¯å°å†™ in w.æ ‡é¢˜.lower() or å…³é”®è¯å°å†™ in w.è¿›ç¨‹å.lower()]
        
        if not çª—å£åˆ—è¡¨:
            print("âŒ æœªæ‰¾åˆ°åŒ¹é…çš„çª—å£")
            return None
        
        print("\n" + "=" * 60)
        print("ğŸªŸ å¯ç”¨çª—å£åˆ—è¡¨")
        print("=" * 60)
        
        for i, çª—å£ in enumerate(çª—å£åˆ—è¡¨, 1):
            çŠ¶æ€ = "ğŸ”²" if çª—å£.æ˜¯å¦æœ€å°åŒ– else "ğŸŸ¢"
            print(f"  {i:2d}. {çŠ¶æ€} {çª—å£.æ ‡é¢˜[:30]:<30s}")
            print(f"      è¿›ç¨‹: {çª—å£.è¿›ç¨‹å}, å¤§å°: {çª—å£.å¤§å°[0]}x{çª—å£.å¤§å°[1]}")
        
        print("=" * 60)
        print("  0. å–æ¶ˆé€‰æ‹©")
        
        try:
            é€‰æ‹© = input("\nè¯·è¾“å…¥çª—å£ç¼–å·: ").strip()
            ç´¢å¼• = int(é€‰æ‹©) - 1
            
            if ç´¢å¼• == -1:
                return None
            
            if 0 <= ç´¢å¼• < len(çª—å£åˆ—è¡¨):
                é€‰ä¸­çª—å£ = çª—å£åˆ—è¡¨[ç´¢å¼•]
                print(f"\nâœ… å·²é€‰æ‹©: {é€‰ä¸­çª—å£.æ ‡é¢˜}")
                return é€‰ä¸­çª—å£.å¥æŸ„
            else:
                print("âŒ æ— æ•ˆçš„é€‰æ‹©")
                return None
                
        except ValueError:
            print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
            return None
    
    def ç‚¹å‡»é€‰æ‹©æ¨¡å¼(self, å€’è®¡æ—¶: int = 3) -> Optional[int]:
        """
        å¯åŠ¨ç‚¹å‡»é€‰æ‹©æ¨¡å¼ï¼ˆå‘½ä»¤è¡Œç‰ˆæœ¬ï¼‰
        
        å‚æ•°:
            å€’è®¡æ—¶: è¿›å…¥é€‰æ‹©æ¨¡å¼å‰çš„å€’è®¡æ—¶ç§’æ•°
            
        è¿”å›:
            é€‰ä¸­çš„çª—å£å¥æŸ„
        """
        print("\nğŸ–±ï¸ ç‚¹å‡»é€‰æ‹©æ¨¡å¼")
        print(f"   è¯·åœ¨ {å€’è®¡æ—¶} ç§’åç‚¹å‡»è¦é€‰æ‹©çš„çª—å£...")
        
        for i in range(å€’è®¡æ—¶, 0, -1):
            print(f"   {i}...", end=" ", flush=True)
            time.sleep(1)
        
        print("\n   è¯·ç‚¹å‡»ç›®æ ‡çª—å£!")
        
        # ç­‰å¾…ç”¨æˆ·ç‚¹å‡»
        time.sleep(0.5)
        
        # è·å–å‰å°çª—å£
        çª—å£ = self._æŸ¥æ‰¾å™¨.è·å–å‰å°çª—å£()
        
        if çª—å£:
            print(f"\nâœ… å·²é€‰æ‹©: {çª—å£.æ ‡é¢˜}")
            print(f"   è¿›ç¨‹: {çª—å£.è¿›ç¨‹å}")
            print(f"   ä½ç½®: {çª—å£.ä½ç½®}, å¤§å°: {çª—å£.å¤§å°}")
            return çª—å£.å¥æŸ„
        
        print("âŒ æœªèƒ½è·å–çª—å£ä¿¡æ¯")
        return None
    
    def ç¡®è®¤é€‰æ‹©(self, å¥æŸ„: int) -> bool:
        """ç¡®è®¤çª—å£é€‰æ‹©ï¼ˆå‘½ä»¤è¡Œç‰ˆæœ¬ï¼‰"""
        ä¿¡æ¯ = self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(å¥æŸ„)
        
        if not ä¿¡æ¯:
            print("âŒ çª—å£ä¸å­˜åœ¨")
            return False
        
        print(f"\nç¡®è®¤é€‰æ‹©ä»¥ä¸‹çª—å£?")
        print(f"  æ ‡é¢˜: {ä¿¡æ¯.æ ‡é¢˜}")
        print(f"  è¿›ç¨‹: {ä¿¡æ¯.è¿›ç¨‹å}")
        print(f"  å¤§å°: {ä¿¡æ¯.å¤§å°[0]}x{ä¿¡æ¯.å¤§å°[1]}")
        
        ç¡®è®¤ = input("\nç¡®è®¤? (y/n): ").strip().lower()
        return ç¡®è®¤ == 'y'


@dataclass
class çª—å£é…ç½®é¡¹:
    """çª—å£é…ç½®æ•°æ®ç±»"""
    æ ‡è¯†: str
    æ ‡è¯†ç±»å‹: str  # "process" æˆ– "title"
    æ ‡è¯†å€¼: str
    ä¸Šæ¬¡ä½ç½®: Tuple[int, int, int, int]  # (x, y, width, height)
    è¿›ç¨‹å: str
    æ ‡é¢˜: str
    ä¸Šæ¬¡ä½¿ç”¨: str
    åˆ«å: str = ""  # ç”¨æˆ·è‡ªå®šä¹‰åˆ«å
    å¤‡æ³¨: str = ""  # ç”¨æˆ·å¤‡æ³¨
    
    def to_dict(self) -> dict:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            "æ ‡è¯†ç±»å‹": self.æ ‡è¯†ç±»å‹,
            "æ ‡è¯†å€¼": self.æ ‡è¯†å€¼,
            "ä¸Šæ¬¡ä½ç½®": list(self.ä¸Šæ¬¡ä½ç½®),
            "è¿›ç¨‹å": self.è¿›ç¨‹å,
            "æ ‡é¢˜": self.æ ‡é¢˜,
            "ä¸Šæ¬¡ä½¿ç”¨": self.ä¸Šæ¬¡ä½¿ç”¨,
            "åˆ«å": self.åˆ«å,
            "å¤‡æ³¨": self.å¤‡æ³¨
        }
    
    @classmethod
    def from_dict(cls, æ ‡è¯†: str, æ•°æ®: dict) -> 'çª—å£é…ç½®é¡¹':
        """ä»å­—å…¸åˆ›å»ºé…ç½®é¡¹"""
        return cls(
            æ ‡è¯†=æ ‡è¯†,
            æ ‡è¯†ç±»å‹=æ•°æ®.get("æ ‡è¯†ç±»å‹", "process"),
            æ ‡è¯†å€¼=æ•°æ®.get("æ ‡è¯†å€¼", æ ‡è¯†),
            ä¸Šæ¬¡ä½ç½®=tuple(æ•°æ®.get("ä¸Šæ¬¡ä½ç½®", [0, 0, 800, 600])),
            è¿›ç¨‹å=æ•°æ®.get("è¿›ç¨‹å", ""),
            æ ‡é¢˜=æ•°æ®.get("æ ‡é¢˜", ""),
            ä¸Šæ¬¡ä½¿ç”¨=æ•°æ®.get("ä¸Šæ¬¡ä½¿ç”¨", ""),
            åˆ«å=æ•°æ®.get("åˆ«å", ""),
            å¤‡æ³¨=æ•°æ®.get("å¤‡æ³¨", "")
        )


class çª—å£é…ç½®ç®¡ç†å™¨:
    """
    ç®¡ç†çª—å£é…ç½®çš„ä¿å­˜å’ŒåŠ è½½
    
    åŠŸèƒ½:
    - ä¿å­˜å’ŒåŠ è½½çª—å£é…ç½®
    - æ”¯æŒå¤šé…ç½®ç®¡ç†ï¼ˆä¸ºä¸åŒæ¸¸æˆä¿å­˜é…ç½®ï¼‰
    - è®¾ç½®é»˜è®¤é…ç½®
    - é…ç½®éªŒè¯å’Œè¿ç§»
    - é…ç½®å¤‡ä»½å’Œæ¢å¤
    
    éœ€æ±‚: 4.1, 4.2, 4.3, 4.4
    """
    
    # é…ç½®æ–‡ä»¶ç‰ˆæœ¬ï¼Œç”¨äºè¿ç§»
    _é…ç½®ç‰ˆæœ¬ = "1.0"
    
    def __init__(self, é…ç½®è·¯å¾„: str = "é…ç½®/çª—å£é…ç½®.json"):
        """
        åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
        
        å‚æ•°:
            é…ç½®è·¯å¾„: é…ç½®æ–‡ä»¶è·¯å¾„
        """
        self._é…ç½®è·¯å¾„ = é…ç½®è·¯å¾„
        self._é…ç½®: Dict = self._åˆ›å»ºç©ºé…ç½®()
        self._åŠ è½½é…ç½®æ–‡ä»¶()
    
    def _åˆ›å»ºç©ºé…ç½®(self) -> Dict:
        """åˆ›å»ºç©ºé…ç½®ç»“æ„"""
        return {
            "ç‰ˆæœ¬": self._é…ç½®ç‰ˆæœ¬,
            "é»˜è®¤": None,
            "é…ç½®åˆ—è¡¨": {}
        }
    
    def _åŠ è½½é…ç½®æ–‡ä»¶(self):
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        if os.path.exists(self._é…ç½®è·¯å¾„):
            try:
                with open(self._é…ç½®è·¯å¾„, 'r', encoding='utf-8') as f:
                    åŠ è½½çš„é…ç½® = json.load(f)
                
                # éªŒè¯å¹¶è¿ç§»é…ç½®
                self._é…ç½® = self._éªŒè¯å¹¶è¿ç§»é…ç½®(åŠ è½½çš„é…ç½®)
                æ—¥å¿—.info(f"çª—å£é…ç½®å·²åŠ è½½: {self._é…ç½®è·¯å¾„}")
                
            except json.JSONDecodeError as e:
                æ—¥å¿—.warning(f"é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤é…ç½®: {e}")
                self._é…ç½® = self._åˆ›å»ºç©ºé…ç½®()
            except Exception as e:
                æ—¥å¿—.warning(f"åŠ è½½çª—å£é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®: {e}")
                self._é…ç½® = self._åˆ›å»ºç©ºé…ç½®()
        else:
            æ—¥å¿—.info("çª—å£é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°é…ç½®")
    
    def _éªŒè¯å¹¶è¿ç§»é…ç½®(self, é…ç½®: Dict) -> Dict:
        """
        éªŒè¯é…ç½®æ ¼å¼å¹¶è¿›è¡Œå¿…è¦çš„è¿ç§»
        
        å‚æ•°:
            é…ç½®: åŠ è½½çš„é…ç½®å­—å…¸
            
        è¿”å›:
            éªŒè¯/è¿ç§»åçš„é…ç½®
        """
        # ç¡®ä¿åŸºæœ¬ç»“æ„å­˜åœ¨
        if not isinstance(é…ç½®, dict):
            return self._åˆ›å»ºç©ºé…ç½®()
        
        # æ·»åŠ ç¼ºå¤±çš„å­—æ®µ
        if "ç‰ˆæœ¬" not in é…ç½®:
            é…ç½®["ç‰ˆæœ¬"] = "0.9"  # æ—§ç‰ˆæœ¬
        
        if "é»˜è®¤" not in é…ç½®:
            é…ç½®["é»˜è®¤"] = None
        
        if "é…ç½®åˆ—è¡¨" not in é…ç½®:
            é…ç½®["é…ç½®åˆ—è¡¨"] = {}
        
        # è¿ç§»æ—§ç‰ˆæœ¬é…ç½®
        if é…ç½®.get("ç‰ˆæœ¬") != self._é…ç½®ç‰ˆæœ¬:
            é…ç½® = self._è¿ç§»é…ç½®(é…ç½®)
        
        # éªŒè¯é…ç½®åˆ—è¡¨ä¸­çš„æ¯ä¸ªé¡¹ç›®
        æœ‰æ•ˆé…ç½®åˆ—è¡¨ = {}
        for æ ‡è¯†, é¡¹ç›® in é…ç½®.get("é…ç½®åˆ—è¡¨", {}).items():
            if self._éªŒè¯é…ç½®é¡¹(é¡¹ç›®):
                æœ‰æ•ˆé…ç½®åˆ—è¡¨[æ ‡è¯†] = é¡¹ç›®
            else:
                æ—¥å¿—.warning(f"é…ç½®é¡¹éªŒè¯å¤±è´¥ï¼Œå·²è·³è¿‡: {æ ‡è¯†}")
        
        é…ç½®["é…ç½®åˆ—è¡¨"] = æœ‰æ•ˆé…ç½®åˆ—è¡¨
        
        # éªŒè¯é»˜è®¤é…ç½®æ˜¯å¦å­˜åœ¨
        if é…ç½®.get("é»˜è®¤") and é…ç½®["é»˜è®¤"] not in é…ç½®["é…ç½®åˆ—è¡¨"]:
            æ—¥å¿—.warning(f"é»˜è®¤é…ç½®ä¸å­˜åœ¨ï¼Œå·²æ¸…é™¤: {é…ç½®['é»˜è®¤']}")
            é…ç½®["é»˜è®¤"] = None
        
        return é…ç½®
    
    def _è¿ç§»é…ç½®(self, é…ç½®: Dict) -> Dict:
        """
        è¿ç§»æ—§ç‰ˆæœ¬é…ç½®åˆ°æ–°ç‰ˆæœ¬
        
        å‚æ•°:
            é…ç½®: æ—§ç‰ˆæœ¬é…ç½®
            
        è¿”å›:
            è¿ç§»åçš„é…ç½®
        """
        æ—§ç‰ˆæœ¬ = é…ç½®.get("ç‰ˆæœ¬", "0.9")
        æ—¥å¿—.info(f"è¿ç§»é…ç½®: {æ—§ç‰ˆæœ¬} -> {self._é…ç½®ç‰ˆæœ¬}")
        
        # ä¸ºæ—§é…ç½®é¡¹æ·»åŠ æ–°å­—æ®µ
        for æ ‡è¯†, é¡¹ç›® in é…ç½®.get("é…ç½®åˆ—è¡¨", {}).items():
            if "åˆ«å" not in é¡¹ç›®:
                é¡¹ç›®["åˆ«å"] = ""
            if "å¤‡æ³¨" not in é¡¹ç›®:
                é¡¹ç›®["å¤‡æ³¨"] = ""
        
        é…ç½®["ç‰ˆæœ¬"] = self._é…ç½®ç‰ˆæœ¬
        return é…ç½®
    
    def _éªŒè¯é…ç½®é¡¹(self, é¡¹ç›®: Dict) -> bool:
        """
        éªŒè¯å•ä¸ªé…ç½®é¡¹æ˜¯å¦æœ‰æ•ˆ
        
        å‚æ•°:
            é¡¹ç›®: é…ç½®é¡¹å­—å…¸
            
        è¿”å›:
            æ˜¯å¦æœ‰æ•ˆ
        """
        å¿…éœ€å­—æ®µ = ["æ ‡è¯†ç±»å‹", "æ ‡è¯†å€¼"]
        
        for å­—æ®µ in å¿…éœ€å­—æ®µ:
            if å­—æ®µ not in é¡¹ç›®:
                return False
        
        # éªŒè¯æ ‡è¯†ç±»å‹
        if é¡¹ç›®.get("æ ‡è¯†ç±»å‹") not in ["process", "title"]:
            return False
        
        # éªŒè¯ä½ç½®æ ¼å¼
        ä½ç½® = é¡¹ç›®.get("ä¸Šæ¬¡ä½ç½®")
        if ä½ç½® and (not isinstance(ä½ç½®, (list, tuple)) or len(ä½ç½®) != 4):
            return False
        
        return True
    
    def _ä¿å­˜é…ç½®æ–‡ä»¶(self) -> bool:
        """
        ä¿å­˜é…ç½®æ–‡ä»¶
        
        è¿”å›:
            æ˜¯å¦ä¿å­˜æˆåŠŸ
        """
        try:
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            ç›®å½• = os.path.dirname(self._é…ç½®è·¯å¾„)
            if ç›®å½•:
                os.makedirs(ç›®å½•, exist_ok=True)
            
            # å†™å…¥é…ç½®æ–‡ä»¶
            with open(self._é…ç½®è·¯å¾„, 'w', encoding='utf-8') as f:
                json.dump(self._é…ç½®, f, ensure_ascii=False, indent=2)
            
            æ—¥å¿—.debug(f"çª—å£é…ç½®å·²ä¿å­˜: {self._é…ç½®è·¯å¾„}")
            return True
            
        except Exception as e:
            æ—¥å¿—.error(f"ä¿å­˜çª—å£é…ç½®å¤±è´¥: {e}")
            return False
    
    def ä¿å­˜é…ç½®(self, çª—å£æ ‡è¯†: str, çª—å£ä¿¡æ¯: çª—å£ä¿¡æ¯, 
                åˆ«å: str = "", å¤‡æ³¨: str = "") -> bool:
        """
        ä¿å­˜çª—å£é…ç½®
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦ï¼ˆè¿›ç¨‹åæˆ–æ ‡é¢˜ï¼‰
            çª—å£ä¿¡æ¯: çª—å£ä¿¡æ¯å¯¹è±¡
            åˆ«å: ç”¨æˆ·è‡ªå®šä¹‰åˆ«åï¼ˆå¯é€‰ï¼‰
            å¤‡æ³¨: ç”¨æˆ·å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
            
        è¿”å›:
            æ˜¯å¦ä¿å­˜æˆåŠŸ
            
        éœ€æ±‚: 4.1
        """
        if not çª—å£æ ‡è¯† or not çª—å£ä¿¡æ¯:
            æ—¥å¿—.error("çª—å£æ ‡è¯†å’Œçª—å£ä¿¡æ¯ä¸èƒ½ä¸ºç©º")
            return False
        
        # ç¡®å®šæ ‡è¯†ç±»å‹
        æ ‡è¯†ç±»å‹ = "process" if çª—å£æ ‡è¯† == çª—å£ä¿¡æ¯.è¿›ç¨‹å else "title"
        
        é…ç½®é¡¹ = {
            "æ ‡è¯†ç±»å‹": æ ‡è¯†ç±»å‹,
            "æ ‡è¯†å€¼": çª—å£æ ‡è¯†,
            "ä¸Šæ¬¡ä½ç½®": list(çª—å£ä¿¡æ¯.è·å–åŒºåŸŸ()),
            "è¿›ç¨‹å": çª—å£ä¿¡æ¯.è¿›ç¨‹å,
            "æ ‡é¢˜": çª—å£ä¿¡æ¯.æ ‡é¢˜,
            "ä¸Šæ¬¡ä½¿ç”¨": datetime.now().isoformat(),
            "åˆ«å": åˆ«å,
            "å¤‡æ³¨": å¤‡æ³¨
        }
        
        self._é…ç½®["é…ç½®åˆ—è¡¨"][çª—å£æ ‡è¯†] = é…ç½®é¡¹
        
        if self._ä¿å­˜é…ç½®æ–‡ä»¶():
            æ—¥å¿—.info(f"çª—å£é…ç½®å·²ä¿å­˜: {çª—å£æ ‡è¯†}")
            return True
        return False
    
    def åŠ è½½é…ç½®(self, çª—å£æ ‡è¯†: str = None) -> Optional[Dict]:
        """
        åŠ è½½çª—å£é…ç½®
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦ï¼ŒNone è¡¨ç¤ºåŠ è½½é»˜è®¤é…ç½®
            
        è¿”å›:
            çª—å£é…ç½®å­—å…¸ï¼Œæœªæ‰¾åˆ°è¿”å› None
            
        éœ€æ±‚: 4.2
        """
        # å¦‚æœæœªæŒ‡å®šæ ‡è¯†ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
        if çª—å£æ ‡è¯† is None:
            çª—å£æ ‡è¯† = self._é…ç½®.get("é»˜è®¤")
        
        if çª—å£æ ‡è¯† is None:
            æ—¥å¿—.debug("æœªæŒ‡å®šçª—å£æ ‡è¯†ä¸”æ— é»˜è®¤é…ç½®")
            return None
        
        é…ç½® = self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}).get(çª—å£æ ‡è¯†)
        
        if é…ç½®:
            # æ›´æ–°ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´
            é…ç½®["ä¸Šæ¬¡ä½¿ç”¨"] = datetime.now().isoformat()
            self._ä¿å­˜é…ç½®æ–‡ä»¶()
            æ—¥å¿—.info(f"å·²åŠ è½½çª—å£é…ç½®: {çª—å£æ ‡è¯†}")
        else:
            æ—¥å¿—.warning(f"æœªæ‰¾åˆ°çª—å£é…ç½®: {çª—å£æ ‡è¯†}")
        
        return é…ç½®
    
    def è·å–é…ç½®é¡¹(self, çª—å£æ ‡è¯†: str) -> Optional[çª—å£é…ç½®é¡¹]:
        """
        è·å–é…ç½®é¡¹å¯¹è±¡
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦
            
        è¿”å›:
            çª—å£é…ç½®é¡¹å¯¹è±¡
        """
        é…ç½® = self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}).get(çª—å£æ ‡è¯†)
        if é…ç½®:
            return çª—å£é…ç½®é¡¹.from_dict(çª—å£æ ‡è¯†, é…ç½®)
        return None
    
    def è·å–æ‰€æœ‰é…ç½®(self) -> List[Dict]:
        """
        è·å–æ‰€æœ‰ä¿å­˜çš„çª—å£é…ç½®
        
        è¿”å›:
            é…ç½®åˆ—è¡¨ï¼Œæ¯ä¸ªé…ç½®åŒ…å« "æ ‡è¯†" å­—æ®µ
            
        éœ€æ±‚: 4.3
        """
        é…ç½®åˆ—è¡¨ = []
        for æ ‡è¯†, é…ç½® in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}).items():
            é…ç½®å‰¯æœ¬ = é…ç½®.copy()
            é…ç½®å‰¯æœ¬["æ ‡è¯†"] = æ ‡è¯†
            é…ç½®åˆ—è¡¨.append(é…ç½®å‰¯æœ¬)
        
        # æŒ‰ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´æ’åºï¼ˆæœ€è¿‘ä½¿ç”¨çš„åœ¨å‰ï¼‰
        é…ç½®åˆ—è¡¨.sort(key=lambda x: x.get("ä¸Šæ¬¡ä½¿ç”¨", ""), reverse=True)
        
        return é…ç½®åˆ—è¡¨
    
    def è·å–æ‰€æœ‰é…ç½®é¡¹(self) -> List[çª—å£é…ç½®é¡¹]:
        """
        è·å–æ‰€æœ‰é…ç½®é¡¹å¯¹è±¡
        
        è¿”å›:
            çª—å£é…ç½®é¡¹å¯¹è±¡åˆ—è¡¨
        """
        é…ç½®é¡¹åˆ—è¡¨ = []
        for æ ‡è¯†, é…ç½® in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}).items():
            é…ç½®é¡¹åˆ—è¡¨.append(çª—å£é…ç½®é¡¹.from_dict(æ ‡è¯†, é…ç½®))
        return é…ç½®é¡¹åˆ—è¡¨
    
    def åˆ é™¤é…ç½®(self, çª—å£æ ‡è¯†: str) -> bool:
        """
        åˆ é™¤æŒ‡å®šçª—å£é…ç½®
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦
            
        è¿”å›:
            æ˜¯å¦åˆ é™¤æˆåŠŸ
        """
        if çª—å£æ ‡è¯† not in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}):
            æ—¥å¿—.warning(f"é…ç½®ä¸å­˜åœ¨: {çª—å£æ ‡è¯†}")
            return False
        
        del self._é…ç½®["é…ç½®åˆ—è¡¨"][çª—å£æ ‡è¯†]
        
        # å¦‚æœåˆ é™¤çš„æ˜¯é»˜è®¤é…ç½®ï¼Œæ¸…é™¤é»˜è®¤è®¾ç½®
        if self._é…ç½®.get("é»˜è®¤") == çª—å£æ ‡è¯†:
            self._é…ç½®["é»˜è®¤"] = None
        
        if self._ä¿å­˜é…ç½®æ–‡ä»¶():
            æ—¥å¿—.info(f"çª—å£é…ç½®å·²åˆ é™¤: {çª—å£æ ‡è¯†}")
            return True
        return False
    
    def è®¾ç½®é»˜è®¤(self, çª—å£æ ‡è¯†: str) -> bool:
        """
        è®¾ç½®é»˜è®¤çª—å£é…ç½®
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦
            
        è¿”å›:
            æ˜¯å¦è®¾ç½®æˆåŠŸ
            
        éœ€æ±‚: 4.4
        """
        if çª—å£æ ‡è¯† not in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}):
            æ—¥å¿—.warning(f"é…ç½®ä¸å­˜åœ¨ï¼Œæ— æ³•è®¾ç½®ä¸ºé»˜è®¤: {çª—å£æ ‡è¯†}")
            return False
        
        self._é…ç½®["é»˜è®¤"] = çª—å£æ ‡è¯†
        
        if self._ä¿å­˜é…ç½®æ–‡ä»¶():
            æ—¥å¿—.info(f"é»˜è®¤çª—å£å·²è®¾ç½®: {çª—å£æ ‡è¯†}")
            return True
        return False
    
    def è·å–é»˜è®¤é…ç½®(self) -> Optional[str]:
        """
        è·å–é»˜è®¤é…ç½®çš„æ ‡è¯†
        
        è¿”å›:
            é»˜è®¤é…ç½®çš„çª—å£æ ‡è¯†ï¼Œæœªè®¾ç½®è¿”å› None
        """
        return self._é…ç½®.get("é»˜è®¤")
    
    def æ¸…é™¤é»˜è®¤(self) -> bool:
        """
        æ¸…é™¤é»˜è®¤é…ç½®è®¾ç½®
        
        è¿”å›:
            æ˜¯å¦æ¸…é™¤æˆåŠŸ
        """
        self._é…ç½®["é»˜è®¤"] = None
        return self._ä¿å­˜é…ç½®æ–‡ä»¶()
    
    def é…ç½®æ˜¯å¦å­˜åœ¨(self, çª—å£æ ‡è¯†: str) -> bool:
        """
        æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦
            
        è¿”å›:
            æ˜¯å¦å­˜åœ¨
        """
        return çª—å£æ ‡è¯† in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {})
    
    def è·å–é…ç½®æ•°é‡(self) -> int:
        """
        è·å–ä¿å­˜çš„é…ç½®æ•°é‡
        
        è¿”å›:
            é…ç½®æ•°é‡
        """
        return len(self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}))
    
    def æ›´æ–°é…ç½®(self, çª—å£æ ‡è¯†: str, æ›´æ–°å†…å®¹: Dict) -> bool:
        """
        æ›´æ–°ç°æœ‰é…ç½®
        
        å‚æ•°:
            çª—å£æ ‡è¯†: çª—å£æ ‡è¯†ç¬¦
            æ›´æ–°å†…å®¹: è¦æ›´æ–°çš„å­—æ®µå­—å…¸
            
        è¿”å›:
            æ˜¯å¦æ›´æ–°æˆåŠŸ
        """
        if çª—å£æ ‡è¯† not in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}):
            æ—¥å¿—.warning(f"é…ç½®ä¸å­˜åœ¨: {çª—å£æ ‡è¯†}")
            return False
        
        # æ›´æ–°å…è®¸çš„å­—æ®µ
        å…è®¸æ›´æ–°çš„å­—æ®µ = ["åˆ«å", "å¤‡æ³¨", "ä¸Šæ¬¡ä½ç½®"]
        
        for å­—æ®µ, å€¼ in æ›´æ–°å†…å®¹.items():
            if å­—æ®µ in å…è®¸æ›´æ–°çš„å­—æ®µ:
                self._é…ç½®["é…ç½®åˆ—è¡¨"][çª—å£æ ‡è¯†][å­—æ®µ] = å€¼
        
        # æ›´æ–°ä¿®æ”¹æ—¶é—´
        self._é…ç½®["é…ç½®åˆ—è¡¨"][çª—å£æ ‡è¯†]["ä¸Šæ¬¡ä½¿ç”¨"] = datetime.now().isoformat()
        
        return self._ä¿å­˜é…ç½®æ–‡ä»¶()
    
    def é‡å‘½åé…ç½®(self, æ—§æ ‡è¯†: str, æ–°æ ‡è¯†: str) -> bool:
        """
        é‡å‘½åé…ç½®æ ‡è¯†
        
        å‚æ•°:
            æ—§æ ‡è¯†: åŸçª—å£æ ‡è¯†
            æ–°æ ‡è¯†: æ–°çª—å£æ ‡è¯†
            
        è¿”å›:
            æ˜¯å¦é‡å‘½åæˆåŠŸ
        """
        if æ—§æ ‡è¯† not in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}):
            æ—¥å¿—.warning(f"é…ç½®ä¸å­˜åœ¨: {æ—§æ ‡è¯†}")
            return False
        
        if æ–°æ ‡è¯† in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}):
            æ—¥å¿—.warning(f"æ–°æ ‡è¯†å·²å­˜åœ¨: {æ–°æ ‡è¯†}")
            return False
        
        # ç§»åŠ¨é…ç½®
        é…ç½® = self._é…ç½®["é…ç½®åˆ—è¡¨"].pop(æ—§æ ‡è¯†)
        é…ç½®["æ ‡è¯†å€¼"] = æ–°æ ‡è¯†
        self._é…ç½®["é…ç½®åˆ—è¡¨"][æ–°æ ‡è¯†] = é…ç½®
        
        # æ›´æ–°é»˜è®¤é…ç½®å¼•ç”¨
        if self._é…ç½®.get("é»˜è®¤") == æ—§æ ‡è¯†:
            self._é…ç½®["é»˜è®¤"] = æ–°æ ‡è¯†
        
        if self._ä¿å­˜é…ç½®æ–‡ä»¶():
            æ—¥å¿—.info(f"é…ç½®å·²é‡å‘½å: {æ—§æ ‡è¯†} -> {æ–°æ ‡è¯†}")
            return True
        return False
    
    def å¯¼å‡ºé…ç½®(self, å¯¼å‡ºè·¯å¾„: str = None) -> Optional[str]:
        """
        å¯¼å‡ºæ‰€æœ‰é…ç½®åˆ°æ–‡ä»¶
        
        å‚æ•°:
            å¯¼å‡ºè·¯å¾„: å¯¼å‡ºæ–‡ä»¶è·¯å¾„ï¼ŒNone åˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„
            
        è¿”å›:
            å¯¼å‡ºæ–‡ä»¶è·¯å¾„ï¼Œå¤±è´¥è¿”å› None
        """
        if å¯¼å‡ºè·¯å¾„ is None:
            æ—¶é—´æˆ³ = datetime.now().strftime("%Y%m%d_%H%M%S")
            å¯¼å‡ºè·¯å¾„ = f"é…ç½®/çª—å£é…ç½®_å¤‡ä»½_{æ—¶é—´æˆ³}.json"
        
        try:
            ç›®å½• = os.path.dirname(å¯¼å‡ºè·¯å¾„)
            if ç›®å½•:
                os.makedirs(ç›®å½•, exist_ok=True)
            
            with open(å¯¼å‡ºè·¯å¾„, 'w', encoding='utf-8') as f:
                json.dump(self._é…ç½®, f, ensure_ascii=False, indent=2)
            
            æ—¥å¿—.info(f"é…ç½®å·²å¯¼å‡º: {å¯¼å‡ºè·¯å¾„}")
            return å¯¼å‡ºè·¯å¾„
            
        except Exception as e:
            æ—¥å¿—.error(f"å¯¼å‡ºé…ç½®å¤±è´¥: {e}")
            return None
    
    def å¯¼å…¥é…ç½®(self, å¯¼å…¥è·¯å¾„: str, è¦†ç›–ç°æœ‰: bool = False) -> bool:
        """
        ä»æ–‡ä»¶å¯¼å…¥é…ç½®
        
        å‚æ•°:
            å¯¼å…¥è·¯å¾„: å¯¼å…¥æ–‡ä»¶è·¯å¾„
            è¦†ç›–ç°æœ‰: æ˜¯å¦è¦†ç›–ç°æœ‰é…ç½®
            
        è¿”å›:
            æ˜¯å¦å¯¼å…¥æˆåŠŸ
        """
        if not os.path.exists(å¯¼å…¥è·¯å¾„):
            æ—¥å¿—.error(f"å¯¼å…¥æ–‡ä»¶ä¸å­˜åœ¨: {å¯¼å…¥è·¯å¾„}")
            return False
        
        try:
            with open(å¯¼å…¥è·¯å¾„, 'r', encoding='utf-8') as f:
                å¯¼å…¥çš„é…ç½® = json.load(f)
            
            # éªŒè¯å¯¼å…¥çš„é…ç½®
            å¯¼å…¥çš„é…ç½® = self._éªŒè¯å¹¶è¿ç§»é…ç½®(å¯¼å…¥çš„é…ç½®)
            
            if è¦†ç›–ç°æœ‰:
                # å®Œå…¨æ›¿æ¢
                self._é…ç½® = å¯¼å…¥çš„é…ç½®
            else:
                # åˆå¹¶é…ç½®ï¼ˆä¸è¦†ç›–ç°æœ‰ï¼‰
                for æ ‡è¯†, é…ç½® in å¯¼å…¥çš„é…ç½®.get("é…ç½®åˆ—è¡¨", {}).items():
                    if æ ‡è¯† not in self._é…ç½®["é…ç½®åˆ—è¡¨"]:
                        self._é…ç½®["é…ç½®åˆ—è¡¨"][æ ‡è¯†] = é…ç½®
            
            if self._ä¿å­˜é…ç½®æ–‡ä»¶():
                æ—¥å¿—.info(f"é…ç½®å·²å¯¼å…¥: {å¯¼å…¥è·¯å¾„}")
                return True
            return False
            
        except Exception as e:
            æ—¥å¿—.error(f"å¯¼å…¥é…ç½®å¤±è´¥: {e}")
            return False
    
    def æ¸…ç©ºæ‰€æœ‰é…ç½®(self) -> bool:
        """
        æ¸…ç©ºæ‰€æœ‰é…ç½®
        
        è¿”å›:
            æ˜¯å¦æ¸…ç©ºæˆåŠŸ
        """
        self._é…ç½® = self._åˆ›å»ºç©ºé…ç½®()
        return self._ä¿å­˜é…ç½®æ–‡ä»¶()
    
    def æŒ‰æ¸¸æˆåæŸ¥æ‰¾é…ç½®(self, æ¸¸æˆå: str) -> List[Dict]:
        """
        æŒ‰æ¸¸æˆåï¼ˆè¿›ç¨‹åæˆ–æ ‡é¢˜ï¼‰æŸ¥æ‰¾é…ç½®
        
        å‚æ•°:
            æ¸¸æˆå: æ¸¸æˆåç§°å…³é”®è¯
            
        è¿”å›:
            åŒ¹é…çš„é…ç½®åˆ—è¡¨
            
        éœ€æ±‚: 4.3
        """
        æ¸¸æˆåå°å†™ = æ¸¸æˆå.lower()
        åŒ¹é…åˆ—è¡¨ = []
        
        for æ ‡è¯†, é…ç½® in self._é…ç½®.get("é…ç½®åˆ—è¡¨", {}).items():
            # åœ¨æ ‡è¯†ã€è¿›ç¨‹åã€æ ‡é¢˜ã€åˆ«åä¸­æœç´¢
            æœç´¢å­—æ®µ = [
                æ ‡è¯†.lower(),
                é…ç½®.get("è¿›ç¨‹å", "").lower(),
                é…ç½®.get("æ ‡é¢˜", "").lower(),
                é…ç½®.get("åˆ«å", "").lower()
            ]
            
            if any(æ¸¸æˆåå°å†™ in å­—æ®µ for å­—æ®µ in æœç´¢å­—æ®µ):
                é…ç½®å‰¯æœ¬ = é…ç½®.copy()
                é…ç½®å‰¯æœ¬["æ ‡è¯†"] = æ ‡è¯†
                åŒ¹é…åˆ—è¡¨.append(é…ç½®å‰¯æœ¬)
        
        return åŒ¹é…åˆ—è¡¨
    
    @property
    def é…ç½®è·¯å¾„(self) -> str:
        """è·å–é…ç½®æ–‡ä»¶è·¯å¾„"""
        return self._é…ç½®è·¯å¾„
    
    @property
    def é…ç½®ç‰ˆæœ¬(self) -> str:
        """è·å–é…ç½®ç‰ˆæœ¬"""
        return self._é…ç½®.get("ç‰ˆæœ¬", self._é…ç½®ç‰ˆæœ¬)


class è‡ªåŠ¨çª—å£æ£€æµ‹å™¨:
    """
    è‡ªåŠ¨çª—å£æ£€æµ‹çš„ç»Ÿä¸€æ¥å£
    
    åŠŸèƒ½:
    - è‡ªåŠ¨æ£€æµ‹æ¸¸æˆçª—å£
    - æ‰‹åŠ¨/ç‚¹å‡»é€‰æ‹©çª—å£
    - çª—å£ä½ç½®è·Ÿè¸ª
    - è‡ªåŠ¨æ›´æ–°æˆªå–åŒºåŸŸ
    - é…ç½®ä¿å­˜å’ŒåŠ è½½
    """
    
    def __init__(self, é…ç½®è·¯å¾„: str = "é…ç½®/çª—å£é…ç½®.json"):
        self._æŸ¥æ‰¾å™¨ = çª—å£æŸ¥æ‰¾å™¨()
        self._é€‰æ‹©å™¨ = çª—å£é€‰æ‹©å™¨(self._æŸ¥æ‰¾å™¨)
        self._é…ç½®ç®¡ç†å™¨ = çª—å£é…ç½®ç®¡ç†å™¨(é…ç½®è·¯å¾„)
        self._è·Ÿè¸ªå™¨: Optional[çª—å£è·Ÿè¸ªå™¨] = None
        self._å½“å‰çª—å£: Optional[çª—å£ä¿¡æ¯] = None
        self._æˆªå–åŒºåŸŸ: Optional[Tuple[int, int, int, int]] = None
        self._åŒºåŸŸæ›´æ–°å›è°ƒ: Optional[Callable[[Tuple[int, int, int, int]], None]] = None
        self._å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ: Optional[Callable[[çª—å£å˜åŒ–äº‹ä»¶], None]] = None
        self._çª—å£å…³é—­é€šçŸ¥å›è°ƒ: Optional[Callable[[çª—å£å˜åŒ–äº‹ä»¶], None]] = None
        self._é” = threading.Lock()
    
    def è®¾ç½®åŒºåŸŸæ›´æ–°å›è°ƒ(self, å›è°ƒ: Callable[[Tuple[int, int, int, int]], None]):
        """
        è®¾ç½®æˆªå–åŒºåŸŸæ›´æ–°å›è°ƒ
        
        å½“çª—å£ç§»åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨æ­¤å›è°ƒæ›´æ–°æˆªå–åŒºåŸŸ
        
        å‚æ•°:
            å›è°ƒ: æ¥æ”¶æ–°åŒºåŸŸ (x, y, width, height) çš„å›è°ƒå‡½æ•°
        """
        self._åŒºåŸŸæ›´æ–°å›è°ƒ = å›è°ƒ
    
    def è®¾ç½®å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ(self, å›è°ƒ: Callable[[çª—å£å˜åŒ–äº‹ä»¶], None]):
        """
        è®¾ç½®çª—å£å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ
        
        å½“çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å›è°ƒé€šçŸ¥ç”¨æˆ·
        
        å‚æ•°:
            å›è°ƒ: æ¥æ”¶å˜åŒ–äº‹ä»¶çš„å›è°ƒå‡½æ•°
        """
        self._å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ = å›è°ƒ
    
    def è®¾ç½®çª—å£å…³é—­é€šçŸ¥å›è°ƒ(self, å›è°ƒ: Callable[[çª—å£å˜åŒ–äº‹ä»¶], None]):
        """
        è®¾ç½®çª—å£å…³é—­é€šçŸ¥å›è°ƒ
        
        å‚æ•°:
            å›è°ƒ: æ¥æ”¶å…³é—­äº‹ä»¶çš„å›è°ƒå‡½æ•°
        """
        self._çª—å£å…³é—­é€šçŸ¥å›è°ƒ = å›è°ƒ
    
    def _å¤„ç†ä½ç½®å˜åŒ–(self, äº‹ä»¶: çª—å£å˜åŒ–äº‹ä»¶):
        """å¤„ç†çª—å£ä½ç½®å˜åŒ– - è‡ªåŠ¨æ›´æ–°æˆªå–åŒºåŸŸ"""
        if äº‹ä»¶.çª—å£ä¿¡æ¯:
            æ–°åŒºåŸŸ = äº‹ä»¶.çª—å£ä¿¡æ¯.è·å–åŒºåŸŸ()
            with self._é”:
                self._æˆªå–åŒºåŸŸ = æ–°åŒºåŸŸ
                self._å½“å‰çª—å£ = äº‹ä»¶.çª—å£ä¿¡æ¯
            
            æ—¥å¿—.info(f"æˆªå–åŒºåŸŸå·²è‡ªåŠ¨æ›´æ–°: {æ–°åŒºåŸŸ}")
            
            # è§¦å‘åŒºåŸŸæ›´æ–°å›è°ƒ
            if self._åŒºåŸŸæ›´æ–°å›è°ƒ:
                try:
                    self._åŒºåŸŸæ›´æ–°å›è°ƒ(æ–°åŒºåŸŸ)
                except Exception as e:
                    æ—¥å¿—.error(f"åŒºåŸŸæ›´æ–°å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
    
    def _å¤„ç†å¤§å°å˜åŒ–(self, äº‹ä»¶: çª—å£å˜åŒ–äº‹ä»¶):
        """å¤„ç†çª—å£å¤§å°å˜åŒ– - æ›´æ–°åŒºåŸŸå¹¶é€šçŸ¥ç”¨æˆ·"""
        if äº‹ä»¶.çª—å£ä¿¡æ¯:
            æ–°åŒºåŸŸ = äº‹ä»¶.çª—å£ä¿¡æ¯.è·å–åŒºåŸŸ()
            with self._é”:
                self._æˆªå–åŒºåŸŸ = æ–°åŒºåŸŸ
                self._å½“å‰çª—å£ = äº‹ä»¶.çª—å£ä¿¡æ¯
            
            æ—¥å¿—.info(f"çª—å£å¤§å°å·²å˜åŒ–: {äº‹ä»¶.æ—§å¤§å°} -> {äº‹ä»¶.æ–°å¤§å°}")
            æ—¥å¿—.info(f"æˆªå–åŒºåŸŸå·²æ›´æ–°: {æ–°åŒºåŸŸ}")
            
            # è§¦å‘åŒºåŸŸæ›´æ–°å›è°ƒ
            if self._åŒºåŸŸæ›´æ–°å›è°ƒ:
                try:
                    self._åŒºåŸŸæ›´æ–°å›è°ƒ(æ–°åŒºåŸŸ)
                except Exception as e:
                    æ—¥å¿—.error(f"åŒºåŸŸæ›´æ–°å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
            
            # è§¦å‘å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ
            if self._å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ:
                try:
                    self._å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒ(äº‹ä»¶)
                except Exception as e:
                    æ—¥å¿—.error(f"å¤§å°å˜åŒ–é€šçŸ¥å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
    
    def _å¤„ç†çª—å£å…³é—­(self, äº‹ä»¶: çª—å£å˜åŒ–äº‹ä»¶):
        """å¤„ç†çª—å£å…³é—­äº‹ä»¶"""
        æ—¥å¿—.warning("è·Ÿè¸ªçš„çª—å£å·²å…³é—­")
        
        with self._é”:
            self._å½“å‰çª—å£ = None
            self._è·Ÿè¸ªå™¨ = None
        
        # è§¦å‘çª—å£å…³é—­é€šçŸ¥å›è°ƒ
        if self._çª—å£å…³é—­é€šçŸ¥å›è°ƒ:
            try:
                self._çª—å£å…³é—­é€šçŸ¥å›è°ƒ(äº‹ä»¶)
            except Exception as e:
                æ—¥å¿—.error(f"çª—å£å…³é—­é€šçŸ¥å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")
    
    def è‡ªåŠ¨æ£€æµ‹(self, è¿›ç¨‹å: str = None, æ ‡é¢˜: str = None) -> Optional[çª—å£ä¿¡æ¯]:
        """
        è‡ªåŠ¨æ£€æµ‹æ¸¸æˆçª—å£
        
        å‚æ•°:
            è¿›ç¨‹å: è¿›ç¨‹åç§°
            æ ‡é¢˜: çª—å£æ ‡é¢˜
            
        è¿”å›:
            æ£€æµ‹åˆ°çš„çª—å£ä¿¡æ¯
        """
        # å°è¯•ä»é…ç½®åŠ è½½
        é…ç½® = self._é…ç½®ç®¡ç†å™¨.åŠ è½½é…ç½®()
        if é…ç½®:
            æ ‡è¯†å€¼ = é…ç½®.get("æ ‡è¯†å€¼")
            æ ‡è¯†ç±»å‹ = é…ç½®.get("æ ‡è¯†ç±»å‹")
            
            if æ ‡è¯†ç±»å‹ == "process":
                çª—å£åˆ—è¡¨ = self._æŸ¥æ‰¾å™¨.æŒ‰è¿›ç¨‹åæŸ¥æ‰¾(æ ‡è¯†å€¼)
            else:
                çª—å£åˆ—è¡¨ = self._æŸ¥æ‰¾å™¨.æŒ‰æ ‡é¢˜æŸ¥æ‰¾(æ ‡è¯†å€¼)
            
            if çª—å£åˆ—è¡¨:
                self._å½“å‰çª—å£ = çª—å£åˆ—è¡¨[0]
                self._æˆªå–åŒºåŸŸ = self._å½“å‰çª—å£.è·å–åŒºåŸŸ()
                æ—¥å¿—.info(f"ä»é…ç½®åŠ è½½çª—å£: {self._å½“å‰çª—å£.æ ‡é¢˜}")
                return self._å½“å‰çª—å£
        
        # æŒ‰å‚æ•°æŸ¥æ‰¾
        if è¿›ç¨‹å:
            çª—å£åˆ—è¡¨ = self._æŸ¥æ‰¾å™¨.æŒ‰è¿›ç¨‹åæŸ¥æ‰¾(è¿›ç¨‹å)
            if çª—å£åˆ—è¡¨:
                self._å½“å‰çª—å£ = çª—å£åˆ—è¡¨[0]
                self._æˆªå–åŒºåŸŸ = self._å½“å‰çª—å£.è·å–åŒºåŸŸ()
                return self._å½“å‰çª—å£
        
        if æ ‡é¢˜:
            çª—å£åˆ—è¡¨ = self._æŸ¥æ‰¾å™¨.æŒ‰æ ‡é¢˜æŸ¥æ‰¾(æ ‡é¢˜)
            if çª—å£åˆ—è¡¨:
                self._å½“å‰çª—å£ = çª—å£åˆ—è¡¨[0]
                self._æˆªå–åŒºåŸŸ = self._å½“å‰çª—å£.è·å–åŒºåŸŸ()
                return self._å½“å‰çª—å£
        
        return None
    
    def æ‰‹åŠ¨é€‰æ‹©(self, è¿‡æ»¤å…³é”®è¯: str = None) -> Optional[çª—å£ä¿¡æ¯]:
        """æ‰‹åŠ¨é€‰æ‹©çª—å£"""
        å¥æŸ„ = self._é€‰æ‹©å™¨.æ˜¾ç¤ºåˆ—è¡¨(è¿‡æ»¤å…³é”®è¯)
        
        if å¥æŸ„:
            self._å½“å‰çª—å£ = self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(å¥æŸ„)
            if self._å½“å‰çª—å£:
                self._æˆªå–åŒºåŸŸ = self._å½“å‰çª—å£.è·å–åŒºåŸŸ()
            return self._å½“å‰çª—å£
        
        return None
    
    def ç‚¹å‡»é€‰æ‹©(self) -> Optional[çª—å£ä¿¡æ¯]:
        """ç‚¹å‡»é€‰æ‹©çª—å£"""
        å¥æŸ„ = self._é€‰æ‹©å™¨.ç‚¹å‡»é€‰æ‹©æ¨¡å¼()
        
        if å¥æŸ„:
            self._å½“å‰çª—å£ = self._æŸ¥æ‰¾å™¨.è·å–çª—å£ä¿¡æ¯(å¥æŸ„)
            if self._å½“å‰çª—å£:
                self._æˆªå–åŒºåŸŸ = self._å½“å‰çª—å£.è·å–åŒºåŸŸ()
            return self._å½“å‰çª—å£
        
        return None
    
    def å¯åŠ¨è·Ÿè¸ª(self, å›è°ƒ: Callable[[çª—å£ä¿¡æ¯], None] = None, è‡ªåŠ¨æ›´æ–°åŒºåŸŸ: bool = True):
        """
        å¯åŠ¨çª—å£ä½ç½®è·Ÿè¸ª
        
        å‚æ•°:
            å›è°ƒ: ä»»ä½•å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
            è‡ªåŠ¨æ›´æ–°åŒºåŸŸ: æ˜¯å¦è‡ªåŠ¨æ›´æ–°æˆªå–åŒºåŸŸï¼ˆé»˜è®¤ Trueï¼‰
        """
        if self._å½“å‰çª—å£ is None:
            æ—¥å¿—.warning("æœªé€‰æ‹©çª—å£ï¼Œæ— æ³•å¯åŠ¨è·Ÿè¸ª")
            return
        
        self.åœæ­¢è·Ÿè¸ª()
        
        # åˆ›å»ºè·Ÿè¸ªå™¨ï¼Œè®¾ç½®å›è°ƒ
        ä½ç½®å›è°ƒ = self._å¤„ç†ä½ç½®å˜åŒ– if è‡ªåŠ¨æ›´æ–°åŒºåŸŸ else None
        å¤§å°å›è°ƒ = self._å¤„ç†å¤§å°å˜åŒ– if è‡ªåŠ¨æ›´æ–°åŒºåŸŸ else None
        
        self._è·Ÿè¸ªå™¨ = çª—å£è·Ÿè¸ªå™¨(
            self._å½“å‰çª—å£.å¥æŸ„,
            ä½ç½®å˜åŒ–å›è°ƒ=ä½ç½®å›è°ƒ,
            å¤§å°å˜åŒ–å›è°ƒ=å¤§å°å›è°ƒ,
            çª—å£å…³é—­å›è°ƒ=self._å¤„ç†çª—å£å…³é—­,
            é€šç”¨å›è°ƒ=å›è°ƒ
        )
        self._è·Ÿè¸ªå™¨.å¯åŠ¨()
    
    def åœæ­¢è·Ÿè¸ª(self):
        """åœæ­¢çª—å£ä½ç½®è·Ÿè¸ª"""
        if self._è·Ÿè¸ªå™¨:
            self._è·Ÿè¸ªå™¨.åœæ­¢()
            self._è·Ÿè¸ªå™¨ = None
    
    def æ˜¯å¦æ­£åœ¨è·Ÿè¸ª(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦æ­£åœ¨è·Ÿè¸ªçª—å£"""
        return self._è·Ÿè¸ªå™¨ is not None and self._è·Ÿè¸ªå™¨.æ˜¯å¦è¿è¡Œä¸­
    
    def ä¿å­˜å½“å‰é…ç½®(self, ä½¿ç”¨è¿›ç¨‹å: bool = True):
        """ä¿å­˜å½“å‰çª—å£é…ç½®"""
        if self._å½“å‰çª—å£ is None:
            æ—¥å¿—.warning("æœªé€‰æ‹©çª—å£ï¼Œæ— æ³•ä¿å­˜é…ç½®")
            return
        
        æ ‡è¯† = self._å½“å‰çª—å£.è¿›ç¨‹å if ä½¿ç”¨è¿›ç¨‹å else self._å½“å‰çª—å£.æ ‡é¢˜
        self._é…ç½®ç®¡ç†å™¨.ä¿å­˜é…ç½®(æ ‡è¯†, self._å½“å‰çª—å£)
        self._é…ç½®ç®¡ç†å™¨.è®¾ç½®é»˜è®¤(æ ‡è¯†)
    
    def è·å–æˆªå–åŒºåŸŸ(self) -> Optional[Tuple[int, int, int, int]]:
        """
        è·å–å½“å‰çª—å£çš„æˆªå–åŒºåŸŸ
        
        å¦‚æœå¯ç”¨äº†è·Ÿè¸ªï¼Œä¼šè¿”å›æœ€æ–°çš„ä½ç½®
        """
        with self._é”:
            # å¦‚æœæœ‰è·Ÿè¸ªå™¨ï¼Œè·å–æœ€æ–°ä½ç½®
            if self._è·Ÿè¸ªå™¨ and self._è·Ÿè¸ªå™¨.æ˜¯å¦è¿è¡Œä¸­:
                ä½ç½® = self._è·Ÿè¸ªå™¨.è·å–å½“å‰ä½ç½®()
                if ä½ç½®:
                    self._æˆªå–åŒºåŸŸ = ä½ç½®
                    return ä½ç½®
            
            # è¿”å›ç¼“å­˜çš„åŒºåŸŸ
            if self._æˆªå–åŒºåŸŸ:
                return self._æˆªå–åŒºåŸŸ
            
            # ä»å½“å‰çª—å£è·å–
            if self._å½“å‰çª—å£:
                return self._å½“å‰çª—å£.è·å–åŒºåŸŸ()
        
        return None
    
    def è·å–å½“å‰çª—å£(self) -> Optional[çª—å£ä¿¡æ¯]:
        """è·å–å½“å‰é€‰ä¸­çš„çª—å£"""
        return self._å½“å‰çª—å£
    
    def è·å–è·Ÿè¸ªå™¨(self) -> Optional[çª—å£è·Ÿè¸ªå™¨]:
        """è·å–å½“å‰çš„è·Ÿè¸ªå™¨å®ä¾‹"""
        return self._è·Ÿè¸ªå™¨
    
    def è·å–å˜åŒ–å†å²(self, æ•°é‡: int = 10) -> List[çª—å£å˜åŒ–äº‹ä»¶]:
        """è·å–çª—å£å˜åŒ–å†å²"""
        if self._è·Ÿè¸ªå™¨:
            return self._è·Ÿè¸ªå™¨.è·å–å˜åŒ–å†å²(æ•°é‡)
        return []


def ä¸»ç¨‹åº():
    """ä¸»ç¨‹åºå…¥å£"""
    print("\n" + "=" * 50)
    print("ğŸªŸ è‡ªåŠ¨çª—å£æ£€æµ‹å·¥å…·")
    print("=" * 50)
    
    æ£€æµ‹å™¨ = è‡ªåŠ¨çª—å£æ£€æµ‹å™¨()
    
    print("\nè¯·é€‰æ‹©åŠŸèƒ½:")
    print("  1. åˆ—è¡¨é€‰æ‹©çª—å£")
    print("  2. ç‚¹å‡»é€‰æ‹©çª—å£")
    print("  3. æŒ‰è¿›ç¨‹åæŸ¥æ‰¾")
    print("  4. æŸ¥çœ‹å·²ä¿å­˜é…ç½®")
    
    é€‰æ‹© = input("\nè¯·è¾“å…¥é€‰é¡¹ (1/2/3/4): ").strip()
    
    if é€‰æ‹© == '1':
        å…³é”®è¯ = input("è¾“å…¥è¿‡æ»¤å…³é”®è¯ (ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨): ").strip()
        çª—å£ = æ£€æµ‹å™¨.æ‰‹åŠ¨é€‰æ‹©(å…³é”®è¯ if å…³é”®è¯ else None)
        if çª—å£:
            ä¿å­˜ = input("\næ˜¯å¦ä¿å­˜é…ç½®? (y/n): ").strip().lower()
            if ä¿å­˜ == 'y':
                æ£€æµ‹å™¨.ä¿å­˜å½“å‰é…ç½®()
    
    elif é€‰æ‹© == '2':
        çª—å£ = æ£€æµ‹å™¨.ç‚¹å‡»é€‰æ‹©()
        if çª—å£:
            ä¿å­˜ = input("\næ˜¯å¦ä¿å­˜é…ç½®? (y/n): ").strip().lower()
            if ä¿å­˜ == 'y':
                æ£€æµ‹å™¨.ä¿å­˜å½“å‰é…ç½®()
    
    elif é€‰æ‹© == '3':
        è¿›ç¨‹å = input("è¾“å…¥è¿›ç¨‹å: ").strip()
        çª—å£ = æ£€æµ‹å™¨.è‡ªåŠ¨æ£€æµ‹(è¿›ç¨‹å=è¿›ç¨‹å)
        if çª—å£:
            print(f"\nâœ… æ‰¾åˆ°çª—å£: {çª—å£.æ ‡é¢˜}")
        else:
            print("âŒ æœªæ‰¾åˆ°åŒ¹é…çš„çª—å£")
    
    elif é€‰æ‹© == '4':
        é…ç½®åˆ—è¡¨ = æ£€æµ‹å™¨._é…ç½®ç®¡ç†å™¨.è·å–æ‰€æœ‰é…ç½®()
        if é…ç½®åˆ—è¡¨:
            print("\nå·²ä¿å­˜çš„çª—å£é…ç½®:")
            for é…ç½® in é…ç½®åˆ—è¡¨:
                print(f"  - {é…ç½®.get('æ ‡è¯†')}: {é…ç½®.get('æ ‡é¢˜', 'æœªçŸ¥')}")
        else:
            print("âŒ æ²¡æœ‰ä¿å­˜çš„é…ç½®")


if __name__ == "__main__":
    ä¸»ç¨‹åº()
