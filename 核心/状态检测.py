"""
çŠ¶æ€æ£€æµ‹æ¨¡å—
æ£€æµ‹æ¸¸æˆä¸­çš„è¡€é‡å’Œè“é‡

åŠŸèƒ½:
- è¡€æ¡æ£€æµ‹
- è“æ¡æ£€æµ‹
- å¹³æ»‘å¤„ç†
- æ ¡å‡†å·¥å…·
"""

import os
import json
import time
from typing import Tuple, Optional, Dict, List
from dataclasses import dataclass
from collections import deque
import numpy as np
import cv2
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
æ—¥å¿— = logging.getLogger(__name__)


@dataclass
class çŠ¶æ€æ£€æµ‹ç»“æœ:
    """çŠ¶æ€æ£€æµ‹ç»“æœ"""
    è¡€é‡ç™¾åˆ†æ¯”: float = 1.0
    è“é‡ç™¾åˆ†æ¯”: float = 1.0
    è¡€é‡ç½®ä¿¡åº¦: float = 0.0
    è“é‡ç½®ä¿¡åº¦: float = 0.0
    æ£€æµ‹æ—¶é—´: float = 0.0
    
    def to_dict(self) -> dict:
        return {
            'è¡€é‡ç™¾åˆ†æ¯”': round(self.è¡€é‡ç™¾åˆ†æ¯”, 3),
            'è“é‡ç™¾åˆ†æ¯”': round(self.è“é‡ç™¾åˆ†æ¯”, 3),
            'è¡€é‡ç½®ä¿¡åº¦': round(self.è¡€é‡ç½®ä¿¡åº¦, 3),
            'è“é‡ç½®ä¿¡åº¦': round(self.è“é‡ç½®ä¿¡åº¦, 3),
            'æ£€æµ‹æ—¶é—´': round(self.æ£€æµ‹æ—¶é—´, 4)
        }


class å¹³æ»‘å™¨:
    """æ£€æµ‹ç»“æœå¹³æ»‘å¤„ç†"""
    
    def __init__(self, çª—å£å¤§å°: int = 5, çªå˜é˜ˆå€¼: float = 0.1):
        """
        åˆå§‹åŒ–å¹³æ»‘å™¨
        
        å‚æ•°:
            çª—å£å¤§å°: å¹³æ»‘çª—å£å¤§å°
            çªå˜é˜ˆå€¼: çªå˜æ£€æµ‹é˜ˆå€¼
        """
        self._å†å²: deque = deque(maxlen=çª—å£å¤§å°)
        self._çªå˜é˜ˆå€¼ = çªå˜é˜ˆå€¼
        self._ä¸Šæ¬¡å€¼: float = 1.0
    
    def å¹³æ»‘(self, å€¼: float) -> float:
        """
        å¹³æ»‘å¤„ç†
        
        å‚æ•°:
            å€¼: åŸå§‹æ£€æµ‹å€¼
            
        è¿”å›:
            å¹³æ»‘åçš„å€¼
        """
        # ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
        å€¼ = max(0.0, min(1.0, å€¼))
        
        # æ£€æµ‹çªå˜
        if self._å†å²:
            å·®å¼‚ = abs(å€¼ - self._ä¸Šæ¬¡å€¼)
            if å·®å¼‚ > self._çªå˜é˜ˆå€¼:
                # çªå˜æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨æ–°å€¼
                self._å†å².clear()
                self._å†å².append(å€¼)
                self._ä¸Šæ¬¡å€¼ = å€¼
                return å€¼
        
        # æ·»åŠ åˆ°å†å²
        self._å†å².append(å€¼)
        
        # è®¡ç®—å¹³æ»‘å€¼ï¼ˆç§»åŠ¨å¹³å‡ï¼‰
        å¹³æ»‘å€¼ = sum(self._å†å²) / len(self._å†å²)
        self._ä¸Šæ¬¡å€¼ = å¹³æ»‘å€¼
        
        return å¹³æ»‘å€¼
    
    def é‡ç½®(self):
        """é‡ç½®å¹³æ»‘å™¨"""
        self._å†å².clear()
        self._ä¸Šæ¬¡å€¼ = 1.0


class çŠ¶æ€æ¡åˆ†æå™¨:
    """åˆ†æçŠ¶æ€æ¡å¡«å……ç¨‹åº¦"""
    
    def __init__(self, é¢œè‰²é…ç½®: dict = None):
        """
        åˆå§‹åŒ–åˆ†æå™¨
        
        å‚æ•°:
            é¢œè‰²é…ç½®: HSV é¢œè‰²èŒƒå›´é…ç½®
        """
        self.é¢œè‰²é…ç½® = é¢œè‰²é…ç½® or self._é»˜è®¤é¢œè‰²é…ç½®()
    
    def _é»˜è®¤é¢œè‰²é…ç½®(self) -> dict:
        """é»˜è®¤é¢œè‰²é…ç½®"""
        return {
            "å¡«å……è‰²": {
                "H_min": 0, "H_max": 180,
                "S_min": 50, "S_max": 255,
                "V_min": 50, "V_max": 255
            }
        }
    
    def åˆ†æ(self, åŒºåŸŸå›¾åƒ: np.ndarray) -> Tuple[float, float]:
        """
        åˆ†æçŠ¶æ€æ¡
        
        å‚æ•°:
            åŒºåŸŸå›¾åƒ: çŠ¶æ€æ¡åŒºåŸŸå›¾åƒ
            
        è¿”å›:
            (å¡«å……ç™¾åˆ†æ¯”, ç½®ä¿¡åº¦)
        """
        if åŒºåŸŸå›¾åƒ is None or åŒºåŸŸå›¾åƒ.size == 0:
            return 1.0, 0.0
        
        try:
            # è½¬æ¢åˆ° HSV ç©ºé—´
            hsv = cv2.cvtColor(åŒºåŸŸå›¾åƒ, cv2.COLOR_BGR2HSV)
            
            # åˆ›å»ºé¢œè‰²æ©ç 
            å¡«å……è‰² = self.é¢œè‰²é…ç½®.get("å¡«å……è‰²", {})
            ä¸‹ç•Œ = np.array([
                å¡«å……è‰².get("H_min", 0),
                å¡«å……è‰².get("S_min", 50),
                å¡«å……è‰².get("V_min", 50)
            ])
            ä¸Šç•Œ = np.array([
                å¡«å……è‰².get("H_max", 180),
                å¡«å……è‰².get("S_max", 255),
                å¡«å……è‰².get("V_max", 255)
            ])
            
            æ©ç  = cv2.inRange(hsv, ä¸‹ç•Œ, ä¸Šç•Œ)
            
            # è®¡ç®—å¡«å……æ¯”ä¾‹
            é«˜åº¦, å®½åº¦ = æ©ç .shape
            
            # æŒ‰åˆ—ç»Ÿè®¡å¡«å……åƒç´ 
            åˆ—å¡«å…… = np.sum(æ©ç  > 0, axis=0) / é«˜åº¦
            
            # æ‰¾åˆ°å¡«å……è¾¹ç•Œ
            å¡«å……é˜ˆå€¼ = 0.3  # è®¤ä¸ºè¯¥åˆ—æœ‰å¡«å……çš„é˜ˆå€¼
            å¡«å……åˆ— = åˆ—å¡«å…… > å¡«å……é˜ˆå€¼
            
            if not np.any(å¡«å……åˆ—):
                return 0.0, 0.5
            
            # æ‰¾åˆ°æœ€å³è¾¹çš„å¡«å……åˆ—
            å¡«å……ç´¢å¼• = np.where(å¡«å……åˆ—)[0]
            å³è¾¹ç•Œ = å¡«å……ç´¢å¼•[-1] if len(å¡«å……ç´¢å¼•) > 0 else 0
            
            # è®¡ç®—ç™¾åˆ†æ¯”
            ç™¾åˆ†æ¯” = (å³è¾¹ç•Œ + 1) / å®½åº¦
            
            # è®¡ç®—ç½®ä¿¡åº¦ï¼ˆåŸºäºå¡«å……åŒºåŸŸçš„ä¸€è‡´æ€§ï¼‰
            å¡«å……åŒºåŸŸ = åˆ—å¡«å……[:å³è¾¹ç•Œ + 1]
            ç½®ä¿¡åº¦ = np.mean(å¡«å……åŒºåŸŸ) if len(å¡«å……åŒºåŸŸ) > 0 else 0.0
            
            return min(1.0, max(0.0, ç™¾åˆ†æ¯”)), ç½®ä¿¡åº¦
            
        except Exception as e:
            æ—¥å¿—.warning(f"çŠ¶æ€æ¡åˆ†æå¤±è´¥: {e}")
            return 1.0, 0.0
    
    def æ£€æµ‹å¡«å……è¾¹ç•Œ(self, åŒºåŸŸå›¾åƒ: np.ndarray) -> int:
        """
        æ£€æµ‹å¡«å……åŒºåŸŸçš„å³è¾¹ç•Œä½ç½®
        
        å‚æ•°:
            åŒºåŸŸå›¾åƒ: çŠ¶æ€æ¡åŒºåŸŸå›¾åƒ
            
        è¿”å›:
            å³è¾¹ç•Œ x åæ ‡
        """
        ç™¾åˆ†æ¯”, _ = self.åˆ†æ(åŒºåŸŸå›¾åƒ)
        å®½åº¦ = åŒºåŸŸå›¾åƒ.shape[1] if åŒºåŸŸå›¾åƒ is not None else 0
        return int(ç™¾åˆ†æ¯” * å®½åº¦)


class è¡€é‡æ£€æµ‹å™¨:
    """æ£€æµ‹æ¸¸æˆè¡€æ¡çš„å¡«å……ç™¾åˆ†æ¯”"""
    
    # é»˜è®¤çº¢è‰²è¡€æ¡é¢œè‰²èŒƒå›´
    é»˜è®¤é¢œè‰²é…ç½® = {
        "å¡«å……è‰²": {
            "H_min": 0, "H_max": 10,  # çº¢è‰²è‰²è°ƒ
            "S_min": 100, "S_max": 255,
            "V_min": 100, "V_max": 255
        }
    }
    
    def __init__(self, é…ç½®: dict = None):
        """
        åˆå§‹åŒ–è¡€é‡æ£€æµ‹å™¨
        
        å‚æ•°:
            é…ç½®: æ£€æµ‹é…ç½®å­—å…¸
        """
        self.é…ç½® = é…ç½® or {}
        self.åŒºåŸŸ = self.é…ç½®.get("åŒºåŸŸ", None)  # (x, y, width, height)
        
        é¢œè‰²é…ç½® = self.é…ç½®.get("é¢œè‰²", self.é»˜è®¤é¢œè‰²é…ç½®)
        self._åˆ†æå™¨ = çŠ¶æ€æ¡åˆ†æå™¨(é¢œè‰²é…ç½®)
        
        çª—å£å¤§å° = self.é…ç½®.get("å¹³æ»‘çª—å£", 5)
        self._å¹³æ»‘å™¨ = å¹³æ»‘å™¨(çª—å£å¤§å°)
        
        self._ä¸Šæ¬¡å€¼ = 1.0
        self._ä¸Šæ¬¡ç½®ä¿¡åº¦ = 0.0
        self._è¿ç»­å¤±è´¥æ¬¡æ•° = 0
        self._æœ€å¤§è¿ç»­å¤±è´¥ = 10
    
    def è®¾ç½®åŒºåŸŸ(self, åŒºåŸŸ: Tuple[int, int, int, int]):
        """
        è®¾ç½®è¡€æ¡æ„Ÿå…´è¶£åŒºåŸŸ
        
        å‚æ•°:
            åŒºåŸŸ: (x, y, width, height)
        """
        self.åŒºåŸŸ = åŒºåŸŸ
    
    def è®¾ç½®é¢œè‰²é…ç½®(self, é¢œè‰²é…ç½®: dict):
        """è®¾ç½®é¢œè‰²é…ç½®"""
        self._åˆ†æå™¨ = çŠ¶æ€æ¡åˆ†æå™¨(é¢œè‰²é…ç½®)
    
    def æ£€æµ‹(self, å›¾åƒ: np.ndarray) -> float:
        """
        æ£€æµ‹è¡€é‡ç™¾åˆ†æ¯”
        
        å‚æ•°:
            å›¾åƒ: æ¸¸æˆç”»é¢
            
        è¿”å›:
            è¡€é‡ç™¾åˆ†æ¯” (0.0-1.0)
        """
        if self.åŒºåŸŸ is None:
            æ—¥å¿—.warning("è¡€æ¡åŒºåŸŸæœªé…ç½®")
            return 1.0
        
        if å›¾åƒ is None or å›¾åƒ.size == 0:
            return self._ä¸Šæ¬¡å€¼
        
        try:
            # æå–åŒºåŸŸ
            x, y, w, h = self.åŒºåŸŸ
            åŒºåŸŸå›¾åƒ = å›¾åƒ[y:y+h, x:x+w]
            
            if åŒºåŸŸå›¾åƒ.size == 0:
                return self._ä¸Šæ¬¡å€¼
            
            # åˆ†æ
            åŸå§‹å€¼, ç½®ä¿¡åº¦ = self._åˆ†æå™¨.åˆ†æ(åŒºåŸŸå›¾åƒ)
            
            # å¹³æ»‘å¤„ç†
            å¹³æ»‘å€¼ = self._å¹³æ»‘å™¨.å¹³æ»‘(åŸå§‹å€¼)
            
            self._ä¸Šæ¬¡å€¼ = å¹³æ»‘å€¼
            self._ä¸Šæ¬¡ç½®ä¿¡åº¦ = ç½®ä¿¡åº¦
            self._è¿ç»­å¤±è´¥æ¬¡æ•° = 0
            
            return å¹³æ»‘å€¼
            
        except Exception as e:
            æ—¥å¿—.warning(f"è¡€é‡æ£€æµ‹å¤±è´¥: {e}")
            self._è¿ç»­å¤±è´¥æ¬¡æ•° += 1
            
            if self._è¿ç»­å¤±è´¥æ¬¡æ•° >= self._æœ€å¤§è¿ç»­å¤±è´¥:
                æ—¥å¿—.warning("è¡€é‡æ£€æµ‹è¿ç»­å¤±è´¥ï¼Œè¿”å›æ»¡è¡€")
                return 1.0
            
            return self._ä¸Šæ¬¡å€¼
    
    def è·å–ç½®ä¿¡åº¦(self) -> float:
        """è·å–æœ€è¿‘ä¸€æ¬¡æ£€æµ‹çš„ç½®ä¿¡åº¦"""
        return self._ä¸Šæ¬¡ç½®ä¿¡åº¦
    
    def é‡ç½®(self):
        """é‡ç½®æ£€æµ‹å™¨çŠ¶æ€"""
        self._å¹³æ»‘å™¨.é‡ç½®()
        self._ä¸Šæ¬¡å€¼ = 1.0
        self._ä¸Šæ¬¡ç½®ä¿¡åº¦ = 0.0
        self._è¿ç»­å¤±è´¥æ¬¡æ•° = 0


class è“é‡æ£€æµ‹å™¨:
    """æ£€æµ‹æ¸¸æˆè“æ¡çš„å¡«å……ç™¾åˆ†æ¯”"""
    
    # é»˜è®¤è“è‰²è“æ¡é¢œè‰²èŒƒå›´
    é»˜è®¤é¢œè‰²é…ç½® = {
        "å¡«å……è‰²": {
            "H_min": 100, "H_max": 130,  # è“è‰²è‰²è°ƒ
            "S_min": 100, "S_max": 255,
            "V_min": 100, "V_max": 255
        }
    }
    
    def __init__(self, é…ç½®: dict = None):
        """
        åˆå§‹åŒ–è“é‡æ£€æµ‹å™¨
        
        å‚æ•°:
            é…ç½®: æ£€æµ‹é…ç½®å­—å…¸
        """
        self.é…ç½® = é…ç½® or {}
        self.åŒºåŸŸ = self.é…ç½®.get("åŒºåŸŸ", None)
        
        é¢œè‰²é…ç½® = self.é…ç½®.get("é¢œè‰²", self.é»˜è®¤é¢œè‰²é…ç½®)
        self._åˆ†æå™¨ = çŠ¶æ€æ¡åˆ†æå™¨(é¢œè‰²é…ç½®)
        
        çª—å£å¤§å° = self.é…ç½®.get("å¹³æ»‘çª—å£", 5)
        self._å¹³æ»‘å™¨ = å¹³æ»‘å™¨(çª—å£å¤§å°)
        
        self._ä¸Šæ¬¡å€¼ = 1.0
        self._ä¸Šæ¬¡ç½®ä¿¡åº¦ = 0.0
        self._è¿ç»­å¤±è´¥æ¬¡æ•° = 0
        self._æœ€å¤§è¿ç»­å¤±è´¥ = 10
    
    def è®¾ç½®åŒºåŸŸ(self, åŒºåŸŸ: Tuple[int, int, int, int]):
        """è®¾ç½®è“æ¡æ„Ÿå…´è¶£åŒºåŸŸ"""
        self.åŒºåŸŸ = åŒºåŸŸ
    
    def è®¾ç½®é¢œè‰²é…ç½®(self, é¢œè‰²é…ç½®: dict):
        """è®¾ç½®é¢œè‰²é…ç½®"""
        self._åˆ†æå™¨ = çŠ¶æ€æ¡åˆ†æå™¨(é¢œè‰²é…ç½®)
    
    def æ£€æµ‹(self, å›¾åƒ: np.ndarray) -> float:
        """
        æ£€æµ‹è“é‡ç™¾åˆ†æ¯”
        
        å‚æ•°:
            å›¾åƒ: æ¸¸æˆç”»é¢
            
        è¿”å›:
            è“é‡ç™¾åˆ†æ¯” (0.0-1.0)
        """
        if self.åŒºåŸŸ is None:
            return 1.0
        
        if å›¾åƒ is None or å›¾åƒ.size == 0:
            return self._ä¸Šæ¬¡å€¼
        
        try:
            x, y, w, h = self.åŒºåŸŸ
            åŒºåŸŸå›¾åƒ = å›¾åƒ[y:y+h, x:x+w]
            
            if åŒºåŸŸå›¾åƒ.size == 0:
                return self._ä¸Šæ¬¡å€¼
            
            åŸå§‹å€¼, ç½®ä¿¡åº¦ = self._åˆ†æå™¨.åˆ†æ(åŒºåŸŸå›¾åƒ)
            å¹³æ»‘å€¼ = self._å¹³æ»‘å™¨.å¹³æ»‘(åŸå§‹å€¼)
            
            self._ä¸Šæ¬¡å€¼ = å¹³æ»‘å€¼
            self._ä¸Šæ¬¡ç½®ä¿¡åº¦ = ç½®ä¿¡åº¦
            self._è¿ç»­å¤±è´¥æ¬¡æ•° = 0
            
            return å¹³æ»‘å€¼
            
        except Exception as e:
            æ—¥å¿—.warning(f"è“é‡æ£€æµ‹å¤±è´¥: {e}")
            self._è¿ç»­å¤±è´¥æ¬¡æ•° += 1
            
            if self._è¿ç»­å¤±è´¥æ¬¡æ•° >= self._æœ€å¤§è¿ç»­å¤±è´¥:
                return 1.0
            
            return self._ä¸Šæ¬¡å€¼
    
    def è·å–ç½®ä¿¡åº¦(self) -> float:
        """è·å–æœ€è¿‘ä¸€æ¬¡æ£€æµ‹çš„ç½®ä¿¡åº¦"""
        return self._ä¸Šæ¬¡ç½®ä¿¡åº¦
    
    def é‡ç½®(self):
        """é‡ç½®æ£€æµ‹å™¨çŠ¶æ€"""
        self._å¹³æ»‘å™¨.é‡ç½®()
        self._ä¸Šæ¬¡å€¼ = 1.0
        self._ä¸Šæ¬¡ç½®ä¿¡åº¦ = 0.0
        self._è¿ç»­å¤±è´¥æ¬¡æ•° = 0


class çŠ¶æ€æ£€æµ‹å™¨:
    """ç»Ÿä¸€çš„çŠ¶æ€æ£€æµ‹å™¨ï¼ŒåŒæ—¶æ£€æµ‹è¡€é‡å’Œè“é‡"""
    
    def __init__(self, é…ç½®: dict = None):
        """
        åˆå§‹åŒ–çŠ¶æ€æ£€æµ‹å™¨
        
        å‚æ•°:
            é…ç½®: æ£€æµ‹é…ç½®å­—å…¸
        """
        self.é…ç½® = é…ç½® or {}
        
        è¡€æ¡é…ç½® = self.é…ç½®.get("è¡€æ¡", {})
        è“æ¡é…ç½® = self.é…ç½®.get("è“æ¡", {})
        
        self._è¡€é‡æ£€æµ‹å™¨ = è¡€é‡æ£€æµ‹å™¨(è¡€æ¡é…ç½®)
        self._è“é‡æ£€æµ‹å™¨ = è“é‡æ£€æµ‹å™¨(è“æ¡é…ç½®)
    
    def æ£€æµ‹(self, å›¾åƒ: np.ndarray) -> çŠ¶æ€æ£€æµ‹ç»“æœ:
        """
        æ£€æµ‹è¡€é‡å’Œè“é‡
        
        å‚æ•°:
            å›¾åƒ: æ¸¸æˆç”»é¢
            
        è¿”å›:
            çŠ¶æ€æ£€æµ‹ç»“æœ
        """
        å¼€å§‹æ—¶é—´ = time.time()
        
        è¡€é‡ = self._è¡€é‡æ£€æµ‹å™¨.æ£€æµ‹(å›¾åƒ)
        è“é‡ = self._è“é‡æ£€æµ‹å™¨.æ£€æµ‹(å›¾åƒ)
        
        return çŠ¶æ€æ£€æµ‹ç»“æœ(
            è¡€é‡ç™¾åˆ†æ¯”=è¡€é‡,
            è“é‡ç™¾åˆ†æ¯”=è“é‡,
            è¡€é‡ç½®ä¿¡åº¦=self._è¡€é‡æ£€æµ‹å™¨.è·å–ç½®ä¿¡åº¦(),
            è“é‡ç½®ä¿¡åº¦=self._è“é‡æ£€æµ‹å™¨.è·å–ç½®ä¿¡åº¦(),
            æ£€æµ‹æ—¶é—´=time.time() - å¼€å§‹æ—¶é—´
        )
    
    def è®¾ç½®è¡€æ¡åŒºåŸŸ(self, åŒºåŸŸ: Tuple[int, int, int, int]):
        """è®¾ç½®è¡€æ¡åŒºåŸŸ"""
        self._è¡€é‡æ£€æµ‹å™¨.è®¾ç½®åŒºåŸŸ(åŒºåŸŸ)
    
    def è®¾ç½®è“æ¡åŒºåŸŸ(self, åŒºåŸŸ: Tuple[int, int, int, int]):
        """è®¾ç½®è“æ¡åŒºåŸŸ"""
        self._è“é‡æ£€æµ‹å™¨.è®¾ç½®åŒºåŸŸ(åŒºåŸŸ)
    
    def ä»é…ç½®åŠ è½½(self, é…ç½®è·¯å¾„: str):
        """ä»é…ç½®æ–‡ä»¶åŠ è½½"""
        with open(é…ç½®è·¯å¾„, 'r', encoding='utf-8') as f:
            é…ç½® = json.load(f)
        
        if "è¡€æ¡" in é…ç½®:
            è¡€æ¡é…ç½® = é…ç½®["è¡€æ¡"]
            if "åŒºåŸŸ" in è¡€æ¡é…ç½®:
                self._è¡€é‡æ£€æµ‹å™¨.è®¾ç½®åŒºåŸŸ(tuple(è¡€æ¡é…ç½®["åŒºåŸŸ"]))
            if "é¢œè‰²" in è¡€æ¡é…ç½®:
                self._è¡€é‡æ£€æµ‹å™¨.è®¾ç½®é¢œè‰²é…ç½®(è¡€æ¡é…ç½®["é¢œè‰²"])
        
        if "è“æ¡" in é…ç½®:
            è“æ¡é…ç½® = é…ç½®["è“æ¡"]
            if "åŒºåŸŸ" in è“æ¡é…ç½®:
                self._è“é‡æ£€æµ‹å™¨.è®¾ç½®åŒºåŸŸ(tuple(è“æ¡é…ç½®["åŒºåŸŸ"]))
            if "é¢œè‰²" in è“æ¡é…ç½®:
                self._è“é‡æ£€æµ‹å™¨.è®¾ç½®é¢œè‰²é…ç½®(è“æ¡é…ç½®["é¢œè‰²"])
    
    def ä¿å­˜é…ç½®(self, é…ç½®è·¯å¾„: str):
        """ä¿å­˜é…ç½®åˆ°æ–‡ä»¶"""
        é…ç½® = {
            "è¡€æ¡": {
                "åŒºåŸŸ": list(self._è¡€é‡æ£€æµ‹å™¨.åŒºåŸŸ) if self._è¡€é‡æ£€æµ‹å™¨.åŒºåŸŸ else None,
                "é¢œè‰²": self._è¡€é‡æ£€æµ‹å™¨._åˆ†æå™¨.é¢œè‰²é…ç½®
            },
            "è“æ¡": {
                "åŒºåŸŸ": list(self._è“é‡æ£€æµ‹å™¨.åŒºåŸŸ) if self._è“é‡æ£€æµ‹å™¨.åŒºåŸŸ else None,
                "é¢œè‰²": self._è“é‡æ£€æµ‹å™¨._åˆ†æå™¨.é¢œè‰²é…ç½®
            }
        }
        
        os.makedirs(os.path.dirname(é…ç½®è·¯å¾„) or '.', exist_ok=True)
        with open(é…ç½®è·¯å¾„, 'w', encoding='utf-8') as f:
            json.dump(é…ç½®, f, ensure_ascii=False, indent=2)


class æ ¡å‡†å·¥å…·:
    """è¡€æ¡/è“æ¡åŒºåŸŸæ ¡å‡†å·¥å…·"""
    
    def __init__(self):
        self._å½“å‰ç±»å‹ = "è¡€æ¡"
        self._é€‰ä¸­åŒºåŸŸ = None
        self._é¢„è§ˆçª—å£å = "çŠ¶æ€æ¡æ ¡å‡†"
    
    def å¯åŠ¨æ ¡å‡†(self, å›¾åƒ: np.ndarray, ç±»å‹: str = "è¡€æ¡") -> Optional[Tuple[int, int, int, int]]:
        """
        å¯åŠ¨æ ¡å‡†æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼Œè¿”å›æ‰‹åŠ¨è¾“å…¥çš„åŒºåŸŸï¼‰
        
        å‚æ•°:
            å›¾åƒ: æ¸¸æˆç”»é¢
            ç±»å‹: "è¡€æ¡" æˆ– "è“æ¡"
            
        è¿”å›:
            é€‰ä¸­çš„åŒºåŸŸ (x, y, width, height)
        """
        self._å½“å‰ç±»å‹ = ç±»å‹
        
        print(f"\n{'='*50}")
        print(f"ğŸ“ {ç±»å‹}åŒºåŸŸæ ¡å‡†")
        print(f"{'='*50}")
        print(f"å›¾åƒå°ºå¯¸: {å›¾åƒ.shape[1]} x {å›¾åƒ.shape[0]}")
        print("\nè¯·è¾“å…¥çŠ¶æ€æ¡åŒºåŸŸåæ ‡:")
        
        try:
            x = int(input("  X åæ ‡: "))
            y = int(input("  Y åæ ‡: "))
            w = int(input("  å®½åº¦: "))
            h = int(input("  é«˜åº¦: "))
            
            self._é€‰ä¸­åŒºåŸŸ = (x, y, w, h)
            
            # é¢„è§ˆ
            é¢„è§ˆå›¾ = self.é¢„è§ˆåŒºåŸŸ(å›¾åƒ, self._é€‰ä¸­åŒºåŸŸ)
            
            print(f"\nâœ… å·²é€‰æ‹©åŒºåŸŸ: {self._é€‰ä¸­åŒºåŸŸ}")
            return self._é€‰ä¸­åŒºåŸŸ
            
        except ValueError as e:
            print(f"âŒ è¾“å…¥æ— æ•ˆ: {e}")
            return None
    
    def é¢„è§ˆåŒºåŸŸ(self, å›¾åƒ: np.ndarray, åŒºåŸŸ: Tuple[int, int, int, int]) -> np.ndarray:
        """
        é¢„è§ˆé€‰ä¸­åŒºåŸŸ
        
        å‚æ•°:
            å›¾åƒ: åŸå§‹å›¾åƒ
            åŒºåŸŸ: (x, y, width, height)
            
        è¿”å›:
            å¸¦æ ‡æ³¨çš„é¢„è§ˆå›¾åƒ
        """
        é¢„è§ˆå›¾ = å›¾åƒ.copy()
        x, y, w, h = åŒºåŸŸ
        
        # ç»˜åˆ¶çŸ©å½¢
        é¢œè‰² = (0, 255, 0) if self._å½“å‰ç±»å‹ == "è¡€æ¡" else (255, 0, 0)
        cv2.rectangle(é¢„è§ˆå›¾, (x, y), (x + w, y + h), é¢œè‰², 2)
        
        # æ·»åŠ æ ‡ç­¾
        cv2.putText(é¢„è§ˆå›¾, self._å½“å‰ç±»å‹, (x, y - 5),
                    cv2.FONT_HERSHEY_SIMPLEX, 0.5, é¢œè‰², 1)
        
        return é¢„è§ˆå›¾
    
    def ä¿å­˜é…ç½®(self, é…ç½®è·¯å¾„: str, è¡€æ¡åŒºåŸŸ: tuple = None, è“æ¡åŒºåŸŸ: tuple = None):
        """ä¿å­˜æ ¡å‡†é…ç½®"""
        é…ç½® = {}
        
        if è¡€æ¡åŒºåŸŸ:
            é…ç½®["è¡€æ¡"] = {"åŒºåŸŸ": list(è¡€æ¡åŒºåŸŸ)}
        
        if è“æ¡åŒºåŸŸ:
            é…ç½®["è“æ¡"] = {"åŒºåŸŸ": list(è“æ¡åŒºåŸŸ)}
        
        os.makedirs(os.path.dirname(é…ç½®è·¯å¾„) or '.', exist_ok=True)
        with open(é…ç½®è·¯å¾„, 'w', encoding='utf-8') as f:
            json.dump(é…ç½®, f, ensure_ascii=False, indent=2)
        
        print(f"âœ… é…ç½®å·²ä¿å­˜: {é…ç½®è·¯å¾„}")
