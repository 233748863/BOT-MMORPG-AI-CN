"""
预定义决策规则集
包含战斗、对话、采集、紧急情况等状态的规则
"""

from typing import List

from 核心.数据类型 import 游戏状态, 决策上下文, 决策规则, 实体类型
from 配置.增强设置 import 紧急规则配置, 状态判定阈值


# ==================== 战斗状态规则 ====================

def _战斗_有近距离敌人(上下文: 决策上下文) -> bool:
    """检查是否有近距离敌人"""
    if 上下文.游戏状态 != 游戏状态.战斗:
        return False
    
    敌人距离阈值 = 状态判定阈值.get("战斗_敌人距离", 200)
    
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.怪物 and 检测.距离 < 敌人距离阈值:
            return True
    return False


def _战斗_敌人在左侧(上下文: 决策上下文) -> bool:
    """检查敌人是否在左侧"""
    if 上下文.游戏状态 != 游戏状态.战斗:
        return False
    
    from 核心.数据类型 import 方向
    
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.怪物:
            if 检测.方向 in (方向.左, 方向.左上, 方向.左下):
                return True
    return False


def _战斗_敌人在右侧(上下文: 决策上下文) -> bool:
    """检查敌人是否在右侧"""
    if 上下文.游戏状态 != 游戏状态.战斗:
        return False
    
    from 核心.数据类型 import 方向
    
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.怪物:
            if 检测.方向 in (方向.右, 方向.右上, 方向.右下):
                return True
    return False


def _战斗_多个敌人(上下文: 决策上下文) -> bool:
    """检查是否有多个敌人"""
    if 上下文.游戏状态 != 游戏状态.战斗:
        return False
    return 上下文.附近敌人数量 >= 2


def _战斗_需要使用技能(上下文: 决策上下文) -> bool:
    """检查是否需要使用技能（战斗中且有敌人）"""
    if 上下文.游戏状态 != 游戏状态.战斗:
        return False
    return 上下文.附近敌人数量 > 0


# 战斗状态规则列表
战斗规则列表: List[决策规则] = [
    决策规则(
        名称="战斗_近距离敌人_使用技能1",
        优先级=50,
        条件=_战斗_有近距离敌人,
        动作=9,  # 技能1
        冷却时间=1.0
    ),
    决策规则(
        名称="战斗_多敌人_使用AOE技能",
        优先级=60,
        条件=_战斗_多个敌人,
        动作=11,  # 技能3 (假设是AOE)
        冷却时间=2.0
    ),
    决策规则(
        名称="战斗_敌人在左_左移",
        优先级=30,
        条件=_战斗_敌人在左侧,
        动作=4,  # 前进+左移
        冷却时间=0.5
    ),
    决策规则(
        名称="战斗_敌人在右_右移",
        优先级=30,
        条件=_战斗_敌人在右侧,
        动作=5,  # 前进+右移
        冷却时间=0.5
    ),
    决策规则(
        名称="战斗_普通攻击",
        优先级=40,
        条件=_战斗_需要使用技能,
        动作=22,  # 鼠标左键
        冷却时间=0.3
    ),
]


# ==================== 对话状态规则 ====================

def _对话_需要确认(上下文: 决策上下文) -> bool:
    """检查是否在对话状态需要确认"""
    return 上下文.游戏状态 == 游戏状态.对话


def _对话_需要交互(上下文: 决策上下文) -> bool:
    """检查是否需要交互"""
    if 上下文.游戏状态 != 游戏状态.对话:
        return False
    
    # 检查是否有NPC在附近
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.NPC:
            return True
    return False


# 对话状态规则列表
对话规则列表: List[决策规则] = [
    决策规则(
        名称="对话_点击确认",
        优先级=70,
        条件=_对话_需要确认,
        动作=22,  # 鼠标左键
        冷却时间=0.5
    ),
    决策规则(
        名称="对话_按F交互",
        优先级=60,
        条件=_对话_需要交互,
        动作=21,  # 交互键F
        冷却时间=0.5
    ),
]


# ==================== 采集状态规则 ====================

def _采集_正在采集(上下文: 决策上下文) -> bool:
    """检查是否正在采集"""
    return 上下文.游戏状态 == 游戏状态.采集


def _采集_被攻击(上下文: 决策上下文) -> bool:
    """检查采集时是否被攻击"""
    if 上下文.游戏状态 != 游戏状态.采集:
        return False
    return 上下文.附近敌人数量 > 0


# 采集状态规则列表
采集规则列表: List[决策规则] = [
    决策规则(
        名称="采集_等待完成",
        优先级=40,
        条件=_采集_正在采集,
        动作=8,  # 无操作
        冷却时间=0.1
    ),
    决策规则(
        名称="采集_被攻击_中断",
        优先级=80,
        条件=_采集_被攻击,
        动作=19,  # 跳跃/闪避
        冷却时间=0.5
    ),
]


# ==================== 紧急情况规则 ====================

def _紧急_低血量(上下文: 决策上下文) -> bool:
    """检查是否低血量"""
    低血量阈值 = 紧急规则配置.get("低血量阈值", 0.3)
    return 上下文.血量百分比 < 低血量阈值


def _紧急_被围攻(上下文: 决策上下文) -> bool:
    """检查是否被围攻"""
    被围攻阈值 = 紧急规则配置.get("被围攻阈值", 3)
    return 上下文.附近敌人数量 >= 被围攻阈值


def _紧急_危险状态(上下文: 决策上下文) -> bool:
    """检查是否处于危险状态（低血量且被围攻）"""
    低血量阈值 = 紧急规则配置.get("低血量阈值", 0.3)
    return 上下文.血量百分比 < 低血量阈值 and 上下文.附近敌人数量 >= 2


# 紧急情况规则列表
紧急规则列表: List[决策规则] = [
    决策规则(
        名称="紧急_危险状态_闪避",
        优先级=100,
        条件=_紧急_危险状态,
        动作=19,  # 跳跃/闪避
        冷却时间=0.5
    ),
    决策规则(
        名称="紧急_低血量_闪避",
        优先级=95,
        条件=_紧急_低血量,
        动作=19,  # 跳跃/闪避
        冷却时间=0.5
    ),
    决策规则(
        名称="紧急_被围攻_闪避",
        优先级=90,
        条件=_紧急_被围攻,
        动作=19,  # 跳跃/闪避
        冷却时间=0.5
    ),
]


# ==================== 拾取状态规则 ====================

def _拾取_有物品(上下文: 决策上下文) -> bool:
    """检查是否有可拾取物品"""
    if 上下文.游戏状态 != 游戏状态.拾取:
        return False
    
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.物品:
            return True
    return False


def _拾取_物品在附近(上下文: 决策上下文) -> bool:
    """检查物品是否在附近"""
    if 上下文.游戏状态 != 游戏状态.拾取:
        return False
    
    物品距离阈值 = 状态判定阈值.get("拾取_物品距离", 100)
    
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.物品 and 检测.距离 < 物品距离阈值:
            return True
    return False


# 拾取状态规则列表
拾取规则列表: List[决策规则] = [
    决策规则(
        名称="拾取_点击物品",
        优先级=50,
        条件=_拾取_物品在附近,
        动作=22,  # 鼠标左键
        冷却时间=0.3
    ),
    决策规则(
        名称="拾取_按F拾取",
        优先级=55,
        条件=_拾取_有物品,
        动作=21,  # 交互键F
        冷却时间=0.3
    ),
]


# ==================== 移动状态规则 ====================

def _移动_空闲状态(上下文: 决策上下文) -> bool:
    """检查是否在移动/空闲状态"""
    return 上下文.游戏状态 in (游戏状态.移动, 游戏状态.空闲)


def _移动_有NPC附近(上下文: 决策上下文) -> bool:
    """检查是否有NPC在附近"""
    if 上下文.游戏状态 not in (游戏状态.移动, 游戏状态.空闲):
        return False
    
    for 检测 in 上下文.检测结果:
        if 检测.类型 == 实体类型.NPC and 检测.距离 < 150:
            return True
    return False


# 移动状态规则列表
移动规则列表: List[决策规则] = [
    决策规则(
        名称="移动_前进",
        优先级=20,
        条件=_移动_空闲状态,
        动作=0,  # 前进
        冷却时间=0.1
    ),
    决策规则(
        名称="移动_与NPC交互",
        优先级=40,
        条件=_移动_有NPC附近,
        动作=21,  # 交互键F
        冷却时间=0.5
    ),
]


# ==================== 菜单状态规则 ====================

def _菜单_需要关闭(上下文: 决策上下文) -> bool:
    """检查是否需要关闭菜单"""
    return 上下文.游戏状态 == 游戏状态.菜单


# 菜单状态规则列表
菜单规则列表: List[决策规则] = [
    决策规则(
        名称="菜单_点击确认",
        优先级=60,
        条件=_菜单_需要关闭,
        动作=22,  # 鼠标左键
        冷却时间=0.5
    ),
]


# ==================== 规则集合 ====================

def 获取所有规则() -> List[决策规则]:
    """
    获取所有预定义规则
    
    Returns:
        所有规则的列表
    """
    所有规则 = []
    所有规则.extend(紧急规则列表)  # 紧急规则优先级最高
    所有规则.extend(战斗规则列表)
    所有规则.extend(对话规则列表)
    所有规则.extend(采集规则列表)
    所有规则.extend(拾取规则列表)
    所有规则.extend(移动规则列表)
    所有规则.extend(菜单规则列表)
    return 所有规则


def 获取战斗规则() -> List[决策规则]:
    """获取战斗状态规则"""
    return 战斗规则列表.copy()


def 获取对话规则() -> List[决策规则]:
    """获取对话状态规则"""
    return 对话规则列表.copy()


def 获取采集规则() -> List[决策规则]:
    """获取采集状态规则"""
    return 采集规则列表.copy()


def 获取紧急规则() -> List[决策规则]:
    """获取紧急情况规则"""
    return 紧急规则列表.copy()


def 获取拾取规则() -> List[决策规则]:
    """获取拾取状态规则"""
    return 拾取规则列表.copy()


def 获取移动规则() -> List[决策规则]:
    """获取移动状态规则"""
    return 移动规则列表.copy()


def 获取菜单规则() -> List[决策规则]:
    """获取菜单状态规则"""
    return 菜单规则列表.copy()


def 创建自定义规则(名称: str, 优先级: int, 条件函数, 
                  动作索引: int, 冷却时间: float = 0.0) -> 决策规则:
    """
    创建自定义规则
    
    Args:
        名称: 规则名称
        优先级: 规则优先级 (数字越大越优先)
        条件函数: 条件判断函数，接收决策上下文，返回布尔值
        动作索引: 要执行的动作索引
        冷却时间: 规则冷却时间（秒）
        
    Returns:
        决策规则对象
    """
    return 决策规则(
        名称=名称,
        优先级=优先级,
        条件=条件函数,
        动作=动作索引,
        冷却时间=冷却时间
    )
