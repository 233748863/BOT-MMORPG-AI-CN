"""
æ¨¡å‹è¯„ä¼°æ¨¡å—
ç”¨äºè¯„ä¼°è®­ç»ƒæ¨¡å‹çš„æ€§èƒ½

åŠŸèƒ½:
- æ··æ·†çŸ©é˜µç”Ÿæˆ
- ç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1 è®¡ç®—
- è¯„ä¼°æŠ¥å‘Šç”Ÿæˆ
- å¯è§†åŒ–
"""

import os
import time
import json
from typing import List, Dict, Any, Tuple, Optional
from dataclasses import dataclass, field
import numpy as np
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
æ—¥å¿— = logging.getLogger(__name__)


@dataclass
class ç±»åˆ«æŒ‡æ ‡:
    """å•ä¸ªç±»åˆ«çš„è¯„ä¼°æŒ‡æ ‡"""
    ç²¾ç¡®ç‡: float = 0.0
    å¬å›ç‡: float = 0.0
    F1åˆ†æ•°: float = 0.0
    æ”¯æŒæ•°: int = 0  # æ ·æœ¬æ•°
    
    def to_dict(self) -> dict:
        return {
            'ç²¾ç¡®ç‡': round(self.ç²¾ç¡®ç‡, 4),
            'å¬å›ç‡': round(self.å¬å›ç‡, 4),
            'F1åˆ†æ•°': round(self.F1åˆ†æ•°, 4),
            'æ”¯æŒæ•°': self.æ”¯æŒæ•°
        }


@dataclass
class è¯„ä¼°ç»“æœ:
    """è¯„ä¼°ç»“æœæ•°æ®ç±»"""
    æ€»ä½“å‡†ç¡®ç‡: float = 0.0
    ç±»åˆ«æŒ‡æ ‡: Dict[str, ç±»åˆ«æŒ‡æ ‡] = field(default_factory=dict)
    æ··æ·†çŸ©é˜µ: np.ndarray = field(default_factory=lambda: np.array([]))
    å®å¹³å‡: Dict[str, float] = field(default_factory=dict)
    åŠ æƒå¹³å‡: Dict[str, float] = field(default_factory=dict)
    è¯„ä¼°æ—¶é—´: float = 0.0
    æ ·æœ¬æ•°é‡: int = 0
    
    def to_dict(self) -> dict:
        return {
            'æ€»ä½“å‡†ç¡®ç‡': round(self.æ€»ä½“å‡†ç¡®ç‡, 4),
            'ç±»åˆ«æŒ‡æ ‡': {k: v.to_dict() for k, v in self.ç±»åˆ«æŒ‡æ ‡.items()},
            'å®å¹³å‡': {k: round(v, 4) for k, v in self.å®å¹³å‡.items()},
            'åŠ æƒå¹³å‡': {k: round(v, 4) for k, v in self.åŠ æƒå¹³å‡.items()},
            'è¯„ä¼°æ—¶é—´': round(self.è¯„ä¼°æ—¶é—´, 2),
            'æ ·æœ¬æ•°é‡': self.æ ·æœ¬æ•°é‡
        }


class æ¨¡å‹è¯„ä¼°å™¨:
    """æ¨¡å‹æ€§èƒ½è¯„ä¼°å™¨"""
    
    def __init__(self, æ¨¡å‹=None, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None):
        """
        åˆå§‹åŒ–è¯„ä¼°å™¨
        
        å‚æ•°:
            æ¨¡å‹: å¾…è¯„ä¼°çš„æ¨¡å‹
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œç´¢å¼•åˆ°åç§°çš„æ˜ å°„ {0: "å‰è¿›", 1: "åé€€", ...}
        """
        self.æ¨¡å‹ = æ¨¡å‹
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
        self.ç±»åˆ«æ•° = len(åŠ¨ä½œå®šä¹‰) if åŠ¨ä½œå®šä¹‰ else 0
    
    def è®¾ç½®æ¨¡å‹(self, æ¨¡å‹):
        """è®¾ç½®æ¨¡å‹"""
        self.æ¨¡å‹ = æ¨¡å‹
    
    def è®¾ç½®åŠ¨ä½œå®šä¹‰(self, åŠ¨ä½œå®šä¹‰: Dict[int, str]):
        """è®¾ç½®åŠ¨ä½œå®šä¹‰"""
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰
        self.ç±»åˆ«æ•° = len(åŠ¨ä½œå®šä¹‰)
    
    def è¯„ä¼°(self, æµ‹è¯•æ•°æ®: List[Tuple[np.ndarray, int]]) -> è¯„ä¼°ç»“æœ:
        """
        åœ¨æµ‹è¯•æ•°æ®ä¸Šè¯„ä¼°æ¨¡å‹
        
        å‚æ•°:
            æµ‹è¯•æ•°æ®: [(å›¾åƒ, æ ‡ç­¾), ...] åˆ—è¡¨
            
        è¿”å›:
            è¯„ä¼°ç»“æœå¯¹è±¡
        """
        if not æµ‹è¯•æ•°æ®:
            æ—¥å¿—.warning("æµ‹è¯•æ•°æ®ä¸ºç©º")
            return è¯„ä¼°ç»“æœ()
        
        if self.æ¨¡å‹ is None:
            æ—¥å¿—.error("æ¨¡å‹æœªè®¾ç½®")
            return è¯„ä¼°ç»“æœ()
        
        å¼€å§‹æ—¶é—´ = time.time()
        
        é¢„æµ‹åˆ—è¡¨ = []
        çœŸå®åˆ—è¡¨ = []
        
        æ—¥å¿—.info(f"å¼€å§‹è¯„ä¼°ï¼Œå…± {len(æµ‹è¯•æ•°æ®)} ä¸ªæ ·æœ¬...")
        
        for i, (å›¾åƒ, æ ‡ç­¾) in enumerate(æµ‹è¯•æ•°æ®):
            try:
                # é¢„æµ‹
                é¢„æµ‹ç»“æœ = self.æ¨¡å‹.predict(np.expand_dims(å›¾åƒ, axis=0))
                é¢„æµ‹ç±»åˆ« = int(np.argmax(é¢„æµ‹ç»“æœ))
                
                é¢„æµ‹åˆ—è¡¨.append(é¢„æµ‹ç±»åˆ«)
                çœŸå®åˆ—è¡¨.append(æ ‡ç­¾)
                
                if (i + 1) % 100 == 0:
                    æ—¥å¿—.info(f"  è¿›åº¦: {i + 1}/{len(æµ‹è¯•æ•°æ®)}")
                    
            except Exception as e:
                æ—¥å¿—.warning(f"é¢„æµ‹æ ·æœ¬ {i} å¤±è´¥: {e}")
                continue
        
        # ç”Ÿæˆæ··æ·†çŸ©é˜µ
        æ··æ·†çŸ©é˜µ = self.ç”Ÿæˆæ··æ·†çŸ©é˜µ(é¢„æµ‹åˆ—è¡¨, çœŸå®åˆ—è¡¨)
        
        # è®¡ç®—æŒ‡æ ‡
        ç»“æœ = self.è®¡ç®—æŒ‡æ ‡(æ··æ·†çŸ©é˜µ)
        ç»“æœ.è¯„ä¼°æ—¶é—´ = time.time() - å¼€å§‹æ—¶é—´
        ç»“æœ.æ ·æœ¬æ•°é‡ = len(é¢„æµ‹åˆ—è¡¨)
        
        æ—¥å¿—.info(f"è¯„ä¼°å®Œæˆï¼Œè€—æ—¶ {ç»“æœ.è¯„ä¼°æ—¶é—´:.2f} ç§’")
        
        return ç»“æœ
    
    def ç”Ÿæˆæ··æ·†çŸ©é˜µ(self, é¢„æµ‹: List[int], çœŸå®: List[int]) -> np.ndarray:
        """
        ç”Ÿæˆæ··æ·†çŸ©é˜µ
        
        å‚æ•°:
            é¢„æµ‹: é¢„æµ‹æ ‡ç­¾åˆ—è¡¨
            çœŸå®: çœŸå®æ ‡ç­¾åˆ—è¡¨
            
        è¿”å›:
            æ··æ·†çŸ©é˜µ (ç±»åˆ«æ•° x ç±»åˆ«æ•°)
        """
        if self.ç±»åˆ«æ•° == 0:
            self.ç±»åˆ«æ•° = max(max(é¢„æµ‹, default=0), max(çœŸå®, default=0)) + 1
        
        æ··æ·†çŸ©é˜µ = np.zeros((self.ç±»åˆ«æ•°, self.ç±»åˆ«æ•°), dtype=np.int32)
        
        for é¢„æµ‹å€¼, çœŸå®å€¼ in zip(é¢„æµ‹, çœŸå®):
            if 0 <= é¢„æµ‹å€¼ < self.ç±»åˆ«æ•° and 0 <= çœŸå®å€¼ < self.ç±»åˆ«æ•°:
                æ··æ·†çŸ©é˜µ[çœŸå®å€¼, é¢„æµ‹å€¼] += 1
        
        return æ··æ·†çŸ©é˜µ
    
    def è®¡ç®—æŒ‡æ ‡(self, æ··æ·†çŸ©é˜µ: np.ndarray) -> è¯„ä¼°ç»“æœ:
        """
        è®¡ç®—å„é¡¹è¯„ä¼°æŒ‡æ ‡
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            
        è¿”å›:
            è¯„ä¼°ç»“æœ
        """
        ç»“æœ = è¯„ä¼°ç»“æœ()
        ç»“æœ.æ··æ·†çŸ©é˜µ = æ··æ·†çŸ©é˜µ
        
        # æ€»ä½“å‡†ç¡®ç‡
        æ€»æ ·æœ¬æ•° = np.sum(æ··æ·†çŸ©é˜µ)
        if æ€»æ ·æœ¬æ•° > 0:
            ç»“æœ.æ€»ä½“å‡†ç¡®ç‡ = np.trace(æ··æ·†çŸ©é˜µ) / æ€»æ ·æœ¬æ•°
        
        # å„ç±»åˆ«æŒ‡æ ‡
        ç²¾ç¡®ç‡åˆ—è¡¨ = []
        å¬å›ç‡åˆ—è¡¨ = []
        F1åˆ—è¡¨ = []
        æ”¯æŒæ•°åˆ—è¡¨ = []
        
        for i in range(len(æ··æ·†çŸ©é˜µ)):
            ç±»åˆ«å = self.åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
            
            # çœŸæ­£ä¾‹ (TP)
            TP = æ··æ·†çŸ©é˜µ[i, i]
            # å‡æ­£ä¾‹ (FP) - é¢„æµ‹ä¸ºè¯¥ç±»ä½†å®é™…ä¸æ˜¯
            FP = np.sum(æ··æ·†çŸ©é˜µ[:, i]) - TP
            # å‡è´Ÿä¾‹ (FN) - å®é™…ä¸ºè¯¥ç±»ä½†é¢„æµ‹ä¸æ˜¯
            FN = np.sum(æ··æ·†çŸ©é˜µ[i, :]) - TP
            # æ”¯æŒæ•° - è¯¥ç±»çš„å®é™…æ ·æœ¬æ•°
            æ”¯æŒæ•° = np.sum(æ··æ·†çŸ©é˜µ[i, :])
            
            # ç²¾ç¡®ç‡
            ç²¾ç¡®ç‡ = TP / (TP + FP) if (TP + FP) > 0 else 0.0
            # å¬å›ç‡
            å¬å›ç‡ = TP / (TP + FN) if (TP + FN) > 0 else 0.0
            # F1 åˆ†æ•°
            F1 = 2 * ç²¾ç¡®ç‡ * å¬å›ç‡ / (ç²¾ç¡®ç‡ + å¬å›ç‡) if (ç²¾ç¡®ç‡ + å¬å›ç‡) > 0 else 0.0
            
            ç»“æœ.ç±»åˆ«æŒ‡æ ‡[ç±»åˆ«å] = ç±»åˆ«æŒ‡æ ‡(
                ç²¾ç¡®ç‡=ç²¾ç¡®ç‡,
                å¬å›ç‡=å¬å›ç‡,
                F1åˆ†æ•°=F1,
                æ”¯æŒæ•°=int(æ”¯æŒæ•°)
            )
            
            if æ”¯æŒæ•° > 0:
                ç²¾ç¡®ç‡åˆ—è¡¨.append(ç²¾ç¡®ç‡)
                å¬å›ç‡åˆ—è¡¨.append(å¬å›ç‡)
                F1åˆ—è¡¨.append(F1)
                æ”¯æŒæ•°åˆ—è¡¨.append(æ”¯æŒæ•°)
        
        # å®å¹³å‡ï¼ˆç®€å•å¹³å‡ï¼‰
        if ç²¾ç¡®ç‡åˆ—è¡¨:
            ç»“æœ.å®å¹³å‡ = {
                'ç²¾ç¡®ç‡': np.mean(ç²¾ç¡®ç‡åˆ—è¡¨),
                'å¬å›ç‡': np.mean(å¬å›ç‡åˆ—è¡¨),
                'F1åˆ†æ•°': np.mean(F1åˆ—è¡¨)
            }
        
        # åŠ æƒå¹³å‡
        if æ”¯æŒæ•°åˆ—è¡¨:
            æ€»æ”¯æŒæ•° = sum(æ”¯æŒæ•°åˆ—è¡¨)
            ç»“æœ.åŠ æƒå¹³å‡ = {
                'ç²¾ç¡®ç‡': sum(p * s for p, s in zip(ç²¾ç¡®ç‡åˆ—è¡¨, æ”¯æŒæ•°åˆ—è¡¨)) / æ€»æ”¯æŒæ•°,
                'å¬å›ç‡': sum(r * s for r, s in zip(å¬å›ç‡åˆ—è¡¨, æ”¯æŒæ•°åˆ—è¡¨)) / æ€»æ”¯æŒæ•°,
                'F1åˆ†æ•°': sum(f * s for f, s in zip(F1åˆ—è¡¨, æ”¯æŒæ•°åˆ—è¡¨)) / æ€»æ”¯æŒæ•°
            }
        
        return ç»“æœ
    
    def è¯†åˆ«å¼±åŠ¿ç±»åˆ«(self, ç»“æœ: è¯„ä¼°ç»“æœ, F1é˜ˆå€¼: float = 0.7) -> List[str]:
        """
        è¯†åˆ«è¡¨ç°è¾ƒå·®çš„ç±»åˆ«
        
        å‚æ•°:
            ç»“æœ: è¯„ä¼°ç»“æœ
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
            
        è¿”å›:
            å¼±åŠ¿ç±»åˆ«åç§°åˆ—è¡¨
        """
        å¼±åŠ¿ç±»åˆ« = []
        for ç±»åˆ«å, æŒ‡æ ‡ in ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼ and æŒ‡æ ‡.æ”¯æŒæ•° > 0:
                å¼±åŠ¿ç±»åˆ«.append(ç±»åˆ«å)
        return å¼±åŠ¿ç±»åˆ«
    
    def è¯†åˆ«æ··æ·†å¯¹(self, æ··æ·†çŸ©é˜µ: np.ndarray, é˜ˆå€¼: float = 0.1) -> List[Tuple[str, str, float]]:
        """
        è¯†åˆ«æœ€å®¹æ˜“æ··æ·†çš„åŠ¨ä½œå¯¹
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            é˜ˆå€¼: æ··æ·†æ¯”ä¾‹é˜ˆå€¼
            
        è¿”å›:
            [(ç±»åˆ«A, ç±»åˆ«B, æ··æ·†æ¯”ä¾‹), ...] åˆ—è¡¨
        """
        æ··æ·†å¯¹ = []
        
        for i in range(len(æ··æ·†çŸ©é˜µ)):
            è¡Œå’Œ = np.sum(æ··æ·†çŸ©é˜µ[i, :])
            if è¡Œå’Œ == 0:
                continue
            
            for j in range(len(æ··æ·†çŸ©é˜µ)):
                if i == j:
                    continue
                
                æ··æ·†æ¯”ä¾‹ = æ··æ·†çŸ©é˜µ[i, j] / è¡Œå’Œ
                if æ··æ·†æ¯”ä¾‹ >= é˜ˆå€¼:
                    ç±»åˆ«A = self.åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
                    ç±»åˆ«B = self.åŠ¨ä½œå®šä¹‰.get(j, f"ç±»åˆ«{j}")
                    æ··æ·†å¯¹.append((ç±»åˆ«A, ç±»åˆ«B, æ··æ·†æ¯”ä¾‹))
        
        # æŒ‰æ··æ·†æ¯”ä¾‹æ’åº
        æ··æ·†å¯¹.sort(key=lambda x: x[2], reverse=True)
        return æ··æ·†å¯¹


class æŠ¥å‘Šç”Ÿæˆå™¨:
    """è¯„ä¼°æŠ¥å‘Šç”Ÿæˆå™¨"""
    
    def __init__(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None):
        """
        åˆå§‹åŒ–æŠ¥å‘Šç”Ÿæˆå™¨
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        """
        self.ç»“æœ = è¯„ä¼°ç»“æœ
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
    
    def ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š(self) -> str:
        """ç”Ÿæˆæ–‡æœ¬æ ¼å¼æŠ¥å‘Š"""
        è¡Œåˆ—è¡¨ = []
        è¡Œåˆ—è¡¨.append("=" * 60)
        è¡Œåˆ—è¡¨.append("æ¨¡å‹è¯„ä¼°æŠ¥å‘Š")
        è¡Œåˆ—è¡¨.append("=" * 60)
        è¡Œåˆ—è¡¨.append("")
        
        # æ€»ä½“æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€æ€»ä½“æŒ‡æ ‡ã€‘")
        è¡Œåˆ—è¡¨.append(f"  æ€»ä½“å‡†ç¡®ç‡: {self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡:.4f}")
        è¡Œåˆ—è¡¨.append(f"  æ ·æœ¬æ•°é‡: {self.ç»“æœ.æ ·æœ¬æ•°é‡}")
        è¡Œåˆ—è¡¨.append(f"  è¯„ä¼°æ—¶é—´: {self.ç»“æœ.è¯„ä¼°æ—¶é—´:.2f} ç§’")
        è¡Œåˆ—è¡¨.append("")
        
        # å¹³å‡æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€å¹³å‡æŒ‡æ ‡ã€‘")
        if self.ç»“æœ.å®å¹³å‡:
            è¡Œåˆ—è¡¨.append(f"  å®å¹³å‡ç²¾ç¡®ç‡: {self.ç»“æœ.å®å¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  å®å¹³å‡å¬å›ç‡: {self.ç»“æœ.å®å¹³å‡.get('å¬å›ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  å®å¹³å‡F1: {self.ç»“æœ.å®å¹³å‡.get('F1åˆ†æ•°', 0):.4f}")
        if self.ç»“æœ.åŠ æƒå¹³å‡:
            è¡Œåˆ—è¡¨.append(f"  åŠ æƒå¹³å‡ç²¾ç¡®ç‡: {self.ç»“æœ.åŠ æƒå¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  åŠ æƒå¹³å‡å¬å›ç‡: {self.ç»“æœ.åŠ æƒå¹³å‡.get('å¬å›ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  åŠ æƒå¹³å‡F1: {self.ç»“æœ.åŠ æƒå¹³å‡.get('F1åˆ†æ•°', 0):.4f}")
        è¡Œåˆ—è¡¨.append("")
        
        # å„ç±»åˆ«æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€å„ç±»åˆ«æŒ‡æ ‡ã€‘")
        è¡Œåˆ—è¡¨.append(f"{'ç±»åˆ«':<15} {'ç²¾ç¡®ç‡':<10} {'å¬å›ç‡':<10} {'F1':<10} {'æ ·æœ¬æ•°':<8}")
        è¡Œåˆ—è¡¨.append("-" * 55)
        
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            è¡Œåˆ—è¡¨.append(
                f"{ç±»åˆ«å:<15} {æŒ‡æ ‡.ç²¾ç¡®ç‡:<10.4f} {æŒ‡æ ‡.å¬å›ç‡:<10.4f} "
                f"{æŒ‡æ ‡.F1åˆ†æ•°:<10.4f} {æŒ‡æ ‡.æ”¯æŒæ•°:<8}"
            )
        
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("=" * 60)
        
        return "\n".join(è¡Œåˆ—è¡¨)
    
    def ç”ŸæˆMarkdownæŠ¥å‘Š(self, è¾“å‡ºè·¯å¾„: str = None) -> str:
        """
        ç”Ÿæˆ Markdown æ ¼å¼æŠ¥å‘Š
        
        å‚æ•°:
            è¾“å‡ºè·¯å¾„: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ŒNone åˆ™åªè¿”å›å†…å®¹
            
        è¿”å›:
            Markdown å†…å®¹
        """
        è¡Œåˆ—è¡¨ = []
        è¡Œåˆ—è¡¨.append("# æ¨¡å‹è¯„ä¼°æŠ¥å‘Š")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("## æ€»ä½“æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append(f"- **æ€»ä½“å‡†ç¡®ç‡**: {self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡:.4f}")
        è¡Œåˆ—è¡¨.append(f"- **æ ·æœ¬æ•°é‡**: {self.ç»“æœ.æ ·æœ¬æ•°é‡}")
        è¡Œåˆ—è¡¨.append(f"- **è¯„ä¼°æ—¶é—´**: {self.ç»“æœ.è¯„ä¼°æ—¶é—´:.2f} ç§’")
        è¡Œåˆ—è¡¨.append("")
        
        # å¹³å‡æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("## å¹³å‡æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("| æŒ‡æ ‡ç±»å‹ | ç²¾ç¡®ç‡ | å¬å›ç‡ | F1åˆ†æ•° |")
        è¡Œåˆ—è¡¨.append("|---------|--------|--------|--------|")
        if self.ç»“æœ.å®å¹³å‡:
            è¡Œåˆ—è¡¨.append(
                f"| å®å¹³å‡ | {self.ç»“æœ.å®å¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f} | "
                f"{self.ç»“æœ.å®å¹³å‡.get('å¬å›ç‡', 0):.4f} | "
                f"{self.ç»“æœ.å®å¹³å‡.get('F1åˆ†æ•°', 0):.4f} |"
            )
        if self.ç»“æœ.åŠ æƒå¹³å‡:
            è¡Œåˆ—è¡¨.append(
                f"| åŠ æƒå¹³å‡ | {self.ç»“æœ.åŠ æƒå¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f} | "
                f"{self.ç»“æœ.åŠ æƒå¹³å‡.get('å¬å›ç‡', 0):.4f} | "
                f"{self.ç»“æœ.åŠ æƒå¹³å‡.get('F1åˆ†æ•°', 0):.4f} |"
            )
        è¡Œåˆ—è¡¨.append("")
        
        # å„ç±»åˆ«æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("## å„ç±»åˆ«æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("| ç±»åˆ« | ç²¾ç¡®ç‡ | å¬å›ç‡ | F1åˆ†æ•° | æ ·æœ¬æ•° |")
        è¡Œåˆ—è¡¨.append("|------|--------|--------|--------|--------|")
        
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            è¡Œåˆ—è¡¨.append(
                f"| {ç±»åˆ«å} | {æŒ‡æ ‡.ç²¾ç¡®ç‡:.4f} | {æŒ‡æ ‡.å¬å›ç‡:.4f} | "
                f"{æŒ‡æ ‡.F1åˆ†æ•°:.4f} | {æŒ‡æ ‡.æ”¯æŒæ•°} |"
            )
        
        å†…å®¹ = "\n".join(è¡Œåˆ—è¡¨)
        
        if è¾“å‡ºè·¯å¾„:
            os.makedirs(os.path.dirname(è¾“å‡ºè·¯å¾„) or '.', exist_ok=True)
            with open(è¾“å‡ºè·¯å¾„, 'w', encoding='utf-8') as f:
                f.write(å†…å®¹)
            æ—¥å¿—.info(f"Markdown æŠ¥å‘Šå·²ä¿å­˜: {è¾“å‡ºè·¯å¾„}")
        
        return å†…å®¹
    
    def ç”ŸæˆJSONæŠ¥å‘Š(self, è¾“å‡ºè·¯å¾„: str = None) -> dict:
        """
        ç”Ÿæˆ JSON æ ¼å¼æŠ¥å‘Š
        
        å‚æ•°:
            è¾“å‡ºè·¯å¾„: è¾“å‡ºæ–‡ä»¶è·¯å¾„
            
        è¿”å›:
            æŠ¥å‘Šå­—å…¸
        """
        æŠ¥å‘Š = self.ç»“æœ.to_dict()
        
        if è¾“å‡ºè·¯å¾„:
            os.makedirs(os.path.dirname(è¾“å‡ºè·¯å¾„) or '.', exist_ok=True)
            with open(è¾“å‡ºè·¯å¾„, 'w', encoding='utf-8') as f:
                json.dump(æŠ¥å‘Š, f, ensure_ascii=False, indent=2)
            æ—¥å¿—.info(f"JSON æŠ¥å‘Šå·²ä¿å­˜: {è¾“å‡ºè·¯å¾„}")
        
        return æŠ¥å‘Š
    
    def ç”Ÿæˆæ”¹è¿›å»ºè®®(self) -> List[str]:
        """ç”Ÿæˆæ¨¡å‹æ”¹è¿›å»ºè®®"""
        å»ºè®®åˆ—è¡¨ = []
        
        # æ£€æŸ¥æ€»ä½“å‡†ç¡®ç‡
        if self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡ < 0.7:
            å»ºè®®åˆ—è¡¨.append("âš ï¸ æ€»ä½“å‡†ç¡®ç‡è¾ƒä½ï¼Œå»ºè®®å¢åŠ è®­ç»ƒæ•°æ®æˆ–è°ƒæ•´æ¨¡å‹ç»“æ„")
        
        # æ£€æŸ¥å¼±åŠ¿ç±»åˆ«
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.æ”¯æŒæ•° > 0:
                if æŒ‡æ ‡.F1åˆ†æ•° < 0.5:
                    å»ºè®®åˆ—è¡¨.append(f"âš ï¸ ç±»åˆ« '{ç±»åˆ«å}' F1åˆ†æ•°è¿‡ä½ ({æŒ‡æ ‡.F1åˆ†æ•°:.2f})ï¼Œå»ºè®®å¢åŠ è¯¥ç±»åˆ«çš„è®­ç»ƒæ ·æœ¬")
                elif æŒ‡æ ‡.ç²¾ç¡®ç‡ < 0.6 and æŒ‡æ ‡.å¬å›ç‡ > 0.8:
                    å»ºè®®åˆ—è¡¨.append(f"ğŸ’¡ ç±»åˆ« '{ç±»åˆ«å}' ç²¾ç¡®ç‡ä½ä½†å¬å›ç‡é«˜ï¼Œå¯èƒ½å­˜åœ¨è¿‡åº¦é¢„æµ‹")
                elif æŒ‡æ ‡.å¬å›ç‡ < 0.6 and æŒ‡æ ‡.ç²¾ç¡®ç‡ > 0.8:
                    å»ºè®®åˆ—è¡¨.append(f"ğŸ’¡ ç±»åˆ« '{ç±»åˆ«å}' å¬å›ç‡ä½ä½†ç²¾ç¡®ç‡é«˜ï¼Œå¯èƒ½å­˜åœ¨æ¬ é¢„æµ‹")
        
        # æ£€æŸ¥æ ·æœ¬ä¸å¹³è¡¡
        æ”¯æŒæ•°åˆ—è¡¨ = [æŒ‡æ ‡.æ”¯æŒæ•° for æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.values() if æŒ‡æ ‡.æ”¯æŒæ•° > 0]
        if æ”¯æŒæ•°åˆ—è¡¨:
            æœ€å¤§æ”¯æŒæ•° = max(æ”¯æŒæ•°åˆ—è¡¨)
            æœ€å°æ”¯æŒæ•° = min(æ”¯æŒæ•°åˆ—è¡¨)
            if æœ€å¤§æ”¯æŒæ•° > æœ€å°æ”¯æŒæ•° * 10:
                å»ºè®®åˆ—è¡¨.append("âš ï¸ ç±»åˆ«æ ·æœ¬æ•°é‡ä¸¥é‡ä¸å¹³è¡¡ï¼Œå»ºè®®ä½¿ç”¨ç±»åˆ«æƒé‡æˆ–è¿‡é‡‡æ ·")
        
        if not å»ºè®®åˆ—è¡¨:
            å»ºè®®åˆ—è¡¨.append("âœ… æ¨¡å‹è¡¨ç°è‰¯å¥½ï¼Œæš‚æ— æ˜æ˜¾æ”¹è¿›å»ºè®®")
        
        return å»ºè®®åˆ—è¡¨


class å¯è§†åŒ–å™¨:
    """è¯„ä¼°ç»“æœå¯è§†åŒ–"""
    
    def __init__(self):
        self._matplotlibå¯ç”¨ = False
        try:
            import matplotlib
            matplotlib.use('Agg')  # éäº¤äº’å¼åç«¯
            import matplotlib.pyplot as plt
            self._matplotlibå¯ç”¨ = True
        except ImportError:
            æ—¥å¿—.warning("matplotlib æœªå®‰è£…ï¼Œå¯è§†åŒ–åŠŸèƒ½ä¸å¯ç”¨")
    
    def ç»˜åˆ¶æ··æ·†çŸ©é˜µ(self, æ··æ·†çŸ©é˜µ: np.ndarray, 
                     ç±»åˆ«åç§°: List[str] = None,
                     ä¿å­˜è·¯å¾„: str = None,
                     æ ‡é¢˜: str = "æ··æ·†çŸ©é˜µ"):
        """
        ç»˜åˆ¶æ··æ·†çŸ©é˜µçƒ­åŠ›å›¾
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            ç±»åˆ«åç§°: ç±»åˆ«åç§°åˆ—è¡¨
            ä¿å­˜è·¯å¾„: ä¿å­˜è·¯å¾„
            æ ‡é¢˜: å›¾è¡¨æ ‡é¢˜
        """
        if not self._matplotlibå¯ç”¨:
            æ—¥å¿—.warning("matplotlib ä¸å¯ç”¨ï¼Œè·³è¿‡å¯è§†åŒ–")
            return
        
        import matplotlib.pyplot as plt
        
        plt.figure(figsize=(12, 10))
        plt.imshow(æ··æ·†çŸ©é˜µ, interpolation='nearest', cmap=plt.cm.Blues)
        plt.title(æ ‡é¢˜)
        plt.colorbar()
        
        if ç±»åˆ«åç§°:
            tick_marks = np.arange(len(ç±»åˆ«åç§°))
            plt.xticks(tick_marks, ç±»åˆ«åç§°, rotation=45, ha='right')
            plt.yticks(tick_marks, ç±»åˆ«åç§°)
        
        plt.ylabel('çœŸå®æ ‡ç­¾')
        plt.xlabel('é¢„æµ‹æ ‡ç­¾')
        plt.tight_layout()
        
        if ä¿å­˜è·¯å¾„:
            os.makedirs(os.path.dirname(ä¿å­˜è·¯å¾„) or '.', exist_ok=True)
            plt.savefig(ä¿å­˜è·¯å¾„, dpi=150, bbox_inches='tight')
            æ—¥å¿—.info(f"æ··æ·†çŸ©é˜µå›¾å·²ä¿å­˜: {ä¿å­˜è·¯å¾„}")
        
        plt.close()
    
    def ç»˜åˆ¶ç±»åˆ«æŒ‡æ ‡(self, ç±»åˆ«æŒ‡æ ‡: Dict[str, ç±»åˆ«æŒ‡æ ‡], 
                     ä¿å­˜è·¯å¾„: str = None,
                     æ ‡é¢˜: str = "å„ç±»åˆ«è¯„ä¼°æŒ‡æ ‡"):
        """
        ç»˜åˆ¶å„ç±»åˆ«æŒ‡æ ‡æŸ±çŠ¶å›¾
        
        å‚æ•°:
            ç±»åˆ«æŒ‡æ ‡: ç±»åˆ«æŒ‡æ ‡å­—å…¸
            ä¿å­˜è·¯å¾„: ä¿å­˜è·¯å¾„
            æ ‡é¢˜: å›¾è¡¨æ ‡é¢˜
        """
        if not self._matplotlibå¯ç”¨:
            æ—¥å¿—.warning("matplotlib ä¸å¯ç”¨ï¼Œè·³è¿‡å¯è§†åŒ–")
            return
        
        import matplotlib.pyplot as plt
        
        ç±»åˆ«åç§° = list(ç±»åˆ«æŒ‡æ ‡.keys())
        ç²¾ç¡®ç‡ = [æŒ‡æ ‡.ç²¾ç¡®ç‡ for æŒ‡æ ‡ in ç±»åˆ«æŒ‡æ ‡.values()]
        å¬å›ç‡ = [æŒ‡æ ‡.å¬å›ç‡ for æŒ‡æ ‡ in ç±»åˆ«æŒ‡æ ‡.values()]
        F1åˆ†æ•° = [æŒ‡æ ‡.F1åˆ†æ•° for æŒ‡æ ‡ in ç±»åˆ«æŒ‡æ ‡.values()]
        
        x = np.arange(len(ç±»åˆ«åç§°))
        å®½åº¦ = 0.25
        
        fig, ax = plt.subplots(figsize=(14, 6))
        ax.bar(x - å®½åº¦, ç²¾ç¡®ç‡, å®½åº¦, label='ç²¾ç¡®ç‡')
        ax.bar(x, å¬å›ç‡, å®½åº¦, label='å¬å›ç‡')
        ax.bar(x + å®½åº¦, F1åˆ†æ•°, å®½åº¦, label='F1åˆ†æ•°')
        
        ax.set_ylabel('åˆ†æ•°')
        ax.set_title(æ ‡é¢˜)
        ax.set_xticks(x)
        ax.set_xticklabels(ç±»åˆ«åç§°, rotation=45, ha='right')
        ax.legend()
        ax.set_ylim(0, 1.1)
        
        plt.tight_layout()
        
        if ä¿å­˜è·¯å¾„:
            os.makedirs(os.path.dirname(ä¿å­˜è·¯å¾„) or '.', exist_ok=True)
            plt.savefig(ä¿å­˜è·¯å¾„, dpi=150, bbox_inches='tight')
            æ—¥å¿—.info(f"ç±»åˆ«æŒ‡æ ‡å›¾å·²ä¿å­˜: {ä¿å­˜è·¯å¾„}")
        
        plt.close()
