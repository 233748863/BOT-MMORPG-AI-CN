"""
æ¨¡å‹è¯„ä¼°æ¨¡å—
ç”¨äºè¯„ä¼°è®­ç»ƒæ¨¡å‹çš„æ€§èƒ½

åŠŸèƒ½:
- æ··æ·†çŸ©é˜µç”Ÿæˆ
- ç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1 è®¡ç®—
- è¯„ä¼°æŠ¥å‘Šç”Ÿæˆ
- å¯è§†åŒ–
"""

import os
import time
import json
from typing import List, Dict, Any, Tuple, Optional
from dataclasses import dataclass, field
import numpy as np
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
æ—¥å¿— = logging.getLogger(__name__)


@dataclass
class ç±»åˆ«æŒ‡æ ‡:
    """å•ä¸ªç±»åˆ«çš„è¯„ä¼°æŒ‡æ ‡"""
    ç²¾ç¡®ç‡: float = 0.0
    å¬å›ç‡: float = 0.0
    F1åˆ†æ•°: float = 0.0
    æ”¯æŒæ•°: int = 0  # æ ·æœ¬æ•°
    
    def to_dict(self) -> dict:
        return {
            'ç²¾ç¡®ç‡': round(self.ç²¾ç¡®ç‡, 4),
            'å¬å›ç‡': round(self.å¬å›ç‡, 4),
            'F1åˆ†æ•°': round(self.F1åˆ†æ•°, 4),
            'æ”¯æŒæ•°': self.æ”¯æŒæ•°
        }


@dataclass
class è¯„ä¼°ç»“æœ:
    """è¯„ä¼°ç»“æœæ•°æ®ç±»"""
    æ€»ä½“å‡†ç¡®ç‡: float = 0.0
    ç±»åˆ«æŒ‡æ ‡: Dict[str, ç±»åˆ«æŒ‡æ ‡] = field(default_factory=dict)
    æ··æ·†çŸ©é˜µ: np.ndarray = field(default_factory=lambda: np.array([]))
    å®å¹³å‡: Dict[str, float] = field(default_factory=dict)
    åŠ æƒå¹³å‡: Dict[str, float] = field(default_factory=dict)
    è¯„ä¼°æ—¶é—´: float = 0.0
    æ ·æœ¬æ•°é‡: int = 0
    
    def to_dict(self) -> dict:
        return {
            'æ€»ä½“å‡†ç¡®ç‡': round(self.æ€»ä½“å‡†ç¡®ç‡, 4),
            'ç±»åˆ«æŒ‡æ ‡': {k: v.to_dict() for k, v in self.ç±»åˆ«æŒ‡æ ‡.items()},
            'å®å¹³å‡': {k: round(v, 4) for k, v in self.å®å¹³å‡.items()},
            'åŠ æƒå¹³å‡': {k: round(v, 4) for k, v in self.åŠ æƒå¹³å‡.items()},
            'è¯„ä¼°æ—¶é—´': round(self.è¯„ä¼°æ—¶é—´, 2),
            'æ ·æœ¬æ•°é‡': self.æ ·æœ¬æ•°é‡
        }


class æ¨¡å‹è¯„ä¼°å™¨:
    """æ¨¡å‹æ€§èƒ½è¯„ä¼°å™¨"""
    
    def __init__(self, æ¨¡å‹=None, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None):
        """
        åˆå§‹åŒ–è¯„ä¼°å™¨
        
        å‚æ•°:
            æ¨¡å‹: å¾…è¯„ä¼°çš„æ¨¡å‹
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œç´¢å¼•åˆ°åç§°çš„æ˜ å°„ {0: "å‰è¿›", 1: "åé€€", ...}
        """
        self.æ¨¡å‹ = æ¨¡å‹
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
        self.ç±»åˆ«æ•° = len(åŠ¨ä½œå®šä¹‰) if åŠ¨ä½œå®šä¹‰ else 0
    
    def è®¾ç½®æ¨¡å‹(self, æ¨¡å‹):
        """è®¾ç½®æ¨¡å‹"""
        self.æ¨¡å‹ = æ¨¡å‹
    
    def è®¾ç½®åŠ¨ä½œå®šä¹‰(self, åŠ¨ä½œå®šä¹‰: Dict[int, str]):
        """è®¾ç½®åŠ¨ä½œå®šä¹‰"""
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰
        self.ç±»åˆ«æ•° = len(åŠ¨ä½œå®šä¹‰)
    
    def è¯„ä¼°(self, æµ‹è¯•æ•°æ®: List[Tuple[np.ndarray, int]]) -> è¯„ä¼°ç»“æœ:
        """
        åœ¨æµ‹è¯•æ•°æ®ä¸Šè¯„ä¼°æ¨¡å‹
        
        å‚æ•°:
            æµ‹è¯•æ•°æ®: [(å›¾åƒ, æ ‡ç­¾), ...] åˆ—è¡¨
            
        è¿”å›:
            è¯„ä¼°ç»“æœå¯¹è±¡
        """
        if not æµ‹è¯•æ•°æ®:
            æ—¥å¿—.warning("æµ‹è¯•æ•°æ®ä¸ºç©º")
            return è¯„ä¼°ç»“æœ()
        
        if self.æ¨¡å‹ is None:
            æ—¥å¿—.error("æ¨¡å‹æœªè®¾ç½®")
            return è¯„ä¼°ç»“æœ()
        
        å¼€å§‹æ—¶é—´ = time.time()
        
        é¢„æµ‹åˆ—è¡¨ = []
        çœŸå®åˆ—è¡¨ = []
        
        æ—¥å¿—.info(f"å¼€å§‹è¯„ä¼°ï¼Œå…± {len(æµ‹è¯•æ•°æ®)} ä¸ªæ ·æœ¬...")
        
        for i, (å›¾åƒ, æ ‡ç­¾) in enumerate(æµ‹è¯•æ•°æ®):
            try:
                # é¢„æµ‹
                é¢„æµ‹ç»“æœ = self.æ¨¡å‹.predict(np.expand_dims(å›¾åƒ, axis=0))
                é¢„æµ‹ç±»åˆ« = int(np.argmax(é¢„æµ‹ç»“æœ))
                
                é¢„æµ‹åˆ—è¡¨.append(é¢„æµ‹ç±»åˆ«)
                çœŸå®åˆ—è¡¨.append(æ ‡ç­¾)
                
                if (i + 1) % 100 == 0:
                    æ—¥å¿—.info(f"  è¿›åº¦: {i + 1}/{len(æµ‹è¯•æ•°æ®)}")
                    
            except Exception as e:
                æ—¥å¿—.warning(f"é¢„æµ‹æ ·æœ¬ {i} å¤±è´¥: {e}")
                continue
        
        # ç”Ÿæˆæ··æ·†çŸ©é˜µ
        æ··æ·†çŸ©é˜µ = self.ç”Ÿæˆæ··æ·†çŸ©é˜µ(é¢„æµ‹åˆ—è¡¨, çœŸå®åˆ—è¡¨)
        
        # è®¡ç®—æŒ‡æ ‡
        ç»“æœ = self.è®¡ç®—æŒ‡æ ‡(æ··æ·†çŸ©é˜µ)
        ç»“æœ.è¯„ä¼°æ—¶é—´ = time.time() - å¼€å§‹æ—¶é—´
        ç»“æœ.æ ·æœ¬æ•°é‡ = len(é¢„æµ‹åˆ—è¡¨)
        
        æ—¥å¿—.info(f"è¯„ä¼°å®Œæˆï¼Œè€—æ—¶ {ç»“æœ.è¯„ä¼°æ—¶é—´:.2f} ç§’")
        
        return ç»“æœ
    
    def ç”Ÿæˆæ··æ·†çŸ©é˜µ(self, é¢„æµ‹: List[int], çœŸå®: List[int]) -> np.ndarray:
        """
        ç”Ÿæˆæ··æ·†çŸ©é˜µ
        
        å‚æ•°:
            é¢„æµ‹: é¢„æµ‹æ ‡ç­¾åˆ—è¡¨
            çœŸå®: çœŸå®æ ‡ç­¾åˆ—è¡¨
            
        è¿”å›:
            æ··æ·†çŸ©é˜µ (ç±»åˆ«æ•° x ç±»åˆ«æ•°)
        """
        if self.ç±»åˆ«æ•° == 0:
            self.ç±»åˆ«æ•° = max(max(é¢„æµ‹, default=0), max(çœŸå®, default=0)) + 1
        
        æ··æ·†çŸ©é˜µ = np.zeros((self.ç±»åˆ«æ•°, self.ç±»åˆ«æ•°), dtype=np.int32)
        
        for é¢„æµ‹å€¼, çœŸå®å€¼ in zip(é¢„æµ‹, çœŸå®):
            if 0 <= é¢„æµ‹å€¼ < self.ç±»åˆ«æ•° and 0 <= çœŸå®å€¼ < self.ç±»åˆ«æ•°:
                æ··æ·†çŸ©é˜µ[çœŸå®å€¼, é¢„æµ‹å€¼] += 1
        
        return æ··æ·†çŸ©é˜µ
    
    def è®¡ç®—æŒ‡æ ‡(self, æ··æ·†çŸ©é˜µ: np.ndarray) -> è¯„ä¼°ç»“æœ:
        """
        è®¡ç®—å„é¡¹è¯„ä¼°æŒ‡æ ‡
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            
        è¿”å›:
            è¯„ä¼°ç»“æœ
        """
        ç»“æœ = è¯„ä¼°ç»“æœ()
        ç»“æœ.æ··æ·†çŸ©é˜µ = æ··æ·†çŸ©é˜µ
        
        # æ€»ä½“å‡†ç¡®ç‡
        æ€»æ ·æœ¬æ•° = np.sum(æ··æ·†çŸ©é˜µ)
        if æ€»æ ·æœ¬æ•° > 0:
            ç»“æœ.æ€»ä½“å‡†ç¡®ç‡ = np.trace(æ··æ·†çŸ©é˜µ) / æ€»æ ·æœ¬æ•°
        
        # å„ç±»åˆ«æŒ‡æ ‡
        ç²¾ç¡®ç‡åˆ—è¡¨ = []
        å¬å›ç‡åˆ—è¡¨ = []
        F1åˆ—è¡¨ = []
        æ”¯æŒæ•°åˆ—è¡¨ = []
        
        for i in range(len(æ··æ·†çŸ©é˜µ)):
            ç±»åˆ«å = self.åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
            
            # çœŸæ­£ä¾‹ (TP)
            TP = æ··æ·†çŸ©é˜µ[i, i]
            # å‡æ­£ä¾‹ (FP) - é¢„æµ‹ä¸ºè¯¥ç±»ä½†å®é™…ä¸æ˜¯
            FP = np.sum(æ··æ·†çŸ©é˜µ[:, i]) - TP
            # å‡è´Ÿä¾‹ (FN) - å®é™…ä¸ºè¯¥ç±»ä½†é¢„æµ‹ä¸æ˜¯
            FN = np.sum(æ··æ·†çŸ©é˜µ[i, :]) - TP
            # æ”¯æŒæ•° - è¯¥ç±»çš„å®é™…æ ·æœ¬æ•°
            æ”¯æŒæ•° = np.sum(æ··æ·†çŸ©é˜µ[i, :])
            
            # ç²¾ç¡®ç‡
            ç²¾ç¡®ç‡ = TP / (TP + FP) if (TP + FP) > 0 else 0.0
            # å¬å›ç‡
            å¬å›ç‡ = TP / (TP + FN) if (TP + FN) > 0 else 0.0
            # F1 åˆ†æ•°
            F1 = 2 * ç²¾ç¡®ç‡ * å¬å›ç‡ / (ç²¾ç¡®ç‡ + å¬å›ç‡) if (ç²¾ç¡®ç‡ + å¬å›ç‡) > 0 else 0.0
            
            ç»“æœ.ç±»åˆ«æŒ‡æ ‡[ç±»åˆ«å] = ç±»åˆ«æŒ‡æ ‡(
                ç²¾ç¡®ç‡=ç²¾ç¡®ç‡,
                å¬å›ç‡=å¬å›ç‡,
                F1åˆ†æ•°=F1,
                æ”¯æŒæ•°=int(æ”¯æŒæ•°)
            )
            
            if æ”¯æŒæ•° > 0:
                ç²¾ç¡®ç‡åˆ—è¡¨.append(ç²¾ç¡®ç‡)
                å¬å›ç‡åˆ—è¡¨.append(å¬å›ç‡)
                F1åˆ—è¡¨.append(F1)
                æ”¯æŒæ•°åˆ—è¡¨.append(æ”¯æŒæ•°)
        
        # å®å¹³å‡ï¼ˆç®€å•å¹³å‡ï¼‰
        if ç²¾ç¡®ç‡åˆ—è¡¨:
            ç»“æœ.å®å¹³å‡ = {
                'ç²¾ç¡®ç‡': np.mean(ç²¾ç¡®ç‡åˆ—è¡¨),
                'å¬å›ç‡': np.mean(å¬å›ç‡åˆ—è¡¨),
                'F1åˆ†æ•°': np.mean(F1åˆ—è¡¨)
            }
        
        # åŠ æƒå¹³å‡
        if æ”¯æŒæ•°åˆ—è¡¨:
            æ€»æ”¯æŒæ•° = sum(æ”¯æŒæ•°åˆ—è¡¨)
            ç»“æœ.åŠ æƒå¹³å‡ = {
                'ç²¾ç¡®ç‡': sum(p * s for p, s in zip(ç²¾ç¡®ç‡åˆ—è¡¨, æ”¯æŒæ•°åˆ—è¡¨)) / æ€»æ”¯æŒæ•°,
                'å¬å›ç‡': sum(r * s for r, s in zip(å¬å›ç‡åˆ—è¡¨, æ”¯æŒæ•°åˆ—è¡¨)) / æ€»æ”¯æŒæ•°,
                'F1åˆ†æ•°': sum(f * s for f, s in zip(F1åˆ—è¡¨, æ”¯æŒæ•°åˆ—è¡¨)) / æ€»æ”¯æŒæ•°
            }
        
        return ç»“æœ
    
    def è¯†åˆ«å¼±åŠ¿ç±»åˆ«(self, ç»“æœ: è¯„ä¼°ç»“æœ, F1é˜ˆå€¼: float = 0.7) -> List[str]:
        """
        è¯†åˆ«è¡¨ç°è¾ƒå·®çš„ç±»åˆ«
        
        å‚æ•°:
            ç»“æœ: è¯„ä¼°ç»“æœ
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
            
        è¿”å›:
            å¼±åŠ¿ç±»åˆ«åç§°åˆ—è¡¨
        """
        å¼±åŠ¿ç±»åˆ« = []
        for ç±»åˆ«å, æŒ‡æ ‡ in ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼ and æŒ‡æ ‡.æ”¯æŒæ•° > 0:
                å¼±åŠ¿ç±»åˆ«.append(ç±»åˆ«å)
        return å¼±åŠ¿ç±»åˆ«
    
    def è¯†åˆ«æ··æ·†å¯¹(self, æ··æ·†çŸ©é˜µ: np.ndarray, é˜ˆå€¼: float = 0.1) -> List[Tuple[str, str, float]]:
        """
        è¯†åˆ«æœ€å®¹æ˜“æ··æ·†çš„åŠ¨ä½œå¯¹
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            é˜ˆå€¼: æ··æ·†æ¯”ä¾‹é˜ˆå€¼
            
        è¿”å›:
            [(ç±»åˆ«A, ç±»åˆ«B, æ··æ·†æ¯”ä¾‹), ...] åˆ—è¡¨
        """
        æ··æ·†å¯¹ = []
        
        for i in range(len(æ··æ·†çŸ©é˜µ)):
            è¡Œå’Œ = np.sum(æ··æ·†çŸ©é˜µ[i, :])
            if è¡Œå’Œ == 0:
                continue
            
            for j in range(len(æ··æ·†çŸ©é˜µ)):
                if i == j:
                    continue
                
                æ··æ·†æ¯”ä¾‹ = æ··æ·†çŸ©é˜µ[i, j] / è¡Œå’Œ
                if æ··æ·†æ¯”ä¾‹ >= é˜ˆå€¼:
                    ç±»åˆ«A = self.åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
                    ç±»åˆ«B = self.åŠ¨ä½œå®šä¹‰.get(j, f"ç±»åˆ«{j}")
                    æ··æ·†å¯¹.append((ç±»åˆ«A, ç±»åˆ«B, æ··æ·†æ¯”ä¾‹))
        
        # æŒ‰æ··æ·†æ¯”ä¾‹æ’åº
        æ··æ·†å¯¹.sort(key=lambda x: x[2], reverse=True)
        return æ··æ·†å¯¹


class æŠ¥å‘Šç”Ÿæˆå™¨:
    """è¯„ä¼°æŠ¥å‘Šç”Ÿæˆå™¨
    
    ç”Ÿæˆæ–‡æœ¬ã€Markdownã€HTML æ ¼å¼çš„è¯„ä¼°æŠ¥å‘Šï¼Œ
    åŒ…å«æ‰€æœ‰æŒ‡æ ‡ã€æ··æ·†çŸ©é˜µå’Œåˆ†ææ‘˜è¦ã€‚
    """
    
    def __init__(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None):
        """
        åˆå§‹åŒ–æŠ¥å‘Šç”Ÿæˆå™¨
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        """
        self.ç»“æœ = è¯„ä¼°ç»“æœ
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
        self._å¼±åŠ¿ç±»åˆ«ç¼“å­˜ = None
        self._æ··æ·†å¯¹ç¼“å­˜ = None
    
    def ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š(self, åŒ…å«æ··æ·†çŸ©é˜µ: bool = True, åŒ…å«å»ºè®®: bool = True) -> str:
        """
        ç”Ÿæˆæ–‡æœ¬æ ¼å¼æŠ¥å‘Š
        
        å‚æ•°:
            åŒ…å«æ··æ·†çŸ©é˜µ: æ˜¯å¦åŒ…å«æ··æ·†çŸ©é˜µ
            åŒ…å«å»ºè®®: æ˜¯å¦åŒ…å«æ”¹è¿›å»ºè®®
            
        è¿”å›:
            æ–‡æœ¬æ ¼å¼æŠ¥å‘Šå†…å®¹
        """
        è¡Œåˆ—è¡¨ = []
        è¡Œåˆ—è¡¨.append("=" * 60)
        è¡Œåˆ—è¡¨.append("æ¨¡å‹è¯„ä¼°æŠ¥å‘Š")
        è¡Œåˆ—è¡¨.append("=" * 60)
        è¡Œåˆ—è¡¨.append("")
        
        # æ€»ä½“æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€æ€»ä½“æŒ‡æ ‡ã€‘")
        è¡Œåˆ—è¡¨.append(f"  æ€»ä½“å‡†ç¡®ç‡: {self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡:.4f}")
        è¡Œåˆ—è¡¨.append(f"  æ ·æœ¬æ•°é‡: {self.ç»“æœ.æ ·æœ¬æ•°é‡}")
        è¡Œåˆ—è¡¨.append(f"  è¯„ä¼°æ—¶é—´: {self.ç»“æœ.è¯„ä¼°æ—¶é—´:.2f} ç§’")
        è¡Œåˆ—è¡¨.append("")
        
        # å¹³å‡æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€å¹³å‡æŒ‡æ ‡ã€‘")
        if self.ç»“æœ.å®å¹³å‡:
            è¡Œåˆ—è¡¨.append(f"  å®å¹³å‡ç²¾ç¡®ç‡: {self.ç»“æœ.å®å¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  å®å¹³å‡å¬å›ç‡: {self.ç»“æœ.å®å¹³å‡.get('å¬å›ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  å®å¹³å‡F1: {self.ç»“æœ.å®å¹³å‡.get('F1åˆ†æ•°', 0):.4f}")
        if self.ç»“æœ.åŠ æƒå¹³å‡:
            è¡Œåˆ—è¡¨.append(f"  åŠ æƒå¹³å‡ç²¾ç¡®ç‡: {self.ç»“æœ.åŠ æƒå¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  åŠ æƒå¹³å‡å¬å›ç‡: {self.ç»“æœ.åŠ æƒå¹³å‡.get('å¬å›ç‡', 0):.4f}")
            è¡Œåˆ—è¡¨.append(f"  åŠ æƒå¹³å‡F1: {self.ç»“æœ.åŠ æƒå¹³å‡.get('F1åˆ†æ•°', 0):.4f}")
        è¡Œåˆ—è¡¨.append("")
        
        # å„ç±»åˆ«æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€å„ç±»åˆ«æŒ‡æ ‡ã€‘")
        è¡Œåˆ—è¡¨.append(f"{'ç±»åˆ«':<15} {'ç²¾ç¡®ç‡':<10} {'å¬å›ç‡':<10} {'F1':<10} {'æ ·æœ¬æ•°':<8}")
        è¡Œåˆ—è¡¨.append("-" * 55)
        
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            è¡Œåˆ—è¡¨.append(
                f"{ç±»åˆ«å:<15} {æŒ‡æ ‡.ç²¾ç¡®ç‡:<10.4f} {æŒ‡æ ‡.å¬å›ç‡:<10.4f} "
                f"{æŒ‡æ ‡.F1åˆ†æ•°:<10.4f} {æŒ‡æ ‡.æ”¯æŒæ•°:<8}"
            )
        è¡Œåˆ—è¡¨.append("")
        
        # æ··æ·†çŸ©é˜µ
        if åŒ…å«æ··æ·†çŸ©é˜µ and self.ç»“æœ.æ··æ·†çŸ©é˜µ.size > 0:
            è¡Œåˆ—è¡¨.append("ã€æ··æ·†çŸ©é˜µã€‘")
            è¡Œåˆ—è¡¨.append(self._æ ¼å¼åŒ–æ··æ·†çŸ©é˜µæ–‡æœ¬())
            è¡Œåˆ—è¡¨.append("")
        
        # åˆ†ææ‘˜è¦
        è¡Œåˆ—è¡¨.append("ã€åˆ†ææ‘˜è¦ã€‘")
        æ‘˜è¦ = self._ç”Ÿæˆåˆ†ææ‘˜è¦()
        for é¡¹ in æ‘˜è¦:
            è¡Œåˆ—è¡¨.append(f"  {é¡¹}")
        è¡Œåˆ—è¡¨.append("")
        
        # æ”¹è¿›å»ºè®®
        if åŒ…å«å»ºè®®:
            è¡Œåˆ—è¡¨.append("ã€æ”¹è¿›å»ºè®®ã€‘")
            å»ºè®®åˆ—è¡¨ = self.ç”Ÿæˆæ”¹è¿›å»ºè®®()
            for å»ºè®® in å»ºè®®åˆ—è¡¨:
                è¡Œåˆ—è¡¨.append(f"  {å»ºè®®}")
            è¡Œåˆ—è¡¨.append("")
        
        è¡Œåˆ—è¡¨.append("=" * 60)
        
        return "\n".join(è¡Œåˆ—è¡¨)
    
    def _æ ¼å¼åŒ–æ··æ·†çŸ©é˜µæ–‡æœ¬(self) -> str:
        """æ ¼å¼åŒ–æ··æ·†çŸ©é˜µä¸ºæ–‡æœ¬è¡¨æ ¼"""
        if self.ç»“æœ.æ··æ·†çŸ©é˜µ.size == 0:
            return "  (æ— æ•°æ®)"
        
        çŸ©é˜µ = self.ç»“æœ.æ··æ·†çŸ©é˜µ
        ç±»åˆ«æ•° = len(çŸ©é˜µ)
        
        # è·å–ç±»åˆ«åç§°
        ç±»åˆ«åç§° = []
        for i in range(ç±»åˆ«æ•°):
            åç§° = self.åŠ¨ä½œå®šä¹‰.get(i, f"C{i}")
            # æˆªæ–­è¿‡é•¿çš„åç§°
            if len(åç§°) > 8:
                åç§° = åç§°[:7] + "."
            ç±»åˆ«åç§°.append(åç§°)
        
        è¡Œåˆ—è¡¨ = []
        
        # è¡¨å¤´
        è¡¨å¤´ = "  " + " " * 10 + "  ".join(f"{åç§°:>8}" for åç§° in ç±»åˆ«åç§°)
        è¡Œåˆ—è¡¨.append(è¡¨å¤´)
        è¡Œåˆ—è¡¨.append("  " + "-" * (10 + 10 * ç±»åˆ«æ•°))
        
        # æ•°æ®è¡Œ
        for i in range(ç±»åˆ«æ•°):
            è¡Œæ•°æ® = f"  {ç±»åˆ«åç§°[i]:<10}" + "  ".join(f"{int(çŸ©é˜µ[i, j]):>8}" for j in range(ç±»åˆ«æ•°))
            è¡Œåˆ—è¡¨.append(è¡Œæ•°æ®)
        
        return "\n".join(è¡Œåˆ—è¡¨)
    
    def _ç”Ÿæˆåˆ†ææ‘˜è¦(self) -> List[str]:
        """ç”Ÿæˆåˆ†ææ‘˜è¦"""
        æ‘˜è¦ = []
        
        # æ€»ä½“è¡¨ç°è¯„ä»·
        å‡†ç¡®ç‡ = self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡
        if å‡†ç¡®ç‡ >= 0.9:
            æ‘˜è¦.append(f"æ€»ä½“è¡¨ç°: ä¼˜ç§€ (å‡†ç¡®ç‡ {å‡†ç¡®ç‡:.1%})")
        elif å‡†ç¡®ç‡ >= 0.8:
            æ‘˜è¦.append(f"æ€»ä½“è¡¨ç°: è‰¯å¥½ (å‡†ç¡®ç‡ {å‡†ç¡®ç‡:.1%})")
        elif å‡†ç¡®ç‡ >= 0.7:
            æ‘˜è¦.append(f"æ€»ä½“è¡¨ç°: ä¸€èˆ¬ (å‡†ç¡®ç‡ {å‡†ç¡®ç‡:.1%})")
        else:
            æ‘˜è¦.append(f"æ€»ä½“è¡¨ç°: éœ€æ”¹è¿› (å‡†ç¡®ç‡ {å‡†ç¡®ç‡:.1%})")
        
        # å¼±åŠ¿ç±»åˆ«ç»Ÿè®¡
        å¼±åŠ¿ç±»åˆ« = self._è¯†åˆ«å¼±åŠ¿ç±»åˆ«()
        if å¼±åŠ¿ç±»åˆ«:
            æ‘˜è¦.append(f"å¼±åŠ¿ç±»åˆ«æ•°: {len(å¼±åŠ¿ç±»åˆ«)} ä¸ª")
            æ‘˜è¦.append(f"å¼±åŠ¿ç±»åˆ«: {', '.join(å¼±åŠ¿ç±»åˆ«[:5])}" + ("..." if len(å¼±åŠ¿ç±»åˆ«) > 5 else ""))
        else:
            æ‘˜è¦.append("æ‰€æœ‰ç±»åˆ«è¡¨ç°å‡è¾¾æ ‡")
        
        # æ··æ·†å¯¹ç»Ÿè®¡
        æ··æ·†å¯¹ = self._è¯†åˆ«æ··æ·†å¯¹()
        if æ··æ·†å¯¹:
            æ‘˜è¦.append(f"ä¸»è¦æ··æ·†å¯¹æ•°: {len(æ··æ·†å¯¹)} å¯¹")
            if æ··æ·†å¯¹:
                æœ€ä¸¥é‡ = æ··æ·†å¯¹[0]
                æ‘˜è¦.append(f"æœ€ä¸¥é‡æ··æ·†: {æœ€ä¸¥é‡[0]} â†’ {æœ€ä¸¥é‡[1]} ({æœ€ä¸¥é‡[2]:.1%})")
        
        return æ‘˜è¦
    
    def _è¯†åˆ«å¼±åŠ¿ç±»åˆ«(self, F1é˜ˆå€¼: float = 0.7) -> List[str]:
        """è¯†åˆ«å¼±åŠ¿ç±»åˆ«ï¼ˆF1 < é˜ˆå€¼ï¼‰"""
        if self._å¼±åŠ¿ç±»åˆ«ç¼“å­˜ is not None:
            return self._å¼±åŠ¿ç±»åˆ«ç¼“å­˜
        
        å¼±åŠ¿ç±»åˆ« = []
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.æ”¯æŒæ•° > 0 and æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                å¼±åŠ¿ç±»åˆ«.append(ç±»åˆ«å)
        
        # æŒ‰ F1 åˆ†æ•°æ’åº
        å¼±åŠ¿ç±»åˆ«.sort(key=lambda x: self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡[x].F1åˆ†æ•°)
        self._å¼±åŠ¿ç±»åˆ«ç¼“å­˜ = å¼±åŠ¿ç±»åˆ«
        return å¼±åŠ¿ç±»åˆ«
    
    def _è¯†åˆ«æ··æ·†å¯¹(self, é˜ˆå€¼: float = 0.1) -> List[Tuple[str, str, float]]:
        """è¯†åˆ«æ··æ·†å¯¹"""
        if self._æ··æ·†å¯¹ç¼“å­˜ is not None:
            return self._æ··æ·†å¯¹ç¼“å­˜
        
        if self.ç»“æœ.æ··æ·†çŸ©é˜µ.size == 0:
            return []
        
        æ··æ·†å¯¹ = []
        çŸ©é˜µ = self.ç»“æœ.æ··æ·†çŸ©é˜µ
        ç±»åˆ«æ•° = len(çŸ©é˜µ)
        
        for i in range(ç±»åˆ«æ•°):
            è¡Œå’Œ = np.sum(çŸ©é˜µ[i, :])
            if è¡Œå’Œ == 0:
                continue
            
            for j in range(ç±»åˆ«æ•°):
                if i == j:
                    continue
                
                æ··æ·†æ¯”ä¾‹ = çŸ©é˜µ[i, j] / è¡Œå’Œ
                if æ··æ·†æ¯”ä¾‹ >= é˜ˆå€¼:
                    ç±»åˆ«A = self.åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
                    ç±»åˆ«B = self.åŠ¨ä½œå®šä¹‰.get(j, f"ç±»åˆ«{j}")
                    æ··æ·†å¯¹.append((ç±»åˆ«A, ç±»åˆ«B, æ··æ·†æ¯”ä¾‹))
        
        æ··æ·†å¯¹.sort(key=lambda x: x[2], reverse=True)
        self._æ··æ·†å¯¹ç¼“å­˜ = æ··æ·†å¯¹
        return æ··æ·†å¯¹
    
    def ç”ŸæˆMarkdownæŠ¥å‘Š(self, è¾“å‡ºè·¯å¾„: str = None, åŒ…å«æ··æ·†çŸ©é˜µ: bool = True, åŒ…å«å»ºè®®: bool = True) -> str:
        """
        ç”Ÿæˆ Markdown æ ¼å¼æŠ¥å‘Š
        
        å‚æ•°:
            è¾“å‡ºè·¯å¾„: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ŒNone åˆ™åªè¿”å›å†…å®¹
            åŒ…å«æ··æ·†çŸ©é˜µ: æ˜¯å¦åŒ…å«æ··æ·†çŸ©é˜µ
            åŒ…å«å»ºè®®: æ˜¯å¦åŒ…å«æ”¹è¿›å»ºè®®
            
        è¿”å›:
            Markdown å†…å®¹
        """
        è¡Œåˆ—è¡¨ = []
        è¡Œåˆ—è¡¨.append("# æ¨¡å‹è¯„ä¼°æŠ¥å‘Š")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("## æ€»ä½“æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append(f"- **æ€»ä½“å‡†ç¡®ç‡**: {self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡:.4f}")
        è¡Œåˆ—è¡¨.append(f"- **æ ·æœ¬æ•°é‡**: {self.ç»“æœ.æ ·æœ¬æ•°é‡}")
        è¡Œåˆ—è¡¨.append(f"- **è¯„ä¼°æ—¶é—´**: {self.ç»“æœ.è¯„ä¼°æ—¶é—´:.2f} ç§’")
        è¡Œåˆ—è¡¨.append("")
        
        # å¹³å‡æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("## å¹³å‡æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("| æŒ‡æ ‡ç±»å‹ | ç²¾ç¡®ç‡ | å¬å›ç‡ | F1åˆ†æ•° |")
        è¡Œåˆ—è¡¨.append("|---------|--------|--------|--------|")
        if self.ç»“æœ.å®å¹³å‡:
            è¡Œåˆ—è¡¨.append(
                f"| å®å¹³å‡ | {self.ç»“æœ.å®å¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f} | "
                f"{self.ç»“æœ.å®å¹³å‡.get('å¬å›ç‡', 0):.4f} | "
                f"{self.ç»“æœ.å®å¹³å‡.get('F1åˆ†æ•°', 0):.4f} |"
            )
        if self.ç»“æœ.åŠ æƒå¹³å‡:
            è¡Œåˆ—è¡¨.append(
                f"| åŠ æƒå¹³å‡ | {self.ç»“æœ.åŠ æƒå¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f} | "
                f"{self.ç»“æœ.åŠ æƒå¹³å‡.get('å¬å›ç‡', 0):.4f} | "
                f"{self.ç»“æœ.åŠ æƒå¹³å‡.get('F1åˆ†æ•°', 0):.4f} |"
            )
        è¡Œåˆ—è¡¨.append("")
        
        # å„ç±»åˆ«æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("## å„ç±»åˆ«æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("| ç±»åˆ« | ç²¾ç¡®ç‡ | å¬å›ç‡ | F1åˆ†æ•° | æ ·æœ¬æ•° |")
        è¡Œåˆ—è¡¨.append("|------|--------|--------|--------|--------|")
        
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            è¡Œåˆ—è¡¨.append(
                f"| {ç±»åˆ«å} | {æŒ‡æ ‡.ç²¾ç¡®ç‡:.4f} | {æŒ‡æ ‡.å¬å›ç‡:.4f} | "
                f"{æŒ‡æ ‡.F1åˆ†æ•°:.4f} | {æŒ‡æ ‡.æ”¯æŒæ•°} |"
            )
        è¡Œåˆ—è¡¨.append("")
        
        # æ··æ·†çŸ©é˜µ
        if åŒ…å«æ··æ·†çŸ©é˜µ and self.ç»“æœ.æ··æ·†çŸ©é˜µ.size > 0:
            è¡Œåˆ—è¡¨.append("## æ··æ·†çŸ©é˜µ")
            è¡Œåˆ—è¡¨.append("")
            è¡Œåˆ—è¡¨.append(self._æ ¼å¼åŒ–æ··æ·†çŸ©é˜µMarkdown())
            è¡Œåˆ—è¡¨.append("")
        
        # åˆ†ææ‘˜è¦
        è¡Œåˆ—è¡¨.append("## åˆ†ææ‘˜è¦")
        è¡Œåˆ—è¡¨.append("")
        æ‘˜è¦ = self._ç”Ÿæˆåˆ†ææ‘˜è¦()
        for é¡¹ in æ‘˜è¦:
            è¡Œåˆ—è¡¨.append(f"- {é¡¹}")
        è¡Œåˆ—è¡¨.append("")
        
        # æ”¹è¿›å»ºè®®
        if åŒ…å«å»ºè®®:
            è¡Œåˆ—è¡¨.append("## æ”¹è¿›å»ºè®®")
            è¡Œåˆ—è¡¨.append("")
            å»ºè®®åˆ—è¡¨ = self.ç”Ÿæˆæ”¹è¿›å»ºè®®()
            for å»ºè®® in å»ºè®®åˆ—è¡¨:
                è¡Œåˆ—è¡¨.append(f"- {å»ºè®®}")
            è¡Œåˆ—è¡¨.append("")
        
        å†…å®¹ = "\n".join(è¡Œåˆ—è¡¨)
        
        if è¾“å‡ºè·¯å¾„:
            os.makedirs(os.path.dirname(è¾“å‡ºè·¯å¾„) or '.', exist_ok=True)
            with open(è¾“å‡ºè·¯å¾„, 'w', encoding='utf-8') as f:
                f.write(å†…å®¹)
            æ—¥å¿—.info(f"Markdown æŠ¥å‘Šå·²ä¿å­˜: {è¾“å‡ºè·¯å¾„}")
        
        return å†…å®¹
    
    def _æ ¼å¼åŒ–æ··æ·†çŸ©é˜µMarkdown(self) -> str:
        """æ ¼å¼åŒ–æ··æ·†çŸ©é˜µä¸º Markdown è¡¨æ ¼"""
        if self.ç»“æœ.æ··æ·†çŸ©é˜µ.size == 0:
            return "*æ— æ•°æ®*"
        
        çŸ©é˜µ = self.ç»“æœ.æ··æ·†çŸ©é˜µ
        ç±»åˆ«æ•° = len(çŸ©é˜µ)
        
        # è·å–ç±»åˆ«åç§°
        ç±»åˆ«åç§° = []
        for i in range(ç±»åˆ«æ•°):
            åç§° = self.åŠ¨ä½œå®šä¹‰.get(i, f"C{i}")
            ç±»åˆ«åç§°.append(åç§°)
        
        è¡Œåˆ—è¡¨ = []
        
        # è¡¨å¤´
        è¡¨å¤´ = "| çœŸå®\\é¢„æµ‹ | " + " | ".join(ç±»åˆ«åç§°) + " |"
        è¡Œåˆ—è¡¨.append(è¡¨å¤´)
        
        # åˆ†éš”è¡Œ
        åˆ†éš” = "|" + "|".join(["---"] * (ç±»åˆ«æ•° + 1)) + "|"
        è¡Œåˆ—è¡¨.append(åˆ†éš”)
        
        # æ•°æ®è¡Œ
        for i in range(ç±»åˆ«æ•°):
            è¡Œæ•°æ® = f"| **{ç±»åˆ«åç§°[i]}** | " + " | ".join(str(int(çŸ©é˜µ[i, j])) for j in range(ç±»åˆ«æ•°)) + " |"
            è¡Œåˆ—è¡¨.append(è¡Œæ•°æ®)
        
        return "\n".join(è¡Œåˆ—è¡¨)
    
    def ç”ŸæˆJSONæŠ¥å‘Š(self, è¾“å‡ºè·¯å¾„: str = None) -> dict:
        """
        ç”Ÿæˆ JSON æ ¼å¼æŠ¥å‘Š
        
        å‚æ•°:
            è¾“å‡ºè·¯å¾„: è¾“å‡ºæ–‡ä»¶è·¯å¾„
            
        è¿”å›:
            æŠ¥å‘Šå­—å…¸
        """
        æŠ¥å‘Š = self.ç»“æœ.to_dict()
        
        # æ·»åŠ åˆ†ææ‘˜è¦å’Œæ”¹è¿›å»ºè®®
        æŠ¥å‘Š['åˆ†ææ‘˜è¦'] = self._ç”Ÿæˆåˆ†ææ‘˜è¦()
        æŠ¥å‘Š['æ”¹è¿›å»ºè®®'] = self.ç”Ÿæˆæ”¹è¿›å»ºè®®()
        
        if è¾“å‡ºè·¯å¾„:
            os.makedirs(os.path.dirname(è¾“å‡ºè·¯å¾„) or '.', exist_ok=True)
            with open(è¾“å‡ºè·¯å¾„, 'w', encoding='utf-8') as f:
                json.dump(æŠ¥å‘Š, f, ensure_ascii=False, indent=2)
            æ—¥å¿—.info(f"JSON æŠ¥å‘Šå·²ä¿å­˜: {è¾“å‡ºè·¯å¾„}")
        
        return æŠ¥å‘Š
    
    def ç”ŸæˆHTMLæŠ¥å‘Š(self, è¾“å‡ºè·¯å¾„: str = None, åŒ…å«æ··æ·†çŸ©é˜µ: bool = True, åŒ…å«å»ºè®®: bool = True) -> str:
        """
        ç”Ÿæˆ HTML æ ¼å¼æŠ¥å‘Š
        
        å‚æ•°:
            è¾“å‡ºè·¯å¾„: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ŒNone åˆ™åªè¿”å›å†…å®¹
            åŒ…å«æ··æ·†çŸ©é˜µ: æ˜¯å¦åŒ…å«æ··æ·†çŸ©é˜µ
            åŒ…å«å»ºè®®: æ˜¯å¦åŒ…å«æ”¹è¿›å»ºè®®
            
        è¿”å›:
            HTML å†…å®¹
        """
        # HTML æ¨¡æ¿
        html_parts = []
        html_parts.append("""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹è¯„ä¼°æŠ¥å‘Š</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .metric-card {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px;
            min-width: 150px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .suggestion {
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .suggestion.good {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        .summary-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .confusion-matrix {
            overflow-x: auto;
        }
        .confusion-matrix table {
            min-width: 100%;
        }
        .confusion-matrix th:first-child,
        .confusion-matrix td:first-child {
            background-color: #f0f0f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æ¨¡å‹è¯„ä¼°æŠ¥å‘Š</h1>
""")
        
        # æ€»ä½“æŒ‡æ ‡å¡ç‰‡
        html_parts.append("""
        <h2>æ€»ä½“æŒ‡æ ‡</h2>
        <div class="metrics-container">
""")
        html_parts.append(f"""
            <div class="metric-card">
                <div class="metric-value">{self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡:.1%}</div>
                <div class="metric-label">æ€»ä½“å‡†ç¡®ç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{self.ç»“æœ.æ ·æœ¬æ•°é‡}</div>
                <div class="metric-label">æ ·æœ¬æ•°é‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">{self.ç»“æœ.è¯„ä¼°æ—¶é—´:.2f}s</div>
                <div class="metric-label">è¯„ä¼°æ—¶é—´</div>
            </div>
        </div>
""")
        
        # å¹³å‡æŒ‡æ ‡è¡¨æ ¼
        html_parts.append("""
        <h2>å¹³å‡æŒ‡æ ‡</h2>
        <table>
            <tr>
                <th>æŒ‡æ ‡ç±»å‹</th>
                <th>ç²¾ç¡®ç‡</th>
                <th>å¬å›ç‡</th>
                <th>F1åˆ†æ•°</th>
            </tr>
""")
        if self.ç»“æœ.å®å¹³å‡:
            html_parts.append(f"""
            <tr>
                <td>å®å¹³å‡</td>
                <td>{self.ç»“æœ.å®å¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f}</td>
                <td>{self.ç»“æœ.å®å¹³å‡.get('å¬å›ç‡', 0):.4f}</td>
                <td>{self.ç»“æœ.å®å¹³å‡.get('F1åˆ†æ•°', 0):.4f}</td>
            </tr>
""")
        if self.ç»“æœ.åŠ æƒå¹³å‡:
            html_parts.append(f"""
            <tr>
                <td>åŠ æƒå¹³å‡</td>
                <td>{self.ç»“æœ.åŠ æƒå¹³å‡.get('ç²¾ç¡®ç‡', 0):.4f}</td>
                <td>{self.ç»“æœ.åŠ æƒå¹³å‡.get('å¬å›ç‡', 0):.4f}</td>
                <td>{self.ç»“æœ.åŠ æƒå¹³å‡.get('F1åˆ†æ•°', 0):.4f}</td>
            </tr>
""")
        html_parts.append("        </table>")
        
        # å„ç±»åˆ«æŒ‡æ ‡è¡¨æ ¼
        html_parts.append("""
        <h2>å„ç±»åˆ«æŒ‡æ ‡</h2>
        <table>
            <tr>
                <th>ç±»åˆ«</th>
                <th>ç²¾ç¡®ç‡</th>
                <th>å¬å›ç‡</th>
                <th>F1åˆ†æ•°</th>
                <th>æ ·æœ¬æ•°</th>
            </tr>
""")
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            html_parts.append(f"""
            <tr>
                <td>{ç±»åˆ«å}</td>
                <td>{æŒ‡æ ‡.ç²¾ç¡®ç‡:.4f}</td>
                <td>{æŒ‡æ ‡.å¬å›ç‡:.4f}</td>
                <td>{æŒ‡æ ‡.F1åˆ†æ•°:.4f}</td>
                <td>{æŒ‡æ ‡.æ”¯æŒæ•°}</td>
            </tr>
""")
        html_parts.append("        </table>")
        
        # æ··æ·†çŸ©é˜µ
        if åŒ…å«æ··æ·†çŸ©é˜µ and self.ç»“æœ.æ··æ·†çŸ©é˜µ.size > 0:
            html_parts.append("""
        <h2>æ··æ·†çŸ©é˜µ</h2>
        <div class="confusion-matrix">
""")
            html_parts.append(self._æ ¼å¼åŒ–æ··æ·†çŸ©é˜µHTML())
            html_parts.append("        </div>")
        
        # åˆ†ææ‘˜è¦
        html_parts.append("""
        <h2>åˆ†ææ‘˜è¦</h2>
""")
        æ‘˜è¦ = self._ç”Ÿæˆåˆ†ææ‘˜è¦()
        for é¡¹ in æ‘˜è¦:
            html_parts.append(f'        <div class="summary-item">{é¡¹}</div>')
        
        # æ”¹è¿›å»ºè®®
        if åŒ…å«å»ºè®®:
            html_parts.append("""
        <h2>æ”¹è¿›å»ºè®®</h2>
""")
            å»ºè®®åˆ—è¡¨ = self.ç”Ÿæˆæ”¹è¿›å»ºè®®()
            for å»ºè®® in å»ºè®®åˆ—è¡¨:
                css_class = "suggestion good" if "âœ…" in å»ºè®® else "suggestion"
                html_parts.append(f'        <div class="{css_class}">{å»ºè®®}</div>')
        
        # ç»“æŸæ ‡ç­¾
        html_parts.append("""
    </div>
</body>
</html>
""")
        
        å†…å®¹ = "".join(html_parts)
        
        if è¾“å‡ºè·¯å¾„:
            os.makedirs(os.path.dirname(è¾“å‡ºè·¯å¾„) or '.', exist_ok=True)
            with open(è¾“å‡ºè·¯å¾„, 'w', encoding='utf-8') as f:
                f.write(å†…å®¹)
            æ—¥å¿—.info(f"HTML æŠ¥å‘Šå·²ä¿å­˜: {è¾“å‡ºè·¯å¾„}")
        
        return å†…å®¹
    
    def _æ ¼å¼åŒ–æ··æ·†çŸ©é˜µHTML(self) -> str:
        """æ ¼å¼åŒ–æ··æ·†çŸ©é˜µä¸º HTML è¡¨æ ¼"""
        if self.ç»“æœ.æ··æ·†çŸ©é˜µ.size == 0:
            return "<p><em>æ— æ•°æ®</em></p>"
        
        çŸ©é˜µ = self.ç»“æœ.æ··æ·†çŸ©é˜µ
        ç±»åˆ«æ•° = len(çŸ©é˜µ)
        
        # è·å–ç±»åˆ«åç§°
        ç±»åˆ«åç§° = []
        for i in range(ç±»åˆ«æ•°):
            åç§° = self.åŠ¨ä½œå®šä¹‰.get(i, f"C{i}")
            ç±»åˆ«åç§°.append(åç§°)
        
        html_parts = ["            <table>"]
        
        # è¡¨å¤´
        html_parts.append("                <tr>")
        html_parts.append("                    <th>çœŸå®\\é¢„æµ‹</th>")
        for åç§° in ç±»åˆ«åç§°:
            html_parts.append(f"                    <th>{åç§°}</th>")
        html_parts.append("                </tr>")
        
        # æ•°æ®è¡Œ
        for i in range(ç±»åˆ«æ•°):
            html_parts.append("                <tr>")
            html_parts.append(f"                    <td><strong>{ç±»åˆ«åç§°[i]}</strong></td>")
            for j in range(ç±»åˆ«æ•°):
                å€¼ = int(çŸ©é˜µ[i, j])
                html_parts.append(f"                    <td>{å€¼}</td>")
            html_parts.append("                </tr>")
        
        html_parts.append("            </table>")
        return "\n".join(html_parts)
    
    def ç”Ÿæˆæ”¹è¿›å»ºè®®(self, F1é˜ˆå€¼: float = 0.7, ç²¾ç¡®ç‡é˜ˆå€¼: float = 0.6, å¬å›ç‡é˜ˆå€¼: float = 0.6) -> List[str]:
        """
        ç”Ÿæˆæ¨¡å‹æ”¹è¿›å»ºè®®
        
        å‚æ•°:
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼ï¼Œä½äºæ­¤å€¼è§†ä¸ºå¼±åŠ¿ç±»åˆ«
            ç²¾ç¡®ç‡é˜ˆå€¼: ç²¾ç¡®ç‡é˜ˆå€¼
            å¬å›ç‡é˜ˆå€¼: å¬å›ç‡é˜ˆå€¼
            
        è¿”å›:
            æ”¹è¿›å»ºè®®åˆ—è¡¨
        """
        å»ºè®®åˆ—è¡¨ = []
        
        # æ£€æŸ¥æ€»ä½“å‡†ç¡®ç‡
        if self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡ < 0.7:
            å»ºè®®åˆ—è¡¨.append("âš ï¸ æ€»ä½“å‡†ç¡®ç‡è¾ƒä½ï¼Œå»ºè®®å¢åŠ è®­ç»ƒæ•°æ®æˆ–è°ƒæ•´æ¨¡å‹ç»“æ„")
        elif self.ç»“æœ.æ€»ä½“å‡†ç¡®ç‡ < 0.8:
            å»ºè®®åˆ—è¡¨.append("ğŸ’¡ æ€»ä½“å‡†ç¡®ç‡ä¸€èˆ¬ï¼Œå¯è€ƒè™‘æ•°æ®å¢å¼ºæˆ–è°ƒæ•´è¶…å‚æ•°")
        
        # æ£€æŸ¥å¼±åŠ¿ç±»åˆ«
        å¼±åŠ¿ç±»åˆ«è¯¦æƒ… = []
        è¿‡åº¦é¢„æµ‹ç±»åˆ« = []
        æ¬ é¢„æµ‹ç±»åˆ« = []
        
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.æ”¯æŒæ•° > 0:
                if æŒ‡æ ‡.F1åˆ†æ•° < 0.5:
                    å¼±åŠ¿ç±»åˆ«è¯¦æƒ….append((ç±»åˆ«å, æŒ‡æ ‡.F1åˆ†æ•°, æŒ‡æ ‡.æ”¯æŒæ•°))
                elif æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                    å¼±åŠ¿ç±»åˆ«è¯¦æƒ….append((ç±»åˆ«å, æŒ‡æ ‡.F1åˆ†æ•°, æŒ‡æ ‡.æ”¯æŒæ•°))
                
                if æŒ‡æ ‡.ç²¾ç¡®ç‡ < ç²¾ç¡®ç‡é˜ˆå€¼ and æŒ‡æ ‡.å¬å›ç‡ > 0.8:
                    è¿‡åº¦é¢„æµ‹ç±»åˆ«.append(ç±»åˆ«å)
                elif æŒ‡æ ‡.å¬å›ç‡ < å¬å›ç‡é˜ˆå€¼ and æŒ‡æ ‡.ç²¾ç¡®ç‡ > 0.8:
                    æ¬ é¢„æµ‹ç±»åˆ«.append(ç±»åˆ«å)
        
        # å¼±åŠ¿ç±»åˆ«å»ºè®®
        if å¼±åŠ¿ç±»åˆ«è¯¦æƒ…:
            # æŒ‰ F1 åˆ†æ•°æ’åº
            å¼±åŠ¿ç±»åˆ«è¯¦æƒ….sort(key=lambda x: x[1])
            for ç±»åˆ«å, f1, æ”¯æŒæ•° in å¼±åŠ¿ç±»åˆ«è¯¦æƒ…[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                if f1 < 0.5:
                    å»ºè®®åˆ—è¡¨.append(f"âš ï¸ ç±»åˆ« '{ç±»åˆ«å}' F1åˆ†æ•°è¿‡ä½ ({f1:.2f})ï¼Œå»ºè®®å¢åŠ è¯¥ç±»åˆ«çš„è®­ç»ƒæ ·æœ¬")
                else:
                    å»ºè®®åˆ—è¡¨.append(f"ğŸ’¡ ç±»åˆ« '{ç±»åˆ«å}' F1åˆ†æ•°åä½ ({f1:.2f})ï¼Œå¯è€ƒè™‘å¢åŠ è®­ç»ƒæ ·æœ¬æˆ–è°ƒæ•´ç±»åˆ«æƒé‡")
        
        # è¿‡åº¦é¢„æµ‹å»ºè®®
        if è¿‡åº¦é¢„æµ‹ç±»åˆ«:
            å»ºè®®åˆ—è¡¨.append(f"ğŸ’¡ ç±»åˆ« {', '.join(è¿‡åº¦é¢„æµ‹ç±»åˆ«[:3])} ç²¾ç¡®ç‡ä½ä½†å¬å›ç‡é«˜ï¼Œå¯èƒ½å­˜åœ¨è¿‡åº¦é¢„æµ‹ï¼Œå»ºè®®æ£€æŸ¥è®­ç»ƒæ•°æ®è´¨é‡")
        
        # æ¬ é¢„æµ‹å»ºè®®
        if æ¬ é¢„æµ‹ç±»åˆ«:
            å»ºè®®åˆ—è¡¨.append(f"ğŸ’¡ ç±»åˆ« {', '.join(æ¬ é¢„æµ‹ç±»åˆ«[:3])} å¬å›ç‡ä½ä½†ç²¾ç¡®ç‡é«˜ï¼Œå¯èƒ½å­˜åœ¨æ¬ é¢„æµ‹ï¼Œå»ºè®®å¢åŠ è¯¥ç±»åˆ«æ ·æœ¬")
        
        # æ£€æŸ¥æ ·æœ¬ä¸å¹³è¡¡
        æ”¯æŒæ•°åˆ—è¡¨ = [æŒ‡æ ‡.æ”¯æŒæ•° for æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.values() if æŒ‡æ ‡.æ”¯æŒæ•° > 0]
        if æ”¯æŒæ•°åˆ—è¡¨:
            æœ€å¤§æ”¯æŒæ•° = max(æ”¯æŒæ•°åˆ—è¡¨)
            æœ€å°æ”¯æŒæ•° = min(æ”¯æŒæ•°åˆ—è¡¨)
            if æœ€å¤§æ”¯æŒæ•° > æœ€å°æ”¯æŒæ•° * 10:
                å»ºè®®åˆ—è¡¨.append("âš ï¸ ç±»åˆ«æ ·æœ¬æ•°é‡ä¸¥é‡ä¸å¹³è¡¡ï¼Œå»ºè®®ä½¿ç”¨ç±»åˆ«æƒé‡æˆ–è¿‡é‡‡æ ·")
            elif æœ€å¤§æ”¯æŒæ•° > æœ€å°æ”¯æŒæ•° * 5:
                å»ºè®®åˆ—è¡¨.append("ğŸ’¡ ç±»åˆ«æ ·æœ¬æ•°é‡å­˜åœ¨ä¸å¹³è¡¡ï¼Œå¯è€ƒè™‘ä½¿ç”¨ç±»åˆ«æƒé‡")
        
        # æ£€æŸ¥æ··æ·†å¯¹
        æ··æ·†å¯¹ = self._è¯†åˆ«æ··æ·†å¯¹(é˜ˆå€¼=0.15)
        if æ··æ·†å¯¹:
            æœ€ä¸¥é‡æ··æ·† = æ··æ·†å¯¹[:3]
            for çœŸå®, é¢„æµ‹, æ¯”ä¾‹ in æœ€ä¸¥é‡æ··æ·†:
                å»ºè®®åˆ—è¡¨.append(f"ğŸ’¡ '{çœŸå®}' ç»å¸¸è¢«è¯¯åˆ¤ä¸º '{é¢„æµ‹}' ({æ¯”ä¾‹:.1%})ï¼Œå»ºè®®æ£€æŸ¥è¿™ä¸¤ä¸ªç±»åˆ«çš„åŒºåˆ†ç‰¹å¾")
        
        if not å»ºè®®åˆ—è¡¨:
            å»ºè®®åˆ—è¡¨.append("âœ… æ¨¡å‹è¡¨ç°è‰¯å¥½ï¼Œæš‚æ— æ˜æ˜¾æ”¹è¿›å»ºè®®")
        
        return å»ºè®®åˆ—è¡¨
    
    def åˆ†æå¼±åŠ¿ç±»åˆ«(self, F1é˜ˆå€¼: float = 0.7) -> Dict[str, Any]:
        """
        è¯¦ç»†åˆ†æå¼±åŠ¿ç±»åˆ«
        
        å‚æ•°:
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
            
        è¿”å›:
            å¼±åŠ¿ç±»åˆ«åˆ†æç»“æœå­—å…¸
        """
        åˆ†æç»“æœ = {
            'å¼±åŠ¿ç±»åˆ«åˆ—è¡¨': [],
            'æ€»å¼±åŠ¿ç±»åˆ«æ•°': 0,
            'å¹³å‡F1åˆ†æ•°': 0.0,
            'å»ºè®®ä¼˜å…ˆå¤„ç†': []
        }
        
        å¼±åŠ¿ç±»åˆ« = []
        for ç±»åˆ«å, æŒ‡æ ‡ in self.ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.æ”¯æŒæ•° > 0 and æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                å¼±åŠ¿ç±»åˆ«.append({
                    'ç±»åˆ«å': ç±»åˆ«å,
                    'F1åˆ†æ•°': æŒ‡æ ‡.F1åˆ†æ•°,
                    'ç²¾ç¡®ç‡': æŒ‡æ ‡.ç²¾ç¡®ç‡,
                    'å¬å›ç‡': æŒ‡æ ‡.å¬å›ç‡,
                    'æ”¯æŒæ•°': æŒ‡æ ‡.æ”¯æŒæ•°,
                    'é—®é¢˜ç±»å‹': self._è¯Šæ–­é—®é¢˜ç±»å‹(æŒ‡æ ‡)
                })
        
        # æŒ‰ F1 åˆ†æ•°æ’åº
        å¼±åŠ¿ç±»åˆ«.sort(key=lambda x: x['F1åˆ†æ•°'])
        
        åˆ†æç»“æœ['å¼±åŠ¿ç±»åˆ«åˆ—è¡¨'] = å¼±åŠ¿ç±»åˆ«
        åˆ†æç»“æœ['æ€»å¼±åŠ¿ç±»åˆ«æ•°'] = len(å¼±åŠ¿ç±»åˆ«)
        
        if å¼±åŠ¿ç±»åˆ«:
            åˆ†æç»“æœ['å¹³å‡F1åˆ†æ•°'] = sum(c['F1åˆ†æ•°'] for c in å¼±åŠ¿ç±»åˆ«) / len(å¼±åŠ¿ç±»åˆ«)
            # ä¼˜å…ˆå¤„ç† F1 æœ€ä½çš„å‰3ä¸ª
            åˆ†æç»“æœ['å»ºè®®ä¼˜å…ˆå¤„ç†'] = [c['ç±»åˆ«å'] for c in å¼±åŠ¿ç±»åˆ«[:3]]
        
        return åˆ†æç»“æœ
    
    def _è¯Šæ–­é—®é¢˜ç±»å‹(self, æŒ‡æ ‡: ç±»åˆ«æŒ‡æ ‡) -> str:
        """è¯Šæ–­ç±»åˆ«çš„é—®é¢˜ç±»å‹"""
        if æŒ‡æ ‡.ç²¾ç¡®ç‡ < 0.5 and æŒ‡æ ‡.å¬å›ç‡ < 0.5:
            return "æ•´ä½“è¡¨ç°å·®"
        elif æŒ‡æ ‡.ç²¾ç¡®ç‡ < 0.6 and æŒ‡æ ‡.å¬å›ç‡ > 0.7:
            return "è¿‡åº¦é¢„æµ‹"
        elif æŒ‡æ ‡.å¬å›ç‡ < 0.6 and æŒ‡æ ‡.ç²¾ç¡®ç‡ > 0.7:
            return "æ¬ é¢„æµ‹"
        elif æŒ‡æ ‡.æ”¯æŒæ•° < 10:
            return "æ ·æœ¬ä¸è¶³"
        else:
            return "éœ€è¿›ä¸€æ­¥åˆ†æ"


class æµ‹è¯•æ•°æ®åŠ è½½å™¨:
    """æµ‹è¯•æ•°æ®åŠ è½½å™¨
    
    ä»æ•°æ®ç›®å½•åŠ è½½æµ‹è¯•æ•°æ®ï¼Œæ”¯æŒå¤šç§æ•°æ®æ ¼å¼ã€‚
    éœ€æ±‚: 4.1 - ä»æ•°æ®ç›®å½•åŠ è½½æµ‹è¯•æ•°æ®
    """
    
    def __init__(self, æ•°æ®ç›®å½•: str = None):
        """
        åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨
        
        å‚æ•°:
            æ•°æ®ç›®å½•: æ•°æ®ç›®å½•è·¯å¾„ï¼Œé»˜è®¤ä¸º "æ•°æ®/"
        """
        self.æ•°æ®ç›®å½• = æ•°æ®ç›®å½• or "æ•°æ®/"
        self.æ”¯æŒæ ¼å¼ = ['.npy', '.npz', '.json', '.pkl']
    
    def åŠ è½½æµ‹è¯•æ•°æ®(self, æ•°æ®è·¯å¾„: str = None, 
                     æµ‹è¯•æ¯”ä¾‹: float = 0.2,
                     éšæœºç§å­: int = 42,
                     æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """
        åŠ è½½æµ‹è¯•æ•°æ®
        
        å‚æ•°:
            æ•°æ®è·¯å¾„: æ•°æ®æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„ï¼ŒNone åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®ç›®å½•
            æµ‹è¯•æ¯”ä¾‹: ä»æ•°æ®ä¸­åˆ’åˆ†çš„æµ‹è¯•æ¯”ä¾‹ï¼ˆå¦‚æœæ²¡æœ‰å•ç‹¬çš„æµ‹è¯•é›†ï¼‰
            éšæœºç§å­: éšæœºç§å­ï¼Œç”¨äºå¯é‡å¤çš„æ•°æ®åˆ’åˆ†
            æœ€å¤§æ ·æœ¬æ•°: æœ€å¤§åŠ è½½æ ·æœ¬æ•°ï¼ŒNone è¡¨ç¤ºå…¨éƒ¨åŠ è½½
            
        è¿”å›:
            [(å›¾åƒ, æ ‡ç­¾), ...] åˆ—è¡¨
        """
        è·¯å¾„ = æ•°æ®è·¯å¾„ or self.æ•°æ®ç›®å½•
        
        if not os.path.exists(è·¯å¾„):
            æ—¥å¿—.warning(f"æ•°æ®è·¯å¾„ä¸å­˜åœ¨: {è·¯å¾„}")
            return []
        
        # åˆ¤æ–­æ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•
        if os.path.isfile(è·¯å¾„):
            return self._åŠ è½½å•ä¸ªæ–‡ä»¶(è·¯å¾„, æœ€å¤§æ ·æœ¬æ•°)
        else:
            return self._åŠ è½½ç›®å½•(è·¯å¾„, æµ‹è¯•æ¯”ä¾‹, éšæœºç§å­, æœ€å¤§æ ·æœ¬æ•°)
    
    def _åŠ è½½å•ä¸ªæ–‡ä»¶(self, æ–‡ä»¶è·¯å¾„: str, æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """åŠ è½½å•ä¸ªæ•°æ®æ–‡ä»¶"""
        æ‰©å±•å = os.path.splitext(æ–‡ä»¶è·¯å¾„)[1].lower()
        
        try:
            if æ‰©å±•å == '.npy':
                return self._åŠ è½½npyæ–‡ä»¶(æ–‡ä»¶è·¯å¾„, æœ€å¤§æ ·æœ¬æ•°)
            elif æ‰©å±•å == '.npz':
                return self._åŠ è½½npzæ–‡ä»¶(æ–‡ä»¶è·¯å¾„, æœ€å¤§æ ·æœ¬æ•°)
            elif æ‰©å±•å == '.json':
                return self._åŠ è½½jsonæ–‡ä»¶(æ–‡ä»¶è·¯å¾„, æœ€å¤§æ ·æœ¬æ•°)
            elif æ‰©å±•å == '.pkl':
                return self._åŠ è½½pklæ–‡ä»¶(æ–‡ä»¶è·¯å¾„, æœ€å¤§æ ·æœ¬æ•°)
            else:
                æ—¥å¿—.warning(f"ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: {æ‰©å±•å}")
                return []
        except Exception as e:
            æ—¥å¿—.error(f"åŠ è½½æ–‡ä»¶å¤±è´¥ {æ–‡ä»¶è·¯å¾„}: {e}")
            return []
    
    def _åŠ è½½npyæ–‡ä»¶(self, æ–‡ä»¶è·¯å¾„: str, æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """åŠ è½½ .npy æ ¼å¼æ–‡ä»¶"""
        æ•°æ® = np.load(æ–‡ä»¶è·¯å¾„, allow_pickle=True)
        
        æµ‹è¯•æ•°æ® = []
        for é¡¹ in æ•°æ®:
            if len(é¡¹) >= 2:
                å›¾åƒ = é¡¹[0]
                åŠ¨ä½œ = é¡¹[1]
                
                # å¤„ç†åŠ¨ä½œæ ¼å¼ï¼ˆå¯èƒ½æ˜¯ one-hot æˆ–ç´¢å¼•ï¼‰
                if isinstance(åŠ¨ä½œ, (list, np.ndarray)):
                    if len(åŠ¨ä½œ) > 1:
                        # one-hot ç¼–ç ï¼Œè½¬æ¢ä¸ºç´¢å¼•
                        æ ‡ç­¾ = int(np.argmax(åŠ¨ä½œ))
                    else:
                        æ ‡ç­¾ = int(åŠ¨ä½œ[0])
                else:
                    æ ‡ç­¾ = int(åŠ¨ä½œ)
                
                æµ‹è¯•æ•°æ®.append((å›¾åƒ, æ ‡ç­¾))
                
                if æœ€å¤§æ ·æœ¬æ•° and len(æµ‹è¯•æ•°æ®) >= æœ€å¤§æ ·æœ¬æ•°:
                    break
        
        æ—¥å¿—.info(f"ä» {æ–‡ä»¶è·¯å¾„} åŠ è½½äº† {len(æµ‹è¯•æ•°æ®)} ä¸ªæ ·æœ¬")
        return æµ‹è¯•æ•°æ®
    
    def _åŠ è½½npzæ–‡ä»¶(self, æ–‡ä»¶è·¯å¾„: str, æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """åŠ è½½ .npz æ ¼å¼æ–‡ä»¶"""
        æ•°æ® = np.load(æ–‡ä»¶è·¯å¾„, allow_pickle=True)
        
        # å°è¯•å¸¸è§çš„é”®å
        å›¾åƒé”® = None
        æ ‡ç­¾é”® = None
        
        for é”® in ['images', 'X', 'x', 'data', 'å›¾åƒ']:
            if é”® in æ•°æ®:
                å›¾åƒé”® = é”®
                break
        
        for é”® in ['labels', 'y', 'Y', 'targets', 'æ ‡ç­¾']:
            if é”® in æ•°æ®:
                æ ‡ç­¾é”® = é”®
                break
        
        if å›¾åƒé”® is None or æ ‡ç­¾é”® is None:
            æ—¥å¿—.warning(f"æ— æ³•è¯†åˆ« npz æ–‡ä»¶ç»“æ„: {list(æ•°æ®.keys())}")
            return []
        
        å›¾åƒåˆ—è¡¨ = æ•°æ®[å›¾åƒé”®]
        æ ‡ç­¾åˆ—è¡¨ = æ•°æ®[æ ‡ç­¾é”®]
        
        æµ‹è¯•æ•°æ® = []
        for i, (å›¾åƒ, æ ‡ç­¾) in enumerate(zip(å›¾åƒåˆ—è¡¨, æ ‡ç­¾åˆ—è¡¨)):
            if isinstance(æ ‡ç­¾, (list, np.ndarray)) and len(æ ‡ç­¾) > 1:
                æ ‡ç­¾ = int(np.argmax(æ ‡ç­¾))
            else:
                æ ‡ç­¾ = int(æ ‡ç­¾)
            
            æµ‹è¯•æ•°æ®.append((å›¾åƒ, æ ‡ç­¾))
            
            if æœ€å¤§æ ·æœ¬æ•° and len(æµ‹è¯•æ•°æ®) >= æœ€å¤§æ ·æœ¬æ•°:
                break
        
        æ—¥å¿—.info(f"ä» {æ–‡ä»¶è·¯å¾„} åŠ è½½äº† {len(æµ‹è¯•æ•°æ®)} ä¸ªæ ·æœ¬")
        return æµ‹è¯•æ•°æ®
    
    def _åŠ è½½jsonæ–‡ä»¶(self, æ–‡ä»¶è·¯å¾„: str, æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """åŠ è½½ .json æ ¼å¼æ–‡ä»¶ï¼ˆå…ƒæ•°æ®æ–‡ä»¶ï¼Œå›¾åƒè·¯å¾„+æ ‡ç­¾ï¼‰"""
        with open(æ–‡ä»¶è·¯å¾„, 'r', encoding='utf-8') as f:
            æ•°æ® = json.load(f)
        
        æµ‹è¯•æ•°æ® = []
        åŸºç¡€ç›®å½• = os.path.dirname(æ–‡ä»¶è·¯å¾„)
        
        # æ”¯æŒä¸¤ç§æ ¼å¼ï¼šåˆ—è¡¨æ ¼å¼å’Œå­—å…¸æ ¼å¼
        if isinstance(æ•°æ®, list):
            é¡¹ç›®åˆ—è¡¨ = æ•°æ®
        elif isinstance(æ•°æ®, dict) and 'samples' in æ•°æ®:
            é¡¹ç›®åˆ—è¡¨ = æ•°æ®['samples']
        else:
            æ—¥å¿—.warning(f"æ— æ³•è¯†åˆ« JSON æ–‡ä»¶ç»“æ„")
            return []
        
        for é¡¹ in é¡¹ç›®åˆ—è¡¨:
            if isinstance(é¡¹, dict):
                å›¾åƒè·¯å¾„ = é¡¹.get('image', é¡¹.get('path', é¡¹.get('å›¾åƒ')))
                æ ‡ç­¾ = é¡¹.get('label', é¡¹.get('action', é¡¹.get('æ ‡ç­¾')))
            elif isinstance(é¡¹, (list, tuple)) and len(é¡¹) >= 2:
                å›¾åƒè·¯å¾„, æ ‡ç­¾ = é¡¹[0], é¡¹[1]
            else:
                continue
            
            # åŠ è½½å›¾åƒ
            å®Œæ•´è·¯å¾„ = os.path.join(åŸºç¡€ç›®å½•, å›¾åƒè·¯å¾„) if not os.path.isabs(å›¾åƒè·¯å¾„) else å›¾åƒè·¯å¾„
            if os.path.exists(å®Œæ•´è·¯å¾„):
                try:
                    import cv2
                    å›¾åƒ = cv2.imread(å®Œæ•´è·¯å¾„)
                    if å›¾åƒ is not None:
                        å›¾åƒ = cv2.cvtColor(å›¾åƒ, cv2.COLOR_BGR2RGB)
                        æµ‹è¯•æ•°æ®.append((å›¾åƒ, int(æ ‡ç­¾)))
                except Exception as e:
                    æ—¥å¿—.warning(f"åŠ è½½å›¾åƒå¤±è´¥ {å®Œæ•´è·¯å¾„}: {e}")
            
            if æœ€å¤§æ ·æœ¬æ•° and len(æµ‹è¯•æ•°æ®) >= æœ€å¤§æ ·æœ¬æ•°:
                break
        
        æ—¥å¿—.info(f"ä» {æ–‡ä»¶è·¯å¾„} åŠ è½½äº† {len(æµ‹è¯•æ•°æ®)} ä¸ªæ ·æœ¬")
        return æµ‹è¯•æ•°æ®
    
    def _åŠ è½½pklæ–‡ä»¶(self, æ–‡ä»¶è·¯å¾„: str, æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """åŠ è½½ .pkl æ ¼å¼æ–‡ä»¶"""
        import pickle
        
        with open(æ–‡ä»¶è·¯å¾„, 'rb') as f:
            æ•°æ® = pickle.load(f)
        
        æµ‹è¯•æ•°æ® = []
        
        # æ”¯æŒå¤šç§æ•°æ®ç»“æ„
        if isinstance(æ•°æ®, list):
            for é¡¹ in æ•°æ®:
                if isinstance(é¡¹, (list, tuple)) and len(é¡¹) >= 2:
                    å›¾åƒ, åŠ¨ä½œ = é¡¹[0], é¡¹[1]
                    if isinstance(åŠ¨ä½œ, (list, np.ndarray)) and len(åŠ¨ä½œ) > 1:
                        æ ‡ç­¾ = int(np.argmax(åŠ¨ä½œ))
                    else:
                        æ ‡ç­¾ = int(åŠ¨ä½œ)
                    æµ‹è¯•æ•°æ®.append((å›¾åƒ, æ ‡ç­¾))
                
                if æœ€å¤§æ ·æœ¬æ•° and len(æµ‹è¯•æ•°æ®) >= æœ€å¤§æ ·æœ¬æ•°:
                    break
        elif isinstance(æ•°æ®, dict):
            å›¾åƒåˆ—è¡¨ = æ•°æ®.get('images', æ•°æ®.get('X', []))
            æ ‡ç­¾åˆ—è¡¨ = æ•°æ®.get('labels', æ•°æ®.get('y', []))
            
            for å›¾åƒ, æ ‡ç­¾ in zip(å›¾åƒåˆ—è¡¨, æ ‡ç­¾åˆ—è¡¨):
                if isinstance(æ ‡ç­¾, (list, np.ndarray)) and len(æ ‡ç­¾) > 1:
                    æ ‡ç­¾ = int(np.argmax(æ ‡ç­¾))
                else:
                    æ ‡ç­¾ = int(æ ‡ç­¾)
                æµ‹è¯•æ•°æ®.append((å›¾åƒ, æ ‡ç­¾))
                
                if æœ€å¤§æ ·æœ¬æ•° and len(æµ‹è¯•æ•°æ®) >= æœ€å¤§æ ·æœ¬æ•°:
                    break
        
        æ—¥å¿—.info(f"ä» {æ–‡ä»¶è·¯å¾„} åŠ è½½äº† {len(æµ‹è¯•æ•°æ®)} ä¸ªæ ·æœ¬")
        return æµ‹è¯•æ•°æ®
    
    def _åŠ è½½ç›®å½•(self, ç›®å½•è·¯å¾„: str, æµ‹è¯•æ¯”ä¾‹: float, 
                  éšæœºç§å­: int, æœ€å¤§æ ·æœ¬æ•°: int = None) -> List[Tuple[np.ndarray, int]]:
        """åŠ è½½ç›®å½•ä¸­çš„æ‰€æœ‰æ•°æ®æ–‡ä»¶"""
        æ‰€æœ‰æ•°æ® = []
        
        # æŸ¥æ‰¾æ‰€æœ‰æ”¯æŒçš„æ•°æ®æ–‡ä»¶
        æ•°æ®æ–‡ä»¶åˆ—è¡¨ = []
        for æ–‡ä»¶å in os.listdir(ç›®å½•è·¯å¾„):
            æ‰©å±•å = os.path.splitext(æ–‡ä»¶å)[1].lower()
            if æ‰©å±•å in self.æ”¯æŒæ ¼å¼:
                æ•°æ®æ–‡ä»¶åˆ—è¡¨.append(os.path.join(ç›®å½•è·¯å¾„, æ–‡ä»¶å))
        
        if not æ•°æ®æ–‡ä»¶åˆ—è¡¨:
            æ—¥å¿—.warning(f"ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„æ•°æ®æ–‡ä»¶: {ç›®å½•è·¯å¾„}")
            return []
        
        æ—¥å¿—.info(f"æ‰¾åˆ° {len(æ•°æ®æ–‡ä»¶åˆ—è¡¨)} ä¸ªæ•°æ®æ–‡ä»¶")
        
        # åŠ è½½æ‰€æœ‰æ–‡ä»¶
        for æ–‡ä»¶è·¯å¾„ in sorted(æ•°æ®æ–‡ä»¶åˆ—è¡¨):
            æ–‡ä»¶æ•°æ® = self._åŠ è½½å•ä¸ªæ–‡ä»¶(æ–‡ä»¶è·¯å¾„)
            æ‰€æœ‰æ•°æ®.extend(æ–‡ä»¶æ•°æ®)
            
            if æœ€å¤§æ ·æœ¬æ•° and len(æ‰€æœ‰æ•°æ®) >= æœ€å¤§æ ·æœ¬æ•°:
                æ‰€æœ‰æ•°æ® = æ‰€æœ‰æ•°æ®[:æœ€å¤§æ ·æœ¬æ•°]
                break
        
        if not æ‰€æœ‰æ•°æ®:
            return []
        
        # å¦‚æœéœ€è¦åˆ’åˆ†æµ‹è¯•é›†
        if æµ‹è¯•æ¯”ä¾‹ > 0 and æµ‹è¯•æ¯”ä¾‹ < 1:
            np.random.seed(éšæœºç§å­)
            ç´¢å¼•åˆ—è¡¨ = np.arange(len(æ‰€æœ‰æ•°æ®))
            np.random.shuffle(ç´¢å¼•åˆ—è¡¨)
            
            æµ‹è¯•æ•°é‡ = int(len(æ‰€æœ‰æ•°æ®) * æµ‹è¯•æ¯”ä¾‹)
            æµ‹è¯•ç´¢å¼• = ç´¢å¼•åˆ—è¡¨[:æµ‹è¯•æ•°é‡]
            
            æµ‹è¯•æ•°æ® = [æ‰€æœ‰æ•°æ®[i] for i in æµ‹è¯•ç´¢å¼•]
            æ—¥å¿—.info(f"ä» {len(æ‰€æœ‰æ•°æ®)} ä¸ªæ ·æœ¬ä¸­åˆ’åˆ†äº† {len(æµ‹è¯•æ•°æ®)} ä¸ªæµ‹è¯•æ ·æœ¬")
            return æµ‹è¯•æ•°æ®
        
        return æ‰€æœ‰æ•°æ®
    
    def è·å–æ•°æ®ç»Ÿè®¡(self, æµ‹è¯•æ•°æ®: List[Tuple[np.ndarray, int]]) -> Dict[str, Any]:
        """
        è·å–æµ‹è¯•æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯
        
        å‚æ•°:
            æµ‹è¯•æ•°æ®: æµ‹è¯•æ•°æ®åˆ—è¡¨
            
        è¿”å›:
            ç»Ÿè®¡ä¿¡æ¯å­—å…¸
        """
        if not æµ‹è¯•æ•°æ®:
            return {'æ€»æ ·æœ¬æ•°': 0, 'ç±»åˆ«åˆ†å¸ƒ': {}}
        
        æ ‡ç­¾åˆ—è¡¨ = [æ ‡ç­¾ for _, æ ‡ç­¾ in æµ‹è¯•æ•°æ®]
        ç±»åˆ«åˆ†å¸ƒ = {}
        for æ ‡ç­¾ in æ ‡ç­¾åˆ—è¡¨:
            ç±»åˆ«åˆ†å¸ƒ[æ ‡ç­¾] = ç±»åˆ«åˆ†å¸ƒ.get(æ ‡ç­¾, 0) + 1
        
        # è·å–å›¾åƒå°ºå¯¸
        å›¾åƒ = æµ‹è¯•æ•°æ®[0][0]
        å›¾åƒå°ºå¯¸ = å›¾åƒ.shape if hasattr(å›¾åƒ, 'shape') else None
        
        return {
            'æ€»æ ·æœ¬æ•°': len(æµ‹è¯•æ•°æ®),
            'ç±»åˆ«æ•°': len(ç±»åˆ«åˆ†å¸ƒ),
            'ç±»åˆ«åˆ†å¸ƒ': ç±»åˆ«åˆ†å¸ƒ,
            'å›¾åƒå°ºå¯¸': å›¾åƒå°ºå¯¸,
            'æœ€å¤§ç±»åˆ«æ ·æœ¬æ•°': max(ç±»åˆ«åˆ†å¸ƒ.values()) if ç±»åˆ«åˆ†å¸ƒ else 0,
            'æœ€å°ç±»åˆ«æ ·æœ¬æ•°': min(ç±»åˆ«åˆ†å¸ƒ.values()) if ç±»åˆ«åˆ†å¸ƒ else 0
        }


class å¯è§†åŒ–å™¨:
    """è¯„ä¼°ç»“æœå¯è§†åŒ–
    
    æä¾›æ··æ·†çŸ©é˜µçƒ­åŠ›å›¾ã€ç±»åˆ«æŒ‡æ ‡æŸ±çŠ¶å›¾ç­‰å¯è§†åŒ–åŠŸèƒ½ã€‚
    æ”¯æŒæ˜¾ç¤ºåŠ¨ä½œåç§°ã€é«˜äº®æ··æ·†å¯¹ã€ä¿å­˜ä¸ºå›¾åƒæ–‡ä»¶ã€‚
    """
    
    def __init__(self, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None):
        """
        åˆå§‹åŒ–å¯è§†åŒ–å™¨
        
        å‚æ•°:
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œç´¢å¼•åˆ°åç§°çš„æ˜ å°„ {0: "å‰è¿›", 1: "åé€€", ...}
        """
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
        self._matplotlibå¯ç”¨ = False
        self._seabornå¯ç”¨ = False
        
        try:
            import matplotlib
            matplotlib.use('Agg')  # éäº¤äº’å¼åç«¯
            import matplotlib.pyplot as plt
            # è®¾ç½®ä¸­æ–‡å­—ä½“æ”¯æŒ
            plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'DejaVu Sans']
            plt.rcParams['axes.unicode_minus'] = False
            self._matplotlibå¯ç”¨ = True
        except ImportError:
            æ—¥å¿—.warning("matplotlib æœªå®‰è£…ï¼Œå¯è§†åŒ–åŠŸèƒ½ä¸å¯ç”¨")
        
        try:
            import seaborn as sns
            self._seabornå¯ç”¨ = True
        except ImportError:
            æ—¥å¿—.info("seaborn æœªå®‰è£…ï¼Œå°†ä½¿ç”¨åŸºç¡€å¯è§†åŒ–")
    
    def è®¾ç½®åŠ¨ä½œå®šä¹‰(self, åŠ¨ä½œå®šä¹‰: Dict[int, str]):
        """è®¾ç½®åŠ¨ä½œå®šä¹‰"""
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰
    
    def è·å–ç±»åˆ«åç§°(self, æ··æ·†çŸ©é˜µ: np.ndarray) -> List[str]:
        """
        è·å–ç±»åˆ«åç§°åˆ—è¡¨
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            
        è¿”å›:
            ç±»åˆ«åç§°åˆ—è¡¨ï¼ˆä½¿ç”¨åŠ¨ä½œåç§°è€Œéç´¢å¼•ï¼‰
        """
        ç±»åˆ«æ•° = len(æ··æ·†çŸ©é˜µ)
        ç±»åˆ«åç§° = []
        for i in range(ç±»åˆ«æ•°):
            åç§° = self.åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
            ç±»åˆ«åç§°.append(åç§°)
        return ç±»åˆ«åç§°
    
    def ç»˜åˆ¶æ··æ·†çŸ©é˜µ(self, æ··æ·†çŸ©é˜µ: np.ndarray, 
                     ç±»åˆ«åç§°: List[str] = None,
                     ä¿å­˜è·¯å¾„: str = None,
                     æ ‡é¢˜: str = "æ··æ·†çŸ©é˜µ",
                     æ˜¾ç¤ºæ•°å€¼: bool = True,
                     å½’ä¸€åŒ–: bool = False,
                     é«˜äº®æ··æ·†å¯¹: bool = False,
                     æ··æ·†é˜ˆå€¼: float = 0.1) -> bool:
        """
        ç»˜åˆ¶æ··æ·†çŸ©é˜µçƒ­åŠ›å›¾
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            ç±»åˆ«åç§°: ç±»åˆ«åç§°åˆ—è¡¨ï¼ŒNone åˆ™ä½¿ç”¨åŠ¨ä½œå®šä¹‰
            ä¿å­˜è·¯å¾„: ä¿å­˜è·¯å¾„
            æ ‡é¢˜: å›¾è¡¨æ ‡é¢˜
            æ˜¾ç¤ºæ•°å€¼: æ˜¯å¦åœ¨å•å…ƒæ ¼ä¸­æ˜¾ç¤ºæ•°å€¼
            å½’ä¸€åŒ–: æ˜¯å¦æŒ‰è¡Œå½’ä¸€åŒ–ï¼ˆæ˜¾ç¤ºæ¯”ä¾‹ï¼‰
            é«˜äº®æ··æ·†å¯¹: æ˜¯å¦é«˜äº®æ˜¾ç¤ºæ··æ·†å¯¹
            æ··æ·†é˜ˆå€¼: æ··æ·†æ¯”ä¾‹é˜ˆå€¼ï¼ˆç”¨äºé«˜äº®ï¼‰
            
        è¿”å›:
            æ˜¯å¦æˆåŠŸç»˜åˆ¶
        """
        if not self._matplotlibå¯ç”¨:
            æ—¥å¿—.warning("matplotlib ä¸å¯ç”¨ï¼Œè·³è¿‡å¯è§†åŒ–")
            return False
        
        import matplotlib.pyplot as plt
        
        # è·å–ç±»åˆ«åç§°
        if ç±»åˆ«åç§° is None:
            ç±»åˆ«åç§° = self.è·å–ç±»åˆ«åç§°(æ··æ·†çŸ©é˜µ)
        
        # å‡†å¤‡æ•°æ®
        æ˜¾ç¤ºçŸ©é˜µ = æ··æ·†çŸ©é˜µ.copy().astype(float)
        if å½’ä¸€åŒ–:
            # æŒ‰è¡Œå½’ä¸€åŒ–
            è¡Œå’Œ = æ˜¾ç¤ºçŸ©é˜µ.sum(axis=1, keepdims=True)
            è¡Œå’Œ[è¡Œå’Œ == 0] = 1  # é¿å…é™¤é›¶
            æ˜¾ç¤ºçŸ©é˜µ = æ˜¾ç¤ºçŸ©é˜µ / è¡Œå’Œ
        
        # åˆ›å»ºå›¾å½¢
        ç±»åˆ«æ•° = len(æ··æ·†çŸ©é˜µ)
        å›¾å½¢å¤§å° = max(8, ç±»åˆ«æ•° * 0.5)
        fig, ax = plt.subplots(figsize=(å›¾å½¢å¤§å°, å›¾å½¢å¤§å°))
        
        # ä½¿ç”¨ seaborn æˆ– matplotlib ç»˜åˆ¶çƒ­åŠ›å›¾
        if self._seabornå¯ç”¨:
            import seaborn as sns
            æ ¼å¼ = '.2f' if å½’ä¸€åŒ– else 'd'
            sns.heatmap(æ˜¾ç¤ºçŸ©é˜µ, annot=æ˜¾ç¤ºæ•°å€¼, fmt=æ ¼å¼, cmap='Blues',
                       xticklabels=ç±»åˆ«åç§°, yticklabels=ç±»åˆ«åç§°,
                       ax=ax, cbar=True, square=True,
                       annot_kws={'size': max(6, 10 - ç±»åˆ«æ•° // 5)})
        else:
            im = ax.imshow(æ˜¾ç¤ºçŸ©é˜µ, interpolation='nearest', cmap=plt.cm.Blues)
            plt.colorbar(im, ax=ax)
            
            # è®¾ç½®åˆ»åº¦
            tick_marks = np.arange(ç±»åˆ«æ•°)
            ax.set_xticks(tick_marks)
            ax.set_yticks(tick_marks)
            ax.set_xticklabels(ç±»åˆ«åç§°, rotation=45, ha='right', fontsize=max(6, 10 - ç±»åˆ«æ•° // 5))
            ax.set_yticklabels(ç±»åˆ«åç§°, fontsize=max(6, 10 - ç±»åˆ«æ•° // 5))
            
            # æ˜¾ç¤ºæ•°å€¼
            if æ˜¾ç¤ºæ•°å€¼:
                é˜ˆå€¼ = æ˜¾ç¤ºçŸ©é˜µ.max() / 2
                for i in range(ç±»åˆ«æ•°):
                    for j in range(ç±»åˆ«æ•°):
                        å€¼ = æ˜¾ç¤ºçŸ©é˜µ[i, j]
                        æ–‡æœ¬ = f'{å€¼:.2f}' if å½’ä¸€åŒ– else f'{int(æ··æ·†çŸ©é˜µ[i, j])}'
                        é¢œè‰² = 'white' if å€¼ > é˜ˆå€¼ else 'black'
                        ax.text(j, i, æ–‡æœ¬, ha='center', va='center', 
                               color=é¢œè‰², fontsize=max(6, 8 - ç±»åˆ«æ•° // 5))
        
        # é«˜äº®æ··æ·†å¯¹
        if é«˜äº®æ··æ·†å¯¹:
            self._é«˜äº®æ··æ·†å•å…ƒæ ¼(ax, æ··æ·†çŸ©é˜µ, æ··æ·†é˜ˆå€¼)
        
        ax.set_title(æ ‡é¢˜, fontsize=14)
        ax.set_ylabel('çœŸå®æ ‡ç­¾', fontsize=12)
        ax.set_xlabel('é¢„æµ‹æ ‡ç­¾', fontsize=12)
        
        plt.tight_layout()
        
        # ä¿å­˜å›¾åƒ
        if ä¿å­˜è·¯å¾„:
            os.makedirs(os.path.dirname(ä¿å­˜è·¯å¾„) or '.', exist_ok=True)
            plt.savefig(ä¿å­˜è·¯å¾„, dpi=150, bbox_inches='tight')
            æ—¥å¿—.info(f"æ··æ·†çŸ©é˜µå›¾å·²ä¿å­˜: {ä¿å­˜è·¯å¾„}")
        
        plt.close()
        return True
    
    def _é«˜äº®æ··æ·†å•å…ƒæ ¼(self, ax, æ··æ·†çŸ©é˜µ: np.ndarray, é˜ˆå€¼: float):
        """
        åœ¨æ··æ·†çŸ©é˜µä¸­é«˜äº®æ˜¾ç¤ºæ··æ·†å¯¹
        
        å‚æ•°:
            ax: matplotlib è½´å¯¹è±¡
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            é˜ˆå€¼: æ··æ·†æ¯”ä¾‹é˜ˆå€¼
        """
        import matplotlib.patches as patches
        
        ç±»åˆ«æ•° = len(æ··æ·†çŸ©é˜µ)
        for i in range(ç±»åˆ«æ•°):
            è¡Œå’Œ = np.sum(æ··æ·†çŸ©é˜µ[i, :])
            if è¡Œå’Œ == 0:
                continue
            
            for j in range(ç±»åˆ«æ•°):
                if i == j:
                    continue
                
                æ··æ·†æ¯”ä¾‹ = æ··æ·†çŸ©é˜µ[i, j] / è¡Œå’Œ
                if æ··æ·†æ¯”ä¾‹ >= é˜ˆå€¼:
                    # æ·»åŠ çº¢è‰²è¾¹æ¡†é«˜äº®
                    rect = patches.Rectangle(
                        (j - 0.5, i - 0.5), 1, 1,
                        linewidth=2, edgecolor='red', facecolor='none'
                    )
                    ax.add_patch(rect)
    
    def é«˜äº®æ··æ·†å¯¹(self, æ··æ·†çŸ©é˜µ: np.ndarray, 
                   é˜ˆå€¼: float = 0.1,
                   åŠ¨ä½œå®šä¹‰: Dict[int, str] = None) -> List[Tuple[str, str, float, int]]:
        """
        è¯†åˆ«æœ€å®¹æ˜“æ··æ·†çš„åŠ¨ä½œå¯¹
        
        å‚æ•°:
            æ··æ·†çŸ©é˜µ: æ··æ·†çŸ©é˜µ
            é˜ˆå€¼: æ··æ·†æ¯”ä¾‹é˜ˆå€¼
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸ï¼ŒNone åˆ™ä½¿ç”¨å®ä¾‹å±æ€§
            
        è¿”å›:
            [(çœŸå®ç±»åˆ«, é¢„æµ‹ç±»åˆ«, æ··æ·†æ¯”ä¾‹, æ··æ·†æ¬¡æ•°), ...] åˆ—è¡¨ï¼ŒæŒ‰æ··æ·†æ¯”ä¾‹é™åºæ’åˆ—
        """
        if åŠ¨ä½œå®šä¹‰ is None:
            åŠ¨ä½œå®šä¹‰ = self.åŠ¨ä½œå®šä¹‰
        
        æ··æ·†å¯¹åˆ—è¡¨ = []
        ç±»åˆ«æ•° = len(æ··æ·†çŸ©é˜µ)
        
        for i in range(ç±»åˆ«æ•°):
            è¡Œå’Œ = np.sum(æ··æ·†çŸ©é˜µ[i, :])
            if è¡Œå’Œ == 0:
                continue
            
            for j in range(ç±»åˆ«æ•°):
                if i == j:
                    continue
                
                æ··æ·†æ¬¡æ•° = int(æ··æ·†çŸ©é˜µ[i, j])
                if æ··æ·†æ¬¡æ•° == 0:
                    continue
                
                æ··æ·†æ¯”ä¾‹ = æ··æ·†æ¬¡æ•° / è¡Œå’Œ
                if æ··æ·†æ¯”ä¾‹ >= é˜ˆå€¼:
                    çœŸå®ç±»åˆ« = åŠ¨ä½œå®šä¹‰.get(i, f"ç±»åˆ«{i}")
                    é¢„æµ‹ç±»åˆ« = åŠ¨ä½œå®šä¹‰.get(j, f"ç±»åˆ«{j}")
                    æ··æ·†å¯¹åˆ—è¡¨.append((çœŸå®ç±»åˆ«, é¢„æµ‹ç±»åˆ«, æ··æ·†æ¯”ä¾‹, æ··æ·†æ¬¡æ•°))
        
        # æŒ‰æ··æ·†æ¯”ä¾‹é™åºæ’åˆ—
        æ··æ·†å¯¹åˆ—è¡¨.sort(key=lambda x: x[2], reverse=True)
        return æ··æ·†å¯¹åˆ—è¡¨
    
    def ç»˜åˆ¶æ··æ·†å¯¹å›¾(self, æ··æ·†å¯¹åˆ—è¡¨: List[Tuple[str, str, float, int]],
                     ä¿å­˜è·¯å¾„: str = None,
                     æ ‡é¢˜: str = "æœ€å®¹æ˜“æ··æ·†çš„åŠ¨ä½œå¯¹",
                     æœ€å¤§æ˜¾ç¤ºæ•°: int = 10) -> bool:
        """
        ç»˜åˆ¶æ··æ·†å¯¹æŸ±çŠ¶å›¾
        
        å‚æ•°:
            æ··æ·†å¯¹åˆ—è¡¨: æ··æ·†å¯¹åˆ—è¡¨ [(çœŸå®ç±»åˆ«, é¢„æµ‹ç±»åˆ«, æ··æ·†æ¯”ä¾‹, æ··æ·†æ¬¡æ•°), ...]
            ä¿å­˜è·¯å¾„: ä¿å­˜è·¯å¾„
            æ ‡é¢˜: å›¾è¡¨æ ‡é¢˜
            æœ€å¤§æ˜¾ç¤ºæ•°: æœ€å¤šæ˜¾ç¤ºçš„æ··æ·†å¯¹æ•°é‡
            
        è¿”å›:
            æ˜¯å¦æˆåŠŸç»˜åˆ¶
        """
        if not self._matplotlibå¯ç”¨:
            æ—¥å¿—.warning("matplotlib ä¸å¯ç”¨ï¼Œè·³è¿‡å¯è§†åŒ–")
            return False
        
        if not æ··æ·†å¯¹åˆ—è¡¨:
            æ—¥å¿—.info("æ²¡æœ‰æ··æ·†å¯¹éœ€è¦æ˜¾ç¤º")
            return False
        
        import matplotlib.pyplot as plt
        
        # é™åˆ¶æ˜¾ç¤ºæ•°é‡
        æ˜¾ç¤ºåˆ—è¡¨ = æ··æ·†å¯¹åˆ—è¡¨[:æœ€å¤§æ˜¾ç¤ºæ•°]
        
        # å‡†å¤‡æ•°æ®
        æ ‡ç­¾åˆ—è¡¨ = [f"{çœŸå®} â†’ {é¢„æµ‹}" for çœŸå®, é¢„æµ‹, _, _ in æ˜¾ç¤ºåˆ—è¡¨]
        æ¯”ä¾‹åˆ—è¡¨ = [æ¯”ä¾‹ for _, _, æ¯”ä¾‹, _ in æ˜¾ç¤ºåˆ—è¡¨]
        æ¬¡æ•°åˆ—è¡¨ = [æ¬¡æ•° for _, _, _, æ¬¡æ•° in æ˜¾ç¤ºåˆ—è¡¨]
        
        # åˆ›å»ºå›¾å½¢
        fig, ax = plt.subplots(figsize=(12, max(6, len(æ˜¾ç¤ºåˆ—è¡¨) * 0.4)))
        
        y_pos = np.arange(len(æ ‡ç­¾åˆ—è¡¨))
        bars = ax.barh(y_pos, æ¯”ä¾‹åˆ—è¡¨, color='coral', edgecolor='darkred')
        
        # æ·»åŠ æ•°å€¼æ ‡ç­¾
        for i, (bar, æ¬¡æ•°) in enumerate(zip(bars, æ¬¡æ•°åˆ—è¡¨)):
            å®½åº¦ = bar.get_width()
            ax.text(å®½åº¦ + 0.01, bar.get_y() + bar.get_height() / 2,
                   f'{å®½åº¦:.1%} ({æ¬¡æ•°}æ¬¡)',
                   ha='left', va='center', fontsize=10)
        
        ax.set_yticks(y_pos)
        ax.set_yticklabels(æ ‡ç­¾åˆ—è¡¨, fontsize=10)
        ax.set_xlabel('æ··æ·†æ¯”ä¾‹', fontsize=12)
        ax.set_title(æ ‡é¢˜, fontsize=14)
        ax.set_xlim(0, max(æ¯”ä¾‹åˆ—è¡¨) * 1.3)
        ax.invert_yaxis()  # æœ€é«˜çš„åœ¨ä¸Šé¢
        
        plt.tight_layout()
        
        if ä¿å­˜è·¯å¾„:
            os.makedirs(os.path.dirname(ä¿å­˜è·¯å¾„) or '.', exist_ok=True)
            plt.savefig(ä¿å­˜è·¯å¾„, dpi=150, bbox_inches='tight')
            æ—¥å¿—.info(f"æ··æ·†å¯¹å›¾å·²ä¿å­˜: {ä¿å­˜è·¯å¾„}")
        
        plt.close()
        return True
    
    def ç»˜åˆ¶ç±»åˆ«æŒ‡æ ‡(self, ç±»åˆ«æŒ‡æ ‡: Dict[str, ç±»åˆ«æŒ‡æ ‡], 
                     ä¿å­˜è·¯å¾„: str = None,
                     æ ‡é¢˜: str = "å„ç±»åˆ«è¯„ä¼°æŒ‡æ ‡") -> bool:
        """
        ç»˜åˆ¶å„ç±»åˆ«æŒ‡æ ‡æŸ±çŠ¶å›¾
        
        å‚æ•°:
            ç±»åˆ«æŒ‡æ ‡: ç±»åˆ«æŒ‡æ ‡å­—å…¸
            ä¿å­˜è·¯å¾„: ä¿å­˜è·¯å¾„
            æ ‡é¢˜: å›¾è¡¨æ ‡é¢˜
            
        è¿”å›:
            æ˜¯å¦æˆåŠŸç»˜åˆ¶
        """
        if not self._matplotlibå¯ç”¨:
            æ—¥å¿—.warning("matplotlib ä¸å¯ç”¨ï¼Œè·³è¿‡å¯è§†åŒ–")
            return False
        
        import matplotlib.pyplot as plt
        
        ç±»åˆ«åç§° = list(ç±»åˆ«æŒ‡æ ‡.keys())
        ç²¾ç¡®ç‡ = [æŒ‡æ ‡.ç²¾ç¡®ç‡ for æŒ‡æ ‡ in ç±»åˆ«æŒ‡æ ‡.values()]
        å¬å›ç‡ = [æŒ‡æ ‡.å¬å›ç‡ for æŒ‡æ ‡ in ç±»åˆ«æŒ‡æ ‡.values()]
        F1åˆ†æ•° = [æŒ‡æ ‡.F1åˆ†æ•° for æŒ‡æ ‡ in ç±»åˆ«æŒ‡æ ‡.values()]
        
        x = np.arange(len(ç±»åˆ«åç§°))
        å®½åº¦ = 0.25
        
        fig, ax = plt.subplots(figsize=(max(10, len(ç±»åˆ«åç§°) * 0.8), 6))
        ax.bar(x - å®½åº¦, ç²¾ç¡®ç‡, å®½åº¦, label='ç²¾ç¡®ç‡', color='steelblue')
        ax.bar(x, å¬å›ç‡, å®½åº¦, label='å¬å›ç‡', color='seagreen')
        ax.bar(x + å®½åº¦, F1åˆ†æ•°, å®½åº¦, label='F1åˆ†æ•°', color='coral')
        
        ax.set_ylabel('åˆ†æ•°', fontsize=12)
        ax.set_title(æ ‡é¢˜, fontsize=14)
        ax.set_xticks(x)
        ax.set_xticklabels(ç±»åˆ«åç§°, rotation=45, ha='right', fontsize=max(8, 12 - len(ç±»åˆ«åç§°) // 5))
        ax.legend(loc='upper right')
        ax.set_ylim(0, 1.1)
        ax.axhline(y=0.7, color='gray', linestyle='--', alpha=0.5, label='é˜ˆå€¼çº¿')
        
        plt.tight_layout()
        
        if ä¿å­˜è·¯å¾„:
            os.makedirs(os.path.dirname(ä¿å­˜è·¯å¾„) or '.', exist_ok=True)
            plt.savefig(ä¿å­˜è·¯å¾„, dpi=150, bbox_inches='tight')
            æ—¥å¿—.info(f"ç±»åˆ«æŒ‡æ ‡å›¾å·²ä¿å­˜: {ä¿å­˜è·¯å¾„}")
        
        plt.close()
        return True
    
    def ç”Ÿæˆå®Œæ•´å¯è§†åŒ–æŠ¥å‘Š(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ,
                           è¾“å‡ºç›®å½•: str,
                           å‰ç¼€: str = "eval") -> Dict[str, str]:
        """
        ç”Ÿæˆå®Œæ•´çš„å¯è§†åŒ–æŠ¥å‘Šï¼ŒåŒ…å«æ‰€æœ‰å›¾è¡¨
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            è¾“å‡ºç›®å½•: è¾“å‡ºç›®å½•
            å‰ç¼€: æ–‡ä»¶åå‰ç¼€
            
        è¿”å›:
            ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„å­—å…¸ {å›¾è¡¨ç±»å‹: æ–‡ä»¶è·¯å¾„}
        """
        os.makedirs(è¾“å‡ºç›®å½•, exist_ok=True)
        ç”Ÿæˆæ–‡ä»¶ = {}
        
        # 1. æ··æ·†çŸ©é˜µçƒ­åŠ›å›¾
        æ··æ·†çŸ©é˜µè·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"{å‰ç¼€}_æ··æ·†çŸ©é˜µ.png")
        if self.ç»˜åˆ¶æ··æ·†çŸ©é˜µ(è¯„ä¼°ç»“æœ.æ··æ·†çŸ©é˜µ, ä¿å­˜è·¯å¾„=æ··æ·†çŸ©é˜µè·¯å¾„,
                           é«˜äº®æ··æ·†å¯¹=True, æ··æ·†é˜ˆå€¼=0.1):
            ç”Ÿæˆæ–‡ä»¶['æ··æ·†çŸ©é˜µ'] = æ··æ·†çŸ©é˜µè·¯å¾„
        
        # 2. å½’ä¸€åŒ–æ··æ·†çŸ©é˜µ
        å½’ä¸€åŒ–è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"{å‰ç¼€}_æ··æ·†çŸ©é˜µ_å½’ä¸€åŒ–.png")
        if self.ç»˜åˆ¶æ··æ·†çŸ©é˜µ(è¯„ä¼°ç»“æœ.æ··æ·†çŸ©é˜µ, ä¿å­˜è·¯å¾„=å½’ä¸€åŒ–è·¯å¾„,
                           å½’ä¸€åŒ–=True, æ ‡é¢˜="æ··æ·†çŸ©é˜µï¼ˆå½’ä¸€åŒ–ï¼‰"):
            ç”Ÿæˆæ–‡ä»¶['å½’ä¸€åŒ–æ··æ·†çŸ©é˜µ'] = å½’ä¸€åŒ–è·¯å¾„
        
        # 3. ç±»åˆ«æŒ‡æ ‡æŸ±çŠ¶å›¾
        æŒ‡æ ‡è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"{å‰ç¼€}_ç±»åˆ«æŒ‡æ ‡.png")
        if self.ç»˜åˆ¶ç±»åˆ«æŒ‡æ ‡(è¯„ä¼°ç»“æœ.ç±»åˆ«æŒ‡æ ‡, ä¿å­˜è·¯å¾„=æŒ‡æ ‡è·¯å¾„):
            ç”Ÿæˆæ–‡ä»¶['ç±»åˆ«æŒ‡æ ‡'] = æŒ‡æ ‡è·¯å¾„
        
        # 4. æ··æ·†å¯¹å›¾
        æ··æ·†å¯¹åˆ—è¡¨ = self.é«˜äº®æ··æ·†å¯¹(è¯„ä¼°ç»“æœ.æ··æ·†çŸ©é˜µ, é˜ˆå€¼=0.05)
        if æ··æ·†å¯¹åˆ—è¡¨:
            æ··æ·†å¯¹è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"{å‰ç¼€}_æ··æ·†å¯¹.png")
            if self.ç»˜åˆ¶æ··æ·†å¯¹å›¾(æ··æ·†å¯¹åˆ—è¡¨, ä¿å­˜è·¯å¾„=æ··æ·†å¯¹è·¯å¾„):
                ç”Ÿæˆæ–‡ä»¶['æ··æ·†å¯¹'] = æ··æ·†å¯¹è·¯å¾„
        
        æ—¥å¿—.info(f"å¯è§†åŒ–æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå…± {len(ç”Ÿæˆæ–‡ä»¶)} ä¸ªå›¾è¡¨")
        return ç”Ÿæˆæ–‡ä»¶



class æ‰¹é‡è¯„ä¼°å™¨:
    """æ‰¹é‡è¯„ä¼°å™¨
    
    åœ¨æµ‹è¯•æ•°æ®é›†ä¸Šæ‰¹é‡è¯„ä¼°æ¨¡å‹ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡ï¼ŒæŠ¥å‘Šè¯„ä¼°æ—¶é—´å’Œååé‡ã€‚
    éœ€æ±‚: 4.2, 4.3, 4.4 - æ‰¹é‡è¯„ä¼°åŠŸèƒ½
    """
    
    def __init__(self, æ¨¡å‹=None, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None):
        """
        åˆå§‹åŒ–æ‰¹é‡è¯„ä¼°å™¨
        
        å‚æ•°:
            æ¨¡å‹: å¾…è¯„ä¼°çš„æ¨¡å‹
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œç´¢å¼•åˆ°åç§°çš„æ˜ å°„
        """
        self.æ¨¡å‹ = æ¨¡å‹
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
        self.æ•°æ®åŠ è½½å™¨ = æµ‹è¯•æ•°æ®åŠ è½½å™¨()
        self.è¯„ä¼°å™¨ = æ¨¡å‹è¯„ä¼°å™¨(æ¨¡å‹, åŠ¨ä½œå®šä¹‰)
        self._tqdmå¯ç”¨ = False
        
        try:
            from tqdm import tqdm
            self._tqdmå¯ç”¨ = True
        except ImportError:
            æ—¥å¿—.info("tqdm æœªå®‰è£…ï¼Œå°†ä½¿ç”¨ç®€å•è¿›åº¦æ˜¾ç¤º")
    
    def è®¾ç½®æ¨¡å‹(self, æ¨¡å‹):
        """è®¾ç½®æ¨¡å‹"""
        self.æ¨¡å‹ = æ¨¡å‹
        self.è¯„ä¼°å™¨.è®¾ç½®æ¨¡å‹(æ¨¡å‹)
    
    def è®¾ç½®åŠ¨ä½œå®šä¹‰(self, åŠ¨ä½œå®šä¹‰: Dict[int, str]):
        """è®¾ç½®åŠ¨ä½œå®šä¹‰"""
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰
        self.è¯„ä¼°å™¨.è®¾ç½®åŠ¨ä½œå®šä¹‰(åŠ¨ä½œå®šä¹‰)
    
    def æ‰¹é‡è¯„ä¼°(self, æ•°æ®è·¯å¾„: str = None,
                 æµ‹è¯•æ¯”ä¾‹: float = 0.2,
                 æ‰¹æ¬¡å¤§å°: int = 32,
                 æ˜¾ç¤ºè¿›åº¦: bool = True,
                 æœ€å¤§æ ·æœ¬æ•°: int = None) -> è¯„ä¼°ç»“æœ:
        """
        åœ¨æµ‹è¯•æ•°æ®ä¸Šæ‰¹é‡è¯„ä¼°æ¨¡å‹
        
        å‚æ•°:
            æ•°æ®è·¯å¾„: æ•°æ®æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„
            æµ‹è¯•æ¯”ä¾‹: æµ‹è¯•æ•°æ®æ¯”ä¾‹
            æ‰¹æ¬¡å¤§å°: æ‰¹å¤„ç†å¤§å°
            æ˜¾ç¤ºè¿›åº¦: æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡
            æœ€å¤§æ ·æœ¬æ•°: æœ€å¤§è¯„ä¼°æ ·æœ¬æ•°
            
        è¿”å›:
            è¯„ä¼°ç»“æœå¯¹è±¡
        """
        # åŠ è½½æµ‹è¯•æ•°æ®
        æ—¥å¿—.info("æ­£åœ¨åŠ è½½æµ‹è¯•æ•°æ®...")
        æµ‹è¯•æ•°æ® = self.æ•°æ®åŠ è½½å™¨.åŠ è½½æµ‹è¯•æ•°æ®(
            æ•°æ®è·¯å¾„=æ•°æ®è·¯å¾„,
            æµ‹è¯•æ¯”ä¾‹=æµ‹è¯•æ¯”ä¾‹,
            æœ€å¤§æ ·æœ¬æ•°=æœ€å¤§æ ·æœ¬æ•°
        )
        
        if not æµ‹è¯•æ•°æ®:
            æ—¥å¿—.warning("æ²¡æœ‰åŠ è½½åˆ°æµ‹è¯•æ•°æ®")
            return è¯„ä¼°ç»“æœ()
        
        # æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡
        ç»Ÿè®¡ä¿¡æ¯ = self.æ•°æ®åŠ è½½å™¨.è·å–æ•°æ®ç»Ÿè®¡(æµ‹è¯•æ•°æ®)
        æ—¥å¿—.info(f"æµ‹è¯•æ•°æ®ç»Ÿè®¡: æ€»æ ·æœ¬æ•°={ç»Ÿè®¡ä¿¡æ¯['æ€»æ ·æœ¬æ•°']}, ç±»åˆ«æ•°={ç»Ÿè®¡ä¿¡æ¯['ç±»åˆ«æ•°']}")
        
        # æ£€æŸ¥æ¨¡å‹
        if self.æ¨¡å‹ is None:
            æ—¥å¿—.error("æ¨¡å‹æœªè®¾ç½®")
            return è¯„ä¼°ç»“æœ()
        
        # å¼€å§‹è¯„ä¼°
        å¼€å§‹æ—¶é—´ = time.time()
        é¢„æµ‹åˆ—è¡¨ = []
        çœŸå®åˆ—è¡¨ = []
        
        æ€»æ ·æœ¬æ•° = len(æµ‹è¯•æ•°æ®)
        æ—¥å¿—.info(f"å¼€å§‹æ‰¹é‡è¯„ä¼°ï¼Œå…± {æ€»æ ·æœ¬æ•°} ä¸ªæ ·æœ¬...")
        
        # åˆ›å»ºè¿›åº¦æ¡
        if æ˜¾ç¤ºè¿›åº¦ and self._tqdmå¯ç”¨:
            from tqdm import tqdm
            è¿­ä»£å™¨ = tqdm(æµ‹è¯•æ•°æ®, desc="è¯„ä¼°è¿›åº¦", unit="æ ·æœ¬")
        else:
            è¿­ä»£å™¨ = æµ‹è¯•æ•°æ®
        
        å¤„ç†è®¡æ•° = 0
        é”™è¯¯è®¡æ•° = 0
        ä¸Šæ¬¡è¿›åº¦æ—¶é—´ = å¼€å§‹æ—¶é—´
        
        for i, (å›¾åƒ, æ ‡ç­¾) in enumerate(è¿­ä»£å™¨):
            try:
                # é¢„æµ‹
                é¢„æµ‹ç»“æœ = self.æ¨¡å‹.predict(np.expand_dims(å›¾åƒ, axis=0))
                é¢„æµ‹ç±»åˆ« = int(np.argmax(é¢„æµ‹ç»“æœ))
                
                é¢„æµ‹åˆ—è¡¨.append(é¢„æµ‹ç±»åˆ«)
                çœŸå®åˆ—è¡¨.append(æ ‡ç­¾)
                å¤„ç†è®¡æ•° += 1
                
            except Exception as e:
                é”™è¯¯è®¡æ•° += 1
                if é”™è¯¯è®¡æ•° <= 5:  # åªè®°å½•å‰5ä¸ªé”™è¯¯
                    æ—¥å¿—.warning(f"é¢„æµ‹æ ·æœ¬ {i} å¤±è´¥: {e}")
                continue
            
            # ç®€å•è¿›åº¦æ˜¾ç¤ºï¼ˆå¦‚æœæ²¡æœ‰ tqdmï¼‰
            if not self._tqdmå¯ç”¨ and æ˜¾ç¤ºè¿›åº¦:
                å½“å‰æ—¶é—´ = time.time()
                if å½“å‰æ—¶é—´ - ä¸Šæ¬¡è¿›åº¦æ—¶é—´ >= 2.0:  # æ¯2ç§’æ›´æ–°ä¸€æ¬¡
                    è¿›åº¦ = (i + 1) / æ€»æ ·æœ¬æ•° * 100
                    å·²ç”¨æ—¶é—´ = å½“å‰æ—¶é—´ - å¼€å§‹æ—¶é—´
                    é€Ÿåº¦ = (i + 1) / å·²ç”¨æ—¶é—´ if å·²ç”¨æ—¶é—´ > 0 else 0
                    å‰©ä½™æ—¶é—´ = (æ€»æ ·æœ¬æ•° - i - 1) / é€Ÿåº¦ if é€Ÿåº¦ > 0 else 0
                    print(f"\rè¿›åº¦: {è¿›åº¦:.1f}% ({i+1}/{æ€»æ ·æœ¬æ•°}) | "
                          f"é€Ÿåº¦: {é€Ÿåº¦:.1f} æ ·æœ¬/ç§’ | "
                          f"å‰©ä½™: {å‰©ä½™æ—¶é—´:.0f}ç§’", end="")
                    ä¸Šæ¬¡è¿›åº¦æ—¶é—´ = å½“å‰æ—¶é—´
        
        if not self._tqdmå¯ç”¨ and æ˜¾ç¤ºè¿›åº¦:
            print()  # æ¢è¡Œ
        
        # è®¡ç®—è¯„ä¼°æ—¶é—´
        ç»“æŸæ—¶é—´ = time.time()
        è¯„ä¼°æ—¶é—´ = ç»“æŸæ—¶é—´ - å¼€å§‹æ—¶é—´
        
        if é”™è¯¯è®¡æ•° > 0:
            æ—¥å¿—.warning(f"è¯„ä¼°è¿‡ç¨‹ä¸­æœ‰ {é”™è¯¯è®¡æ•°} ä¸ªæ ·æœ¬å¤„ç†å¤±è´¥")
        
        # ç”Ÿæˆæ··æ·†çŸ©é˜µå’Œè®¡ç®—æŒ‡æ ‡
        æ··æ·†çŸ©é˜µ = self.è¯„ä¼°å™¨.ç”Ÿæˆæ··æ·†çŸ©é˜µ(é¢„æµ‹åˆ—è¡¨, çœŸå®åˆ—è¡¨)
        ç»“æœ = self.è¯„ä¼°å™¨.è®¡ç®—æŒ‡æ ‡(æ··æ·†çŸ©é˜µ)
        
        # æ›´æ–°è¯„ä¼°ç»“æœ
        ç»“æœ.è¯„ä¼°æ—¶é—´ = è¯„ä¼°æ—¶é—´
        ç»“æœ.æ ·æœ¬æ•°é‡ = å¤„ç†è®¡æ•°
        
        # è®¡ç®—ååé‡
        ååé‡ = å¤„ç†è®¡æ•° / è¯„ä¼°æ—¶é—´ if è¯„ä¼°æ—¶é—´ > 0 else 0
        
        æ—¥å¿—.info(f"è¯„ä¼°å®Œæˆ!")
        æ—¥å¿—.info(f"  - å¤„ç†æ ·æœ¬æ•°: {å¤„ç†è®¡æ•°}")
        æ—¥å¿—.info(f"  - è¯„ä¼°æ—¶é—´: {è¯„ä¼°æ—¶é—´:.2f} ç§’")
        æ—¥å¿—.info(f"  - ååé‡: {ååé‡:.1f} æ ·æœ¬/ç§’")
        æ—¥å¿—.info(f"  - æ€»ä½“å‡†ç¡®ç‡: {ç»“æœ.æ€»ä½“å‡†ç¡®ç‡:.4f}")
        
        return ç»“æœ
    
    def æ‰¹é‡è¯„ä¼°å¹¶ç”ŸæˆæŠ¥å‘Š(self, æ•°æ®è·¯å¾„: str = None,
                           è¾“å‡ºç›®å½•: str = "è¯„ä¼°æŠ¥å‘Š",
                           æŠ¥å‘Šæ ¼å¼: List[str] = None,
                           æµ‹è¯•æ¯”ä¾‹: float = 0.2,
                           æ˜¾ç¤ºè¿›åº¦: bool = True,
                           æœ€å¤§æ ·æœ¬æ•°: int = None) -> Dict[str, Any]:
        """
        æ‰¹é‡è¯„ä¼°å¹¶ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
        
        å‚æ•°:
            æ•°æ®è·¯å¾„: æ•°æ®æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„
            è¾“å‡ºç›®å½•: æŠ¥å‘Šè¾“å‡ºç›®å½•
            æŠ¥å‘Šæ ¼å¼: æŠ¥å‘Šæ ¼å¼åˆ—è¡¨ï¼Œå¦‚ ['text', 'markdown', 'html', 'json']
            æµ‹è¯•æ¯”ä¾‹: æµ‹è¯•æ•°æ®æ¯”ä¾‹
            æ˜¾ç¤ºè¿›åº¦: æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡
            æœ€å¤§æ ·æœ¬æ•°: æœ€å¤§è¯„ä¼°æ ·æœ¬æ•°
            
        è¿”å›:
            åŒ…å«è¯„ä¼°ç»“æœå’Œç”Ÿæˆæ–‡ä»¶è·¯å¾„çš„å­—å…¸
        """
        if æŠ¥å‘Šæ ¼å¼ is None:
            æŠ¥å‘Šæ ¼å¼ = ['text', 'markdown']
        
        # æ‰§è¡Œæ‰¹é‡è¯„ä¼°
        ç»“æœ = self.æ‰¹é‡è¯„ä¼°(
            æ•°æ®è·¯å¾„=æ•°æ®è·¯å¾„,
            æµ‹è¯•æ¯”ä¾‹=æµ‹è¯•æ¯”ä¾‹,
            æ˜¾ç¤ºè¿›åº¦=æ˜¾ç¤ºè¿›åº¦,
            æœ€å¤§æ ·æœ¬æ•°=æœ€å¤§æ ·æœ¬æ•°
        )
        
        if ç»“æœ.æ ·æœ¬æ•°é‡ == 0:
            return {'è¯„ä¼°ç»“æœ': ç»“æœ, 'ç”Ÿæˆæ–‡ä»¶': {}}
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        os.makedirs(è¾“å‡ºç›®å½•, exist_ok=True)
        
        # ç”Ÿæˆæ—¶é—´æˆ³
        æ—¶é—´æˆ³ = time.strftime("%Y%m%d_%H%M%S")
        
        # ç”ŸæˆæŠ¥å‘Š
        æŠ¥å‘Šç”Ÿæˆ = æŠ¥å‘Šç”Ÿæˆå™¨(ç»“æœ, self.åŠ¨ä½œå®šä¹‰)
        ç”Ÿæˆæ–‡ä»¶ = {}
        
        if 'text' in æŠ¥å‘Šæ ¼å¼:
            æ–‡æœ¬æŠ¥å‘Š = æŠ¥å‘Šç”Ÿæˆ.ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š()
            æ–‡æœ¬è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.txt")
            with open(æ–‡æœ¬è·¯å¾„, 'w', encoding='utf-8') as f:
                f.write(æ–‡æœ¬æŠ¥å‘Š)
            ç”Ÿæˆæ–‡ä»¶['text'] = æ–‡æœ¬è·¯å¾„
            æ—¥å¿—.info(f"æ–‡æœ¬æŠ¥å‘Šå·²ä¿å­˜: {æ–‡æœ¬è·¯å¾„}")
        
        if 'markdown' in æŠ¥å‘Šæ ¼å¼:
            mdè·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.md")
            æŠ¥å‘Šç”Ÿæˆ.ç”ŸæˆMarkdownæŠ¥å‘Š(mdè·¯å¾„)
            ç”Ÿæˆæ–‡ä»¶['markdown'] = mdè·¯å¾„
        
        if 'html' in æŠ¥å‘Šæ ¼å¼:
            htmlè·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.html")
            æŠ¥å‘Šç”Ÿæˆ.ç”ŸæˆHTMLæŠ¥å‘Š(htmlè·¯å¾„)
            ç”Ÿæˆæ–‡ä»¶['html'] = htmlè·¯å¾„
        
        if 'json' in æŠ¥å‘Šæ ¼å¼:
            jsonè·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.json")
            æŠ¥å‘Šç”Ÿæˆ.ç”ŸæˆJSONæŠ¥å‘Š(jsonè·¯å¾„)
            ç”Ÿæˆæ–‡ä»¶['json'] = jsonè·¯å¾„
        
        # ç”Ÿæˆå¯è§†åŒ–
        å¯è§†åŒ– = å¯è§†åŒ–å™¨(self.åŠ¨ä½œå®šä¹‰)
        å¯è§†åŒ–æ–‡ä»¶ = å¯è§†åŒ–.ç”Ÿæˆå®Œæ•´å¯è§†åŒ–æŠ¥å‘Š(ç»“æœ, è¾“å‡ºç›®å½•, f"eval_{æ—¶é—´æˆ³}")
        ç”Ÿæˆæ–‡ä»¶.update(å¯è§†åŒ–æ–‡ä»¶)
        
        return {
            'è¯„ä¼°ç»“æœ': ç»“æœ,
            'ç”Ÿæˆæ–‡ä»¶': ç”Ÿæˆæ–‡ä»¶,
            'ç»Ÿè®¡ä¿¡æ¯': {
                'æ ·æœ¬æ•°é‡': ç»“æœ.æ ·æœ¬æ•°é‡,
                'è¯„ä¼°æ—¶é—´': ç»“æœ.è¯„ä¼°æ—¶é—´,
                'ååé‡': ç»“æœ.æ ·æœ¬æ•°é‡ / ç»“æœ.è¯„ä¼°æ—¶é—´ if ç»“æœ.è¯„ä¼°æ—¶é—´ > 0 else 0,
                'æ€»ä½“å‡†ç¡®ç‡': ç»“æœ.æ€»ä½“å‡†ç¡®ç‡
            }
        }
    
    def ä»ç›®å½•è¯„ä¼°(self, æ•°æ®ç›®å½•: str,
                   è¾“å‡ºç›®å½•: str = "è¯„ä¼°æŠ¥å‘Š",
                   æŠ¥å‘Šæ ¼å¼: List[str] = None) -> Dict[str, Any]:
        """
        ä»æ•°æ®ç›®å½•åŠ è½½æ•°æ®å¹¶è¯„ä¼°
        
        å‚æ•°:
            æ•°æ®ç›®å½•: æ•°æ®ç›®å½•è·¯å¾„
            è¾“å‡ºç›®å½•: æŠ¥å‘Šè¾“å‡ºç›®å½•
            æŠ¥å‘Šæ ¼å¼: æŠ¥å‘Šæ ¼å¼åˆ—è¡¨
            
        è¿”å›:
            è¯„ä¼°ç»“æœå­—å…¸
        """
        return self.æ‰¹é‡è¯„ä¼°å¹¶ç”ŸæˆæŠ¥å‘Š(
            æ•°æ®è·¯å¾„=æ•°æ®ç›®å½•,
            è¾“å‡ºç›®å½•=è¾“å‡ºç›®å½•,
            æŠ¥å‘Šæ ¼å¼=æŠ¥å‘Šæ ¼å¼,
            æµ‹è¯•æ¯”ä¾‹=1.0  # ä½¿ç”¨å…¨éƒ¨æ•°æ®ä½œä¸ºæµ‹è¯•æ•°æ®
        )


# ==================== åŠ¨ä½œç±»åˆ«åˆ†æ ====================

# é»˜è®¤åŠ¨ä½œåˆ†ç»„å®šä¹‰ï¼ˆæ ¹æ®è®¾è®¡æ–‡æ¡£ï¼‰
é»˜è®¤åŠ¨ä½œåˆ†ç»„ = {
    "ç§»åŠ¨": [0, 1, 2, 3, 4, 5, 6, 7, 8],
    "æŠ€èƒ½": [9, 10, 11, 12, 13, 14, 15, 16, 17, 18],
    "ç‰¹æ®Š": [19, 20, 21],
    "é¼ æ ‡": [22, 23, 24],
    "ç»„åˆ": [25, 26, 27, 28, 29, 30, 31]
}


@dataclass
class åˆ†ç»„æŒ‡æ ‡:
    """åŠ¨ä½œåˆ†ç»„çš„è¯„ä¼°æŒ‡æ ‡"""
    åˆ†ç»„åç§°: str = ""
    åŠ¨ä½œåˆ—è¡¨: List[int] = field(default_factory=list)
    åŠ¨ä½œåç§°åˆ—è¡¨: List[str] = field(default_factory=list)
    å¹³å‡ç²¾ç¡®ç‡: float = 0.0
    å¹³å‡å¬å›ç‡: float = 0.0
    å¹³å‡F1åˆ†æ•°: float = 0.0
    æ€»æ ·æœ¬æ•°: int = 0
    ç±»åˆ«æ•°: int = 0
    å¼±åŠ¿ç±»åˆ«æ•°: int = 0
    å¼±åŠ¿ç±»åˆ«åˆ—è¡¨: List[str] = field(default_factory=list)
    
    def to_dict(self) -> dict:
        return {
            'åˆ†ç»„åç§°': self.åˆ†ç»„åç§°,
            'åŠ¨ä½œåˆ—è¡¨': self.åŠ¨ä½œåˆ—è¡¨,
            'åŠ¨ä½œåç§°åˆ—è¡¨': self.åŠ¨ä½œåç§°åˆ—è¡¨,
            'å¹³å‡ç²¾ç¡®ç‡': round(self.å¹³å‡ç²¾ç¡®ç‡, 4),
            'å¹³å‡å¬å›ç‡': round(self.å¹³å‡å¬å›ç‡, 4),
            'å¹³å‡F1åˆ†æ•°': round(self.å¹³å‡F1åˆ†æ•°, 4),
            'æ€»æ ·æœ¬æ•°': self.æ€»æ ·æœ¬æ•°,
            'ç±»åˆ«æ•°': self.ç±»åˆ«æ•°,
            'å¼±åŠ¿ç±»åˆ«æ•°': self.å¼±åŠ¿ç±»åˆ«æ•°,
            'å¼±åŠ¿ç±»åˆ«åˆ—è¡¨': self.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨
        }


@dataclass
class å¼±åŠ¿ç±»åˆ«ä¿¡æ¯:
    """å¼±åŠ¿ç±»åˆ«çš„è¯¦ç»†ä¿¡æ¯"""
    ç±»åˆ«åç§°: str = ""
    ç±»åˆ«ç´¢å¼•: int = 0
    æ‰€å±åˆ†ç»„: str = ""
    F1åˆ†æ•°: float = 0.0
    ç²¾ç¡®ç‡: float = 0.0
    å¬å›ç‡: float = 0.0
    æ”¯æŒæ•°: int = 0
    é—®é¢˜ç±»å‹: str = ""
    å»ºè®®: str = ""
    
    def to_dict(self) -> dict:
        return {
            'ç±»åˆ«åç§°': self.ç±»åˆ«åç§°,
            'ç±»åˆ«ç´¢å¼•': self.ç±»åˆ«ç´¢å¼•,
            'æ‰€å±åˆ†ç»„': self.æ‰€å±åˆ†ç»„,
            'F1åˆ†æ•°': round(self.F1åˆ†æ•°, 4),
            'ç²¾ç¡®ç‡': round(self.ç²¾ç¡®ç‡, 4),
            'å¬å›ç‡': round(self.å¬å›ç‡, 4),
            'æ”¯æŒæ•°': self.æ”¯æŒæ•°,
            'é—®é¢˜ç±»å‹': self.é—®é¢˜ç±»å‹,
            'å»ºè®®': self.å»ºè®®
        }


@dataclass
class ç±»åˆ«åˆ†æç»“æœ:
    """åŠ¨ä½œç±»åˆ«åˆ†æçš„å®Œæ•´ç»“æœ"""
    åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨: List[åˆ†ç»„æŒ‡æ ‡] = field(default_factory=list)
    å¼±åŠ¿ç±»åˆ«åˆ—è¡¨: List[å¼±åŠ¿ç±»åˆ«ä¿¡æ¯] = field(default_factory=list)
    æ€»å¼±åŠ¿ç±»åˆ«æ•°: int = 0
    éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«: List[str] = field(default_factory=list)
    å»ºè®®ä¼˜å…ˆå¤„ç†: List[str] = field(default_factory=list)
    åˆ†ææ‘˜è¦: List[str] = field(default_factory=list)
    
    def to_dict(self) -> dict:
        return {
            'åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨': [g.to_dict() for g in self.åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨],
            'å¼±åŠ¿ç±»åˆ«åˆ—è¡¨': [w.to_dict() for w in self.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨],
            'æ€»å¼±åŠ¿ç±»åˆ«æ•°': self.æ€»å¼±åŠ¿ç±»åˆ«æ•°,
            'éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«': self.éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«,
            'å»ºè®®ä¼˜å…ˆå¤„ç†': self.å»ºè®®ä¼˜å…ˆå¤„ç†,
            'åˆ†ææ‘˜è¦': self.åˆ†ææ‘˜è¦
        }


class åŠ¨ä½œç±»åˆ«åˆ†æå™¨:
    """åŠ¨ä½œç±»åˆ«åˆ†æå™¨
    
    æŒ‰ç±»å‹åˆ†ç»„åŠ¨ä½œï¼ˆç§»åŠ¨ã€æŠ€èƒ½ã€ç‰¹æ®Šã€é¼ æ ‡ã€ç»„åˆï¼‰ï¼Œ
    è®¡ç®—æ¯ä¸ªåŠ¨ä½œç»„çš„æŒ‡æ ‡ï¼Œè¯†åˆ«è¡¨ç°ä¸ä½³çš„åŠ¨ä½œç±»åˆ«ï¼Œ
    å»ºè®®å¯èƒ½éœ€è¦æ›´å¤šè®­ç»ƒæ ·æœ¬çš„åŠ¨ä½œã€‚
    
    éœ€æ±‚: 5.1, 5.2, 5.3, 5.4 - åŠ¨ä½œç±»åˆ«åˆ†æ
    """
    
    def __init__(self, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None, 
                 åŠ¨ä½œåˆ†ç»„: Dict[str, List[int]] = None):
        """
        åˆå§‹åŒ–åŠ¨ä½œç±»åˆ«åˆ†æå™¨
        
        å‚æ•°:
            åŠ¨ä½œå®šä¹‰: åŠ¨ä½œç´¢å¼•åˆ°åç§°çš„æ˜ å°„ {0: "å‰è¿›", 1: "åé€€", ...}
            åŠ¨ä½œåˆ†ç»„: åŠ¨ä½œåˆ†ç»„å®šä¹‰ {"ç§»åŠ¨": [0, 1, 2, ...], "æŠ€èƒ½": [9, 10, ...], ...}
        """
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰ or {}
        self.åŠ¨ä½œåˆ†ç»„ = åŠ¨ä½œåˆ†ç»„ or é»˜è®¤åŠ¨ä½œåˆ†ç»„.copy()
        
        # æ„å»ºåå‘æ˜ å°„ï¼šåŠ¨ä½œç´¢å¼• -> åˆ†ç»„åç§°
        self._åŠ¨ä½œåˆ°åˆ†ç»„ = {}
        self._æ›´æ–°åŠ¨ä½œåˆ°åˆ†ç»„æ˜ å°„()
    
    def _æ›´æ–°åŠ¨ä½œåˆ°åˆ†ç»„æ˜ å°„(self):
        """æ›´æ–°åŠ¨ä½œç´¢å¼•åˆ°åˆ†ç»„åç§°çš„æ˜ å°„"""
        self._åŠ¨ä½œåˆ°åˆ†ç»„ = {}
        for åˆ†ç»„å, åŠ¨ä½œåˆ—è¡¨ in self.åŠ¨ä½œåˆ†ç»„.items():
            for åŠ¨ä½œç´¢å¼• in åŠ¨ä½œåˆ—è¡¨:
                self._åŠ¨ä½œåˆ°åˆ†ç»„[åŠ¨ä½œç´¢å¼•] = åˆ†ç»„å
    
    def è®¾ç½®åŠ¨ä½œå®šä¹‰(self, åŠ¨ä½œå®šä¹‰: Dict[int, str]):
        """è®¾ç½®åŠ¨ä½œå®šä¹‰"""
        self.åŠ¨ä½œå®šä¹‰ = åŠ¨ä½œå®šä¹‰
    
    def è®¾ç½®åŠ¨ä½œåˆ†ç»„(self, åŠ¨ä½œåˆ†ç»„: Dict[str, List[int]]):
        """è®¾ç½®åŠ¨ä½œåˆ†ç»„"""
        self.åŠ¨ä½œåˆ†ç»„ = åŠ¨ä½œåˆ†ç»„
        self._æ›´æ–°åŠ¨ä½œåˆ°åˆ†ç»„æ˜ å°„()
    
    def è·å–åŠ¨ä½œåˆ†ç»„(self, åŠ¨ä½œç´¢å¼•: int) -> str:
        """
        è·å–åŠ¨ä½œæ‰€å±çš„åˆ†ç»„
        
        å‚æ•°:
            åŠ¨ä½œç´¢å¼•: åŠ¨ä½œç´¢å¼•
            
        è¿”å›:
            åˆ†ç»„åç§°ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› "æœªåˆ†ç»„"
        """
        return self._åŠ¨ä½œåˆ°åˆ†ç»„.get(åŠ¨ä½œç´¢å¼•, "æœªåˆ†ç»„")
    
    def æŒ‰åˆ†ç»„è®¡ç®—æŒ‡æ ‡(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ, 
                       F1é˜ˆå€¼: float = 0.7) -> List[åˆ†ç»„æŒ‡æ ‡]:
        """
        æŒ‰åŠ¨ä½œåˆ†ç»„è®¡ç®—æŒ‡æ ‡
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼ï¼Œä½äºæ­¤å€¼è§†ä¸ºå¼±åŠ¿ç±»åˆ«
            
        è¿”å›:
            åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨
        """
        åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨ = []
        
        for åˆ†ç»„å, åŠ¨ä½œç´¢å¼•åˆ—è¡¨ in self.åŠ¨ä½œåˆ†ç»„.items():
            åˆ†ç»„ = åˆ†ç»„æŒ‡æ ‡(åˆ†ç»„åç§°=åˆ†ç»„å)
            åˆ†ç»„.åŠ¨ä½œåˆ—è¡¨ = åŠ¨ä½œç´¢å¼•åˆ—è¡¨.copy()
            
            ç²¾ç¡®ç‡åˆ—è¡¨ = []
            å¬å›ç‡åˆ—è¡¨ = []
            F1åˆ—è¡¨ = []
            æ€»æ ·æœ¬æ•° = 0
            æœ‰æ•ˆç±»åˆ«æ•° = 0
            å¼±åŠ¿ç±»åˆ« = []
            åŠ¨ä½œåç§°åˆ—è¡¨ = []
            
            for åŠ¨ä½œç´¢å¼• in åŠ¨ä½œç´¢å¼•åˆ—è¡¨:
                # è·å–åŠ¨ä½œåç§°
                åŠ¨ä½œåç§° = self.åŠ¨ä½œå®šä¹‰.get(åŠ¨ä½œç´¢å¼•, f"ç±»åˆ«{åŠ¨ä½œç´¢å¼•}")
                åŠ¨ä½œåç§°åˆ—è¡¨.append(åŠ¨ä½œåç§°)
                
                # æŸ¥æ‰¾è¯¥åŠ¨ä½œçš„æŒ‡æ ‡
                if åŠ¨ä½œåç§° in è¯„ä¼°ç»“æœ.ç±»åˆ«æŒ‡æ ‡:
                    æŒ‡æ ‡ = è¯„ä¼°ç»“æœ.ç±»åˆ«æŒ‡æ ‡[åŠ¨ä½œåç§°]
                    
                    if æŒ‡æ ‡.æ”¯æŒæ•° > 0:
                        ç²¾ç¡®ç‡åˆ—è¡¨.append(æŒ‡æ ‡.ç²¾ç¡®ç‡)
                        å¬å›ç‡åˆ—è¡¨.append(æŒ‡æ ‡.å¬å›ç‡)
                        F1åˆ—è¡¨.append(æŒ‡æ ‡.F1åˆ†æ•°)
                        æ€»æ ·æœ¬æ•° += æŒ‡æ ‡.æ”¯æŒæ•°
                        æœ‰æ•ˆç±»åˆ«æ•° += 1
                        
                        # æ£€æŸ¥æ˜¯å¦ä¸ºå¼±åŠ¿ç±»åˆ«
                        if æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                            å¼±åŠ¿ç±»åˆ«.append(åŠ¨ä½œåç§°)
            
            åˆ†ç»„.åŠ¨ä½œåç§°åˆ—è¡¨ = åŠ¨ä½œåç§°åˆ—è¡¨
            åˆ†ç»„.æ€»æ ·æœ¬æ•° = æ€»æ ·æœ¬æ•°
            åˆ†ç»„.ç±»åˆ«æ•° = æœ‰æ•ˆç±»åˆ«æ•°
            åˆ†ç»„.å¼±åŠ¿ç±»åˆ«æ•° = len(å¼±åŠ¿ç±»åˆ«)
            åˆ†ç»„.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨ = å¼±åŠ¿ç±»åˆ«
            
            # è®¡ç®—å¹³å‡æŒ‡æ ‡
            if ç²¾ç¡®ç‡åˆ—è¡¨:
                åˆ†ç»„.å¹³å‡ç²¾ç¡®ç‡ = sum(ç²¾ç¡®ç‡åˆ—è¡¨) / len(ç²¾ç¡®ç‡åˆ—è¡¨)
                åˆ†ç»„.å¹³å‡å¬å›ç‡ = sum(å¬å›ç‡åˆ—è¡¨) / len(å¬å›ç‡åˆ—è¡¨)
                åˆ†ç»„.å¹³å‡F1åˆ†æ•° = sum(F1åˆ—è¡¨) / len(F1åˆ—è¡¨)
            
            åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨.append(åˆ†ç»„)
        
        return åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨
    
    def è¯†åˆ«å¼±åŠ¿ç±»åˆ«(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ,
                     F1é˜ˆå€¼: float = 0.7,
                     ç²¾ç¡®ç‡é˜ˆå€¼: float = 0.6,
                     å¬å›ç‡é˜ˆå€¼: float = 0.6,
                     æœ€å°æ ·æœ¬æ•°: int = 5) -> List[å¼±åŠ¿ç±»åˆ«ä¿¡æ¯]:
        """
        è¯†åˆ«è¡¨ç°ä¸ä½³çš„åŠ¨ä½œç±»åˆ«
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
            ç²¾ç¡®ç‡é˜ˆå€¼: ç²¾ç¡®ç‡é˜ˆå€¼
            å¬å›ç‡é˜ˆå€¼: å¬å›ç‡é˜ˆå€¼
            æœ€å°æ ·æœ¬æ•°: æœ€å°æ ·æœ¬æ•°é˜ˆå€¼ï¼Œä½äºæ­¤å€¼è§†ä¸ºæ ·æœ¬ä¸è¶³
            
        è¿”å›:
            å¼±åŠ¿ç±»åˆ«ä¿¡æ¯åˆ—è¡¨ï¼ŒæŒ‰ F1 åˆ†æ•°å‡åºæ’åˆ—
        """
        å¼±åŠ¿ç±»åˆ«åˆ—è¡¨ = []
        
        for ç±»åˆ«å, æŒ‡æ ‡ in è¯„ä¼°ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            # è·³è¿‡æ²¡æœ‰æ ·æœ¬çš„ç±»åˆ«
            if æŒ‡æ ‡.æ”¯æŒæ•° == 0:
                continue
            
            # åˆ¤æ–­æ˜¯å¦ä¸ºå¼±åŠ¿ç±»åˆ«
            æ˜¯å¼±åŠ¿ = False
            é—®é¢˜ç±»å‹ = ""
            å»ºè®® = ""
            
            # æŸ¥æ‰¾ç±»åˆ«ç´¢å¼•
            ç±»åˆ«ç´¢å¼• = -1
            for ç´¢å¼•, åç§° in self.åŠ¨ä½œå®šä¹‰.items():
                if åç§° == ç±»åˆ«å:
                    ç±»åˆ«ç´¢å¼• = ç´¢å¼•
                    break
            
            # è·å–æ‰€å±åˆ†ç»„
            æ‰€å±åˆ†ç»„ = self.è·å–åŠ¨ä½œåˆ†ç»„(ç±»åˆ«ç´¢å¼•) if ç±»åˆ«ç´¢å¼• >= 0 else "æœªåˆ†ç»„"
            
            # è¯Šæ–­é—®é¢˜ç±»å‹
            if æŒ‡æ ‡.æ”¯æŒæ•° < æœ€å°æ ·æœ¬æ•°:
                æ˜¯å¼±åŠ¿ = True
                é—®é¢˜ç±»å‹ = "æ ·æœ¬ä¸è¶³"
                å»ºè®® = f"å»ºè®®å¢åŠ è¯¥ç±»åˆ«çš„è®­ç»ƒæ ·æœ¬ï¼ˆå½“å‰ä»… {æŒ‡æ ‡.æ”¯æŒæ•°} ä¸ªï¼‰"
            elif æŒ‡æ ‡.F1åˆ†æ•° < 0.5:
                æ˜¯å¼±åŠ¿ = True
                é—®é¢˜ç±»å‹ = "æ•´ä½“è¡¨ç°å·®"
                å»ºè®® = "å»ºè®®æ£€æŸ¥æ•°æ®è´¨é‡å¹¶å¢åŠ è®­ç»ƒæ ·æœ¬"
            elif æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                æ˜¯å¼±åŠ¿ = True
                if æŒ‡æ ‡.ç²¾ç¡®ç‡ < ç²¾ç¡®ç‡é˜ˆå€¼ and æŒ‡æ ‡.å¬å›ç‡ > 0.7:
                    é—®é¢˜ç±»å‹ = "è¿‡åº¦é¢„æµ‹"
                    å»ºè®® = "æ¨¡å‹å€¾å‘äºè¿‡åº¦é¢„æµ‹è¯¥ç±»åˆ«ï¼Œå»ºè®®æ£€æŸ¥è®­ç»ƒæ•°æ®ä¸­æ˜¯å¦æœ‰æ ‡æ³¨é”™è¯¯"
                elif æŒ‡æ ‡.å¬å›ç‡ < å¬å›ç‡é˜ˆå€¼ and æŒ‡æ ‡.ç²¾ç¡®ç‡ > 0.7:
                    é—®é¢˜ç±»å‹ = "æ¬ é¢„æµ‹"
                    å»ºè®® = "æ¨¡å‹éš¾ä»¥è¯†åˆ«è¯¥ç±»åˆ«ï¼Œå»ºè®®å¢åŠ è¯¥ç±»åˆ«çš„è®­ç»ƒæ ·æœ¬æˆ–è¿›è¡Œæ•°æ®å¢å¼º"
                else:
                    é—®é¢˜ç±»å‹ = "ç»¼åˆè¡¨ç°åä½"
                    å»ºè®® = "å»ºè®®å¢åŠ è®­ç»ƒæ ·æœ¬å¹¶è°ƒæ•´ç±»åˆ«æƒé‡"
            
            if æ˜¯å¼±åŠ¿:
                å¼±åŠ¿ä¿¡æ¯ = å¼±åŠ¿ç±»åˆ«ä¿¡æ¯(
                    ç±»åˆ«åç§°=ç±»åˆ«å,
                    ç±»åˆ«ç´¢å¼•=ç±»åˆ«ç´¢å¼•,
                    æ‰€å±åˆ†ç»„=æ‰€å±åˆ†ç»„,
                    F1åˆ†æ•°=æŒ‡æ ‡.F1åˆ†æ•°,
                    ç²¾ç¡®ç‡=æŒ‡æ ‡.ç²¾ç¡®ç‡,
                    å¬å›ç‡=æŒ‡æ ‡.å¬å›ç‡,
                    æ”¯æŒæ•°=æŒ‡æ ‡.æ”¯æŒæ•°,
                    é—®é¢˜ç±»å‹=é—®é¢˜ç±»å‹,
                    å»ºè®®=å»ºè®®
                )
                å¼±åŠ¿ç±»åˆ«åˆ—è¡¨.append(å¼±åŠ¿ä¿¡æ¯)
        
        # æŒ‰ F1 åˆ†æ•°å‡åºæ’åˆ—ï¼ˆæœ€å·®çš„åœ¨å‰é¢ï¼‰
        å¼±åŠ¿ç±»åˆ«åˆ—è¡¨.sort(key=lambda x: x.F1åˆ†æ•°)
        
        return å¼±åŠ¿ç±»åˆ«åˆ—è¡¨
    
    def å»ºè®®éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ,
                               F1é˜ˆå€¼: float = 0.7,
                               å¬å›ç‡é˜ˆå€¼: float = 0.6,
                               æœ€å°æ ·æœ¬æ•°: int = 10) -> List[Tuple[str, str]]:
        """
        å»ºè®®å¯èƒ½éœ€è¦æ›´å¤šè®­ç»ƒæ ·æœ¬çš„åŠ¨ä½œ
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
            å¬å›ç‡é˜ˆå€¼: å¬å›ç‡é˜ˆå€¼
            æœ€å°æ ·æœ¬æ•°: æœ€å°æ ·æœ¬æ•°é˜ˆå€¼
            
        è¿”å›:
            [(ç±»åˆ«åç§°, å»ºè®®åŸå› ), ...] åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº
        """
        å»ºè®®åˆ—è¡¨ = []
        
        for ç±»åˆ«å, æŒ‡æ ‡ in è¯„ä¼°ç»“æœ.ç±»åˆ«æŒ‡æ ‡.items():
            if æŒ‡æ ‡.æ”¯æŒæ•° == 0:
                continue
            
            åŸå›  = None
            ä¼˜å…ˆçº§ = 0  # æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
            
            # æ ·æœ¬æ•°è¿‡å°‘
            if æŒ‡æ ‡.æ”¯æŒæ•° < æœ€å°æ ·æœ¬æ•°:
                åŸå›  = f"æ ·æœ¬æ•°è¿‡å°‘ï¼ˆä»… {æŒ‡æ ‡.æ”¯æŒæ•°} ä¸ªï¼‰ï¼Œå»ºè®®è‡³å°‘æ”¶é›† {æœ€å°æ ·æœ¬æ•°} ä¸ªæ ·æœ¬"
                ä¼˜å…ˆçº§ = 1
            # å¬å›ç‡ä½ï¼ˆæ¨¡å‹éš¾ä»¥è¯†åˆ«ï¼‰
            elif æŒ‡æ ‡.å¬å›ç‡ < å¬å›ç‡é˜ˆå€¼ and æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                åŸå›  = f"å¬å›ç‡ä½ï¼ˆ{æŒ‡æ ‡.å¬å›ç‡:.2f}ï¼‰ï¼Œæ¨¡å‹éš¾ä»¥è¯†åˆ«è¯¥ç±»åˆ«"
                ä¼˜å…ˆçº§ = 2
            # F1 åˆ†æ•°ä½
            elif æŒ‡æ ‡.F1åˆ†æ•° < 0.5:
                åŸå›  = f"F1 åˆ†æ•°è¿‡ä½ï¼ˆ{æŒ‡æ ‡.F1åˆ†æ•°:.2f}ï¼‰ï¼Œæ•´ä½“è¡¨ç°å·®"
                ä¼˜å…ˆçº§ = 3
            elif æŒ‡æ ‡.F1åˆ†æ•° < F1é˜ˆå€¼:
                åŸå›  = f"F1 åˆ†æ•°åä½ï¼ˆ{æŒ‡æ ‡.F1åˆ†æ•°:.2f}ï¼‰ï¼Œå¯è€ƒè™‘å¢åŠ æ ·æœ¬"
                ä¼˜å…ˆçº§ = 4
            
            if åŸå› :
                å»ºè®®åˆ—è¡¨.append((ç±»åˆ«å, åŸå› , ä¼˜å…ˆçº§))
        
        # æŒ‰ä¼˜å…ˆçº§æ’åº
        å»ºè®®åˆ—è¡¨.sort(key=lambda x: (x[2], -è¯„ä¼°ç»“æœ.ç±»åˆ«æŒ‡æ ‡[x[0]].æ”¯æŒæ•°))
        
        # è¿”å›ä¸å«ä¼˜å…ˆçº§çš„åˆ—è¡¨
        return [(åç§°, åŸå› ) for åç§°, åŸå› , _ in å»ºè®®åˆ—è¡¨]
    
    def å®Œæ•´åˆ†æ(self, è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ,
                 F1é˜ˆå€¼: float = 0.7,
                 ç²¾ç¡®ç‡é˜ˆå€¼: float = 0.6,
                 å¬å›ç‡é˜ˆå€¼: float = 0.6,
                 æœ€å°æ ·æœ¬æ•°: int = 5) -> ç±»åˆ«åˆ†æç»“æœ:
        """
        æ‰§è¡Œå®Œæ•´çš„åŠ¨ä½œç±»åˆ«åˆ†æ
        
        å‚æ•°:
            è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
            F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
            ç²¾ç¡®ç‡é˜ˆå€¼: ç²¾ç¡®ç‡é˜ˆå€¼
            å¬å›ç‡é˜ˆå€¼: å¬å›ç‡é˜ˆå€¼
            æœ€å°æ ·æœ¬æ•°: æœ€å°æ ·æœ¬æ•°é˜ˆå€¼
            
        è¿”å›:
            ç±»åˆ«åˆ†æç»“æœå¯¹è±¡
        """
        ç»“æœ = ç±»åˆ«åˆ†æç»“æœ()
        
        # 1. æŒ‰åˆ†ç»„è®¡ç®—æŒ‡æ ‡
        ç»“æœ.åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨ = self.æŒ‰åˆ†ç»„è®¡ç®—æŒ‡æ ‡(è¯„ä¼°ç»“æœ, F1é˜ˆå€¼)
        
        # 2. è¯†åˆ«å¼±åŠ¿ç±»åˆ«
        ç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨ = self.è¯†åˆ«å¼±åŠ¿ç±»åˆ«(
            è¯„ä¼°ç»“æœ, F1é˜ˆå€¼, ç²¾ç¡®ç‡é˜ˆå€¼, å¬å›ç‡é˜ˆå€¼, æœ€å°æ ·æœ¬æ•°
        )
        ç»“æœ.æ€»å¼±åŠ¿ç±»åˆ«æ•° = len(ç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨)
        
        # 3. å»ºè®®éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«
        æ ·æœ¬å»ºè®® = self.å»ºè®®éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«(
            è¯„ä¼°ç»“æœ, F1é˜ˆå€¼, å¬å›ç‡é˜ˆå€¼, æœ€å°æ ·æœ¬æ•°
        )
        ç»“æœ.éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ« = [åç§° for åç§°, _ in æ ·æœ¬å»ºè®®]
        
        # 4. å»ºè®®ä¼˜å…ˆå¤„ç†çš„ç±»åˆ«ï¼ˆF1 æœ€ä½çš„å‰ 5 ä¸ªï¼‰
        ç»“æœ.å»ºè®®ä¼˜å…ˆå¤„ç† = [w.ç±»åˆ«åç§° for w in ç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨[:5]]
        
        # 5. ç”Ÿæˆåˆ†ææ‘˜è¦
        ç»“æœ.åˆ†ææ‘˜è¦ = self._ç”Ÿæˆåˆ†ææ‘˜è¦(ç»“æœ, è¯„ä¼°ç»“æœ)
        
        return ç»“æœ
    
    def _ç”Ÿæˆåˆ†ææ‘˜è¦(self, åˆ†æç»“æœ: ç±»åˆ«åˆ†æç»“æœ, 
                      è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ) -> List[str]:
        """ç”Ÿæˆåˆ†ææ‘˜è¦"""
        æ‘˜è¦ = []
        
        # åˆ†ç»„è¡¨ç°æ¦‚è¿°
        æ‘˜è¦.append("ã€åˆ†ç»„è¡¨ç°æ¦‚è¿°ã€‘")
        for åˆ†ç»„ in åˆ†æç»“æœ.åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨:
            if åˆ†ç»„.ç±»åˆ«æ•° > 0:
                çŠ¶æ€ = "âœ… è‰¯å¥½" if åˆ†ç»„.å¹³å‡F1åˆ†æ•° >= 0.7 else "âš ï¸ éœ€æ”¹è¿›"
                æ‘˜è¦.append(
                    f"  {åˆ†ç»„.åˆ†ç»„åç§°}: å¹³å‡F1={åˆ†ç»„.å¹³å‡F1åˆ†æ•°:.2f}, "
                    f"ç±»åˆ«æ•°={åˆ†ç»„.ç±»åˆ«æ•°}, å¼±åŠ¿ç±»åˆ«={åˆ†ç»„.å¼±åŠ¿ç±»åˆ«æ•°} {çŠ¶æ€}"
                )
        
        # å¼±åŠ¿ç±»åˆ«ç»Ÿè®¡
        æ‘˜è¦.append("")
        æ‘˜è¦.append("ã€å¼±åŠ¿ç±»åˆ«ç»Ÿè®¡ã€‘")
        if åˆ†æç»“æœ.æ€»å¼±åŠ¿ç±»åˆ«æ•° == 0:
            æ‘˜è¦.append("  âœ… æ‰€æœ‰ç±»åˆ«è¡¨ç°å‡è¾¾æ ‡")
        else:
            æ‘˜è¦.append(f"  å…±å‘ç° {åˆ†æç»“æœ.æ€»å¼±åŠ¿ç±»åˆ«æ•°} ä¸ªå¼±åŠ¿ç±»åˆ«")
            
            # æŒ‰é—®é¢˜ç±»å‹ç»Ÿè®¡
            é—®é¢˜ç»Ÿè®¡ = {}
            for å¼±åŠ¿ in åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
                é—®é¢˜ç»Ÿè®¡[å¼±åŠ¿.é—®é¢˜ç±»å‹] = é—®é¢˜ç»Ÿè®¡.get(å¼±åŠ¿.é—®é¢˜ç±»å‹, 0) + 1
            
            for é—®é¢˜ç±»å‹, æ•°é‡ in é—®é¢˜ç»Ÿè®¡.items():
                æ‘˜è¦.append(f"    - {é—®é¢˜ç±»å‹}: {æ•°é‡} ä¸ª")
        
        # ä¼˜å…ˆå¤„ç†å»ºè®®
        if åˆ†æç»“æœ.å»ºè®®ä¼˜å…ˆå¤„ç†:
            æ‘˜è¦.append("")
            æ‘˜è¦.append("ã€å»ºè®®ä¼˜å…ˆå¤„ç†ã€‘")
            for i, ç±»åˆ«å in enumerate(åˆ†æç»“æœ.å»ºè®®ä¼˜å…ˆå¤„ç†[:5], 1):
                # æŸ¥æ‰¾è¯¥ç±»åˆ«çš„è¯¦ç»†ä¿¡æ¯
                for å¼±åŠ¿ in åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
                    if å¼±åŠ¿.ç±»åˆ«åç§° == ç±»åˆ«å:
                        æ‘˜è¦.append(
                            f"  {i}. {ç±»åˆ«å} (F1={å¼±åŠ¿.F1åˆ†æ•°:.2f}, {å¼±åŠ¿.é—®é¢˜ç±»å‹})"
                        )
                        break
        
        return æ‘˜è¦
    
    def ç”Ÿæˆåˆ†ææŠ¥å‘Š(self, åˆ†æç»“æœ: ç±»åˆ«åˆ†æç»“æœ,
                     æ ¼å¼: str = "text") -> str:
        """
        ç”ŸæˆåŠ¨ä½œç±»åˆ«åˆ†ææŠ¥å‘Š
        
        å‚æ•°:
            åˆ†æç»“æœ: ç±»åˆ«åˆ†æç»“æœå¯¹è±¡
            æ ¼å¼: æŠ¥å‘Šæ ¼å¼ ('text', 'markdown')
            
        è¿”å›:
            æŠ¥å‘Šå†…å®¹
        """
        if æ ¼å¼ == "markdown":
            return self._ç”ŸæˆMarkdownæŠ¥å‘Š(åˆ†æç»“æœ)
        else:
            return self._ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š(åˆ†æç»“æœ)
    
    def _ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š(self, åˆ†æç»“æœ: ç±»åˆ«åˆ†æç»“æœ) -> str:
        """ç”Ÿæˆæ–‡æœ¬æ ¼å¼æŠ¥å‘Š"""
        è¡Œåˆ—è¡¨ = []
        è¡Œåˆ—è¡¨.append("=" * 60)
        è¡Œåˆ—è¡¨.append("åŠ¨ä½œç±»åˆ«åˆ†ææŠ¥å‘Š")
        è¡Œåˆ—è¡¨.append("=" * 60)
        è¡Œåˆ—è¡¨.append("")
        
        # åˆ†ç»„æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("ã€å„åˆ†ç»„æŒ‡æ ‡ã€‘")
        è¡Œåˆ—è¡¨.append(f"{'åˆ†ç»„':<10} {'å¹³å‡ç²¾ç¡®ç‡':<12} {'å¹³å‡å¬å›ç‡':<12} {'å¹³å‡F1':<10} {'ç±»åˆ«æ•°':<8} {'å¼±åŠ¿æ•°':<8}")
        è¡Œåˆ—è¡¨.append("-" * 60)
        
        for åˆ†ç»„ in åˆ†æç»“æœ.åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨:
            è¡Œåˆ—è¡¨.append(
                f"{åˆ†ç»„.åˆ†ç»„åç§°:<10} {åˆ†ç»„.å¹³å‡ç²¾ç¡®ç‡:<12.4f} {åˆ†ç»„.å¹³å‡å¬å›ç‡:<12.4f} "
                f"{åˆ†ç»„.å¹³å‡F1åˆ†æ•°:<10.4f} {åˆ†ç»„.ç±»åˆ«æ•°:<8} {åˆ†ç»„.å¼±åŠ¿ç±»åˆ«æ•°:<8}"
            )
        è¡Œåˆ—è¡¨.append("")
        
        # å¼±åŠ¿ç±»åˆ«è¯¦æƒ…
        è¡Œåˆ—è¡¨.append("ã€å¼±åŠ¿ç±»åˆ«è¯¦æƒ…ã€‘")
        if not åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
            è¡Œåˆ—è¡¨.append("  æ— å¼±åŠ¿ç±»åˆ«")
        else:
            è¡Œåˆ—è¡¨.append(f"{'ç±»åˆ«':<15} {'åˆ†ç»„':<10} {'F1':<8} {'ç²¾ç¡®ç‡':<8} {'å¬å›ç‡':<8} {'æ ·æœ¬æ•°':<8} {'é—®é¢˜ç±»å‹':<12}")
            è¡Œåˆ—è¡¨.append("-" * 70)
            
            for å¼±åŠ¿ in åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
                è¡Œåˆ—è¡¨.append(
                    f"{å¼±åŠ¿.ç±»åˆ«åç§°:<15} {å¼±åŠ¿.æ‰€å±åˆ†ç»„:<10} {å¼±åŠ¿.F1åˆ†æ•°:<8.4f} "
                    f"{å¼±åŠ¿.ç²¾ç¡®ç‡:<8.4f} {å¼±åŠ¿.å¬å›ç‡:<8.4f} {å¼±åŠ¿.æ”¯æŒæ•°:<8} {å¼±åŠ¿.é—®é¢˜ç±»å‹:<12}"
                )
        è¡Œåˆ—è¡¨.append("")
        
        # æ”¹è¿›å»ºè®®
        è¡Œåˆ—è¡¨.append("ã€æ”¹è¿›å»ºè®®ã€‘")
        for å¼±åŠ¿ in åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨[:10]:  # æœ€å¤šæ˜¾ç¤º10ä¸ª
            è¡Œåˆ—è¡¨.append(f"  â€¢ {å¼±åŠ¿.ç±»åˆ«åç§°}: {å¼±åŠ¿.å»ºè®®}")
        è¡Œåˆ—è¡¨.append("")
        
        # åˆ†ææ‘˜è¦
        for è¡Œ in åˆ†æç»“æœ.åˆ†ææ‘˜è¦:
            è¡Œåˆ—è¡¨.append(è¡Œ)
        
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("=" * 60)
        
        return "\n".join(è¡Œåˆ—è¡¨)
    
    def _ç”ŸæˆMarkdownæŠ¥å‘Š(self, åˆ†æç»“æœ: ç±»åˆ«åˆ†æç»“æœ) -> str:
        """ç”Ÿæˆ Markdown æ ¼å¼æŠ¥å‘Š"""
        è¡Œåˆ—è¡¨ = []
        è¡Œåˆ—è¡¨.append("# åŠ¨ä½œç±»åˆ«åˆ†ææŠ¥å‘Š")
        è¡Œåˆ—è¡¨.append("")
        
        # åˆ†ç»„æŒ‡æ ‡
        è¡Œåˆ—è¡¨.append("## å„åˆ†ç»„æŒ‡æ ‡")
        è¡Œåˆ—è¡¨.append("")
        è¡Œåˆ—è¡¨.append("| åˆ†ç»„ | å¹³å‡ç²¾ç¡®ç‡ | å¹³å‡å¬å›ç‡ | å¹³å‡F1 | ç±»åˆ«æ•° | å¼±åŠ¿ç±»åˆ«æ•° |")
        è¡Œåˆ—è¡¨.append("|------|-----------|-----------|--------|--------|-----------|")
        
        for åˆ†ç»„ in åˆ†æç»“æœ.åˆ†ç»„æŒ‡æ ‡åˆ—è¡¨:
            è¡Œåˆ—è¡¨.append(
                f"| {åˆ†ç»„.åˆ†ç»„åç§°} | {åˆ†ç»„.å¹³å‡ç²¾ç¡®ç‡:.4f} | {åˆ†ç»„.å¹³å‡å¬å›ç‡:.4f} | "
                f"{åˆ†ç»„.å¹³å‡F1åˆ†æ•°:.4f} | {åˆ†ç»„.ç±»åˆ«æ•°} | {åˆ†ç»„.å¼±åŠ¿ç±»åˆ«æ•°} |"
            )
        è¡Œåˆ—è¡¨.append("")
        
        # å¼±åŠ¿ç±»åˆ«è¯¦æƒ…
        è¡Œåˆ—è¡¨.append("## å¼±åŠ¿ç±»åˆ«è¯¦æƒ…")
        è¡Œåˆ—è¡¨.append("")
        
        if not åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
            è¡Œåˆ—è¡¨.append("âœ… æ‰€æœ‰ç±»åˆ«è¡¨ç°å‡è¾¾æ ‡ï¼Œæ— å¼±åŠ¿ç±»åˆ«ã€‚")
        else:
            è¡Œåˆ—è¡¨.append("| ç±»åˆ« | åˆ†ç»„ | F1åˆ†æ•° | ç²¾ç¡®ç‡ | å¬å›ç‡ | æ ·æœ¬æ•° | é—®é¢˜ç±»å‹ |")
            è¡Œåˆ—è¡¨.append("|------|------|--------|--------|--------|--------|----------|")
            
            for å¼±åŠ¿ in åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
                è¡Œåˆ—è¡¨.append(
                    f"| {å¼±åŠ¿.ç±»åˆ«åç§°} | {å¼±åŠ¿.æ‰€å±åˆ†ç»„} | {å¼±åŠ¿.F1åˆ†æ•°:.4f} | "
                    f"{å¼±åŠ¿.ç²¾ç¡®ç‡:.4f} | {å¼±åŠ¿.å¬å›ç‡:.4f} | {å¼±åŠ¿.æ”¯æŒæ•°} | {å¼±åŠ¿.é—®é¢˜ç±»å‹} |"
                )
        è¡Œåˆ—è¡¨.append("")
        
        # æ”¹è¿›å»ºè®®
        è¡Œåˆ—è¡¨.append("## æ”¹è¿›å»ºè®®")
        è¡Œåˆ—è¡¨.append("")
        
        if not åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨:
            è¡Œåˆ—è¡¨.append("- âœ… æ¨¡å‹è¡¨ç°è‰¯å¥½ï¼Œæš‚æ— æ”¹è¿›å»ºè®®")
        else:
            for å¼±åŠ¿ in åˆ†æç»“æœ.å¼±åŠ¿ç±»åˆ«åˆ—è¡¨[:10]:
                è¡Œåˆ—è¡¨.append(f"- **{å¼±åŠ¿.ç±»åˆ«åç§°}**: {å¼±åŠ¿.å»ºè®®}")
        è¡Œåˆ—è¡¨.append("")
        
        # åˆ†ææ‘˜è¦
        è¡Œåˆ—è¡¨.append("## åˆ†ææ‘˜è¦")
        è¡Œåˆ—è¡¨.append("")
        for è¡Œ in åˆ†æç»“æœ.åˆ†ææ‘˜è¦:
            if è¡Œ.startswith("ã€"):
                è¡Œåˆ—è¡¨.append(f"### {è¡Œ[1:-1]}")
            else:
                è¡Œåˆ—è¡¨.append(è¡Œ)
        è¡Œåˆ—è¡¨.append("")
        
        return "\n".join(è¡Œåˆ—è¡¨)


# ==================== ä¾¿æ·å‡½æ•° ====================

def å¿«é€Ÿè¯„ä¼°(æ¨¡å‹, æµ‹è¯•æ•°æ®: List[Tuple[np.ndarray, int]], 
             åŠ¨ä½œå®šä¹‰: Dict[int, str] = None) -> è¯„ä¼°ç»“æœ:
    """
    å¿«é€Ÿè¯„ä¼°æ¨¡å‹
    
    å‚æ•°:
        æ¨¡å‹: å¾…è¯„ä¼°çš„æ¨¡å‹
        æµ‹è¯•æ•°æ®: [(å›¾åƒ, æ ‡ç­¾), ...] åˆ—è¡¨
        åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        
    è¿”å›:
        è¯„ä¼°ç»“æœ
    """
    è¯„ä¼°å™¨ = æ¨¡å‹è¯„ä¼°å™¨(æ¨¡å‹, åŠ¨ä½œå®šä¹‰)
    return è¯„ä¼°å™¨.è¯„ä¼°(æµ‹è¯•æ•°æ®)


def åŠ è½½å¹¶è¯„ä¼°(æ¨¡å‹, æ•°æ®è·¯å¾„: str, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None,
               æ˜¾ç¤ºè¿›åº¦: bool = True) -> è¯„ä¼°ç»“æœ:
    """
    åŠ è½½æ•°æ®å¹¶è¯„ä¼°æ¨¡å‹
    
    å‚æ•°:
        æ¨¡å‹: å¾…è¯„ä¼°çš„æ¨¡å‹
        æ•°æ®è·¯å¾„: æ•°æ®æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„
        åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        æ˜¾ç¤ºè¿›åº¦: æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡
        
    è¿”å›:
        è¯„ä¼°ç»“æœ
    """
    æ‰¹é‡è¯„ä¼° = æ‰¹é‡è¯„ä¼°å™¨(æ¨¡å‹, åŠ¨ä½œå®šä¹‰)
    return æ‰¹é‡è¯„ä¼°.æ‰¹é‡è¯„ä¼°(æ•°æ®è·¯å¾„, æ˜¾ç¤ºè¿›åº¦=æ˜¾ç¤ºè¿›åº¦)


def ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š(è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ, åŠ¨ä½œå®šä¹‰: Dict[int, str] = None,
                 è¾“å‡ºç›®å½•: str = "è¯„ä¼°æŠ¥å‘Š", æ ¼å¼: str = "markdown") -> str:
    """
    ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
    
    å‚æ•°:
        è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
        åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        è¾“å‡ºç›®å½•: è¾“å‡ºç›®å½•
        æ ¼å¼: æŠ¥å‘Šæ ¼å¼ ('text', 'markdown', 'html', 'json')
        
    è¿”å›:
        æŠ¥å‘Šæ–‡ä»¶è·¯å¾„
    """
    os.makedirs(è¾“å‡ºç›®å½•, exist_ok=True)
    æ—¶é—´æˆ³ = time.strftime("%Y%m%d_%H%M%S")
    
    æŠ¥å‘Šç”Ÿæˆ = æŠ¥å‘Šç”Ÿæˆå™¨(è¯„ä¼°ç»“æœ, åŠ¨ä½œå®šä¹‰)
    
    if æ ¼å¼ == 'text':
        è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.txt")
        with open(è·¯å¾„, 'w', encoding='utf-8') as f:
            f.write(æŠ¥å‘Šç”Ÿæˆ.ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š())
    elif æ ¼å¼ == 'markdown':
        è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.md")
        æŠ¥å‘Šç”Ÿæˆ.ç”ŸæˆMarkdownæŠ¥å‘Š(è·¯å¾„)
    elif æ ¼å¼ == 'html':
        è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.html")
        æŠ¥å‘Šç”Ÿæˆ.ç”ŸæˆHTMLæŠ¥å‘Š(è·¯å¾„)
    elif æ ¼å¼ == 'json':
        è·¯å¾„ = os.path.join(è¾“å‡ºç›®å½•, f"è¯„ä¼°æŠ¥å‘Š_{æ—¶é—´æˆ³}.json")
        æŠ¥å‘Šç”Ÿæˆ.ç”ŸæˆJSONæŠ¥å‘Š(è·¯å¾„)
    else:
        raise ValueError(f"ä¸æ”¯æŒçš„æŠ¥å‘Šæ ¼å¼: {æ ¼å¼}")
    
    return è·¯å¾„


def åˆ†æåŠ¨ä½œç±»åˆ«(è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ, 
                 åŠ¨ä½œå®šä¹‰: Dict[int, str] = None,
                 åŠ¨ä½œåˆ†ç»„: Dict[str, List[int]] = None,
                 F1é˜ˆå€¼: float = 0.7) -> ç±»åˆ«åˆ†æç»“æœ:
    """
    åˆ†æåŠ¨ä½œç±»åˆ«è¡¨ç°
    
    å‚æ•°:
        è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
        åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        åŠ¨ä½œåˆ†ç»„: åŠ¨ä½œåˆ†ç»„å®šä¹‰
        F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
        
    è¿”å›:
        ç±»åˆ«åˆ†æç»“æœ
    """
    åˆ†æå™¨ = åŠ¨ä½œç±»åˆ«åˆ†æå™¨(åŠ¨ä½œå®šä¹‰, åŠ¨ä½œåˆ†ç»„)
    return åˆ†æå™¨.å®Œæ•´åˆ†æ(è¯„ä¼°ç»“æœ, F1é˜ˆå€¼=F1é˜ˆå€¼)


def è¯†åˆ«å¼±åŠ¿åŠ¨ä½œ(è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ,
                 åŠ¨ä½œå®šä¹‰: Dict[int, str] = None,
                 F1é˜ˆå€¼: float = 0.7) -> List[å¼±åŠ¿ç±»åˆ«ä¿¡æ¯]:
    """
    è¯†åˆ«è¡¨ç°ä¸ä½³çš„åŠ¨ä½œç±»åˆ«
    
    å‚æ•°:
        è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
        åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
        
    è¿”å›:
        å¼±åŠ¿ç±»åˆ«ä¿¡æ¯åˆ—è¡¨
    """
    åˆ†æå™¨ = åŠ¨ä½œç±»åˆ«åˆ†æå™¨(åŠ¨ä½œå®šä¹‰)
    return åˆ†æå™¨.è¯†åˆ«å¼±åŠ¿ç±»åˆ«(è¯„ä¼°ç»“æœ, F1é˜ˆå€¼=F1é˜ˆå€¼)


def è·å–æ ·æœ¬å»ºè®®(è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœ,
                 åŠ¨ä½œå®šä¹‰: Dict[int, str] = None,
                 F1é˜ˆå€¼: float = 0.7) -> List[Tuple[str, str]]:
    """
    è·å–éœ€è¦æ›´å¤šè®­ç»ƒæ ·æœ¬çš„ç±»åˆ«å»ºè®®
    
    å‚æ•°:
        è¯„ä¼°ç»“æœ: è¯„ä¼°ç»“æœå¯¹è±¡
        åŠ¨ä½œå®šä¹‰: åŠ¨ä½œå®šä¹‰å­—å…¸
        F1é˜ˆå€¼: F1 åˆ†æ•°é˜ˆå€¼
        
    è¿”å›:
        [(ç±»åˆ«åç§°, å»ºè®®åŸå› ), ...] åˆ—è¡¨
    """
    åˆ†æå™¨ = åŠ¨ä½œç±»åˆ«åˆ†æå™¨(åŠ¨ä½œå®šä¹‰)
    return åˆ†æå™¨.å»ºè®®éœ€è¦æ›´å¤šæ ·æœ¬çš„ç±»åˆ«(è¯„ä¼°ç»“æœ, F1é˜ˆå€¼=F1é˜ˆå€¼)
